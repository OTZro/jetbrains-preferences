<application>
  <component name="VimEditorSettings">
    <editor>
      <key-repeat enabled="true" />
    </editor>
  </component>
  <component name="VimHistorySettings">
    <history>
      <history-search>
        <entry>ATTACHMENT</entry>
        <entry>WebSocket</entry>
        <entry>message_group_member</entry>
        <entry>isCross</entry>
        <entry>inBlack</entry>
        <entry>user</entry>
        <entry>$user</entry>
        <entry>projectGro</entry>
        <entry>follow</entry>
        <entry>attachment</entry>
        <entry>users_compos</entry>
        <entry encoding="base64">XDxyZXF1ZXN0XD4=</entry>
        <entry encoding="base64">XDxmdW5jdGlvblw+</entry>
        <entry encoding="base64">XDx1c2VcPg==</entry>
        <entry encoding="base64">XDxwdWJsaWNcPg==</entry>
        <entry>keyword</entry>
        <entry>csrf</entry>
        <entry>picture</entry>
        <entry encoding="base64">XDxDb250cmFjdHNcPg==</entry>
        <entry>:136</entry>
      </history-search>
      <history-cmd>
        <entry>107</entry>
        <entry>70</entry>
        <entry>116</entry>
        <entry>238</entry>
        <entry>141</entry>
        <entry encoding="base64">JzwsJz4yMzk5</entry>
        <entry>2399</entry>
        <entry>2424</entry>
        <entry>202</entry>
        <entry>140</entry>
        <entry>36</entry>
        <entry>99</entry>
        <entry>529</entry>
        <entry>50</entry>
        <entry>109</entry>
        <entry>17</entry>
        <entry>138</entry>
        <entry>w</entry>
        <entry>624</entry>
        <entry>1260</entry>
      </history-cmd>
      <history-expr />
      <history-input />
    </history>
  </component>
  <component name="VimKeySettings">
    <shortcut-conflicts>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed F</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed B</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed E</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed D</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed R</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed H</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed P</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed N</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed U</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed V</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed O</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed I</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed Q</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed W</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed A</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed G</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed 2</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed J</text>
      </shortcut-conflict>
      <shortcut-conflict owner="vim">
        <text>ctrl pressed K</text>
      </shortcut-conflict>
    </shortcut-conflicts>
  </component>
  <component name="VimMarksSettings">
    <globalmarks />
    <filemarks>
      <file name="$USER_HOME$/gofreight/fms/static/freight/plugins/ui-select/select.js" timestamp="1592462614620">
        <mark key="[" line="1274" column="76" />
        <mark key="]" line="1273" column="0" />
        <mark key="^" line="1276" column="22" />
        <mark key="." line="1273" column="0" />
      </file>
      <file name="$USER_HOME$/gofreight/fms/frontend/src/page/freight/shipment/air/export_basic_entry/index.js" timestamp="1592464811774" />
      <file name="$USER_HOME$/gofreight/fms/frontend/src/page/freight/shipment/status.controller.js" timestamp="1592460285832">
        <mark key="[" line="48" column="0" />
        <mark key="]" line="48" column="0" />
        <mark key="." line="48" column="0" />
      </file>
      <file name="$USER_HOME$/gofreight/fms/frontend/src/page/freight/shipment/ocean/import_my_shipment/index.html" timestamp="1592449042737" />
      <file name="$USER_HOME$/gofreight/fms/frontend/src/lib/angular/shared-component/hc-location-select/hc-location-select.component.html" timestamp="1592449212848" />
      <file name="$USER_HOME$/gofreight/fms/frontend/src/component/core/auto_complete/vessel_select.component.js" timestamp="1592449305780" />
      <file name="$USER_HOME$/gofreight/fms/frontend/src/component/core/auto_complete/trade_partner_select.html" timestamp="1592452870595" />
      <file name="$USER_HOME$/gofreight/fms/frontend/src/lib/angular/shared-component/hc-tp-select/hc-tp-select.component.html" timestamp="1592461546550" />
      <file name="$USER_HOME$/gofreight/fms/frontend/src/page/freight/accounting/invoice.service.js" timestamp="1592454676182">
        <mark key="[" line="177" column="0" />
        <mark key="]" line="177" column="0" />
        <mark key="." line="177" column="0" />
      </file>
      <file name="$USER_HOME$/gofreight/fms/frontend/src/page/freight/shipment/air/export_basic_entry/index.html" timestamp="1592465085047" />
      <file name="$USER_HOME$/gofreight/fms/frontend/src/page/freight/shipment/ocean/import_basic_entry/index.js" timestamp="1592460382000" />
      <file name="$USER_HOME$/gofreight/fms/app/freight/func/shipment/views_ocean.py" timestamp="1592453689394" />
      <file name="$USER_HOME$/gofreight/fms/frontend/src/component/core/auto_complete/location_select.component.js" timestamp="1592452843609" />
      <file name="$USER_HOME$/gofreight/fms/frontend/src/lib/angular/shared-component/hc-autocomplete-base/hc-autocomplete-base.component.ts" timestamp="1592462495225">
        <mark key="[" line="0" column="0" />
        <mark key="]" line="0" column="0" />
        <mark key="." line="0" column="0" />
      </file>
      <file name="$USER_HOME$/gofreight/fms/frontend/src/component/core/auto_complete/location_select.component.html" timestamp="1592452840150">
        <mark key="[" line="7" column="0" />
        <mark key="." line="7" column="53" />
      </file>
      <file name="$USER_HOME$/gofreight/fms/frontend/src/component/core/auto_complete/auto_complete.service.js" timestamp="1592449399899" />
      <file name="$USER_HOME$/gofreight/fms/frontend/src/page/freight/approval/setting/approval-rule.service.text_def.ts" timestamp="1592463410578">
        <mark key="[" line="4" column="29" />
        <mark key="]" line="4" column="29" />
        <mark key="." line="4" column="29" />
        <mark key="^" line="4" column="65" />
      </file>
      <file name="$USER_HOME$/gofreight/fms/frontend/src/page/freight/shipment/ocean/import_basic_entry/index.html" timestamp="1592460802151">
        <mark key="[" line="50" column="20" />
        <mark key="]" line="232" column="108" />
        <mark key="." line="232" column="108" />
      </file>
      <file name="$USER_HOME$/gofreight/fms/frontend/src/page/freight/shipment/basic_entry.controller.js" timestamp="1592462501854">
        <mark key="[" line="0" column="0" />
        <mark key="]" line="0" column="0" />
        <mark key="." line="0" column="0" />
      </file>
      <file name="$USER_HOME$/gofreight/fms/frontend/src/lib/angular/shared-component/hc-tp-select/hc-tp-select.component.ts" timestamp="1592451758105">
        <mark key="[" line="176" column="47" />
      </file>
    </filemarks>
    <jumps>
      <jump line="1236" column="63" filename="$USER_HOME$/gofreight/fms/app/freight/views_reports/utility.py" />
      <jump line="1232" column="4" filename="$USER_HOME$/gofreight/fms/app/freight/views_reports/utility.py" />
      <jump line="134" column="29" filename="$USER_HOME$/gofreight/fms/app/jobflow/views.py" />
      <jump line="69" column="39" filename="$USER_HOME$/gofreight/fms/frontend/src/page/freight/approval/setting/app.component.html" />
      <jump line="0" column="0" filename="$USER_HOME$/gofreight/fms/frontend/src/page/freight/approval/setting/app.component.html" />
      <jump line="5" column="4" filename="$USER_HOME$/gofreight/fms/frontend/src/component_form/trade_partner/form_trade_partner_info_picker.html" />
      <jump line="28" column="0" filename="$USER_HOME$/gofreight/fms/frontend/src/lib/angular/bootstrap-tool/hc-popover-hover.directive.ts" />
      <jump line="163" column="39" filename="$USER_HOME$/gofreight/fms/frontend/src/page/freight/sales/trade_partner_entry/index.html" />
      <jump line="6" column="19" filename="$USER_HOME$/gofreight/fms/frontend/src/page/freight/approval/setting/rule.type.ts" />
      <jump line="34" column="24" filename="/amendment.py" />
      <jump line="8" column="34" filename="$USER_HOME$/gofreight/fms/frontend/src/page/freight/accounting/prepaid_expanse/app.component.text_def.ts" />
      <jump line="45" column="105" filename="$USER_HOME$/gofreight/fms/test/accounting/transaction/updater/utility.py" />
      <jump line="118" column="4" filename="$USER_HOME$/gofreight/fms/test/accounting/transaction/updater/utility.py" />
      <jump line="52" column="82" filename="$USER_HOME$/gofreight/fms/frontend/src/page/freight/approval/center/app.component.html" />
      <jump line="24" column="42" filename="$USER_HOME$/gofreight/fms/app/accounting/transaction/db_updater/amortization.py" />
    </jumps>
  </component>
  <component name="VimRegisterSettings">
    <registers>
      <register name="a" type="4">
        <keys>
          <key char="70" code="0" mods="0" />
          <key char="60" code="0" mods="0" />
          <key char="108" code="0" mods="0" />
          <key char="99" code="0" mods="0" />
          <key char="36" code="0" mods="0" />
          <key char="104" code="0" mods="0" />
          <key char="99" code="0" mods="0" />
          <key char="45" code="0" mods="0" />
          <key char="116" code="0" mods="0" />
          <key char="112" code="0" mods="0" />
          <key char="45" code="0" mods="0" />
          <key char="115" code="0" mods="0" />
          <key char="101" code="0" mods="0" />
          <key char="108" code="0" mods="0" />
          <key char="101" code="0" mods="0" />
          <key char="99" code="0" mods="0" />
          <key char="116" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
        </keys>
      </register>
      <register name="&quot;" type="4">
        <text>All pending submissions will be canceled. Are you sure you want to delete?</text>
      </register>
      <register name="b" type="4">
        <keys>
          <key char="94" code="0" mods="0" />
          <key char="105" code="0" mods="0" />
          <key char="110" code="0" mods="0" />
          <key char="103" code="0" mods="0" />
          <key char="45" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
          <key char="106" code="0" mods="0" />
          <key char="94" code="0" mods="0" />
          <key char="105" code="0" mods="0" />
          <key char="91" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
          <key char="102" code="0" mods="0" />
          <key char="61" code="0" mods="0" />
          <key char="105" code="0" mods="0" />
          <key char="93" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
          <key char="106" code="0" mods="0" />
          <key char="94" code="0" mods="0" />
          <key char="105" code="0" mods="0" />
          <key char="91" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
          <key char="102" code="0" mods="0" />
          <key char="61" code="0" mods="0" />
          <key char="105" code="0" mods="0" />
          <key char="93" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
          <key char="111" code="0" mods="0" />
          <key char="104" code="0" mods="0" />
          <key char="99" code="0" mods="0" />
          <key char="45" code="0" mods="0" />
          <key char="99" code="0" mods="0" />
          <key char="108" code="0" mods="0" />
          <key char="97" code="0" mods="0" />
          <key char="115" code="0" mods="0" />
          <key char="115" code="0" mods="0" />
          <key char="61" code="0" mods="0" />
          <key char="118" code="0" mods="0" />
          <key char="97" code="0" mods="0" />
          <key char="108" code="0" mods="0" />
          <key char="117" code="0" mods="0" />
          <key char="101" code="0" mods="0" />
          <key char="45" code="0" mods="0" />
          <key char="115" code="0" mods="0" />
          <key char="109" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
        </keys>
      </register>
      <register name="c" type="4">
        <keys>
          <key char="94" code="0" mods="0" />
          <key char="99" code="0" mods="0" />
          <key char="102" code="0" mods="0" />
          <key char="100" code="0" mods="0" />
          <key char="40" code="0" mods="0" />
          <key char="99" code="0" mods="0" />
          <key char="104" code="0" mods="0" />
          <key char="97" code="0" mods="0" />
          <key char="110" code="0" mods="0" />
          <key char="103" code="0" mods="0" />
          <key char="101" code="0" mods="0" />
          <key char="41" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
        </keys>
      </register>
      <register name="d" type="4">
        <text>2ddj2dd</text>
      </register>
      <register name="f" type="4">
        <keys>
          <key char="108" code="0" mods="0" />
          <key char="99" code="0" mods="0" />
          <key char="104" code="0" mods="0" />
          <key char="99" code="0" mods="0" />
          <key char="45" code="0" mods="0" />
          <key char="116" code="0" mods="0" />
          <key char="112" code="0" mods="0" />
          <key char="45" code="0" mods="0" />
          <key char="115" code="0" mods="0" />
          <key char="101" code="0" mods="0" />
          <key char="108" code="0" mods="0" />
          <key char="101" code="0" mods="0" />
          <key char="99" code="0" mods="0" />
          <key char="116" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
          <key char="106" code="0" mods="0" />
          <key char="94" code="0" mods="0" />
          <key char="105" code="0" mods="0" />
          <key char="110" code="0" mods="0" />
          <key char="103" code="0" mods="0" />
          <key char="45" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
          <key char="106" code="0" mods="0" />
          <key char="94" code="0" mods="0" />
          <key char="105" code="0" mods="0" />
          <key char="91" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
          <key char="102" code="0" mods="0" />
          <key char="61" code="0" mods="0" />
          <key char="105" code="0" mods="0" />
          <key char="93" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
          <key char="106" code="0" mods="0" />
          <key char="94" code="0" mods="0" />
          <key char="105" code="0" mods="0" />
          <key char="91" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
          <key char="102" code="0" mods="0" />
          <key char="61" code="0" mods="0" />
          <key char="105" code="0" mods="0" />
          <key char="93" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
        </keys>
      </register>
      <register name="j" type="4">
        <text>2ddkkkk2dd</text>
      </register>
      <register name="l" type="4">
        <keys>
          <key char="108" code="0" mods="0" />
          <key char="97" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
          <key char="65535" code="27" mods="0" />
          <key char="65535" code="27" mods="0" />
        </keys>
      </register>
      <register name="-" type="4">
        <text>All pending submissions will be canceled. Are you sure you want to delete?</text>
      </register>
      <register name="m" type="4">
        <keys>
          <key char="48" code="0" mods="0" />
          <key char="71" code="0" mods="0" />
          <key char="49" code="0" mods="0" />
          <key char="71" code="0" mods="0" />
          <key char="79" code="0" mods="0" />
          <key char="60" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
          <key char="71" code="0" mods="0" />
          <key char="111" code="0" mods="0" />
          <key char="63" code="0" mods="0" />
          <key char="112" code="0" mods="0" />
          <key char="113" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
        </keys>
      </register>
      <register name="n" type="4">
        <keys>
          <key char="94" code="0" mods="0" />
          <key char="105" code="0" mods="0" />
          <key char="110" code="0" mods="0" />
          <key char="103" code="0" mods="0" />
          <key char="45" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
        </keys>
      </register>
      <register name="/" type="4">
        <text>:136</text>
      </register>
      <register name="0" type="2">
        <text encoding="base64">ICAgICAgICBwcmludCgnPT09PT09PScpCg==</text>
      </register>
      <register name="p" type="4">
        <keys>
          <key char="99" code="0" mods="0" />
          <key char="105" code="0" mods="0" />
          <key char="119" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
          <key char="112" code="0" mods="0" />
          <key char="97" code="0" mods="0" />
          <key char="59" code="0" mods="0" />
          <key char="32" code="0" mods="0" />
          <key char="95" code="0" mods="0" />
          <key char="40" code="0" mods="0" />
          <key char="39" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
          <key char="112" code="0" mods="0" />
          <key char="108" code="0" mods="0" />
          <key char="108" code="0" mods="0" />
          <key char="97" code="0" mods="0" />
          <key char="44" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
        </keys>
      </register>
      <register name="1" type="2">
        <text encoding="base64">ICAgICAgICAgICAgY29uc29sZS5sb2coZS50YXJnZXQpOwo=</text>
      </register>
      <register name="q" type="4">
        <text>kkjk</text>
      </register>
      <register name="2" type="2">
        <text encoding="base64">ICAgICAgICAgICAgICBkZWJ1Z2dlcgo=</text>
      </register>
      <register name="3" type="2">
        <text encoding="base64">aW1wb3J0IHsgdG9NZWFzdXJlLCB0b1dlaWdodCB9IGZyb20gJ0xpYi9qcy9zaGlwbWVudC9udW1iZXInOwppbXBvcnQgUmVzdFVwZGF0ZXIgZnJvbSAnLi4vLi4vLi4vbGliL2FqL3Jlc3QtdXBkYXRlcic7CmltcG9ydCBUcmFja2luZ1ZpZXdNb2RlbCBmcm9tICcuL2Z0cy52bS5qcyc7CmltcG9ydCAnUGFnZS9mcmVpZ2h0L2FjY291bnRpbmcvaW52b2ljZV90cF91cGRhdGUuc2VydmljZSc7CmltcG9ydCAnLi9zaGlwbWVudC5ibG9jay5zZXJ2aWNlJzsKaW1wb3J0ICdQYWdlL2ZyZWlnaHQvc2hpcG1lbnQvYmF0Y2hfcHJpbnQuc2VydmljZSc7CmltcG9ydCAnTGliL2FqL21lLnNlcnZpY2UnOwppbXBvcnQgeyBTaGlwbWVudEFjY2Vzc0NvbnRyb2xTZXJ2aWNlIH0gZnJvbSAnLi9zaGlwbWVudC5hY2Nlc3NfY29udHJvbC5zZXJ2aWNlJzsKaW1wb3J0IHsgSGJsQmxvY2tVbmJsb2NrSGFuZGxlciwgTWJsQmxvY2tVbmJsb2NrSGFuZGxlciB9IGZyb20gJy4vc2hpcG1lbnQuYmxvY2suc2VydmljZSc7CgppbXBvcnQgVHJhZGVQYXJ0bmVyRW50aXR5IGZyb20gJy4uLy4uLy4uL2NvcmUvdHJhZGVfcGFydG5lci90cmFkZV9wYXJ0bmVyLmVudGl0eSc7CmltcG9ydCAnUGFnZS9mcmVpZ2h0L3NoaXBtZW50L2Fpci9leHBvcnRfYmFzaWNfZW50cnkvYWlyX2V4cG9ydF9tYXdiLnNlcnZpY2UnOwppbXBvcnQgJ1BhZ2UvZnJlaWdodC9zaGlwbWVudC9haXIvZXhwb3J0X2Jhc2ljX2VudHJ5L2Fpcl9leHBvcnRfaGF3Yi5zZXJ2aWNlJzsKaW1wb3J0ICdQYWdlL2ZyZWlnaHQvc2hpcG1lbnQvYWlyL2ltcG9ydF9iYXNpY19lbnRyeS9haXJfaW1wb3J0X21hd2JfZXZlbnRfaGFuZGxlcnMuc2VydmljZSc7CmltcG9ydCAnUGFnZS9mcmVpZ2h0L3NoaXBtZW50L2Fpci9pbXBvcnRfYmFzaWNfZW50cnkvYWlyX2ltcG9ydF9oYXdiX2V2ZW50X2hhbmRsZXJzLnNlcnZpY2UnOwppbXBvcnQgJ1BhZ2UvZnJlaWdodC9zaGlwbWVudC9haXIvZXhwb3J0X2Jhc2ljX2VudHJ5L2Fpcl9leHBvcnRfbWF3Yl9ldmVudF9oYW5kbGVycy5zZXJ2aWNlJzsKaW1wb3J0ICdQYWdlL2ZyZWlnaHQvc2hpcG1lbnQvYWlyL2V4cG9ydF9iYXNpY19lbnRyeS9haXJfZXhwb3J0X2hhd2JfZXZlbnRfaGFuZGxlcnMuc2VydmljZSc7CmltcG9ydCAnUGFnZS9mcmVpZ2h0L3NoaXBtZW50L29jZWFuL2V4cG9ydF9iYXNpY19lbnRyeS9vY2Vhbl9leHBvcnRfbWJsLnNlcnZpY2UnOwppbXBvcnQgJ1BhZ2UvZnJlaWdodC9zaGlwbWVudC9vY2Vhbi9pbXBvcnRfYmFzaWNfZW50cnkvb2NlYW5faW1wb3J0X2hibC5zZXJ2aWNlJzsKaW1wb3J0ICdQYWdlL2ZyZWlnaHQvc2hpcG1lbnQvb2NlYW4vZXhwb3J0X2Jhc2ljX2VudHJ5L29jZWFuX2V4cG9ydF9oYmwuc2VydmljZSc7CmltcG9ydCBBZXNEaXJlY3RTZXJ2aWNlCiAgZnJvbSAnUGFnZS9mcmVpZ2h0L3NoaXBtZW50L29jZWFuL2V4cG9ydF9iYXNpY19lbnRyeS9hZXNfZGlyZWN0L2Flc19kaXJlY3Quc2VydmljZSc7CmltcG9ydCBFc2lTZXJ2aWNlCiAgZnJvbSAnUGFnZS9mcmVpZ2h0L3NoaXBtZW50L29jZWFuL2V4cG9ydF9iYXNpY19lbnRyeS9zaGlwcGluZ19pbnN0cnVjdGlvbi9lc2lfc2VydmljZSc7CmltcG9ydCB7IE1ibENhcnJpZXJCb29raW5nTm9TZXJ2aWNlIH0gZnJvbSAnUGFnZS9mcmVpZ2h0L3NoaXBtZW50L29jZWFuL2NhcnJpZXJfYm9va2luZ19uby5zZXJ2aWNlJzsKaW1wb3J0IE1vZGFsQ29weVNoaXBtZW50SW5mb0Zyb21Jc2ZDb250cm9sbGVyCiAgZnJvbSAnUGFnZS9mcmVpZ2h0L3NoaXBtZW50L29jZWFuL2ltcG9ydF9iYXNpY19lbnRyeS9tb2RhbF9jb3B5X3NoaXBtZW50X2luZm9fZnJvbV9pc2YuY29udHJvbGxlcic7CmltcG9ydCBNb2RhbEhibENvcHlUb0N0cmwgZnJvbSAnUGFnZS9mcmVpZ2h0L2dlbmVyYWwvbW9kYWxfaGJsX2NvcHlfdG8nOwppbXBvcnQgTW9kYWxIYmxNb3ZlVG9DdHJsIGZyb20gJ1BhZ2UvZnJlaWdodC9nZW5lcmFsL21vZGFsX2hibF9tb3ZlX3RvJzsKaW1wb3J0IHsgQUVTX1NFVFVQX1NUWUxFIH0gZnJvbSAnUGFnZS9mcmVpZ2h0L3NoaXBtZW50L29jZWFuL2V4cG9ydF9iYXNpY19lbnRyeS9hZXNfZGlyZWN0L2Flcy5jb25zdGFudHMnOwoKaW1wb3J0IFdpdGhJMThuIGZyb20gJ0xpYi9hai90cmFuc2xhdGlvbi93aXRoX2kxOG4nOwppbXBvcnQgeyBfVCB9IGZyb20gJy4vYmFzaWNfZW50cnkuY29udHJvbGxlci50ZXh0X2RlZic7CmltcG9ydCB7IF9UIGFzIF9UX09JX01PREFMIH0gZnJvbSAnLi9vY2Vhbi9pbXBvcnRfYmFzaWNfZW50cnkvbW9kYWxfY29weV9zaGlwbWVudF9pbmZvX2Zyb21faXNmLmNvbnRyb2xsZXIudGV4dF9kZWYnOwoKaW1wb3J0IHsgU2hvd0FjY291bnRpbmdCbG9ja01zZywgU2hvd0FjY291bnRpbmdCbG9ja0VkaXRpb25XYXJuaW5nTXNnLCBTaG93T25Ib2xkSEJMTXNnLCBTaG93WWVhckVuZEJsb2NrTXNnIH0gZnJvbSAnTGliL2pzL21lc3NhZ2UudHMnOwoKY29uc3QgQ0FOQ0VMX0JMX0RJU0FCTEVfTU9ERSA9IHsKICBOT05FOiAnbm9uZScsCiAgTUJMX0NBTkNFTEVEOiAnbWJsX2NhbmNlbGVkJywKICBQQVlNRU5UX0xPQ0s6ICdwYXltZW50X2xvY2snLAogIE5PX1BFUk1JU1NJT046ICdub19wZXJtaXNzaW9uJywKfTsKCgo7KGZ1bmN0aW9uKCkgewogICd1c2Ugc3RyaWN0JzsKCiAgbWJsQ29udHJvbGxlci4kaW5qZWN0ID0gWwogICAgJyRzY29wZScsICckaHR0cCcsICckZmlsdGVyJywgJyRxJywgJyR0aW1lb3V0JywgJyRsb2cnLCAnJHdpbmRvdycsCiAgICAnbWJsQ29udHJvbGxlck1lc3NhZ2UnLCAnbWJsQ29udHJvbGxlckV2ZW50JywgJ21ibENvbnRyb2xsZXJDb25zdGFudCcsCiAgICAnbW9kYWwnLCAnc2hpcG1lbnRUb29sU2VydmljZScsCiAgICAndXJsU2VydmljZScsICdmdHNTZXJ2aWNlJywgJ2RhdGFTZXJ2aWNlJywgJ2VudHJ5SGVscGVyU2VydmljZScsICckbG9jYXRpb24nLCAnJHVpYk1vZGFsJywKICAgICdtb2RhbEFkdmFuY2VkQ29weVNoaXBtZW50JywgJ3F0aXBTZXJ2aWNlJywgJ2hjQmF0Y2hFbWFpbFNlcnZpY2UnLAogICAgJ3RwU2VydmljZScsICdoY0FXQlZhbGlkYXRvcicsICdleGNlcHRpb25IYW5kbGVyJywgJ2FjdGlvbkZvckN1c3RvbWVySGlzdG9yeVNlcnZpY2UnLAogICAgJ3ByZWZlcmVuY2VTZXJ2aWNlJywgJ2JhdGNoUHJpbnRTZXJ2aWNlJywgJ3Blcm1pc3Npb25zJywgJ2ludm9pY2VUcFVwZGF0ZVNlcnZpY2UnLAogICAgJ3NoaXBtZW50QmxvY2tTZXJ2aWNlJywgJ21lU2VydmljZScsCgogICAgJ2FpckV4cG9ydE1BV0InLAogICAgJ2FpckV4cG9ydEhBV0InLAoKICAgICdhaXJJbXBvcnRNYXdiRXZlbnRIYW5kbGVycycsICdhaXJFeHBvcnRNYXdiRXZlbnRIYW5kbGVycycsCiAgICAnYWlySW1wb3J0SGF3YkV2ZW50SGFuZGxlcnMnLCAnYWlyRXhwb3J0SGF3YkV2ZW50SGFuZGxlcnMnLAoKICAgICdvY2VhbkV4cG9ydE1ibCcsCiAgICAnb2NlYW5JbXBvcnRIYmwnLCAnb2NlYW5FeHBvcnRIYmwnLAogIF07CgogIGFuZ3VsYXIubW9kdWxlKCdoY0FwcCcpCiAgICAuY29uc3RhbnQoJ21ibENvbnRyb2xsZXJNZXNzYWdlJywgewogICAgICBQQUNLQUdFX0NPVU5UX01JU01BVENIOiBfVC5NU0cuUEFDS0FHRV9DT1VOVF9NSVNNQVRDSCwKICAgICAgQ0FOX05PVF9DT1BZX0JZX0JMT0NLOiBfVC5NU0cuQ0FOX05PVF9DT1BZX0JZX0JMT0NLLAogICAgICBDQU5fTk9UX0NPUFlfVE9fQllfQkxPQ0s6IF9ULk1TRy5DQU5fTk9UX0NPUFlfVE9fQllfQkxPQ0ssCiAgICAgIENBTl9OT1RfTU9WRV9UT19CWV9CTE9DSzogX1QuTVNHLkNBTl9OT1RfTU9WRV9UT19CWV9CTE9DSywKICAgICAgQ0FOX05PVF9NT1ZFX1RPX0JZX0JMT0NLX0hCTDogX1QuTVNHLkNBTl9OT1RfTU9WRV9UT19CWV9CTE9DS19IQkwsCiAgICAgIENBTl9OT1RfTU9WRV9UT19CWV9CTE9DS19JTlZPSUNFOiBfVC5NU0cuQ0FOX05PVF9NT1ZFX1RPX0JZX0JMT0NLX0lOVk9JQ0UsCiAgICAgIENBTl9OT1RfREVMRVRFX0JZX1BFUk1JU1NJT046IF9ULk1TRy5DQU5fTk9UX0RFTEVURV9CWV9QRVJNSVNTSU9OLAogICAgICBDQU5fTk9UX0RFTEVURV9CWV9CTE9DSzogX1QuTVNHLkNBTl9OT1RfREVMRVRFX0JZX0JMT0NLLAogICAgICBDQU5fTk9UX0RFTEVURV9CWV9IQkxfQkxPQ0s6IF9ULk1TRy5DQU5fTk9UX0RFTEVURV9CWV9IQkxfQkxPQ0ssCiAgICAgIENBTl9OT1RfREVMRVRFX0JZX1BBWU1FTlRfTE9DSzogX1QuTVNHLkNBTl9OT1RfREVMRVRFX0JZX1BBWU1FTlRfTE9DSywKICAgICAgQ0FOX05PVF9ERUxFVEVfQllfRVNJX1NVQk1JVFRFRDogX1QuTVNHLkNBTl9OT1RfREVMRVRFX0JZX0VTSV9TVUJNSVRURUQsCiAgICAgIENBTl9OT1RfREVUQUNIX0JZX0JMT0NLOiBfVC5NU0cuQ0FOX05PVF9ERVRBQ0hfQllfQkxPQ0ssCiAgICAgIENBTl9OT1RfREVUQUNIX0JZX0FOWV9GUkVJR0hUX0FTU0lHTl9UT19NQkw6IF9ULk1TRy5DQU5fTk9UX0RFVEFDSF9CWV9BTllfRlJFSUdIVF9BU1NJR05fVE9fTUJMLAogICAgICBDQU5fTk9UX0RFVEFDSF9CWV9DQU5DRUxFRDogX1QuTVNHLkNBTl9OT1RfREVUQUNIX0JZX0NBTkNFTEVELAogICAgICBDT05GSVJNX1NZTkNfTUJMX0NBTkNFTF9UT19BTExfSEJMOiBfVC5NU0cuQ09ORklSTV9TWU5DX01CTF9DQU5DRUxfVE9fQUxMX0hCTCwKICAgICAgTk9USUZZX1RPX1NBVkVfTk9XOiBfVC5NU0cuTk9USUZZX1RPX1NBVkVfTk9XLAogICAgICBOT1RJRllfTk9fUEVSTV9UT19TQVZFOiBfVC5NU0cuTk9USUZZX05PX1BFUk1fVE9fU0FWRSwKICAgICAgQklMTF9UT19DUkVESVRfSE9MRDogX1QuTVNHLkJJTExfVE9fQ1JFRElUX0hPTEQsCiAgICB9KQogICAgLmNvbnN0YW50KCdtYmxDb250cm9sbGVyRXZlbnQnLCB7CiAgICAgIE1CTF9BRV9JTkZPX1BBQ0tBR0VfQ0hBTkdFRDogJ21ibENvbnRyb2xsZXJFdmVudC9NQkxfQUVfSU5GT19QQUNLQUdFX0NIQU5HRUQnLAogICAgICBIQkxfUEFDS0FHRV9DSEFOR0VEOiAnbWJsQ29udHJvbGxlckV2ZW50L0hCTF9QQUNLQUdFX0NIQU5HRUQnLAogICAgfSkKICAgIC5jb25zdGFudCgnbWJsQ29udHJvbGxlckNvbnN0YW50JywgewogICAgICBQQUNLQUdFX1dBUk5JTkdfREVMQVk6IDUwMDAsCiAgICB9KQogICAgLmNvbnRyb2xsZXIoJ21ibENvbnRyb2xsZXInLCBXaXRoSTE4bihtYmxDb250cm9sbGVyLCBfVCkpOwoKICBmdW5jdGlvbiBtYmxDb250cm9sbGVyKAogICAgJHNjb3BlLCAkaHR0cCwgJGZpbHRlciwgJHEsICR0aW1lb3V0LCAkbG9nLCAkd2luZG93LAogICAgbWJsQ29udHJvbGxlck1lc3NhZ2UsIG1ibENvbnRyb2xsZXJFdmVudCwgbWJsQ29udHJvbGxlckNvbnN0YW50LAogICAgbW9kYWwsIHNoaXBtZW50VG9vbFNlcnZpY2UsCiAgICB1cmxTZXJ2aWNlLCBmdHNTZXJ2aWNlLCBkYXRhU2VydmljZSwgZW50cnlIZWxwZXJTZXJ2aWNlLCAkbG9jYXRpb24sICR1aWJNb2RhbCwKICAgIG1vZGFsQWR2YW5jZWRDb3B5U2hpcG1lbnQsIHF0aXBTZXJ2aWNlLCBoY0JhdGNoRW1haWxTZXJ2aWNlLAogICAgdHBTZXJ2aWNlLCBoY0FXQlZhbGlkYXRvciwgZXhjZXB0aW9uSGFuZGxlciwgYWN0aW9uRm9yQ3VzdG9tZXJIaXN0b3J5U2VydmljZSwKICAgIHByZWZlcmVuY2VTZXJ2aWNlLCBiYXRjaFByaW50U2VydmljZSwgcGVybWlzc2lvbnMsIGludm9pY2VUcFVwZGF0ZVNlcnZpY2UsCiAgICBzaGlwbWVudEJsb2NrU2VydmljZSwgbWVTZXJ2aWNlLAoKICAgIGFpckV4cG9ydE1BV0IsCiAgICBhaXJFeHBvcnRIQVdCLAoKICAgIGFpckltcG9ydE1hd2JFdmVudEhhbmRsZXJzLCBhaXJFeHBvcnRNYXdiRXZlbnRIYW5kbGVycywKICAgIGFpckltcG9ydEhhd2JFdmVudEhhbmRsZXJzLCBhaXJFeHBvcnRIYXdiRXZlbnRIYW5kbGVycywKCiAgICBvY2VhbkV4cG9ydE1ibCwKICAgIG9jZWFuSW1wb3J0SGJsLCBvY2VhbkV4cG9ydEhibCwKICApIHsKCiAgICAkc2NvcGUuVHJhZGVQYXJ0bmVyRW50aXR5ID0gZCA9PiBuZXcgVHJhZGVQYXJ0bmVyRW50aXR5KGQpOwoKICAgIHZhciBVUkwgPSB7fTsKICAgIHZhciB0aWQgPSAwOwoKICAgIHZhciB0b2RheSA9IGdldFNlcnZlclN0ckZyb21EYXRlKG5ldyBEYXRlKCkpOwogICAgdmFyIHVwZGF0ZXIgPSBuZXcgUmVzdFVwZGF0ZXIoKTsKICAgIHZhciBhd2JWYWxpZGF0b3IgPSBuZXcgaGNBV0JWYWxpZGF0b3IoKTsKICAgIHZhciB2bSA9IHRoaXM7CgogICAgdmFyIFFUSVBfR1JPVVAgPSAnbWFpbic7CiAgICB2bS5QID0gcGVybWlzc2lvbnMuUDsKICAgIHZtLndhcm5pbmcgPSB7fTsKICAgIHZtLmVycm9ycyA9IHt9OwogICAgdm0ubWVzc2FnZSA9IG1ibENvbnRyb2xsZXJNZXNzYWdlOwogICAgdm0uZXZlbnRzID0gbWJsQ29udHJvbGxlckV2ZW50OwogICAgdm0uY29uc3RhbnQgPSBtYmxDb250cm9sbGVyQ29uc3RhbnQ7CiAgICB2bS5hd2JWYWxpZGF0b3IgPSBhd2JWYWxpZGF0b3I7CiAgICB2bS5haXJFeHBvcnRNYXdiID0gYWlyRXhwb3J0TUFXQjsKCiAgICB2bS5haXJFeHBvcnRIYXdiID0gYWlyRXhwb3J0SEFXQjsKICAgIHZtLmFpckltcG9ydE1hd2JFdmVudEhhbmRsZXJzID0gYWlySW1wb3J0TWF3YkV2ZW50SGFuZGxlcnM7CgogICAgdm0uYWlySW1wb3J0SGF3YkV2ZW50SGFuZGxlcnMgPSBhaXJJbXBvcnRIYXdiRXZlbnRIYW5kbGVyczsKICAgIHZtLmFpckV4cG9ydE1hd2JFdmVudEhhbmRsZXJzID0gYWlyRXhwb3J0TWF3YkV2ZW50SGFuZGxlcnM7CiAgICB2bS5haXJFeHBvcnRIYXdiRXZlbnRIYW5kbGVycyA9IGFpckV4cG9ydEhhd2JFdmVudEhhbmRsZXJzOwogICAgdm0ub2NlYW5FeHBvcnRNYmwgPSBvY2VhbkV4cG9ydE1ibDsKCiAgICB2bS5vY2VhbkltcG9ydEhibCA9IG9jZWFuSW1wb3J0SGJsOwogICAgdm0ub2NlYW5FeHBvcnRIYmwgPSBvY2VhbkV4cG9ydEhibDsKICAgIHZtLmFpckZsaWdodERhdGVTdHlsZSA9IENPTVBBTllfSU5GTy5haXJfZmxpZ2h0X2RhdGVfc3R5bGU7CgogICAgdm0ucHJpbnRGb2N1cyA9IGZ1bmN0aW9uKCkgewogICAgICBjb25zb2xlLmxvZygnRm9jdXNlZCBpbiBpbnB1dCcpOwogICAgfTsKCiAgICB2bS5zeW5jTUJMRmllbGRUb0FsbEhCTCA9IHN5bmNNQkxGaWVsZFRvQWxsSEJMOwogICAgdm0ucG9wdXBUcmFkZVBhcnRuZXJUaXBzID0gdHBTZXJ2aWNlLnBvcHVwVGlwczsKICAgIHZtLmlzU2hpcHBlclVJTW9kZSA9IGlzU2hpcHBlclVJTW9kZTsKCiAgICAvLyBOYXYgVGFiCiAgICB2bS5pc0Zvcm1OZWVkU2F2ZSA9IGlzRm9ybU5lZWRTYXZlOwoKICAgIC8vIENvbW1vbgogICAgdm0uaW5pdGlhbCA9IGluaXRpYWw7CiAgICB2bS5oaWRlV2FybmluZyA9IGhpZGVXYXJuaW5nOwogICAgdm0uc2F2ZSA9IHNhdmU7CiAgICB2bS5jYW5TYXZlID0gY2FuU2F2ZTsKCiAgICAvLyBBbGwgU2hpcG1lbnQKICAgIHZtLmFkZEhibCA9IGFkZEhibDsKICAgIHZtLnRvZ2dsZUhibCA9IHRvZ2dsZUhibDsKICAgIHZtLmNvcHlIYmwgPSBjb3B5SGJsOwogICAgdm0uY29weUhibFRvT3RoZXJNYmwgPSBjb3B5SGJsVG9PdGhlck1ibDsKICAgIHZtLm1vdmVIYmxUb090aGVyTWJsID0gbW92ZUhibFRvT3RoZXJNYmw7CiAgICB2bS5jbG9zZUhibCA9IGNsb3NlSGJsOwogICAgdm0uaXNIYmxOZWVkUmVuZGVyZWQgPSBpc0hibE5lZWRSZW5kZXJlZDsKICAgIHZtLmdldEJsb2NrVG9vbHRpcCA9IGdldEJsb2NrVG9vbHRpcDsKICAgIHZtLmRpc2FibGVNb2RlID0gZGlzYWJsZU1vZGU7CiAgICB2bS5oYmxEaXNhYmxlTW9kZSA9IGhibERpc2FibGVNb2RlOwogICAgdm0ub25PZmZpY2VDaGFuZ2luZyA9IG9uT2ZmaWNlQ2hhbmdpbmc7CiAgICB2bS50b2dnbGVIYmxBZHZhbmNlZCA9IHRvZ2dsZUhibEFkdmFuY2VkOwogICAgdm0uZ2V0Q3VycmVudERpc3BsYXlWYWx1ZSA9IGdldEN1cnJlbnREaXNwbGF5VmFsdWU7CiAgICB2bS5lZGl0Rm9ybURpc3BsYXkgPSBlZGl0Rm9ybURpc3BsYXk7CiAgICB2bS5jYW5FZGl0QWxsSGJsID0gY2FuRWRpdEFsbEhibDsKICAgIHZtLnRvZ2dsZU1ibERpc3BsYXlTdGF0dXMgPSB0b2dnbGVNYmxEaXNwbGF5U3RhdHVzOwogICAgdm0uaXNEaXJlY3RNYXN0ZXIgPSBpc0RpcmVjdE1hc3RlcjsKCiAgICAvLyBFVEEgRVRECiAgICB2bS5vbkRhdGVDaGFuZ2VkID0gb25EYXRlQ2hhbmdlZDsKICAgIHZtLnZhbGlkYXRlRVRBRVREID0gdmFsaWRhdGVFVEFFVEQ7CiAgICB2bS5vbkVURENoYW5nZWQgPSBvbkVURENoYW5nZWQ7CiAgICB2bS5vbkVUQUNoYW5nZWQgPSBvbkVUQUNoYW5nZWQ7CgogICAgLy8gVHJhY2tpbmcKICAgIHZtLmdldFRyYWNraW5nSGJsTGluayA9IGdldFRyYWNraW5nSGJsTGluazsKCiAgICAvLyBUYWcgcmVsYXRlZAogICAgdm0ubmdUYWdzRmlsdGVyID0gbmdUYWdzRmlsdGVyOwogICAgdm0uYWRkZWRQb1RhZyA9IGFkZGVkUG9UYWc7CiAgICB2bS5yZW1vdmluZ1BvVGFnID0gcmVtb3ZpbmdQb1RhZzsKCiAgICB2bS5pc0VuYWJsZU9mZmljZURlcGFydG1lbnQgPSBpc0VuYWJsZU9mZmljZURlcGFydG1lbnQ7CgogICAgLy8gT2NlYW4gb25seQogICAgdm0ub25NYmxTaGlwTW9kZVVwZGF0ZSA9IG9uTWJsU2hpcE1vZGVVcGRhdGU7CiAgICB2bS5vbkhibFNoaXBNb2RlVXBkYXRlID0gb25IYmxTaGlwTW9kZVVwZGF0ZTsKICAgIHZtLmVuYWJsZVJlbGVhc2VkID0gZW5hYmxlUmVsZWFzZWQ7CiAgICB2bS5vbkV4cHJlc3NCTENoYW5nZSA9IG9uRXhwcmVzc0JMQ2hhbmdlOwogICAgdm0ub25IYmxPQkxSZWNlaXZlZCA9IG9uSGJsT0JMUmVjZWl2ZWRDaGFuZ2U7CiAgICB2bS50b2dnbGVPYmxSZWNlaXZlZCA9IHRvZ2dsZU9ibFJlY2VpdmVkOwogICAgdm0udG9nZ2xlVGVsZXhSZWxlYXNlUmVjZWl2ZWQgPSB0b2dnbGVUZWxleFJlbGVhc2VSZWNlaXZlZDsKICAgIHZtLmZpbGxPY2VhbkNhcnJpZXIgPSBmaWxsT2NlYW5DYXJyaWVyOwogICAgdm0ub25Jc0hvbGRDaGFuZ2UgPSBvbklzSG9sZENoYW5nZTsKICAgIHZtLm9uTWJsRGVsQ2hhbmdlZCA9IG9uTWJsRGVsQ2hhbmdlZDsKICAgIHZtLm9uTWJsRGV0YUNoYW5nZWQgPSBvbk1ibERldGFDaGFuZ2VkOwogICAgdm0ub25NYmxQb2RDaGFuZ2VkID0gb25NYmxQb2RDaGFuZ2VkOwogICAgdm0ub25NYmxGZGVzdENoYW5nZWQgPSBvbk1ibEZkZXN0Q2hhbmdlZDsKICAgIHZtLm9uT0VNYmxJc0RpcmVjdENoYW5nZWQgPSBvbk9FTWJsSXNEaXJlY3RDaGFuZ2VkOwogICAgdm0ub25BRU1ibElzRGlyZWN0Q2hhbmdlZCA9IG9uQUVNYmxJc0RpcmVjdENoYW5nZWQ7CiAgICB2bS5vbkhibERlbENoYW5nZWQgPSBvbkhibERlbENoYW5nZWQ7CiAgICB2bS5vbkhibEZkZXN0Q2hhbmdlZCA9IG9uSGJsRmRlc3RDaGFuZ2VkOwogICAgdm0uaXNFeHByZXNzTWJsID0gaXNFeHByZXNzTWJsOwogICAgdm0uY2FuRG9EZXBhcnRtZW50VHJhbnNmZXIgPSBjYW5Eb0RlcGFydG1lbnRUcmFuc2ZlcjsKICAgIHZtLm9wZW5Nb2RhbERlcGFydG1lbnRUcmFuc2ZlciA9IG9wZW5Nb2RhbERlcGFydG1lbnRUcmFuc2ZlcjsKICAgIHZtLmlzRW5hYmxlRGVwYXJ0bWVudFRyYW5zZmVyID0gaXNFbmFibGVEZXBhcnRtZW50VHJhbnNmZXI7CiAgICB2bS5pc0Rpc2FibGVNYmxPZmZpY2VEZXBhcnRtZW50ID0gaXNEaXNhYmxlTWJsT2ZmaWNlRGVwYXJ0bWVudDsKICAgIHZtLmlzRGlzYWJsZUhibE9mZmljZURlcGFydG1lbnQgPSBpc0Rpc2FibGVIYmxPZmZpY2VEZXBhcnRtZW50OwoKICAgIC8vIE9jZWFuIEltcG9ydCBvbmx5CiAgICB2bS50b2dnbGVNQkxSZWNlaXZlZCA9IHRvZ2dsZU1CTFJlY2VpdmVkOwogICAgdm0udG9nZ2xlSEJMUmVsZWFzZWQgPSB0b2dnbGVIQkxSZWxlYXNlZDsKICAgIHZtLnNob3dIb2xkTWVzc2FnZSA9IHNob3dIb2xkTWVzc2FnZTsKICAgIHZtLmdldEhvbGRNZXNzYWdlID0gZ2V0SG9sZE1lc3NhZ2U7CiAgICB2bS5vcGVuSXNmRW50cnkgPSBvcGVuSXNmRW50cnk7CiAgICB2bS5vcGVuQ3JlYXRlSXNmRnJvbUhibCA9IG9wZW5DcmVhdGVJc2ZGcm9tSGJsOwogICAgdm0ub25Db3B5SXNmSW5mb1RvQWxsSGJscyA9IG9uQ29weUlzZkluZm9Ub0FsbEhibHM7CiAgICB2bS5zaG93Q3JlYXRlSXNmRnJvbUhibCA9IHNob3dDcmVhdGVJc2ZGcm9tSGJsOwogICAgdm0uaGFuZGxlSGJsQW1zTm9Gb2N1cyA9IGhhbmRsZUhibEFtc05vRm9jdXM7CiAgICB2bS5oYW5kbGVIYmxBbXNOb0NoYW5nZU9uQmx1ciA9IGhhbmRsZUhibEFtc05vQ2hhbmdlT25CbHVyOwoKICAgIC8vIE9jZWFuIEV4cG9ydCBvbmx5CiAgICB2bS5vbkJvb2tpbmdOb0JsdXIgPSBvbkJvb2tpbmdOb0JsdXI7CiAgICB2bS5vbkJvb2tpbmdOb0NoYW5nZU9uQmx1ciA9IG9uQm9va2luZ05vQ2hhbmdlT25CbHVyOwogICAgdm0ub25IYmxOb0NoYW5nZU9uQmx1ciA9IG9uSGJsTm9DaGFuZ2VPbkJsdXI7CiAgICB2bS5zaG93Q2FjaGVkQm9va2luZ05vRXhpc3RXYXJuaW5nID0gc2hvd0NhY2hlZEJvb2tpbmdOb0V4aXN0V2FybmluZzsKICAgIHZtLm9uU2hpcG1lbnROb0JsdXIgPSBvblNoaXBtZW50Tm9CbHVyOwogICAgdm0ub25DdXN0b21lclJlZk5vQ2hhbmdlZCA9IG9uQ3VzdG9tZXJSZWZOb0NoYW5nZWQ7CiAgICB2bS5pc0Jvb2tpbmdOb1N5bmNIYmxObyA9IGlzQm9va2luZ05vU3luY0hibE5vOwogICAgdm0uaXNCb29raW5nTm9SZWFkT25seSA9IGlzQm9va2luZ05vUmVhZE9ubHk7CiAgICB2bS5vbk1ibERlbGl2ZXJ5VG9DaGFuZ2VkID0gb25NYmxEZWxpdmVyeVRvQ2hhbmdlZDsKICAgIHZtLm9uTWJsRW1wdHlQaWNrdXBDaGFuZ2VkID0gb25NYmxFbXB0eVBpY2t1cENoYW5nZWQ7CiAgICB2bS5vbk1ibEl0bk5vQ2hhbmdlZCA9IG9uTWJsSXRuTm9DaGFuZ2VkOwogICAgdm0ub25NYmxQT1JDaGFuZ2VkID0gb25NYmxQT1JDaGFuZ2VkOwogICAgdm0ub25Vc2VDYXJlT2ZDaGFuZ2VkID0gb25Vc2VDYXJlT2ZDaGFuZ2VkOwogICAgdm0uc2hvd0VkaU1ibE1hbmRhdG9yeUVycm9yID0gc2hvd0VkaU1ibE1hbmRhdG9yeUVycm9yOwogICAgdm0uc2hvd0VkaU1ibE1hbmRhdG9yeVdhcm5pbmcgPSBzaG93RWRpTWJsTWFuZGF0b3J5V2FybmluZzsKICAgIHZtLmdldEV0YVdhcm5pbmdNZXNzYWdlID0gZ2V0RXRhV2FybmluZ01lc3NhZ2U7CiAgICB2bS50b2dnbGVNQkxSZWxlYXNlZCA9IHRvZ2dsZU1CTFJlbGVhc2VkOwoKICAgIC8vIEFpciBvbmx5CiAgICB2bS5hZGRDb21tb2RpdHkgPSBhZGRDb21tb2RpdHk7CiAgICB2bS5kZWxDb21tb2RpdHkgPSBkZWxDb21tb2RpdHk7CiAgICB2bS5vbkNoYXJnZUl0ZW1DaGFuZ2VkID0gb25DaGFyZ2VJdGVtQ2hhbmdlZDsKICAgIHZtLm9uQWlyQ2FycmllckNoYW5nZWQgPSBvbkFpckNhcnJpZXJDaGFuZ2VkOwogICAgdm0uaXNNQVdCVmFsaWQgPSBpc01BV0JWYWxpZDsKICAgIHZtLmlzUGFja2FnZVZhbGlkID0gaXNQYWNrYWdlVmFsaWQ7CiAgICB2bS5pc0FFSGJsUGFja2FnZVZhbGlkID0gaXNBRUhibFBhY2thZ2VWYWxpZDsKICAgIHZtLmZpbGxBaXJDYXJyaWVyID0gZmlsbEFpckNhcnJpZXI7CiAgICB2bS5jb3B5UE9Ob1RvRGVzY3JpcHRpb24gPSBjb3B5UE9Ob1RvRGVzY3JpcHRpb247CiAgICB2bS5jb3B5Q29tbW9kaXR5VG9EZXNjcmlwdGlvbiA9IGNvcHlDb21tb2RpdHlUb0Rlc2NyaXB0aW9uOwogICAgdm0uc2VsQWxsQ29tbW9kaXRpZXMgPSBzZWxBbGxDb21tb2RpdGllczsKICAgIHZtLnNlbENvbW1vZGl0eSA9IHNlbENvbW1vZGl0eTsKICAgIHZtLm9wZW5Wb2x1bWVXZWlnaHRDYWxjdWxhdGlvbiA9IG9wZW5Wb2x1bWVXZWlnaHRDYWxjdWxhdGlvbjsKICAgIHZtLm9wZW5Db25uZWN0RmxpZ2h0ID0gb3BlbkNvbm5lY3RGbGlnaHQ7CiAgICB2bS5pc1Nob3dIdHNGaWVsZHMgPSBpc1Nob3dIdHNGaWVsZHM7CiAgICB2bS5nZXRDb2xzcGFuRm9yTm9Db21tb2RpdHkgPSBnZXRDb2xzcGFuRm9yTm9Db21tb2RpdHk7CiAgICB2bS5nZXRBZGROZXdSb3dXb3JkaW5nID0gZ2V0QWRkTmV3Um93V29yZGluZzsKCiAgICAvLyBBaXIgSW1wb3J0IG9ubHkKICAgIHZtLmFkZFN1Ykhhd2IgPSBhZGRTdWJIYXdiOwogICAgdm0uZGVsU3ViSGF3YiA9IGRlbFN1Ykhhd2I7CiAgICB2bS5zZWxBbGxTdWJIYXdiID0gc2VsQWxsU3ViSGF3YjsKICAgIHZtLnNlbFN1Ykhhd2IgPSBzZWxTdWJIYXdiOwogICAgdm0uaXNBSUhibFBhY2thZ2VWYWxpZCA9IGlzQUlIYmxQYWNrYWdlVmFsaWQ7CgogICAgLy8gRXhwb3J0IG9ubHkKICAgIHZtLm9uQWlyRXhwb3J0TWJsSXRuTm9DaGFuZ2UgPSBvbkFpckV4cG9ydE1ibEl0bk5vQ2hhbmdlOwogICAgdm0udG9nZ2xlTUJMQ2FuY2VsbGVkID0gdG9nZ2xlTUJMQ2FuY2VsbGVkOwogICAgdm0udG9nZ2xlT0VIQkxDYW5jZWxsZWQgPSB0b2dnbGVPRUhCTENhbmNlbGxlZDsKICAgIHZtLnRvZ2dsZUFFSEJMQ2FuY2VsbGVkID0gdG9nZ2xlQUVIQkxDYW5jZWxsZWQ7CiAgICB2bS5vbk1ibENhbmNlbERhdGVDaGFuZ2VkID0gb25NYmxDYW5jZWxEYXRlQ2hhbmdlZDsKICAgIHZtLm9uTWJsQ2FuY2VsUmVhc29uQ2hhbmdlZCA9IG9uTWJsQ2FuY2VsUmVhc29uQ2hhbmdlZDsKICAgIHZtLmNhbkNhbmNlbE1CTCA9IGNhbkNhbmNlbE1CTDsKICAgIHZtLmNhbkNhbmNlbEhCTCA9IGNhbkNhbmNlbEhCTDsKICAgIHZtLmdldENhbmNlbE1CTFRvb2x0aXAgPSBnZXRDYW5jZWxNQkxUb29sdGlwOwogICAgdm0uZ2V0Q2FuY2VsSEJMVG9vbHRpcCA9IGdldENhbmNlbEhCTFRvb2x0aXA7CiAgICB2bS5lbmFibGVBdXRvR2VuSEJMID0gZW5hYmxlQXV0b0dlbkhCTDsKICAgIHZtLm9uQ2xpY2tIQkxOb0F1dG9HZW4gPSBvbkNsaWNrSEJMTm9BdXRvR2VuOwoKICAgIC8vIFRydWNrIG9ubHkKICAgIHZtLm9uVHJ1Y2tEZWxpdmVyZWRDaGFuZ2UgPSBvblRydWNrRGVsaXZlcmVkQ2hhbmdlOwogICAgdm0ub25UcnVja1RyYWRlUGFydG5lckNoYW5nZSA9IG9uVHJ1Y2tUcmFkZVBhcnRuZXJDaGFuZ2U7CiAgICB2bS5vbk1pc2NUcmFkZVBhcnRuZXJDaGFuZ2UgPSBvbk1pc2NUcmFkZVBhcnRuZXJDaGFuZ2U7CgogICAgY29uc3Qgc2hpcG1lbnRBY1N2YyA9IG5ldyBTaGlwbWVudEFjY2Vzc0NvbnRyb2xTZXJ2aWNlKG1lU2VydmljZSwgcGVybWlzc2lvbnMpOwogICAgdm0uYWVzU3ZjID0gbmV3IEFlc0RpcmVjdFNlcnZpY2UoJHVpYk1vZGFsKTsKICAgIHZtLmVzaVNlcnZpY2UgPSBuZXcgRXNpU2VydmljZSgkdWliTW9kYWwpOwogICAgdm0ubWJsQ2FycmllckJvb2tpbmdOb1NlcnZpY2UgPSBuZXcgTWJsQ2FycmllckJvb2tpbmdOb1NlcnZpY2UoJGh0dHAsIHF0aXBTZXJ2aWNlKTsKCiAgICB2YXIgTVNHX1NVUkVfQ09OVElOVUVfU0FWSU5HID0gX1QuTVNHLlNVUkVfQ09OVElOVUVfU0FWSU5HOwogICAgdmFyIE1TR19EVVBMSUNBVEVfQk9PS0lOR19OTyA9IF9ULk1TRy5EVVBMSUNBVEVfQk9PS0lOR19OTzsKICAgIHZhciBNU0dfRFVQTElDQVRFX1NISVBNRU5UX05PID0gX1QuTVNHLkRVUExJQ0FURV9TSElQTUVOVF9OTzsKCiAgICB2YXIgTVNHX0NPUFlfSEJMX0ZJRUxEX1RPX09USEVSUyA9IF9ULk1TRy5DT1BZX0hCTF9GSUVMRF9UT19PVEhFUlM7CgogICAgZnVuY3Rpb24gaW5pdGlhbChvcHRpb25zKXsKCiAgICAgIHZtLnR5cGUgPSBvcHRpb25zLnR5cGU7CiAgICAgIHVybFNlcnZpY2UuY29uZmlnKHtzaGlwbWVudFR5cGU6IHZtLnR5cGV9KTsKICAgICAgdm0uZW5kcG9pbnRzID0gZGF0YVNlcnZpY2UuYnVpbGRFbmRwb2ludHMoKTsKICAgICAgVVJMID0gdXJsU2VydmljZS5VUkw7CgogICAgICB2bS5maWxpbmdObyA9IG9wdGlvbnMuZmlsaW5nTm87CiAgICAgIHZtLmNyZWF0aW5nID0gb3B0aW9ucy5jcmVhdGluZzsKICAgICAgdm0ubWJsID0gb3B0aW9ucy5kZWZhdWx0TWJsOwogICAgICB2bS5tYmwuY29weUZyb20gPSBvcHRpb25zLmNvcHlGcm9tOwogICAgICB2bS5tYmwuY29weUZyb21NYmxObyA9IG9wdGlvbnMuY29weUZyb21NYmxObzsKICAgICAgdm0ubWJsLmNvcHlJbnZUeXBlcyA9IG9wdGlvbnMuY29weUludlR5cGVzOwogICAgICB2bS5jb3B5RnJvbSA9IG9wdGlvbnMuY29weUZyb207CiAgICAgIHZtLmRlZmF1bHRIYmwgPSBvcHRpb25zLmRlZmF1bHRIYmw7CiAgICAgIHZtLmhibF9saXN0ID0gb3B0aW9ucy5kZWZhdWx0SGJsTGlzdDsKICAgICAgdm0uY2FycnlIYmxBdHRyID0gb3B0aW9ucy5jYXJyeUhibEF0dHI7CiAgICAgIHZtLnRhcmdldEhibElkID0gb3B0aW9ucy50YXJnZXRIYmxJZDsKICAgICAgdm0ub3B0aW9ucyA9IG9wdGlvbnMub3B0aW9uczsKICAgICAgdm0udXNlcmlkID0gb3B0aW9ucy51c2VyaWQ7CiAgICAgIHZtLnVzZXIgPSBvcHRpb25zLnVzZXI7CiAgICAgIHZtLnJlcXVlc3RQYXRoID0gb3B0aW9ucy5yZXF1ZXN0UGF0aDsKICAgICAgdm0uYWN0aW9uID0gb3B0aW9ucy5hY3Rpb247CiAgICAgIHZtLmxhc3RCbG9ja0RhdGUgPSBvcHRpb25zLmxhc3RCbG9ja0RhdGU7CgogICAgICB2bS5oaWRlTWJsID0gJGxvY2F0aW9uLnNlYXJjaCgpLmhpZGVfbWJsID09PSAndHJ1ZSc7CgogICAgICB2bS5vZmZpY2VzID0gbnVsbDsKICAgICAgdm0uc2hpcG1lbnRCYXNpY0luZm8gPSBudWxsOwogICAgICB2bS5hdXRvR2VuSEJMTk8gPSB0cnVlOwogICAgICB2bS50cmFja2luZyA9IG51bGw7CiAgICAgIHZtLmNhblNob3dFZGlFcnJvciA9IGZhbHNlOwoKICAgICAgaWYgKCR3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcikgewogICAgICAgICR3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignZW1haWxTZW50JywgKCkgPT4gewogICAgICAgICAgJHNjb3BlLiRhcHBseSgoKSA9PiB7CiAgICAgICAgICAgIGlmICghaXNGb3JtTmVlZFNhdmUoKSkgewogICAgICAgICAgICAgIGxvYWREYXRhKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0sIGZhbHNlKTsKCiAgICAgICAgLy8gcmVmcmVzaCBhZnRlciB1cGRhdGVkIG9uIElTRiBlbnRyeQogICAgICAgICR3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignaXNmVXBkYXRlZCcsICgpID0+IHsKICAgICAgICAgICRzY29wZS4kYXBwbHkoKCkgPT4gewogICAgICAgICAgICBpZiAoIWlzRm9ybU5lZWRTYXZlKCkpIHsKICAgICAgICAgICAgICBsb2FkRGF0YSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9LCBmYWxzZSk7CiAgICAgIH0KCiAgICAgIHNoaXBtZW50VG9vbFNlcnZpY2UuY29uZmlnKHsKICAgICAgICBjaGVja0Zvcm1GdW5jOiB3YXJuRm9ybU5lZWRTYXZlLAogICAgICAgIGdldENvbnRhaW5lckNvdW50RnVuYzogZnVuY3Rpb24oKSB7IHJldHVybiB2bS5tYmwgPyAodm0ubWJsLmNvbnRhaW5lcl9jb3VudCB8fCAwKSA6IDA7IH0sCiAgICAgICAgZ2V0U2hpcG1lbnRCYXNpY0luZm9GdW5jOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiB2bS5zaGlwbWVudEJhc2ljSW5mbzsKICAgICAgICB9LAogICAgICAgIGdldElzRGlyZWN0TWFzdGVyRnVuYzogKCkgPT4gaXNEaXJlY3RNYXN0ZXIoKSwKICAgICAgICBnZXRBRUFnZW50U2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAoIWlzQUUoKSkgewogICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIF8odm0uaGJsX2xpc3QpCiAgICAgICAgICAgIC5yZWplY3QoaXRlbSA9PiBpdGVtLmFlX2luZm8uaXNfY2FuY2VsZWQpCiAgICAgICAgICAgIC5tYXAoaXRlbSA9PiBpdGVtLmFlX2luZm8ub3ZlcnNlYV9hZ2VudCkKICAgICAgICAgICAgLmNvbXBhY3QoKQogICAgICAgICAgICAudW5pcUJ5KHRwID0+IHRwLmNvZGUpCiAgICAgICAgICAgIC52YWx1ZSgpOwogICAgICAgIH0sCiAgICAgICAgZ2V0TWJsQU5Db25zaWduZWVTZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIC8vIEZpbmQgY29uc2lnbmVlIHdobyBleGlzdHMgaW4gdHdvIG1vcmUgSEJMcwogICAgICAgICAgdmFyIGNvbnNpZ25lZXMgPSBbXTsKCiAgICAgICAgICBpZiAoaXNPSSgpIHx8IGlzQUkoKSkgewogICAgICAgICAgICB2YXIgY291bnRNYXAgPSB7fTsKICAgICAgICAgICAgdm0uaGJsX2xpc3QuZm9yRWFjaChmdW5jdGlvbiAoaGJsKSB7CiAgICAgICAgICAgICAgaWYgKGhibC5jb25zaWduZWUpIHsKICAgICAgICAgICAgICAgIHZhciBjb2RlID0gaGJsLmNvbnNpZ25lZS5jb2RlOwogICAgICAgICAgICAgICAgY291bnRNYXBbY29kZV0gPSBfLmRlZmF1bHRUbyhjb3VudE1hcFtjb2RlXSwgMCkgKyAxOwoKICAgICAgICAgICAgICAgIC8vIHB1c2ggY29uc2lnbmVlIHdoZW4gY291bnRlciBpcyAyIHRvIGVuc3VyZSBjb25zaWduZWUgdW5pcXVlCiAgICAgICAgICAgICAgICBpZiAoY291bnRNYXBbY29kZV0gPT09IDIpIHsKICAgICAgICAgICAgICAgICAgY29uc2lnbmVlcy5wdXNoKGhibC5jb25zaWduZWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIGNvbnNpZ25lZXM7CiAgICAgICAgfSwKICAgICAgICBvcGVuVHJhY2tpbmdNYmxMaW5rOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgdXJsID0gZnRzU2VydmljZS5nZXRNYmxVcmwodm0ubWJsLk1CTF9OTyk7CiAgICAgICAgICBpZiAodXJsKSB7CiAgICAgICAgICAgIHdpbmRvdy5vcGVuKHVybCwgJ19ibGFuaycpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgb3BlblRyYWNraW5nSGJsTGluazogZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKHZtLmN1ckhibElkeCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgdXJsID0gZ2V0VHJhY2tpbmdIYmxMaW5rKHZtLmhibF9saXN0W3ZtLmN1ckhibElkeF0pOwogICAgICAgICAgICBpZiAodXJsKSB7CiAgICAgICAgICAgICAgd2luZG93Lm9wZW4odXJsLCAnX2JsYW5rJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGlzVHJhY2tpbmdNYmxMaW5rRGlzYWJsZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuICF2bS5tYmwgfHwgIWZ0c1NlcnZpY2UuZ2V0TWJsVXJsKHZtLm1ibC5NQkxfTk8pOwogICAgICAgIH0sCiAgICAgICAgaXNUcmFja2luZ0hibExpbmtEaXNhYmxlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gdm0uY3VySGJsSWR4PT09bnVsbCB8fCAhZ2V0VHJhY2tpbmdIYmxMaW5rKHZtLmhibF9saXN0W3ZtLmN1ckhibElkeF0pOwogICAgICAgIH0sCiAgICAgICAgaXNEaXNhYmxlUHJpbnRPQkw6IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKGlzT0UoKSkgewogICAgICAgICAgICByZXR1cm4gIXZtLmhibF9saXN0W3ZtLmN1ckhibElkeF0gfHwgdm0uaGJsX2xpc3Rbdm0uY3VySGJsSWR4XS5pc19leHByZXNzOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwKICAgICAgICBpc1N1YkhibDogZnVuY3Rpb24oKSB7CiAgICAgICAgICBsZXQgaGJsID0gdm0uaGJsX2xpc3Rbdm0uY3VySGJsSWR4XTsKICAgICAgICAgIHJldHVybiBoYmwgJiYgKF8uZ2V0KGhibCwgJ29lX2luZm8uaXNfc3ViX2FnZW50X2JsJywgZmFsc2UpIHx8IF8uZ2V0KGhibCwgJ2FlX2luZm8uaXNfc3ViX2FnZW50X2JsJywgZmFsc2UpKTsKICAgICAgICB9LAogICAgICAgIGdldE9FSW5mb0NoZWNrTGlzdFNhdmVkKCkgewogICAgICAgICAgY29uc3QgaGJsID0gdm0uaGJsX2xpc3Rbdm0uY3VySGJsSWR4XTsKICAgICAgICAgIHJldHVybiAkaHR0cC5nZXQoZ2VuVXJsKFVSTC5TSElQTUVOVF9IQkwsIHsgaGJsX2lkOiBoYmwuaWQgfSkpCiAgICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgICAgIGNvbnN0IG5ld0hibCA9IHJlc3BvbnNlLmRhdGE7CiAgICAgICAgICAgICAgcmV0dXJuIG5ld0hibC5vZV9pbmZvLmlzX2NoZWNrX2xpc3Rfc2F2ZWQ7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgaXNOT0MoKSB7CiAgICAgICAgICBjb25zdCBjb250YWluZXJPd25lclR5cGUgPSBfLmdldCgKICAgICAgICAgICAgdm0uaGJsX2xpc3QsCiAgICAgICAgICAgIGBbJHt2bS5jdXJIYmxJZHh9XS5vaV9pbmZvLmNvbnRhaW5lcl9vd25lcl90eXBlYCwKICAgICAgICAgICk7CiAgICAgICAgICByZXR1cm4gY29udGFpbmVyT3duZXJUeXBlID09PSAnTk9DJzsKICAgICAgICB9LAogICAgICAgIGdldEhibENvbnRhaW5lckNvdW50KCkgewogICAgICAgICAgY29uc3QgaGJsID0gdm0uaGJsX2xpc3Rbdm0uY3VySGJsSWR4XTsKICAgICAgICAgIHJldHVybiBoYmwgPyBoYmwuY29udGFpbmVyX2NvdW50IDogMDsKICAgICAgICB9LAogICAgICB9KTsKCiAgICAgIHZtLm1ibEhpc3RvcnlFeGlzdFF1ZXJpZXIgPSBhY3Rpb25Gb3JDdXN0b21lckhpc3RvcnlTZXJ2aWNlLmJ1aWxkRXhpc3RRdWVyaWVyKCdtYmwnKTsKICAgICAgdm0uaGJsSGlzdG9yeUV4aXN0UXVlcmllciA9IGFjdGlvbkZvckN1c3RvbWVySGlzdG9yeVNlcnZpY2UuYnVpbGRFeGlzdFF1ZXJpZXIoJ2hibCcpOwoKICAgICAgdm0ubWJsVG9vbHMgPSBwcmVwYXJlTWJsVG9vbHMob3B0aW9ucyk7CiAgICAgIHZtLmhibFRvb2xzID0gcHJlcGFyZUhibFRvb2xzKG9wdGlvbnMpOwoKICAgICAgaWYgKGlzQUkoKSB8fCBpc0FFKCkpIHsKICAgICAgICB2bS5kZWZhdWx0SXRlbSA9IHsKICAgICAgICAgIG1ibDogb3B0aW9ucy5kZWZhdWx0TWJsSXRlbSwKICAgICAgICAgIGhibDogb3B0aW9ucy5kZWZhdWx0SGJsSXRlbSwKICAgICAgICB9OwoKICAgICAgICB2bS5jb21tb2RpdHlGb2N1c1RpZCA9IHsKICAgICAgICAgIG1ibDogbnVsbCwKICAgICAgICAgIGhibDogbnVsbCwKICAgICAgICB9OwoKICAgICAgICB2bS5zdWJIYXdiRm9jdXNUaWQgPSBudWxsOwoKICAgICAgICBpZiAoaXNBSSgpKSB7CiAgICAgICAgICB2bS5kZWZhdWx0U3ViSGF3YiA9IG9wdGlvbnMuZGVmYXVsdFN1Ykhhd2I7CiAgICAgICAgICB2bS5kZWZhdWx0SGJsLl9fc3ViaGF3YiA9IFtdOwoKICAgICAgICAgIHZtLmhibF9saXN0LmZvckVhY2goZnVuY3Rpb24oaGJsKSB7CiAgICAgICAgICAgIGlmKGhibC5fX3N1Ymhhd2IgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgIGhibC5fX3N1Ymhhd2IgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNBRSgpKSB7CiAgICAgICAgICB2bS5kZWZhdWx0SXRlbS5tYmwuX19wb19udW1fbGlzdCA9IFtdOwogICAgICAgICAgaWYgKHZtLm1ibC5hZV9pbmZvLl9faXRzID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdm0ubWJsLmFlX2luZm8uX19pdHMgPSBbXTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2bS5tYmwuYWVfaW5mby5fX3BvX251bV9saXN0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdm0ubWJsLmFlX2luZm8uX19wb19udW1fbGlzdCA9IFtdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2bS5kZWZhdWx0SGJsLl9faXRzID0gW107ICAvLyBpbml0IGhibF9pdGVtIGxpc3QKICAgICAgICB2bS5kZWZhdWx0SGJsLl9fcG9fbnVtX2xpc3QgPSBbXTsKICAgICAgICB2bS5kZWZhdWx0SXRlbS5oYmwuX19wb19udW1fbGlzdCA9IFtdOwoKICAgICAgICBmb3IodmFyIGk9MDsgaTx2bS5oYmxfbGlzdC5sZW5ndGg7ICsraSkgewogICAgICAgICAgaWYgKHZtLmhibF9saXN0W2ldLl9faXRzID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdm0uaGJsX2xpc3RbaV0uX19pdHMgPSBbXTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2bS5oYmxfbGlzdFtpXS5fX3BvX251bV9saXN0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdm0uaGJsX2xpc3RbaV0uX19wb19udW1fbGlzdCA9IFtdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2bS52b2x1bWVDb252ZXJ0ID0gdm9sdW1lQ29udmVydDsKICAgICAgfQoKICAgICAgaWYgKGlzVEsoKSB8fCBpc01pc2MoKSkgewogICAgICAgIHZtLm1ibF93ZWlnaHRfbGIgPSBudWxsOwogICAgICAgIHZtLm1ibF9tZWFzdXJlX2NmdCA9IG51bGw7CgogICAgICAgIHZtLndlaWdodENvbnZlcnQgPSAodiwgc3JjLCBkZXN0KSA9PiB0b1dlaWdodCh3ZWlnaHRDb252ZXJ0KHYsIHNyYywgZGVzdCkpOwogICAgICAgIHZtLm1lYXN1cmVDb252ZXJ0ID0gKHYsIHNyYywgZGVzdCkgPT4gdG9NZWFzdXJlKG1lYXN1cmVDb252ZXJ0KHYsIHNyYywgZGVzdCkpOwogICAgICB9CgogICAgICB2bS5jdXJIYmxJZHggPSBudWxsOwogICAgICB2bS5wcmV2aW91c0hibElkeCA9IG51bGw7CiAgICAgIHZtLmN1ckhibENhY2hlZCA9IG51bGw7CiAgICAgIHZtLmFkZGluZ0hibCA9IGZhbHNlOwogICAgICB2bS5pc1NhdmluZyA9IGZhbHNlOwoKICAgICAgdm0udHJhZGVQYXJ0bmVyUmVsYXRpb24gPSBlbnRyeUhlbHBlclNlcnZpY2UuZ2V0VHJhZGVQYXJ0bmVyUmVsYXRpb24oKTsKICAgICAgdm0udHJhZGVQYXJ0bmVyUmVsYXRpb24ub3ZlcnNlYV9hZ2VudC5iZWZvcmVWYWx1ZSA9IHZtLm1ibC5vdmVyc2VhX2FnZW50OwogICAgICB2bS50cmFkZVBhcnRuZXJSZWxhdGlvbi5zaGlwcGluZ19hZ2VudC5iZWZvcmVWYWx1ZSA9IHZtLm1ibC5zaGlwcGluZ19hZ2VudDsKICAgICAgdm0udHJhZGVQYXJ0bmVyUmVsYXRpb24uY2Fycmllci5iZWZvcmVWYWx1ZSA9IHZtLm1ibC5jYXJyaWVyOwogICAgICB2bS50cmFkZVBhcnRuZXJSZWxhdGlvbi5mb3J3YXJkaW5nX2FnZW50LmJlZm9yZVZhbHVlID0gKHZtLm1ibC5vZV9pbmZvID8gdm0ubWJsLm9lX2luZm8uZm9yd2FyZGluZ19hZ2VudCA6IG51bGwpOwoKICAgICAgZW50cnlIZWxwZXJTZXJ2aWNlLnNldFNoaXBtZW50VHlwZSh2bS50eXBlKTsKICAgICAgZW50cnlIZWxwZXJTZXJ2aWNlLnNldE1ibEdldHRlcihmdW5jdGlvbigpeyByZXR1cm4gdm0ubWJsOyB9KTsKICAgICAgZW50cnlIZWxwZXJTZXJ2aWNlLnNldEhibEdldHRlcihmdW5jdGlvbigpeyByZXR1cm4gdm0uaGJsX2xpc3Rbdm0uY3VySGJsSWR4XTsgfSk7CiAgICAgIHRwU2VydmljZS5zZXRTaGlwbWVudFR5cGUodm0udHlwZSk7CgogICAgICAvLyBEYXRhIHN5bmMgZm9yIE1CTCB0byBhbGwgSEJMcwoKICAgICAgdm0uaGJsUG9zdFNhdmluZyA9IHsKICAgICAgICAvKgogICAgICAgIEhCTCBsaXN0IHRvIHNhdmUgc3BlY2lmaWMgZmllbGRzIHdoZW4gc2F2aW5nLgogICAgICAgIGhibF9pZF8xOiBbe2ZpZWxkOiBtYmxGaWVsZE5hbWVUb1N5bmMxXzEsIGNvbmRpdGlvbkNob2ljZUluZGV4OiBjb25kSWR4MV8xfSwKICAgICAgICAgICAgICAgICAgIHtmaWVsZDogbWJsRmllbGROYW1lVG9TeW5jMV8yLCBjb25kaXRpb25DaG9pY2VJbmRleDogY29uZElkeDFfMn0sCiAgICAgICAgICAgICAgICAgICB7ZmllbGQ6IG1ibEZpZWxkTmFtZVRvU3luYzFfMywgY29uZGl0aW9uQ2hvaWNlSW5kZXg6IGNvbmRJZHgxXzN9LAogICAgICAgICAgICAgICAgICAgLi4uXSwKICAgICAgICBoYmxfaWRfMjogW3tmaWVsZDogbWJsRmllbGROYW1lVG9TeW5jMl8xLCBjb25kaXRpb25DaG9pY2VJbmRleDogY29uZElkeDJfMX0sCiAgICAgICAgICAgICAgICAgICB7ZmllbGQ6IG1ibEZpZWxkTmFtZVRvU3luYzJfMiwgY29uZGl0aW9uQ2hvaWNlSW5kZXg6IGNvbmRJZHgyXzJ9LAogICAgICAgICAgICAgICAgICAge2ZpZWxkOiBtYmxGaWVsZE5hbWVUb1N5bmMyXzMsIGNvbmRpdGlvbkNob2ljZUluZGV4OiBjb25kSWR4Ml8yfSwKICAgICAgICAgICAgICAgICAgIC4uLl0sCiAgICAgICAgaGJsX2lkXzM6IFt7ZmllbGQ6IG1ibEZpZWxkTmFtZVRvU3luYzNfMSwgY29uZGl0aW9uQ2hvaWNlSW5kZXg6IGNvbmRJZHgzXzF9LAogICAgICAgICAgICAgICAgICAge2ZpZWxkOiBtYmxGaWVsZE5hbWVUb1N5bmMzXzIsIGNvbmRpdGlvbkNob2ljZUluZGV4OiBjb25kSWR4M18yfSwKICAgICAgICAgICAgICAgICAgIHtmaWVsZDogbWJsRmllbGROYW1lVG9TeW5jM18zLCBjb25kaXRpb25DaG9pY2VJbmRleDogY29uZElkeDNfMn0sCiAgICAgICAgICAgICAgICAgICAuLi5dLAogICAgICAgIC4uLgogICAgICAgICovCiAgICAgIH07CgogICAgICB2bS5vblRyYWRlUGFydG5lckNoYW5nZWQgPSBvblRyYWRlUGFydG5lckNoYW5nZWQ7CiAgICAgIHZtLm9uTWJsQXBvbENoYW5nZWQgPSBvbk1ibEFwb2xDaGFuZ2VkOwogICAgICB2bS5vbk1ibEFwb2RDaGFuZ2VkID0gb25NYmxBcG9kQ2hhbmdlZDsKICAgICAgdm0ub25EaXNwbGF5RmllbGRDaGFuZ2VIYW5kbGVyID0gZW50cnlIZWxwZXJTZXJ2aWNlLmRpc3BsYXlGaWVsZENoYW5nZUhhbmRsZXI7CiAgICAgIHZtLmNsZWFyUXVvdGF0aW9uTm8gPSBjbGVhclF1b3RhdGlvbk5vOwoKICAgICAgdm0ubGF5b3V0ID0gcHJlcGFyZUxheW91dCgpOwoKICAgICAgY2FjaGVGb3JtRGF0YSgpOwoKICAgICAgaWYodm0uY3JlYXRpbmcpewogICAgICAgIHByZXBhcmVOb3RpZmljYXRpb25IZWxwZXIoKTsKCiAgICAgICAgbG9hZENyZWF0aW5nRGF0YSgpCiAgICAgICAgICAudGhlbigoKSA9PiB7CiAgICAgICAgICAgIHBvc3RJbml0aWFsKCk7CiAgICAgICAgfSk7CiAgICAgIH0gLy8vLyB2bS5jcmVhdGluZwogICAgICBlbHNlewogICAgICAgIGlmICh2bS5oaWRlTWJsKSB7CiAgICAgICAgICAvLyBDb2xsYXBzZSBNQkwgYXJlYSBpZiB1c2VyIGNhbWUgZnJvbSBIQkwgbGlzdAogICAgICAgICAgc2xpZGVVcE1ibFBhbmUoKTsKICAgICAgICB9CgogICAgICAgIHByZWZlcmVuY2VTZXJ2aWNlCiAgICAgICAgICAud2FpdEluaXQoKQogICAgICAgICAgLnRoZW4ocHJlcGFyZU5vdGlmaWNhdGlvbkhlbHBlcikKICAgICAgICAgIC50aGVuKGxvYWREYXRhKQogICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2bS5hY3Rpb24gPT09ICdhZGRfaGJsJyAmJiBhZGRIYmwoKTsKICAgICAgICAgICAgcG9zdEluaXRpYWwoKTsKICAgICAgICAgIH0pOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gcHJlcGFyZU5vdGlmaWNhdGlvbkhlbHBlcigpIHsKICAgICAgbGV0IG5vdGlmaWNhdGlvbkNvbmZpZzsKICAgICAgY29uc29sZS5sb2coJ2VuYWJsZSB3b3JrZmxvdyBub3RpZmljYXRpb246ICcsIHByZWZlcmVuY2VTZXJ2aWNlLmdldFdvcmtmbG93Tm90aWZpY2F0aW9uKCkpOwoKICAgICAgaWYgKHByZWZlcmVuY2VTZXJ2aWNlLmdldFdvcmtmbG93Tm90aWZpY2F0aW9uKCkpIHsKICAgICAgICBzd2l0Y2ggKHZtLnR5cGUpIHsKICAgICAgICAgIGNhc2UgJ09JJzogbm90aWZpY2F0aW9uQ29uZmlnID0gbmV3IE9pTm90aWZpY2F0aW9uQ29uZmlnKCk7IGJyZWFrOwogICAgICAgICAgY2FzZSAnQUknOiBub3RpZmljYXRpb25Db25maWcgPSBuZXcgQWlOb3RpZmljYXRpb25Db25maWcoKTsgYnJlYWs7CiAgICAgICAgICBjYXNlICdNUyc6IG5vdGlmaWNhdGlvbkNvbmZpZyA9IG5ldyBNc05vdGlmaWNhdGlvbkNvbmZpZygpOyBicmVhazsKICAgICAgICAgIGRlZmF1bHQ6IG5vdGlmaWNhdGlvbkNvbmZpZyA9IG51bGw7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIG5vdGlmaWNhdGlvbkNvbmZpZyA9IG51bGw7CiAgICAgIH0KCiAgICAgIGNvbnN0IG5vdGlmaWNhdGlvbk9wdGlvbnMgPSB7CiAgICAgICAgICAkaHR0cDogJGh0dHAsCiAgICAgICAgICAkcTogJHEsCiAgICAgICAgICBVUkw6IFVSTCwKICAgICAgICAgIGZpbGluZ05vOiB2bS5maWxpbmdObywKICAgICAgICAgIG5vdGlmaWNhdGlvbkNvbmZpZzogbm90aWZpY2F0aW9uQ29uZmlnLAogICAgICB9OwoKICAgICAgbGV0IGhlbHBlciA9IG51bGw7CiAgICAgIGlmIChub3RpZmljYXRpb25Db25maWcpIHsKICAgICAgICBoZWxwZXIgPSBuZXcgTm90aWZpY2F0aW9uSGVscGVyKG5vdGlmaWNhdGlvbk9wdGlvbnMpCiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgaGVscGVyID0gbmV3IE51bGxOb3RpZmljYXRpb25IZWxwZXIobm90aWZpY2F0aW9uT3B0aW9ucyk7CiAgICAgIH0KICAgICAgdm0ubm90aWZpY2F0aW9uSGVscGVyID0gaGVscGVyOwogICAgfQoKICAgIGZ1bmN0aW9uIHByZXBhcmVMYXlvdXQoKSB7CiAgICAgIHN3aXRjaCAodm0udHlwZSkgewogICAgICAgIGNhc2UgJ0FFJzoKICAgICAgICAgIHJldHVybiBuZXcgQWVCYXNpY0VudHJ5TGF5b3V0KCk7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gbG9hZENyZWF0aW5nRGF0YSgpIHsKICAgICAgc2hvd1NwaW4oKTsKCiAgICAgICRzY29wZS4kZXZhbEFzeW5jKCgpID0+IHsKICAgICAgICAvLyBUaGlzIHdpbGwgd2FpdCB1bnRpbCBBbmd1bGFyIGlzIGRvbmUgdXBkYXRpbmcgdGhlIHNjb3BlCiAgICAgICAgLy8gVE9ETzogaW5pdGlhbGl6ZSBuZy1mb3JtIG9uIG1ibC5fX2Zvcm0gaW5zdGVhZCBvZiAkc2NvcGUubWJsRm9ybQogICAgICAgIHZtLm1ibC5fX2Zvcm0gPSAkc2NvcGUubWJsRm9ybTsKICAgICAgICB2bS5tYmwuX19pc1JlYWR5ID0gdHJ1ZTsKICAgICAgfSk7CgogICAgICBsZXQgcV9hbGwgPSBbXTsKICAgICAgbGV0IHJlcUFsbE9mZmljZSA9IHZtLmVuZHBvaW50cy5BTExfT0ZGSUNFLmdldCgpCiAgICAgICAgLnRoZW4oKHJlcykgPT4gewogICAgICAgICAgdm0ub2ZmaWNlcyA9IHJlcy5kYXRhLm1hcHBpbmc7CiAgICAgICAgfSk7CiAgICAgIHFfYWxsLnB1c2gocmVxQWxsT2ZmaWNlKTsKCiAgICAgIHJldHVybiAkcS5hbGwocV9hbGwpCiAgICAgICAgLnRoZW4oKCkgPT4gewogICAgICAgICAgaWYgKHZtLmNvcHlGcm9tKSB7CiAgICAgICAgICAgIGluaXRSZWxhdGVkRmllbGRzKCk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gU2V0IGZvcm0gdG8gZGlydHkgYmVjYXVzZSBzb21lIGNvcGllZCBzaGlwbWVudHMgY2FuIGJlIHNhdmVkIHdpdGhvdXQgZmlsbGluZyBvdGhlciBmaWVsZHMKICAgICAgICAgIGlmICh2bS5jb3B5RnJvbSkgewogICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgdm0uZ0Zvcm0uJHNldERpcnR5KCk7CiAgICAgICAgICAgIH0sIDApOwogICAgICAgICAgfQoKICAgICAgICAgIGlmICh2bS5jb3B5RnJvbSAmJiB2bS5oYmxfbGlzdC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICR0aW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICBkb1RvZ2dsZUhibCgwLCBmYWxzZSk7CgogICAgICAgICAgICAgIHZtLmhibF9saXN0LmZvckVhY2goZnVuY3Rpb24gKGhibCkgewogICAgICAgICAgICAgICAgaGJsLl9faGJsRm9ybS4kc2V0RGlydHkoKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHZtLmNvcHlGcm9tICYmIHZtLmNyZWF0aW5nKSB7CiAgICAgICAgICAgIGlmIChpc0FFKCkpIHsKICAgICAgICAgICAgICBjb25zdCBpbml0SXRlbSA9IChpdGVtKSA9PiB7CiAgICAgICAgICAgICAgICBwb19iYWNrZW5kMnVpKGl0ZW0pOwogICAgICAgICAgICAgICAgJHRpbWVvdXQoKCkgPT4geyBpdGVtLl9fZm9ybS4kc2V0RGlydHkoKTsgfSk7CiAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgaWYgKHZtLm1ibC5pdGVtX2luZm9fc2V0KSB7CiAgICAgICAgICAgICAgICB2bS5tYmwuYWVfaW5mby5fX2l0cyA9IHZtLm1ibC5pdGVtX2luZm9fc2V0OwogICAgICAgICAgICAgICAgdm0ubWJsLmFlX2luZm8uX19pdHMuZm9yRWFjaChpbml0SXRlbSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZtLmhibF9saXN0LmZvckVhY2goKGhibCkgPT4gewogICAgICAgICAgICAgICAgaWYgKGhibC5pdGVtX2luZm9fc2V0KSB7CiAgICAgICAgICAgICAgICAgIGhibC5fX2l0cyA9IGhibC5pdGVtX2luZm9fc2V0OwogICAgICAgICAgICAgICAgICBoYmwuX19pdHMuZm9yRWFjaChpbml0SXRlbSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBoaWRlU3BpbigpOwogICAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIGxvYWREYXRhKCkgewogICAgICBzaG93U3BpbigpOwogICAgICB2YXIgcV9hbGwgPSBbXTsKCiAgICAgIHZhciByZXFfbWJsID0gJGh0dHAuZ2V0KGdlblVybChVUkwuU0hJUE1FTlQsIHtmaWxpbmdfbm86IHZtLmZpbGluZ05vfSkpICAvLyBNQkwKICAgICAgICAudGhlbigKICAgICAgICAgIGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICB2bS5tYmwgPSByZXNwb25zZS5kYXRhOwogICAgICAgICAgICAkc2NvcGUuJGV2YWxBc3luYygoKSA9PiB7CiAgICAgICAgICAgICAgLy8gVGhpcyB3aWxsIHdhaXQgdW50aWwgQW5ndWxhciBpcyBkb25lIHVwZGF0aW5nIHRoZSBzY29wZQogICAgICAgICAgICAgIC8vIFRPRE86IGluaXRpYWxpemUgbmctZm9ybSBvbiBtYmwuX19mb3JtIGluc3RlYWQgb2YgJHNjb3BlLm1ibEZvcm0KICAgICAgICAgICAgICB2bS5tYmwuX19mb3JtID0gJHNjb3BlLm1ibEZvcm07CiAgICAgICAgICAgICAgdm0ubWJsLl9faXNSZWFkeSA9IHRydWU7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpbml0UmVsYXRlZEZpZWxkcygpOwoKICAgICAgICAgIH0sIGZ1bmN0aW9uIChlcnJSZXNwb25zZSkgewogICAgICAgICAgICBjb25zb2xlLmxvZygnRXJyb3I6ICcgKyBlcnJSZXNwb25zZS5kYXRhKTsKICAgICAgICAgICAgbG9jYXRpb24uaHJlZiA9ICcvNDA0Lyc7CiAgICAgICAgICB9KTsKICAgICAgcV9hbGwucHVzaChyZXFfbWJsKTsKCiAgICAgIGxldCByZXFBbGxPZmZpY2UgPSB2bS5lbmRwb2ludHMuQUxMX09GRklDRS5nZXQoKQogICAgICAgIC50aGVuKChyZXMpID0+IHsKICAgICAgICAgIHZtLm9mZmljZXMgPSByZXMuZGF0YS5tYXBwaW5nOwogICAgICAgIH0pOwogICAgICBxX2FsbC5wdXNoKHJlcUFsbE9mZmljZSk7CgogICAgICBpZiAoaXNPSSgpIHx8IGlzT0UoKSB8fCBpc0FJKCkgfHwgaXNBRSgpKSB7CiAgICAgICAgdmFyIHJlcV9oYmwgPSAkaHR0cC5nZXQoZ2VuVXJsKFVSTC5TSElQTUVOVF9IQkxfTElTVCwge2ZpbGluZ19ubzogdm0uZmlsaW5nTm99KSkgIC8vIEhCTCBsaXN0CiAgICAgICAgICAudGhlbigKICAgICAgICAgICAgZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgdm0uaGJsX2xpc3QgPSByZXNwb25zZS5kYXRhOwogICAgICAgICAgICB9LCBmdW5jdGlvbiAoZXJyUmVzcG9uc2UpIHsKICAgICAgICAgICAgICBjb25zb2xlLmxvZygnRXJyb3I6ICcgKyBlcnJSZXNwb25zZS5kYXRhKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgcV9hbGwucHVzaChyZXFfaGJsKTsKICAgICAgfQoKICAgICAgcV9hbGwucHVzaChfdXBkYXRlTm90aWZpY2F0aW9uKCkpOwogICAgICBxX2FsbC5wdXNoKGdldFNoaXBtZW50QmFzaWNJbmZvKCkpOwoKICAgICAgcmV0dXJuICRxLmFsbChxX2FsbCkKICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgcmVxID0ge307CgogICAgICAgICAgaWYgKGlzQUkoKSkgewogICAgICAgICAgICByZXEuYWxsSGJsU3ViSGF3YiA9ICRodHRwLmdldChnZW5VcmwoVVJMLlNISVBNRU5UX0FMTF9IQkxfU1VCX0hBV0JfTElTVCwge2ZpbGluZ19ubzogdm0ubWJsLmZpbGluZ19ub30pKTsKICAgICAgICAgICAgdm0uaGJsX2xpc3QuZm9yRWFjaChmdW5jdGlvbiAoaGJsKSB7CiAgICAgICAgICAgICAgaGJsLl9fc3ViaGF3YiA9IFtdOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoaXNBRSgpKSB7CiAgICAgICAgICAgIHBvX2JhY2tlbmQydWkodm0ubWJsLmFlX2luZm8pOwogICAgICAgICAgICByZXEubWJsSXRlbSA9ICRodHRwLmdldChnZW5VcmwoVVJMLlNISVBNRU5UX01CTF9JVF9MSVNULCB7ZmlsaW5nX25vOiB2bS5tYmwuZmlsaW5nX25vfSkpOwogICAgICAgICAgICByZXEubWJsT3RoZXJDaGFyZ2UgPSAkaHR0cC5nZXQoZ2VuVXJsKFVSTC5TSElQTUVOVF9NQkxfT1RIRVJfQ0hBUkdFX0xJU1QsIHtmaWxpbmdfbm86IHZtLm1ibC5maWxpbmdfbm99KSk7CiAgICAgICAgICAgIHJlcS5hbGxIYmxPdGhlckNoYXJnZSA9ICRodHRwLmdldChnZW5VcmwoVVJMLlNISVBNRU5UX0FMTF9IQkxfT1RIRVJfQ0hBUkdFX0xJU1QsIHtmaWxpbmdfbm86IHZtLm1ibC5maWxpbmdfbm99KSk7CgogICAgICAgICAgICB2bS5oYmxfbGlzdC5mb3JFYWNoKGZ1bmN0aW9uIChoYmwpIHsKICAgICAgICAgICAgICBoYmwub3RoZXJfY2hhcmdlX2xpc3QgPSBbXTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGlzQUkoKSB8fCBpc0FFKCkpIHsKICAgICAgICAgICAgcmVxLmFsbEhibEl0ZW0gPSAkaHR0cC5nZXQoZ2VuVXJsKFVSTC5TSElQTUVOVF9BTExfSEJMX0lUX0xJU1QsIHtmaWxpbmdfbm86IHZtLm1ibC5maWxpbmdfbm99KSk7CgogICAgICAgICAgICB2bS5oYmxfbGlzdC5mb3JFYWNoKGZ1bmN0aW9uIChoYmwpIHsKICAgICAgICAgICAgICBwb19iYWNrZW5kMnVpKGhibCk7CiAgICAgICAgICAgICAgaGJsLl9faXRzID0gW107CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiAkcS5hbGwocmVxKTsKICAgICAgICB9KQogICAgICAgIC5jYXRjaChmdW5jdGlvbiAoZSkgewogICAgICAgICAgaWYgKGUuc3RhdHVzID09PSA0MDMpCiAgICAgICAgICAgIGxvY2F0aW9uLmhyZWYgPSAnLzQwMy8nOwogICAgICAgICAgcmV0dXJuICRxLnJlamVjdChlKTsKICAgICAgICB9KQogICAgICAgIC50aGVuKGZ1bmN0aW9uIChyZXN1bHQpIHsKCiAgICAgICAgICBpZiAoaXNBSSgpKSB7CiAgICAgICAgICAgIC8vIGFsbCBIQkwKICAgICAgICAgICAgdmFyIHN1Ykhhd2JEYXRhID0gcmVzdWx0LmFsbEhibFN1Ykhhd2IuZGF0YTsKICAgICAgICAgICAgdm0uaGJsX2xpc3QuZm9yRWFjaChmdW5jdGlvbiAoaGJsKSB7CiAgICAgICAgICAgICAgaWYgKGhibC5pZCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBoYmwuX19zdWJoYXdiID0gc3ViSGF3YkRhdGFbaGJsLmlkXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChpc0FFKCkpIHsKICAgICAgICAgICAgLy8gTUJMCiAgICAgICAgICAgIGlmIChyZXN1bHQubWJsSXRlbSkgewogICAgICAgICAgICAgIHZtLm1ibC5hZV9pbmZvLl9faXRzID0gcmVzdWx0Lm1ibEl0ZW0uZGF0YTsKICAgICAgICAgICAgICB2bS5tYmwuYWVfaW5mby5fX2l0cy5mb3JFYWNoKGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgICAgICAgICAgICBwb19iYWNrZW5kMnVpKGl0ZW0pOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZXN1bHQubWJsT3RoZXJDaGFyZ2UpIHsKICAgICAgICAgICAgICB2bS5tYmwuYWVfaW5mby5vdGhlcl9jaGFyZ2VfbGlzdCA9IHJlc3VsdC5tYmxPdGhlckNoYXJnZS5kYXRhOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBhbGwgSEJMCiAgICAgICAgICAgIHZhciBjaGFyZ2VEYXRhID0gcmVzdWx0LmFsbEhibE90aGVyQ2hhcmdlLmRhdGE7CiAgICAgICAgICAgIHZtLmhibF9saXN0LmZvckVhY2goZnVuY3Rpb24gKGhibCkgewogICAgICAgICAgICAgIGlmIChoYmwuaWQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgaGJsLm90aGVyX2NoYXJnZV9saXN0ID0gY2hhcmdlRGF0YVtoYmwuaWRdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGlzQUkoKSB8fCBpc0FFKCkpIHsKICAgICAgICAgICAgdmFyIGl0ZW1EYXRhID0gcmVzdWx0LmFsbEhibEl0ZW0uZGF0YTsKICAgICAgICAgICAgdm0uaGJsX2xpc3QuZm9yRWFjaChmdW5jdGlvbiAoaGJsKSB7CiAgICAgICAgICAgICAgaWYgKGhibC5pZCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBoYmwuX19pdHMgPSBpdGVtRGF0YVtoYmwuaWRdOwogICAgICAgICAgICAgICAgaGJsLl9faXRzLmZvckVhY2gocG9fYmFja2VuZDJ1aSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICB2bS5nRm9ybS4kc2V0UHJpc3RpbmUoKTsKCiAgICAgICAgICBjYWNoZUZvcm1EYXRhKCk7CgogICAgICAgICAgdmFyIHRvX29wZW5faGJsX2lkeCA9IC0xOwoKICAgICAgICAgIGlmICh2bS5hZGRpbmdIYmwgfHwgdm0uY2FycnlIYmxBdHRyKSB7CiAgICAgICAgICAgIC8vIG5ldyBIQi9MIHBhZ2Ugc2hvdWxkIGJlIGFscmVhZHkgb3BlbmVkCiAgICAgICAgICAgIC8vIGJ5cGFzcyBvcGVuIHBhZ2UgYWN0aW9uCiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmICh2bS50YXJnZXRIYmxJZCkgewogICAgICAgICAgICB0b19vcGVuX2hibF9pZHggPSBtYXBIYmxJZFRvSW5kZXgodm0udGFyZ2V0SGJsSWQpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiAodm0uaGJsX2xpc3QubGVuZ3RoID4gMCkgewogICAgICAgICAgICB0b19vcGVuX2hibF9pZHggPSAwOwogICAgICAgICAgfQoKICAgICAgICAgIGlmICh0b19vcGVuX2hibF9pZHggPj0gMCkgewogICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgZG9Ub2dnbGVIYmwodG9fb3Blbl9oYmxfaWR4LCBmYWxzZSk7CiAgICAgICAgICAgIH0pLmZpbmFsbHkoaGlkZVNwaW4pOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGlmIChpc01pc2MoKSkgewogICAgICAgICAgICAgIHZtLm5vdGlmaWNhdGlvbkhlbHBlci5zaG93TWlzY05vdGlmaWNhdGlvbigpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZtLm5vdGlmaWNhdGlvbkhlbHBlci5zaG93TUJMTm90aWZpY2F0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaGlkZVNwaW4oKTsKICAgICAgICAgIH0KCiAgICAgICAgICBjb25maWdJbnZvaWNlVHBVcGRhdGVTZXJ2aWNlKCk7CiAgICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gcG9zdEluaXRpYWwoKSB7CiAgICAgIGlmICh2bS5jcmVhdGluZykgewogICAgICAgIC8vIGZvY3VzIG9uIG5ldyBNQkxfTk8KICAgICAgICAkKCdpbnB1dFtuYW1lPSJNQkxfTk8iXScpLmZvY3VzKCk7CiAgICAgICAgaWYgKCF2bS5jb3B5RnJvbSkgewogICAgICAgICAgb25PZmZpY2VDaGFuZ2VkKCk7ICAvLyBhcHBseSBkZWZhdWx0IG9mZmljZSByZWxhdGVkIHNldHRpbmcKICAgICAgICAgICR0aW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgdm0uZ0Zvcm0uJHNldFByaXN0aW5lKCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgJHRpbWVvdXQoKCkgPT4gewogICAgICAgICAgdm0uZ0Zvcm0uJHNldFByaXN0aW5lKCk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGlmICghdm0uY3JlYXRpbmcgJiYgaXNPSSgpIHx8IGlzT0UoKSkgewogICAgICAgIGZ0c1NlcnZpY2UucXVlcnlTaGlwbWVudEVkaUluZm8odm0ubWJsLk1CTF9OTyk7CiAgICAgICAgZnRzU2VydmljZS5xdWVyeVNoaXBtZW50cyh7CiAgICAgICAgICBtYmxfbm86IFt2bS5tYmwuTUJMX05PXSwKICAgICAgICAgIGhibF9pZDogdm0uaGJsX2xpc3QubWFwKGZ1bmN0aW9uIChoYmwpIHsKICAgICAgICAgICAgcmV0dXJuIGhibC5pZDsKICAgICAgICAgIH0pLAogICAgICAgIH0pOwogICAgICAgIHZtLnRyYWNraW5nID0gbmV3IFRyYWNraW5nVmlld01vZGVsKCRmaWx0ZXIsIGZ0c1NlcnZpY2UsIHZtLm1ibC5NQkxfTk8pOwogICAgICB9CgogICAgICBpbml0TUJMQWR2YW5jZWRUb2dnbGUoKTsKCiAgICAgIGlmKCF3YXJuU2hpcG1lbnRCbG9jayh2bS5tYmwpKSB7CgogICAgICAgIC8vIFRvIGVuc3VyZSBkb1RvZ2dsZUhibCAoY2FsbGVkIGluIGxvYWREYXRhKCkpIGlzIGRvbmUKICAgICAgICAkdGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICB3YXJuU2hpcG1lbnRCbG9jayh2bS5oYmxfbGlzdFt2bS5jdXJIYmxJZHhdKTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgaWYgKCF2bS5jcmVhdGluZykgewogICAgICAgIHZtLm1ibEhpc3RvcnlFeGlzdFF1ZXJpZXIuY2hlY2tFeGlzdCh2bS5tYmwuZmlsaW5nX25vKTsKICAgICAgfQoKICAgICAgaWYgKHZtLmNhcnJ5SGJsQXR0cikgewogICAgICAgIGRvQWRkSGJsQnlDYXJyeUF0dHIodm0uY2FycnlIYmxBdHRyKTsKICAgICAgfQoKICAgICAgaWYgKCF2bS5jcmVhdGluZyAmJiBpc0RpcmVjdE1hc3RlcigpKSB7CiAgICAgICAgZXhwYW5kTWJsTW9yZUluZm9BcmVhKCk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBpc0RpcmVjdE1hc3RlcigpIHsKICAgICAgaWYgKGlzT0UoKSkgewogICAgICAgIHJldHVybiB2bS5tYmwub2VfaW5mby5pc19kaXJlY3Q7CiAgICAgIH0KICAgICAgaWYgKGlzQUUoKSkgewogICAgICAgIHJldHVybiB2bS5tYmwuYWVfaW5mby5pc19kaXJlY3Q7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldERpcmVjdE1hc3RlckJpbGxUbygpIHsKICAgICAgaWYgKGlzT0UoKSkgewogICAgICAgIHJldHVybiB2bS5tYmwub2VfaW5mby5iaWxsX3RvOwogICAgICB9CiAgICAgIGlmIChpc0FFKCkpIHsKICAgICAgICByZXR1cm4gdm0ubWJsLmFlX2luZm8uYmlsbF90bzsKICAgICAgfQogICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICBmdW5jdGlvbiBpc09JKCkgewogICAgICByZXR1cm4gdm0udHlwZSA9PT0gJ09JJzsKICAgIH0KCiAgICBmdW5jdGlvbiBpc09FKCkgewogICAgICByZXR1cm4gdm0udHlwZSA9PT0gJ09FJzsKICAgIH0KCiAgICBmdW5jdGlvbiBpc0FJKCkgewogICAgICByZXR1cm4gdm0udHlwZSA9PT0gJ0FJJzsKICAgIH0KCiAgICBmdW5jdGlvbiBpc0FFKCkgewogICAgICByZXR1cm4gdm0udHlwZSA9PT0gJ0FFJzsKICAgIH0KCiAgICBmdW5jdGlvbiBpc1RLKCkgewogICAgICByZXR1cm4gdm0udHlwZSA9PT0gJ1RLJzsKICAgIH0KCiAgICBmdW5jdGlvbiBpc01pc2MoKSB7CiAgICAgIHJldHVybiB2bS50eXBlID09PSAnTVMnOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzU2hpcHBlclVJTW9kZSgpIHsKICAgICAgcmV0dXJuIENPTVBBTllfSU5GTy51aV9tb2RlID09PSAnc2hpcHBlcic7CiAgICB9CgogICAgZnVuY3Rpb24gaW5pdFJlbGF0ZWRGaWVsZHMoKSB7CiAgICAgIGlmIChpc09JKCkgfHwgaXNPRSgpKSB7CiAgICAgICAgdm0udHJhZGVQYXJ0bmVyUmVsYXRpb24uc2hpcHBpbmdfYWdlbnQuYmVmb3JlVmFsdWUgPSB2bS5tYmwuc2hpcHBpbmdfYWdlbnQ7CiAgICAgICAgdm0udHJhZGVQYXJ0bmVyUmVsYXRpb24ub3ZlcnNlYV9hZ2VudC5iZWZvcmVWYWx1ZSA9IHZtLm1ibC5vdmVyc2VhX2FnZW50OwogICAgICAgIHZtLnRyYWRlUGFydG5lclJlbGF0aW9uLmNhcnJpZXIuYmVmb3JlVmFsdWUgPSB2bS5tYmwuY2FycmllcjsKICAgICAgfQoKICAgICAgaWYgKGlzT0UoKSkgewogICAgICAgIHZtLnRyYWRlUGFydG5lclJlbGF0aW9uLmZvcndhcmRpbmdfYWdlbnQuYmVmb3JlVmFsdWUgPSB2bS5tYmwub2VfaW5mby5mb3J3YXJkaW5nX2FnZW50OwogICAgICB9CgogICAgICBpZiAoaXNBRSgpKSB7CiAgICAgICAgcG9fYmFja2VuZDJ1aSh2bS5tYmwuYWVfaW5mbyk7CiAgICAgIH0KICAgICAgZWxzZSBpZiAoaXNUSygpKSB7CiAgICAgICAgdm0ubWJsX3dlaWdodF9sYiA9IHZtLndlaWdodENvbnZlcnQodm0ubWJsLnRrX2luZm8ud2VpZ2h0LCAnS0cnLCAnTEInKTsKICAgICAgICB2bS5tYmxfbWVhc3VyZV9jZnQgPSB2bS5tZWFzdXJlQ29udmVydCh2bS5tYmwudGtfaW5mby5tZWFzdXJlLCAnQ0JNJywgJ0NGVCcpOwogICAgICB9CiAgICAgIGVsc2UgaWYgKGlzTWlzYygpKSB7CiAgICAgICAgdm0ubWJsX3dlaWdodF9sYiA9IHZtLndlaWdodENvbnZlcnQodm0ubWJsLm1zX2luZm8ud2VpZ2h0LCAnS0cnLCAnTEInKTsKICAgICAgICB2bS5tYmxfbWVhc3VyZV9jZnQgPSB2bS5tZWFzdXJlQ29udmVydCh2bS5tYmwubXNfaW5mby5tZWFzdXJlLCAnQ0JNJywgJ0NGVCcpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gb25NYmxBcG9sQ2hhbmdlZCgpIHsKICAgICAgZW50cnlIZWxwZXJTZXJ2aWNlLmRpc3BsYXlGaWVsZENoYW5nZUhhbmRsZXIoJ2Rpc3BsYXlfQVBPTCcpOwogICAgICBzeW5jTUJMRmllbGRUb0FsbEhCTCgncmVzZXRfZGlzcGxheV9BUE9MJyk7CiAgICB9CgogICAgZnVuY3Rpb24gb25NYmxBcG9kQ2hhbmdlZCgpIHsKICAgICAgZW50cnlIZWxwZXJTZXJ2aWNlLmRpc3BsYXlGaWVsZENoYW5nZUhhbmRsZXIoJ2Rpc3BsYXlfQVBPRCcpOwogICAgICBzeW5jTUJMRmllbGRUb0FsbEhCTCgncmVzZXRfZGlzcGxheV9BUE9EJyk7CiAgICB9CgogICAgZnVuY3Rpb24gaXNTaGlwcGluZ0lQSShtYmwsIGhibCkgewogICAgICBjb25zdCBtYmxQb2QgPSBfLmdldChtYmwsICdQT0QuY29kZScpOwogICAgICBjb25zdCBtYmxQb2RTdWJkaXYgPSBfLmdldChtYmwsICdQT0Quc3ViZGl2X2lkJyk7CiAgICAgIGNvbnN0IG1ibERlbCA9IF8uZ2V0KG1ibCwgJ0RFTC5jb2RlJyk7CiAgICAgIGNvbnN0IG1ibERlbFN1YmRpdiA9IF8uZ2V0KG1ibCwgJ0RFTC5zdWJkaXZfaWQnKTsKICAgICAgY29uc3QgaGJsRGVsID0gXy5nZXQoaGJsLCAnREVMLmNvZGUnKTsKICAgICAgY29uc3QgaGJsRGVsU3ViZGl2ID0gXy5nZXQoaGJsLCAnREVMLnN1YmRpdl9pZCcpOwoKICAgICAgaWYgKG1ibFBvZCAmJiBtYmxQb2RTdWJkaXYpIHsKICAgICAgICBpZiAoCiAgICAgICAgICAobWJsRGVsICYmIG1ibERlbFN1YmRpdiAhPT0gbWJsUG9kU3ViZGl2KSB8fAogICAgICAgICAgKGhibERlbCAmJiBoYmxEZWxTdWJkaXYgIT09IG1ibFBvZFN1YmRpdikKICAgICAgICApIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChtYmxQb2QgJiYgIW1ibFBvZFN1YmRpdikgewogICAgICAgIGlmICgKICAgICAgICAgIChtYmxEZWwgJiYgbWJsRGVsICE9PSBtYmxQb2QpIHx8CiAgICAgICAgICAoaGJsRGVsICYmIGhibERlbCAhPT0gbWJsUG9kKQogICAgICAgICkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgZnVuY3Rpb24gb25NYmxEZWxDaGFuZ2VkKCkgewogICAgICBpZiAoaXNPSSgpKSB7CiAgICAgICAgLy8gYXV0byBjaGVjayBIQi9MIFJhaWwgY2hlY2tib3ggZm9yIElQSSBzaGlwbWVudAogICAgICAgIGZvciAobGV0IGhibCBvZiB2bS5oYmxfbGlzdCkgewogICAgICAgICAgaGJsLm9pX2luZm8uaXNfcmFpbCA9IGlzU2hpcHBpbmdJUEkodm0ubWJsLCBoYmwpOwogICAgICAgICAgaGJsLl9faGJsRm9ybS4kc2V0RGlydHkoKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGlzT0koKSB8fCBpc09FKCkpIHsKICAgICAgICBlbnRyeUhlbHBlclNlcnZpY2UuZGlzcGxheUZpZWxkQ2hhbmdlSGFuZGxlcignZGlzcGxheV9ERUwnKTsKICAgICAgfQogICAgICBzeW5jTUJMRmllbGRUb0FsbEhCTCgnREVMJyk7CiAgICB9CgogICAgZnVuY3Rpb24gb25NYmxEZXRhQ2hhbmdlZCgpIHsKICAgICAgaWYgKCF2bS5tYmwuREVUQSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBzeW5jTUJMRmllbGRUb0FsbEhCTCgnREVUQScpOwogICAgfQoKICAgIGZ1bmN0aW9uIG9uTWJsUG9kQ2hhbmdlZCgpIHsKICAgICAgaWYgKGlzT0koKSkgewogICAgICAgIC8vIGF1dG8gY2hlY2sgSEIvTCBSYWlsIGNoZWNrYm94IGZvciBJUEkgc2hpcG1lbnQKICAgICAgICBmb3IgKGxldCBoYmwgb2Ygdm0uaGJsX2xpc3QpIHsKICAgICAgICAgIGhibC5vaV9pbmZvLmlzX3JhaWwgPSBpc1NoaXBwaW5nSVBJKHZtLm1ibCwgaGJsKTsKICAgICAgICAgIGhibC5fX2hibEZvcm0uJHNldERpcnR5KCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChpc09FKCkpIHsKICAgICAgICBlbnRyeUhlbHBlclNlcnZpY2UuZGlzcGxheUZpZWxkQ2hhbmdlSGFuZGxlcignZGlzcGxheV9QT0QnKTsKICAgICAgICBzeW5jTUJMRmllbGRUb0FsbEhCTCgnUE9EJyk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBvbk1ibEZkZXN0Q2hhbmdlZCgpIHsKICAgICAgaWYgKGlzT0koKSB8fCBpc09FKCkpIHsKICAgICAgICBlbnRyeUhlbHBlclNlcnZpY2UuZGlzcGxheUZpZWxkQ2hhbmdlSGFuZGxlcignZGlzcGxheV9GREVTVCcpOwogICAgICB9CiAgICAgIHN5bmNNQkxGaWVsZFRvQWxsSEJMKCdGREVTVCcpOwogICAgfQoKICAgIGZ1bmN0aW9uIG9uT0VNYmxJc0RpcmVjdENoYW5nZWQoKSB7CiAgICAgIGlmICghdm0ubWJsLm9lX2luZm8uaXNfZGlyZWN0KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIC8vIEFmdGVyIERpcmVjdCBNYXN0ZXIgY2hlY2tlZAogICAgICBpZiAoIXZtLm1ibC5vZV9pbmZvLmNvbnNpZ25lZSkgewogICAgICAgIHZtLm1ibC5vZV9pbmZvLmNvbnNpZ25lZSA9IHZtLm1ibC5vdmVyc2VhX2FnZW50OwogICAgICAgIG9uVHJhZGVQYXJ0bmVyQ2hhbmdlZCgnbWJsX2NvbnNpZ25lZScsICdkaXNwbGF5X21ibF9jb25zaWduZWUnKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIG9uQUVNYmxJc0RpcmVjdENoYW5nZWQoKSB7CiAgICAgIGlmICghdm0ubWJsLmFlX2luZm8uaXNfZGlyZWN0KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIC8vIEFmdGVyIERpcmVjdCBNYXN0ZXIgY2hlY2tlZAogICAgICBpZiAoIXZtLm1ibC5hZV9pbmZvLmNvbnNpZ25lZSkgewogICAgICAgIHZtLm1ibC5hZV9pbmZvLmNvbnNpZ25lZSA9IHZtLm1ibC5vdmVyc2VhX2FnZW50OwogICAgICAgIG9uVHJhZGVQYXJ0bmVyQ2hhbmdlZCgnbWJsX2NvbnNpZ25lZScsICdkaXNwbGF5X21ibF9jb25zaWduZWUnKTsKICAgICAgfQoKICAgICAgZXhwYW5kTWJsTW9yZUluZm9BcmVhKCk7CiAgICB9CgogICAgZnVuY3Rpb24gb25IYmxEZWxDaGFuZ2VkKCkgewogICAgICBlbnRyeUhlbHBlclNlcnZpY2UuZGlzcGxheUZpZWxkQ2hhbmdlSGFuZGxlcignZGlzcGxheV9oYmxfREVMJyk7CgogICAgICBpZiAoaXNPSSgpKSB7CiAgICAgICAgbGV0IGhibCA9IHZtLmhibF9saXN0W3ZtLmN1ckhibElkeF07CiAgICAgICAgaGJsLm9pX2luZm8uaXNfcmFpbCA9IGlzU2hpcHBpbmdJUEkodm0ubWJsLCBoYmwpOwogICAgICAgIGhibC5fX2hibEZvcm0uJHNldERpcnR5KCk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBvbkhibEZkZXN0Q2hhbmdlZCgpIHsKICAgICAgZW50cnlIZWxwZXJTZXJ2aWNlLmRpc3BsYXlGaWVsZENoYW5nZUhhbmRsZXIoJ2Rpc3BsYXlfaGJsX0ZERVNUJyk7CiAgICB9CgogICAgZnVuY3Rpb24gaXNFeHByZXNzTWJsKCkgewogICAgICBjb25zdCBleHByZXNzVHlwZXMgPSBbJ1MnLCAnRSddOwogICAgICBpZiAoaXNPSSgpKSB7CiAgICAgICAgcmV0dXJuIGV4cHJlc3NUeXBlcy5pbmNsdWRlcyh2bS5tYmwub2lfaW5mby5vYmxfdHlwZSk7CiAgICAgIH0KICAgICAgaWYgKGlzT0UoKSkgewogICAgICAgIHJldHVybiBleHByZXNzVHlwZXMuaW5jbHVkZXModm0ubWJsLm9lX2luZm8ub2JsX3R5cGUpOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICBmdW5jdGlvbiBvblRyYWRlUGFydG5lckNoYW5nZWQodHAsIHNvdXJjZVRwKSB7CiAgICAgIHJldHVybiBlbnRyeUhlbHBlclNlcnZpY2UudHJhZGVQYXJ0bmVyQ2hhbmdlSGFuZGxlcih0cCwgc291cmNlVHApCiAgICAgICAgLnRoZW4oKCkgPT4gewogICAgICAgICAgaWYgKGlzRGlyZWN0TWFzdGVyKCkpIHsKICAgICAgICAgICAgaW52b2ljZVRwVXBkYXRlU2VydmljZS5zZXROZXdUcmFkZVBhcnRuZXIoZ2V0RGlyZWN0TWFzdGVyQmlsbFRvKCkpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc3QgaGJsID0gdm0uaGJsX2xpc3Rbdm0uY3VySGJsSWR4XTsKICAgICAgICAgICAgaW52b2ljZVRwVXBkYXRlU2VydmljZS5zZXROZXdUcmFkZVBhcnRuZXIoaGJsICYmIGhibC5iaWxsX3RvKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KCiAgICBmdW5jdGlvbiBleHBhbmRNYmxNb3JlSW5mb0FyZWEoKSB7CiAgICAgIGNvbnN0IG1ibE1vcmVJbmZvQnRuID0gJCgnI21ibE1vcmVJbmZvQnRuJyk7CiAgICAgIGlmIChtYmxNb3JlSW5mb0J0bi5oYXNDbGFzcygnZXhwYW5kJykpIHsgLy8gaWYgYnV0dG9uIGhhcyBleHBhbmQgY2xhc3MgbWVhbnMgdGhhdCB0aGUgYXJlYSBpcyBjb2xsYXBzZWQKICAgICAgICBtYmxNb3JlSW5mb0J0bi5jbGljaygpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gY2xlYXJRdW90YXRpb25ObyhoYmwpIHsKICAgICAgaGJsLnF1b3RhdGlvbiA9IG51bGw7CiAgICAgIGhibC5fX2hibEZvcm0uJHNldERpcnR5KCk7CiAgICB9CgogICAgZnVuY3Rpb24gaW5pdE1CTEFkdmFuY2VkVG9nZ2xlKCkgewogICAgICAvLyBpbml0aWFsaXplIGZvciBNQkwgYWR2YW5jZWQgYnV0dG9uIHRvZ2dsaW5nLgogICAgICAkKCcuaW5wdXQtaGlkZS1tYmwnKS5oaWRlKCk7CiAgICAgICQoJy5hZHZhbmNlLW1ibC1idG4nKS5jbGljayhmdW5jdGlvbigpewogICAgICAgICQoIi5pbnB1dC1oaWRlLW1ibCIpLmZhZGVUb2dnbGUoImZhc3QiLCAibGluZWFyIik7CiAgICAgIH0pOwogICAgICAkKCcuYWR2YW5jZS1tYmwtYnRuJykudG9nZ2xlKGZ1bmN0aW9uICgpIHsKICAgICAgICAkKCcuYWR2YW5jZS1tYmwtYnRuJykuY3NzKCJiYWNrZ3JvdW5kLXBvc2l0aW9uIiwgIjFweCA2NXB4Iik7CiAgICAgICAgfSwgZnVuY3Rpb24gKCkgewogICAgICAgICQoJy5hZHZhbmNlLW1ibC1idG4nKS5jc3MoImJhY2tncm91bmQtcG9zaXRpb24iLCAiMXB4IDFweCIpOwogICAgICB9KTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRTaGlwbWVudEJhc2ljSW5mbygpIHsKICAgICAgcmV0dXJuIGRhdGFTZXJ2aWNlLmdldFNoaXBtZW50QmFzaWNJbmZvKHZtLmZpbGluZ05vKQogICAgICAgIC50aGVuKGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICB2bS5zaGlwbWVudEJhc2ljSW5mbyA9IGRhdGE7CiAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICB9KTsKICAgIH0KCiAgICAvLyA9PT09PT09PT09PT09PT0gdXRpbGl0eSA9PT09PT09PT09PT09PT0KICAgIGZ1bmN0aW9uIGNhY2hlRm9ybURhdGEoKXsKICAgICAgdXBkYXRlci5jYWNoZSgnbWJsJywgdm0ubWJsKTsKICAgICAgdXBkYXRlci5jYWNoZSgnaGJsX2xpc3QnLCB2bS5oYmxfbGlzdCk7CiAgICB9CgogICAgZnVuY3Rpb24gY2FjaGVIYmxGb3JtRGF0YSgpewogICAgICB1cGRhdGVyLmNhY2hlKCdoYmxfbGlzdCcsIHZtLmhibF9saXN0KTsKICAgIH0KCiAgICBmdW5jdGlvbiBjYWNoZUluYWN0aXZlSGJsRm9ybURhdGEoY3VySGJsKSB7CiAgICAgIHZhciBoYmxfbGlzdCA9IHZtLmhibF9saXN0Lm1hcChmdW5jdGlvbihoYmwpIHsKICAgICAgICByZXR1cm4gY3VySGJsLmlkID09PSBoYmwuaWQgPyB2bS5jdXJIYmxDYWNoZWQgOiBoYmw7CiAgICAgIH0pOwogICAgICB1cGRhdGVyLmNhY2hlKCdoYmxfbGlzdCcsIGhibF9saXN0KTsKICAgIH0KCiAgICBmdW5jdGlvbiBtYXBIYmxJZFRvSW5kZXgoaGJsX2lkKSB7CiAgICAgIGZvcih2YXIgaT0wOyBpPHZtLmhibF9saXN0Lmxlbmd0aDsgKytpKSB7CiAgICAgICAgaWYgKHZtLmhibF9saXN0W2ldLmlkID09PSBoYmxfaWQpIHsKICAgICAgICAgIHJldHVybiBpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gLTE7CiAgICB9CgogICAgLy8gPT09PT09PT09PT09PT09IHV0aWxpdHkgKEFFKSA9PT09PT09PT09PT09PT0KICAgIGZ1bmN0aW9uIG9uQWlyQ2FycmllckNoYW5nZWQoKSB7CiAgICAgIHZhciBwcmVmaXggPSB2bS5tYmwuY2FycmllciA/IHZtLm1ibC5jYXJyaWVyLnByZWZpeCA6IG51bGw7CgogICAgICBpZiAoIXByZWZpeCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKCF2bS5tYmwuTUJMX05PKSB7CiAgICAgICAgdm0ubWJsLk1CTF9OTyA9IHByZWZpeCArICctJzsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICghaXNNQVdCVmFsaWQoKSkgewogICAgICAgIFNob3dGZWVkYmFja01zZygnd2FybmluZycsIGF3YlZhbGlkYXRvci5lcnJvcnMpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gaXNNQVdCVmFsaWQoKSB7CiAgICAgIHZhciBhaXJsaW5lUHJlZml4ID0gdm0ubWJsLmNhcnJpZXIgPyB2bS5tYmwuY2Fycmllci5wcmVmaXggOiBudWxsOwogICAgICByZXR1cm4gIXZtLm1ibC5NQkxfTk8gfHwgYXdiVmFsaWRhdG9yLmlzVmFsaWQodm0ubWJsLk1CTF9OTywgYWlybGluZVByZWZpeCk7CiAgICB9CgogICAgZnVuY3Rpb24gaXNQYWNrYWdlVmFsaWQoaW5zdGFuY2UpIHsKICAgICAgY29uc3QgZGF0YSA9IHZvbHVtZUNhbGN1bGF0b3IoKS5kZXNlcmlhbGl6ZShpbnN0YW5jZS52b2x1bWVfd2VpZ2h0X2luZm8pOwoKICAgICAgcmV0dXJuICgKICAgICAgICBkYXRhLml0ZW1zLmxlbmd0aCA8IDEKICAgICAgICB8fCBpbnN0YW5jZS5wYWNrYWdlID09PSB2b2x1bWVDYWxjdWxhdG9yKCkuY2FsY1BDU1N1bShkYXRhLml0ZW1zKQogICAgICApOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzQUVIYmxQYWNrYWdlVmFsaWQoaGJsKSB7CiAgICAgIGlmIChoYmwuaXNfc3luY193YXJlaG91c2VfZGltZW5zaW9ucykgewogICAgICAgIGNvbnN0IHBrZyA9IGhibC5hZV9pbmZvLnBhY2thZ2UgfHwgMDsKICAgICAgICBjb25zdCBkZXRhaWxTZXQgPSBoYmwubGlua193aF9yZWNlaXB0X2RldGFpbF9zZXQgfHwgW107CiAgICAgICAgcmV0dXJuIHBrZyA9PT0gdm9sdW1lQ2FsY3VsYXRvcigpLmNhbGNQQ1NTdW0oZGV0YWlsU2V0Lm1hcChkID0+IGQud2hfcmVjZWlwdF9kZXRhaWwpKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGlzUGFja2FnZVZhbGlkKGhibC5hZV9pbmZvKTsKICAgIH0KCiAgICBmdW5jdGlvbiBpc0FJSGJsUGFja2FnZVZhbGlkKGhibCkgewogICAgICBpZiAoaGJsLmlzX3N5bmNfd2FyZWhvdXNlX2RpbWVuc2lvbnMpIHsKICAgICAgICBjb25zdCBwa2cgPSBoYmwuYWlfaW5mby5wYWNrYWdlIHx8IDA7CiAgICAgICAgY29uc3QgZGV0YWlsU2V0ID0gaGJsLmxpbmtfd2hfcmVjZWlwdF9kZXRhaWxfc2V0IHx8IFtdOwogICAgICAgIHJldHVybiBwa2cgPT09IHZvbHVtZUNhbGN1bGF0b3IoKS5jYWxjUENTU3VtKGRldGFpbFNldC5tYXAoZCA9PiBkLndoX3JlY2VpcHRfZGV0YWlsKSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBpc1BhY2thZ2VWYWxpZChoYmwuYWlfaW5mbyk7CiAgICB9CgogICAgZnVuY3Rpb24gaXNTdWJIYXdiRGlydHkoc3ViaGF3YikgewogICAgICByZXR1cm4gKHN1Ymhhd2IuX19mb3JtICYmIHN1Ymhhd2IuX19mb3JtLiRkaXJ0eSkgfHwKICAgICAgICAoc3ViaGF3Yi5fX2Zvcm0xICYmIHN1Ymhhd2IuX19mb3JtMS4kZGlydHkpOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzT3RoZXJDaGFyZ2VEaXJ0eShjaGFyZ2UpIHsKICAgICAgcmV0dXJuIChjaGFyZ2UuX19mb3JtICYmIGNoYXJnZS5fX2Zvcm0uJGRpcnR5KSB8fAogICAgICAgIChjaGFyZ2UuX19mb3JtMSAmJiBjaGFyZ2UuX19mb3JtMS4kZGlydHkpOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzQ29tbW9kaXR5RGlydHkoaXRlbSkgewogICAgICByZXR1cm4gKGl0ZW0uX19mb3JtICYmIGl0ZW0uX19mb3JtLiRkaXJ0eSkgfHwKICAgICAgICAoaXRlbS5fX2Zvcm0xICYmIGl0ZW0uX19mb3JtMS4kZGlydHkpOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldEJsb2NrVG9vbHRpcChvYmopIHsKICAgICAgcmV0dXJuIHNoaXBtZW50QmxvY2tTZXJ2aWNlLmdldEJsb2NrVG9vbHRpcChvYmopOwogICAgfQoKICAgIGZ1bmN0aW9uIHdhcm5TaGlwbWVudEJsb2NrKHNoaXBtZW50KSB7CiAgICAgIGxldCB3YXJuZWQgPSBmYWxzZTsKCiAgICAgIGlmIChzaGlwbWVudCkgewogICAgICAgIGlmICghdm0uY3JlYXRpbmcgJiYgc2hpcG1lbnQuaXNfYmxvY2tfcGVybSkgewogICAgICAgICAgc2hpcG1lbnRCbG9ja1NlcnZpY2Uud2FpdEluaXQoKS50aGVuKCgpID0+IHsKICAgICAgICAgICAgaWYgKHNoaXBtZW50QmxvY2tTZXJ2aWNlLmlzQmxvY2tCeVllYXJFbmQoc2hpcG1lbnQsIHZtLm1ibC5wb3N0X2RhdGUpKSB7CiAgICAgICAgICAgICAgU2hvd1llYXJFbmRCbG9ja01zZygpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIFNob3dBY2NvdW50aW5nQmxvY2tNc2coc2hpcG1lbnQuYmxvY2tfYnksIHNoaXBtZW50LmJsb2NrX2RhdGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIHdhcm5lZCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICBpZiAoIXZtLmNyZWF0aW5nICYmIGNhbkVkaXRCbG9ja2VkT2JqZWN0KHNoaXBtZW50KSkgewogICAgICAgICAgU2hvd0FjY291bnRpbmdCbG9ja0VkaXRpb25XYXJuaW5nTXNnKHNoaXBtZW50LmJsb2NrX2J5LCBzaGlwbWVudC5ibG9ja19kYXRlKTsKICAgICAgICAgIHdhcm5lZCA9IHRydWU7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gd2FybmVkOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzRW5hYmxlT2ZmaWNlRGVwYXJ0bWVudCgpIHsKICAgICAgaWYgKCF2bS5vZmZpY2VzKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICBpZiAoIXZtLm1ibCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgcmV0dXJuIHZtLm9mZmljZXNbdm0ubWJsLm9mZmljZV0uaXNfZW5hYmxlX29mZmljZV9kZXBhcnRtZW50OwogICAgfQoKICAgIGZ1bmN0aW9uIG9uTWJsU2hpcE1vZGVVcGRhdGUoKSB7CiAgICAgIGlmICh2bS5tYmwuc2hpcF9tb2RlID09PSAnRkFLJyB8fCB2bS5tYmwuc2hpcF9tb2RlID09PSAnTENMJykgewogICAgICAgIHZtLm1ibC5zdmNfdGVybV9mcm9tID0gJ0NGJzsKICAgICAgICB2bS5tYmwuc3ZjX3Rlcm1fdG8gPSAnQ0YnOwogICAgICB9CgogICAgICBzeW5jTUJMRmllbGRUb0FsbEhCTCgnc2hpcF9tb2RlJywgJ3N2Y190ZXJtX2Zyb20nLCAnc3ZjX3Rlcm1fdG8nLCAnY3lfbG9jYXRpb24nLCAnY2ZzX2xvY2F0aW9uJyk7CiAgICB9CgogICAgZnVuY3Rpb24gb25IYmxTaGlwTW9kZVVwZGF0ZShoYmwpIHsKICAgICAgaWYgKGhibC5zaGlwX21vZGUgPT09ICdGQUsnIHx8IGhibC5zaGlwX21vZGUgPT09ICdMQ0wnKSB7CiAgICAgICAgaGJsLnN2Y190ZXJtX2Zyb20gPSAnQ0YnOwogICAgICAgIGhibC5zdmNfdGVybV90byA9ICdDRic7CiAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFVzaW5nIGhibCdzIEFNU19OTyB0byBzZWFyY2ggZm9yIGlzZiB3aGljaCBoYXMgdGhlIHNhbWUgYmxfbm8KICAgICAqLwogICAgZnVuY3Rpb24gZmluZE1hdGNoZWRJc2YoYW1zTm8pIHsKICAgICAgaWYgKCFhbXNObykgewogICAgICAgIHJldHVybiAkcS5yZXNvbHZlKHt9KTsKICAgICAgfQogICAgICByZXR1cm4gdm0uZW5kcG9pbnRzLk1BVENIRURfSVNGCiAgICAgICAgLmdldCh7IHBhcmFtczogeyBhbXNfbm86IGFtc05vIH0gfSkKICAgICAgICAudGhlbihfLnByb3BlcnR5KCdkYXRhJykpOwogICAgfQoKICAgIGZ1bmN0aW9uIGhhbmRsZUhibEFtc05vRm9jdXMoaGJsKSB7CiAgICAgIGhibC5fX2xhc3RBbXNObyA9IGhibC5BTVNfTk87CiAgICB9CgogICAgZnVuY3Rpb24gaGFuZGxlSGJsQW1zTm9DaGFuZ2VPbkJsdXIoaGJsKSB7CiAgICAgIHNob3dTcGluKCk7CiAgICAgIGZpbmRNYXRjaGVkSXNmKGhibC5BTVNfTk8pCiAgICAgICAgLnRoZW4oKGlzZikgPT4gewogICAgICAgICAgaGlkZVNwaW4oKTsKICAgICAgICAgIGlmIChpc2YuaWQpIHsKICAgICAgICAgICAgbGlua0lzZlRvSGJsKGlzZikKICAgICAgICAgICAgICAudGhlbigoKSA9PiAkdWliTW9kYWwub3Blbih7CiAgICAgICAgICAgICAgICBhbmltYXRpb246IHRydWUsCiAgICAgICAgICAgICAgICB0ZW1wbGF0ZTogTW9kYWxDb3B5U2hpcG1lbnRJbmZvRnJvbUlzZkNvbnRyb2xsZXIudGVtcGxhdGUsCiAgICAgICAgICAgICAgICB3aW5kb3dUZW1wbGF0ZVVybDogJ2hjV2luZG93VGVtcGxhdGUuaHRtbCcsCiAgICAgICAgICAgICAgICBjb250cm9sbGVyOiBXaXRoSTE4bihNb2RhbENvcHlTaGlwbWVudEluZm9Gcm9tSXNmQ29udHJvbGxlciwgX1RfT0lfTU9EQUwpLAogICAgICAgICAgICAgICAgY29udHJvbGxlckFzOiAndm0nLAogICAgICAgICAgICAgICAgcmVzb2x2ZTogewogICAgICAgICAgICAgICAgICBpc2Y6ICgpID0+IGlzZiwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgfSkucmVzdWx0KQogICAgICAgICAgICAgIC50aGVuKGNvbmZpZyA9PiBjb3B5U2hpcG1lbnRJbmZvRnJvbUlzZihpc2YsIGNvbmZpZykpCiAgICAgICAgICAgICAgLmZpbmFsbHkoKCkgPT4gU2hvd1N1Y2Nlc3NGZWVkYmFja01zZyhfVC5NU0cuSVNGX0FOU19MSU5LRUQpKTsKICAgICAgICAgIH0gZWxzZSBpZiAoaGJsLmlzZl9pZCkgewogICAgICAgICAgICBvcGVuTW9kYWxVbmxpbmtJc2YoaGJsKQogICAgICAgICAgICAgIC50aGVuKHVubGlua0lzZkZyb21IYmwsIHJlc2V0QW1zTm8pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdW5saW5rSXNmRnJvbUhibCgpOwogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgLyogaW50ZXJuYWwgZnVuY3Rpb25zICovCiAgICAgIGZ1bmN0aW9uIGxpbmtJc2ZUb0hibChpc2YpIHsKICAgICAgICBoYmwuaXNmX2lkID0gaXNmLmlkOwogICAgICAgIGhibC5JU0ZfTk8gPSBpc2YuaXNmX25vOwogICAgICAgIGhibC5fX2hibEZvcm0uJHNldERpcnR5KCk7CiAgICAgICAgcmV0dXJuICRxLnJlc29sdmUoKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gY29weVNoaXBtZW50SW5mb0Zyb21Jc2YoaXNmLCB7IGlzQ29weVRvTWJsLCBpc0NvcHlUb0hibCB9KSB7CiAgICAgICAgaWYgKGlzQ29weVRvTWJsKSB7CiAgICAgICAgICAvLyByZWZlcmVuY2VkIGZyb20gZ2V0X29pX21ibF9hdHRyX2Zyb21faXNmIGFuZCBpdHMgdXNlIHBsYWNlCiAgICAgICAgICBpZiAodm0ubWJsLnR5cGUgPT09ICdPSScpIHsKICAgICAgICAgICAgdm0ubWJsLm92ZXJzZWFfYWdlbnQgPSBpc2Yub3ZlcnNlYV9hZ2VudDsKICAgICAgICAgICAgdm0ubWJsLm9pX2luZm8uYmxfYWNjdF9jYXJyaWVyID0gaXNmLmNhcnJpZXI7CiAgICAgICAgICB9IGVsc2UgaWYgKHZtLm1ibC50eXBlID09PSAnT0UnKSB7CiAgICAgICAgICAgIHZtLm1ibC5zaGlwcGluZ19hZ2VudCA9IGlzZi5vdmVyc2VhX2FnZW50OwogICAgICAgICAgICB2bS5tYmwub2VfaW5mby5ibF9hY2N0X2NhcnJpZXIgPSBpc2YuY2FycmllcjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IEVycm9yKGBVbmV4cGVjdGVkIE1CL0wgdHlwZTogJHt2bS5tYmwudHlwZX1gKTsKICAgICAgICAgIH0KCiAgICAgICAgICB2bS5tYmwuTUJMX05PID0gaXNmLm1ibF9ubzsKICAgICAgICAgIHZtLm1ibC5vZmZpY2UgPSBpc2Yub2ZmaWNlLmlkOwogICAgICAgICAgdm0ubWJsLmRpc3BsYXlfdW5pdCA9IGlzZi5vZmZpY2UuZGlzcGxheV91bml0OwogICAgICAgICAgdm0ubWJsLkVUQSA9IGlzZi5ldGE7CiAgICAgICAgICB2bS5tYmwuRVREID0gaXNmLmV0ZDsKICAgICAgICAgIHZtLm1ibC5QT0wgPSBpc2YucG9sOwogICAgICAgICAgdm0ubWJsLlBPRCA9IGlzZi5wb2Q7CiAgICAgICAgICB2bS5tYmwudmVzc2VsX25hbWUgPSBpc2YudmVzc2VsX25hbWU7CiAgICAgICAgICB2bS5tYmwudm95YWdlID0gaXNmLnZveWFnZTsKICAgICAgICAgIHZtLm1ibC5jYXJyaWVyID0gaXNmLmNhcnJpZXI7CgogICAgICAgICAgdm0ubWJsLl9fZm9ybS4kc2V0RGlydHkoKTsKICAgICAgICB9CgogICAgICAgIGlmIChpc0NvcHlUb0hibCkgewogICAgICAgICAgLy8gcmVmZXJlbmNlZCBmcm9tIGdldF9vaV9oYmxfYXR0cl9mcm9tX2lzZiBhbmQgaXRzIHVzZSBwbGFjZQogICAgICAgICAgaGJsLkZERVNUID0gaXNmLnN1Ym1pc3Npb25fdHlwZSA9PT0gMiA/IGlzZi5wbGFjZV9vZl9kZWxpdmVyeSA6IGhibC5GREVTVDsKICAgICAgICAgIGhibC5IQkxfTk8gPSBpc2YuaGJsX25vOwogICAgICAgICAgaGJsLnBvX251bV9saXN0ID0gaXNmLnBvX251bV9saXN0OwogICAgICAgICAgaGJsLnNoaXBwZXIgPSBpc2Yuc2hpcHBlcjsKICAgICAgICAgIGFzc2lnbkNvbnNpZ25lZUFuZENhcnJ5VHJhZGVQYXJ0eShoYmwsIGlzZi5jb25zaWduZWUpOwogICAgICAgICAgaGJsLl9faGJsRm9ybS4kc2V0RGlydHkoKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHVubGlua0lzZkZyb21IYmwoKSB7CiAgICAgICAgaGJsLmlzZl9pZCA9IG51bGw7CiAgICAgICAgaGJsLklTRl9OTyA9IG51bGw7CiAgICAgICAgaGJsLl9faGJsRm9ybS4kc2V0RGlydHkoKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gcmVzZXRBbXNObygpIHsKICAgICAgICBoYmwuQU1TX05PID0gaGJsLl9fbGFzdEFtc05vOwogICAgICB9CgogICAgICBmdW5jdGlvbiBvcGVuTW9kYWxVbmxpbmtJc2YoaGJsKSB7CiAgICAgICAgY29uc3QgaXNmRW50cnlVcmwgPSBVUkwuSVNGX1ZJRVcuRU5UUlkuZm9ybWF0KGhibC5pc2ZfaWQpOwogICAgICAgIGNvbnN0IGlzZkVudHJ5TGlua1RlbXBsYXRlID0gYDxhIHRhcmdldD0iX2JsYW5rIiBocmVmPSIke2lzZkVudHJ5VXJsfSI+JHtoYmwuX19sYXN0QW1zTm99PC9hPmA7CiAgICAgICAgY29uc3QgbW9kYWxNc2cgPSBjcmVhdGVTdHJpbmdGb3JtYXR0ZXIoX1QuTVNHLkNPTkZJUk1fRElTQ09OTkVDVF9JU0YpLmZvcm1hdChpc2ZFbnRyeUxpbmtUZW1wbGF0ZSk7CgogICAgICAgIHJldHVybiBtb2RhbC5vcGVuQ29uZmlybSgnJywgbW9kYWxNc2cpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZW5hYmxlUmVsZWFzZWQoaGJsKSB7CiAgICAgIHJldHVybiAhaGJsLm9pX2luZm8uaXNfaG9sZCAmJgogICAgICAgIChoYmwuaXNfb3JpZ2luYWxfYmxfcmVjZWl2ZWQgfHwgaGJsLmlzX2V4cHJlc3MpOwogICAgfQoKICAgIGZ1bmN0aW9uIG9uRXhwcmVzc0JMQ2hhbmdlKGhibCkgewogICAgICB1cGRhdGVJc1JlbGVhc2VkKGhibCk7CiAgICB9CgogICAgZnVuY3Rpb24gb25IYmxPQkxSZWNlaXZlZENoYW5nZShoYmwpIHsKICAgICAgdXBkYXRlSXNSZWxlYXNlZChoYmwpOwogICAgICB0b2dnbGVPYmxSZWNlaXZlZChoYmwpOwogICAgfQoKICAgIGZ1bmN0aW9uIHVwZGF0ZUlzUmVsZWFzZWQoaGJsKSB7CiAgICAgIGlmICghZW5hYmxlUmVsZWFzZWQoaGJsKSkgewogICAgICAgIGhibC5pc19yZWxlYXNlZCA9IGZhbHNlOwogICAgICAgIGhibC5yZWxlYXNlX2RhdGUgPSBudWxsOwogICAgICAgIGhibC5yZWxlYXNlX2J5ID0gbnVsbDsKICAgICAgfQogICAgfQoKICAgIC8vID09PT09PT09PT09PT09PSBWaWV3TW9kZWwgYXBpID09PT09PT09PT09PT09PQoKICAgIGZ1bmN0aW9uIGRpc2FibGVNb2RlKG1vZGUpIHsKICAgICAgaWYgKCF2bS5tYmwpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gaXNEaXNhYmxlZChtb2RlLCB2bS5tYmwpIHx8ICFzaGlwbWVudEFjU3ZjLmlzTWJsRWRpdGFibGUodm0ubWJsKTsKICAgIH0KCiAgICBmdW5jdGlvbiBoYmxEaXNhYmxlTW9kZShtb2RlLCBoYmwpIHsKICAgICAgaWYgKCFoYmwpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gaXNEaXNhYmxlZChtb2RlLCBoYmwpIHx8ICFzaGlwbWVudEFjU3ZjLmlzSGJsRWRpdGFibGUoaGJsKTsKICAgIH0KCiAgICBmdW5jdGlvbiBpc0Rpc2FibGVkKG1vZGUsIG9iaikgewogICAgICByZXR1cm4gb2JqICYmICgKICAgICAgICAgIChtb2RlSW5jbHVkZXMoJ0EnKSAmJiBvYmouaXNfYmxvY2tfcGVybSkgfHwKICAgICAgICAgIChtb2RlSW5jbHVkZXMoJ0wnKSAmJiBvYmouaXNfcGF5bWVudF9sb2NrKQogICAgICApOwoKICAgICAgZnVuY3Rpb24gbW9kZUluY2x1ZGVzKGtleSkgewogICAgICAgIHJldHVybiBfKG1vZGUpLmluY2x1ZGVzKGtleSk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBjYW5EZWxldGVNYmwoKSB7CiAgICAgIHJldHVybiAhZGlzYWJsZURlbGV0ZU1ibFRvb2x0aXAoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBjYW5EZWxldGVIYmwoaGJsKSB7CiAgICAgIHJldHVybiAhZGlzYWJsZURlbGV0ZUhibFRvb2x0aXAoaGJsKTsKICAgIH0KCiAgICBmdW5jdGlvbiBkaXNhYmxlRGVsZXRlTWJsVG9vbHRpcCgpIHsKICAgICAgaWYgKCFzaGlwbWVudEFjU3ZjLmlzTWJsRWRpdGFibGUodm0ubWJsKSkgewogICAgICAgIHJldHVybiB2bS5tZXNzYWdlLkNBTl9OT1RfREVMRVRFX0JZX1BFUk1JU1NJT047CiAgICAgIH0KCiAgICAgIGlmICh2bS5tYmwuaXNfYmxvY2spIHsKICAgICAgICByZXR1cm4gdm0ubWVzc2FnZS5DQU5fTk9UX0RFTEVURV9CWV9CTE9DSzsKICAgICAgfQoKICAgICAgaWYgKHZtLmhibF9saXN0ICYmIHZtLmhibF9saXN0LnNvbWUoaGJsID0+IGhibC5pc19ibG9jaykpIHsKICAgICAgICByZXR1cm4gdm0ubWVzc2FnZS5DQU5fTk9UX0RFTEVURV9CWV9IQkxfQkxPQ0s7CiAgICAgIH0KCiAgICAgIGlmICh2bS5tYmwuaXNfcGF5bWVudF9sb2NrCiAgICAgICAgfHwgKHZtLmhibF9saXN0ICYmIHZtLmhibF9saXN0LnNvbWUoaGJsID0+IGhibC5pc19wYXltZW50X2xvY2spKQogICAgICApIHsKICAgICAgICByZXR1cm4gdm0ubWVzc2FnZS5DQU5fTk9UX0RFTEVURV9CWV9QQVlNRU5UX0xPQ0s7CiAgICAgIH0KCiAgICAgIGlmICh2bS5tYmwudHlwZSA9PT0gJ09FJyAmJiB2bS5zaGlwbWVudEJhc2ljSW5mbyAmJiB2bS5zaGlwbWVudEJhc2ljSW5mby5pc19lc2lfaXNzdWVkKSB7CiAgICAgICAgcmV0dXJuIHZtLm1lc3NhZ2UuQ0FOX05PVF9ERUxFVEVfQllfRVNJX1NVQk1JVFRFRDsKICAgICAgfQoKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgZnVuY3Rpb24gZGlzYWJsZURlbGV0ZUhibFRvb2x0aXAoaGJsKSB7CiAgICAgIGlmIChoYmwuaXNfYmxvY2spIHsKICAgICAgICByZXR1cm4gdm0ubWVzc2FnZS5DQU5fTk9UX0RFTEVURV9CWV9CTE9DSzsKICAgICAgfQoKICAgICAgaWYgKGhibC5pc19wYXltZW50X2xvY2spIHsKICAgICAgICByZXR1cm4gdm0ubWVzc2FnZS5DQU5fTk9UX0RFTEVURV9CWV9QQVlNRU5UX0xPQ0s7CiAgICAgIH0KCiAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIGZ1bmN0aW9uIGRpc2FibGVDb3B5SEJMVG9vbHRpcCgpIHsKICAgICAgaWYgKHZtLm1ibC5pc19ibG9ja19wZXJtKSB7CiAgICAgICAgcmV0dXJuIHZtLm1lc3NhZ2UuQ0FOX05PVF9DT1BZX0JZX0JMT0NLOwogICAgICB9CiAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIGZ1bmN0aW9uIGRpc2FibGVDb3B5SEJMVG9PdGhlck1ibFRvb2x0aXAoKSB7CiAgICAgIGlmICh2bS5tYmwuaXNfYmxvY2tfcGVybSkgewogICAgICAgIHJldHVybiB2bS5tZXNzYWdlLkNBTl9OT1RfQ09QWV9UT19CWV9CTE9DSzsKICAgICAgfQogICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICBmdW5jdGlvbiBkaXNhYmxlTW92ZUhCTFRvT3RoZXJNYmxUb29sdGlwKGFyZ3MpIHsKICAgICAgY29uc3QgeyBoYmwgfSA9IGFyZ3M7CiAgICAgIGlmICh2bS5tYmwuaXNfYmxvY2spIHsKICAgICAgICByZXR1cm4gdm0ubWVzc2FnZS5DQU5fTk9UX01PVkVfVE9fQllfQkxPQ0s7CiAgICAgIH0KCiAgICAgIGlmIChoYmwuaXNfYmxvY2spIHsKICAgICAgICByZXR1cm4gdm0ubWVzc2FnZS5DQU5fTk9UX01PVkVfVE9fQllfQkxPQ0tfSEJMOwogICAgICB9CgogICAgICBjb25zdCBoYXNCbG9ja2VkSW52b2ljZSA9IGhibC5pbnZvaWNlX3NldCA/IGhibC5pbnZvaWNlX3NldC5zb21lKGludiA9PiBpbnYuaXNfYmxvY2spIDogZmFsc2U7CiAgICAgIGlmIChoYXNCbG9ja2VkSW52b2ljZSkgewogICAgICAgIHJldHVybiB2bS5tZXNzYWdlLkNBTl9OT1RfTU9WRV9UT19CWV9CTE9DS19JTlZPSUNFOwogICAgICB9CiAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIGZ1bmN0aW9uIHVwZGF0ZUhibENhY2hlKCkgewogICAgICBpZiAodm0uY3VySGJsSWR4ICE9PSBudWxsKSB7CiAgICAgICAgdm0uY3VySGJsQ2FjaGVkID0gYW5ndWxhci5jb3B5KHZtLmhibF9saXN0W3ZtLmN1ckhibElkeF0pOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gcmVzdG9yZUhibENhY2hlKCkgewogICAgICBpZiAodm0uY3VySGJsSWR4ICE9PSBudWxsKSB7CiAgICAgICAgdm0uaGJsX2xpc3Rbdm0uY3VySGJsSWR4XSA9IGFuZ3VsYXIuY29weSh2bS5jdXJIYmxDYWNoZWQpOwogICAgICAgIHZtLmhibF9saXN0W3ZtLmN1ckhibElkeF0uX19oYmxGb3JtLiRzZXRQcmlzdGluZSgpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gYWRkSGJsKCkgewogICAgICBzYXZlRWRpdGluZ0hibCgpCiAgICAgICAgLnRoZW4oZG9BZGRIYmxCeU1ibCk7CiAgICB9CgogICAgZnVuY3Rpb24gc2F2ZUVkaXRpbmdIYmwoKSB7CiAgICAgIHZhciBoYmwgPSB2bS5oYmxfbGlzdFt2bS5jdXJIYmxJZHhdOwogICAgICB2YXIgaGJsSXNFZGl0aW5nID0gaGJsICYmIChoYmwuX19oYmxGb3JtLiRkaXJ0eSB8fCBoYmwuX19oYmxGb3JtLiRpbnZhbGlkKTsKCiAgICAgIGlmICghaGJsSXNFZGl0aW5nKSB7CiAgICAgICAgcmV0dXJuICRxLnJlc29sdmUoKTsKICAgICAgfQoKICAgICAgcmV0dXJuIG1vZGFsCiAgICAgICAgLm9wZW5TYXZlKF9ULk1TRy5OT1RJRllfVE9fU0FWRV9OT1cpCiAgICAgICAgLnRoZW4ob25DaG9zZW4pOwoKICAgICAgZnVuY3Rpb24gb25DaG9zZW4ocmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIHJlc3VsdCA9PT0gJ3NhdmUnID8gc2F2ZSgnYWRkX2hibCcpIDogJHEucmVqZWN0KCk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBkb0FkZEhibEJ5TWJsKCkgewogICAgICB2YXIgbmV3SGJsID0gYnVpbGRIYmxGcm9tTWJsKHZtLm1ibCk7CgogICAgICBkb0FkZEhibChuZXdIYmwsIGFmdGVyQWRkZWQpOwoKICAgICAgZnVuY3Rpb24gYWZ0ZXJBZGRlZCgpIHsKICAgICAgICByZXR1cm4gc2xpZGVVcE1ibFBhbmUoKQogICAgICAgICAgLnRoZW4oc2xpZGVEb3duTGFzdEhibFBhbmUpCiAgICAgICAgICAudGhlbihmb2N1c09uTGFzdEhCTE5PKQogICAgICAgICAgLnRoZW4oXy5wYXJ0aWFsKHNldERpcnR5SWZFbmFibGVBdXRvR2VuSEJMLCBuZXdIYmwpKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGRvQWRkSGJsQnlDb3B5KGNvcHlIYmxJZHgpIHsKICAgICAgdmFyIG5ld0hibCA9IGJ1aWxkSGJsRnJvbUFub3RoZXJIYmwodm0uaGJsX2xpc3RbY29weUhibElkeF0pOwoKICAgICAgZG9BZGRIYmwobmV3SGJsLCBhZnRlckFkZGVkKTsKCiAgICAgIGZ1bmN0aW9uIGFmdGVyQWRkZWQoKSB7CiAgICAgICAgcmV0dXJuIHNsaWRlVXBNYmxQYW5lKCkKICAgICAgICAgIC50aGVuKHNsaWRlRG93bkxhc3RIYmxQYW5lKQogICAgICAgICAgLnRoZW4oZm9jdXNPbkxhc3RIQkxOTykKICAgICAgICAgIC50aGVuKF8ucGFydGlhbChzZXREaXJ0eUlmRW5hYmxlQXV0b0dlbkhCTCwgbmV3SGJsKSk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBkb0FkZEhibEJ5Q2FycnlBdHRyKGNhcnJ5QXR0cikgewogICAgICBjb25zdCBuZXdIYmwgPSBidWlsZEhibEZyb21NYmwodm0ubWJsKTsKICAgICAgZG9BZGRIYmwobmV3SGJsLCBhZnRlckFkZGVkKTsKCiAgICAgIGZ1bmN0aW9uIGFmdGVyQWRkZWQoKSB7CiAgICAgICAgcmV0dXJuIHNsaWRlRG93bkxhc3RIYmxQYW5lKCkKICAgICAgICAgIC50aGVuKCgpID0+IGFzc2lnbkNvbnNpZ25lZUFuZENhcnJ5VHJhZGVQYXJ0eShuZXdIYmwsIGNhcnJ5QXR0ci5jb25zaWduZWUpKQogICAgICAgICAgLnRoZW4oKCkgPT4gYXNzaWduQ2FycnlBdHRyKG5ld0hibCwgY2FycnlBdHRyKSkKICAgICAgICAgIC50aGVuKHNldERpcnR5KTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gc2V0RGlydHkoKSB7CiAgICAgICAgbmV3SGJsLl9faGJsRm9ybS4kc2V0RGlydHkoKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGFzc2lnbkNvbnNpZ25lZUFuZENhcnJ5VHJhZGVQYXJ0eShoYmwsIGNvbnNpZ25lZSkgewogICAgICBoYmwuY29uc2lnbmVlID0gY29uc2lnbmVlOwogICAgICByZXR1cm4gb25UcmFkZVBhcnRuZXJDaGFuZ2VkKCdoYmxfY29uc2lnbmVlJyk7CiAgICB9CgogICAgZnVuY3Rpb24gYXNzaWduQ2FycnlBdHRyKGhibCwgY2FycnlBdHRyKSB7CiAgICAgIC8vIGFzc2lnbiBjYXJyeUF0dHIgYWZ0ZXIgY2FycnkgY29uc2lnbmVlIHRyYWRlIHBhcnR5LAogICAgICAvLyBiZWNhdXNlIHNob3VsZCBicmluZyBpc2YgYXR0ciBpZiB0aGVyZSBzb21lIGZpZWxkcyBjb25mbGljdC4KICAgICAgYW5ndWxhci5leHRlbmQoaGJsLCBjYXJyeUF0dHIpOwogICAgfQoKICAgIGZ1bmN0aW9uIGJ1aWxkSGJsRnJvbU1ibChtYmwpIHsKICAgICAgdmFyIGhibCA9IGFuZ3VsYXIuY29weSh2bS5kZWZhdWx0SGJsKTsKCiAgICAgIGhibC5wYWNrYWdlX3VuaXQgPSBtYmwucGFja2FnZV91bml0OwogICAgICBoYmwud2VpZ2h0X3VuaXQgPSBtYmwud2VpZ2h0X3VuaXQ7CiAgICAgIGhibC5tZWFzdXJlX3VuaXQgPSBtYmwubWVhc3VyZV91bml0OwogICAgICBoYmwub2ZmaWNlX2RlcGFydG1lbnQgPSBtZVNlcnZpY2UuZGF0YS5kZWZhdWx0X2RlcGFydG1lbnQgfHwgbWJsLm9mZmljZV9kZXBhcnRtZW50OwoKICAgICAgaWYgKGlzT0koKSkgewogICAgICAgIGlmIChtYmwuc2hpcF9tb2RlID09PSAnTENMJyB8fCBtYmwuc2hpcF9tb2RlID09PSAnRkFLJykgewogICAgICAgICAgaGJsLmN5X2Nmc19sb2NhdGlvbiA9IG1ibC5jZnNfbG9jYXRpb247CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgaGJsLmN5X2Nmc19sb2NhdGlvbiA9IG1ibC5jeV9sb2NhdGlvbjsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChpc09JKCkgfHwgaXNPRSgpKSB7CiAgICAgICAgaGJsLnNoaXBfbW9kZSA9IG1ibC5zaGlwX21vZGU7CiAgICAgICAgaGJsLml0X25vID0gbWJsLml0X25vOwogICAgICAgIGhibC5pdF9kYXRlID0gbWJsLml0X2RhdGU7CiAgICAgICAgaGJsLml0X2lzc3VlX2xvY2F0aW9uID0gbWJsLml0X2lzc3VlX2xvY2F0aW9uOwogICAgICAgIGhibC5ERUwgPSBtYmwuREVMOwogICAgICAgIGhibC5ERVRBID0gbWJsLkRFVEE7CiAgICAgICAgaGJsLkZERVNUID0gbWJsLkZERVNUOwogICAgICAgIGhibC5GRVRBID0gbWJsLkZFVEE7CgogICAgICAgIC8vIERvIG5vdCBmb2xsb3cgTUJMIHZhbHVlIGlmIEZBSyAoRkNDIFJlcXVlc3QpCiAgICAgICAgaGJsLnN2Y190ZXJtX2Zyb20gPSBtYmwuc2hpcF9tb2RlID09PSAnRkFLJyA/ICdDRicgOiBtYmwuc3ZjX3Rlcm1fZnJvbTsKICAgICAgICBoYmwuc3ZjX3Rlcm1fdG8gPSBtYmwuc2hpcF9tb2RlID09PSAnRkFLJyA/ICdDRicgOiBtYmwuc3ZjX3Rlcm1fdG87CiAgICAgIH0KCiAgICAgIGlmIChpc09JKCkpIHsKICAgICAgICBoYmwub2lfaW5mby5zdWJfYmxfbm8gPSBtYmwuc3ViX2JsX25vOwogICAgICAgIC8vIEZvciB0aGUgZm9ybSBkaXNwbGF5IG5hbWUKICAgICAgICBoYmwub2lfaW5mby5kaXNwbGF5X0RFTCA9IG1ibC5vaV9pbmZvLmRpc3BsYXlfREVMOwogICAgICAgIGhibC5vaV9pbmZvLmRpc3BsYXlfRkRFU1QgPSBtYmwub2lfaW5mby5kaXNwbGF5X0ZERVNUOwogICAgICB9CgogICAgICBpZiAoaXNPRSgpKSB7CiAgICAgICAgaGJsLm9lX2luZm8ub25fYm9hcmRfZGF0ZSA9IGdldFNlcnZlclN0ckZyb21EYXRlKGdldERhdGVGcm9tU2VydmVyU3RyKG1ibC5FVEQpKTsgIC8vIGRhdGV0aW1lIC0+IGRhdGUKICAgICAgICBoYmwub2VfaW5mby5ib29raW5nX25vID0gbWJsLm9lX2luZm8uY2Fycmllcl9ia2dfbm87CiAgICAgICAgaGJsLm9lX2luZm8uZGVsaXZlcnlfdG8gPSBtYmwub2VfaW5mby5kZWxpdmVyeV90bzsKICAgICAgICBoYmwub2VfaW5mby5lbXB0eV9waWNrdXAgPSBtYmwub2VfaW5mby5lbXB0eV9waWNrdXA7CiAgICAgICAgaGJsLm9lX2luZm8uYWdlbnQgPSBtYmwub3ZlcnNlYV9hZ2VudDsKICAgICAgICBoYmwub2VfaW5mby5pdG5fbm8gPSBtYmwub2VfaW5mby5pdG5fbm87CiAgICAgICAgaGJsLm9lX2luZm8uRVRBID0gbWJsLkVUQTsKICAgICAgICBoYmwub2VfaW5mby5QT0QgPSBtYmwuUE9EOwogICAgICAgIGhibC5vZV9pbmZvLlBPUiA9IG1ibC5QT1I7CiAgICAgICAgaGJsLm9lX2luZm8uUE9SX0VURCA9IG1ibC5QT1JfRVREOwogICAgICAgIGhibC5vZV9pbmZvLmlzX2NhbmNlbGVkID0gbWJsLmlzX2NhbmNlbGVkOwogICAgICAgIGhibC5vZV9pbmZvLmNhbmNlbF9ieSA9IG1ibC5jYW5jZWxfYnk7CiAgICAgICAgaGJsLm9lX2luZm8uY2FuY2VsX2RhdGUgPSBtYmwuY2FuY2VsX2RhdGU7CiAgICAgICAgaGJsLm9lX2luZm8uY2FuY2VsX3JlYXNvbiA9IG1ibC5jYW5jZWxfcmVhc29uOwogICAgICAgIC8vIEZvciB0aGUgZm9ybSBkaXNwbGF5IG5hbWUKICAgICAgICBoYmwub2VfaW5mby5kaXNwbGF5X1BPRCA9IG1ibC5kaXNwbGF5X1BPRDsKICAgICAgICBoYmwub2VfaW5mby5kaXNwbGF5X0RFTCA9IG1ibC5vZV9pbmZvLmRpc3BsYXlfREVMOwogICAgICAgIGhibC5vZV9pbmZvLmRpc3BsYXlfRkRFU1QgPSBtYmwub2VfaW5mby5kaXNwbGF5X0ZERVNUOwoKICAgICAgICBpZiAobWJsLmZpbGluZ19ubykgewogICAgICAgICAgaGJsLm9lX2luZm8uZG9jX25vID0gbWJsLmZpbGluZ19ubzsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIEZvciBYTEcKICAgICAgaWYgKGlzT0UoKSAmJiBpc1NoaXBwZXJVSU1vZGUoKSkgewogICAgICAgIGhibC5IQkxfTk8gPSB2bS5tYmwuTUJMX05POwogICAgICAgIHZtLmF1dG9HZW5IQkxOTyA9IGZhbHNlOwogICAgICB9CgogICAgICBpZiAoaXNBSSgpKSB7CiAgICAgICAgaGJsLmFpX2luZm8uc3RvcmFnZV9zdGFydF9kYXRlID0gbWJsLmFpX2luZm8uc3RvcmFnZV9zdGFydF9kYXRlOwogICAgICAgIGhibC5haV9pbmZvLmZyZWlnaHRfbG9jYXRpb24gPSBtYmwuYWlfaW5mby5mcmVpZ2h0X2xvY2F0aW9uOwogICAgICB9CgogICAgICBpZiAoaXNBRSgpKSB7CiAgICAgICAgaWYgKG1ibC5hZV9pbmZvLml0bl9ubykgewogICAgICAgICAgaGJsLmFlX2luZm8uaXRuX25vID0gbWJsLmFlX2luZm8uaXRuX25vOwogICAgICAgIH0KICAgICAgICBoYmwuYWVfaW5mby5pc3N1ZV9jYXJyaWVyID0gbWJsLmFlX2luZm8uaXNzdWVfY2FycmllcjsKICAgICAgICBoYmwuYWVfaW5mby5ib29raW5nX2RhdGUgPSBtYmwuYWVfaW5mby5ibF9kYXRlOwogICAgICAgIGhibC5hZV9pbmZvLmR2X2NhcnJpYWdlID0gbWJsLmFlX2luZm8uZHZfY2FycmlhZ2U7CiAgICAgICAgaGJsLmFlX2luZm8uZHZfY3VzdG9tcyA9IG1ibC5hZV9pbmZvLmR2X2N1c3RvbXM7CiAgICAgICAgaGJsLmFlX2luZm8uaW5zdXJhbmNlID0gbWJsLmFlX2luZm8uaW5zdXJhbmNlOwogICAgICAgIGhibC5hZV9pbmZvLm92ZXJzZWFfYWdlbnQgPSBtYmwub3ZlcnNlYV9hZ2VudDsKICAgICAgICBoYmwuYWVfaW5mby5pc19jYW5jZWxlZCA9IG1ibC5pc19jYW5jZWxlZDsKICAgICAgICBoYmwuYWVfaW5mby5jYW5jZWxfYnkgPSBtYmwuY2FuY2VsX2J5OwogICAgICAgIGhibC5hZV9pbmZvLmNhbmNlbF9kYXRlID0gbWJsLmNhbmNlbF9kYXRlOwogICAgICAgIGhibC5hZV9pbmZvLmNhbmNlbF9yZWFzb24gPSBtYmwuY2FuY2VsX3JlYXNvbjsKICAgICAgICAvLyBGb3IgdGhlIGZvcm0gZGlzcGxheSBuYW1lCiAgICAgICAgaGJsLmFlX2luZm8uZGlzcGxheV9BUE9MID0gbWJsLmFlX2luZm8uZGlzcGxheV9BUE9MOwogICAgICAgIGhibC5hZV9pbmZvLmRpc3BsYXlfQVBPRCA9IG1ibC5hZV9pbmZvLmRpc3BsYXlfQVBPRDsKICAgICAgfQoKICAgICAgcmV0dXJuIGhibDsKICAgIH0KCiAgICBmdW5jdGlvbiBidWlsZEhibEZyb21Bbm90aGVySGJsKGFub3RoZXJIYmwpIHsKICAgICAgdmFyIGhibCA9IGFuZ3VsYXIuY29weShhbm90aGVySGJsKTsKICAgICAgaGJsLmlkID0gdW5kZWZpbmVkOwogICAgICAvLyBUT0RPOiBmcm9udGVuZCBzaG91bGQgaW1wbGVtZW50IGNvcHkgaWdub3JlZCBmaWVsZHMKICAgICAgaGJsLkhCTF9OTyA9IG51bGw7CiAgICAgIGhibC5pc19wYXltZW50X2xvY2sgPSBmYWxzZTsKICAgICAgaGJsLmNvcHlfaGJsX25vID0gYW5vdGhlckhibC5IQkxfTk87CiAgICAgIGhibC5pc18zcmRfcGFydHlfaXNmX2ZpbGluZyA9IGZhbHNlOwogICAgICBoYmwuaXNfYmxvY2tfcGVybSA9IGZhbHNlOwogICAgICBoYmwuaXNfYmxvY2sgPSBmYWxzZTsKICAgICAgaGJsLmJsb2NrX2J5ID0gbnVsbDsKICAgICAgaGJsLmJsb2NrX2RhdGUgPSBudWxsOwogICAgICBoYmwubGlua193aF9yZWNlaXB0X2RldGFpbF9zZXQgPSBbXTsKICAgICAgaGJsLmludm9pY2Vfc2V0ID0gW107CiAgICAgIGhibC5lZGlfaW5mbyA9IG51bGw7CiAgICAgIGhibC5hZXNfaW5mbyA9IG51bGw7CgogICAgICBpZiAoaXNPSSgpIHx8IGlzT0UoKSkgewogICAgICAgIGhibC5wb19udW1fbGlzdCA9IG51bGw7CiAgICAgICAgaGJsLmlzZl9pZCA9IG51bGw7CiAgICAgICAgaGJsLkFNU19OTyA9IG51bGw7CiAgICAgICAgaGJsLklTRl9OTyA9IG51bGw7CiAgICAgIH0KCiAgICAgIGlmIChpc09JKCkpIHsKICAgICAgICBoYmwub2lfaW5mby5pc19ob2xkID0gZmFsc2U7CiAgICAgICAgaGJsLm9pX2luZm8uaG9sZF9ieSA9IG51bGw7CiAgICAgICAgaGJsLm9pX2luZm8uaG9sZF9hdCA9IG51bGw7CiAgICAgICAgaGJsLm9pX2luZm8uaG9sZF9yZWFzb24gPSBudWxsOwogICAgICAgIGhibC5vaV9pbmZvLmFycml2YWxfbm90aWNlX3NlbnRfZGF0ZSA9IG51bGw7CiAgICAgICAgaGJsLm9pX2luZm8uZGVsaXZlcnlfb3JkZXJfc2VudF9kYXRlID0gbnVsbDsKICAgICAgfQoKICAgICAgaWYgKGlzT0UoKSkgewogICAgICAgIGhibC5ib29raW5nX2luZm8gPSBudWxsOwogICAgICAgIGhibC5vZV9pbmZvLm5yYV9ubyA9IG51bGw7CiAgICAgIH0KCiAgICAgIGlmIChpc09JKCkgfHwgaXNBSSgpKSB7CiAgICAgICAgaGJsLml0X25vID0gbnVsbDsKICAgICAgICBoYmwuaXRfZGF0ZSA9IG51bGw7CiAgICAgICAgaGJsLml0X2lzc3VlX2xvY2F0aW9uID0gbnVsbDsKICAgICAgfQoKICAgICAgcmV0dXJuIGhibDsKICAgIH0KCgogICAgZnVuY3Rpb24gZG9BZGRIYmwoaGJsLCBhZnRlckFkZGVkKXsKICAgICAgaWYoIWJlZ2luQWRkSGJsKCkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZtLmhibF9saXN0LnB1c2goaGJsKTsKCiAgICAgIGNhY2hlSGJsRm9ybURhdGEoKTsKCiAgICAgIGFmdGVyQWRkZWQoKQogICAgICAgIC50aGVuKGVuZEFkZEhibCk7CiAgICB9CgogICAgZnVuY3Rpb24gc2xpZGVVcE1ibFBhbmUoKSB7CiAgICAgIHZtLmhpZGVNYmwgPSB0cnVlOwogICAgICB2YXIgJG1ibCA9ICQoJy5tYmxfYm9hcmQgLnBvcnRsZXQtYm9keScpOwogICAgICB2YXIgJG1ibFRvb2wgPSAkKCcubWJsX2JvYXJkIC5wb3J0bGV0LXRpdGxlIC50b29scyAuY29sbGFwc2UnKTsKICAgICAgJG1ibC5zbGlkZVVwKDIwMCk7CiAgICAgICRtYmxUb29sLnJlbW92ZUNsYXNzKCdjb2xsYXBzZScpLmFkZENsYXNzKCdleHBhbmQnKTsKCiAgICAgIHJldHVybiAkcS53aGVuKHRydWUpOwogICAgfQoKICAgIGZ1bmN0aW9uIHNsaWRlRG93bkxhc3RIYmxQYW5lKCkgewogICAgICB2YXIgaWR4ID0gdm0uaGJsX2xpc3QubGVuZ3RoIC0gMTsKICAgICAgcmV0dXJuICR0aW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdG9nZ2xlSGJsKGlkeCk7CiAgICAgIH0sIDEwMCk7CiAgICB9CgogICAgZnVuY3Rpb24gZm9jdXNPbkxhc3RIQkxOTygpIHsKICAgICAgdmFyIGlkeCA9IHZtLmhibF9saXN0Lmxlbmd0aCAtIDE7CiAgICAgIHJldHVybiAkdGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgJCgnaW5wdXRbbmFtZT0iSEJMX05PXycgKyBpZHggKyAnIl0nKS5mb2N1cygpOwogICAgICB9LCAxMDAwKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXREaXJ0eUlmRW5hYmxlQXV0b0dlbkhCTChoYmwpIHsKICAgICAgaWYgKGVuYWJsZUF1dG9HZW5IQkwoaGJsKSkgewogICAgICAgIGhibC5fX2hibEZvcm0uJHNldERpcnR5KCk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBiZWdpbkFkZEhibCgpIHsKICAgICAgaWYgKCEhdm0uYWRkaW5nSGJsKSB7CiAgICAgICAgJGxvZy5kZWJ1ZygnYWRkIGhibCAoc3RhcnQtLUJMT0NLRUQpJyk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgICRsb2cuZGVidWcoJ2FkZCBoYmwgKHN0YXJ0KScpOwogICAgICB2bS5hZGRpbmdIYmwgPSB0cnVlOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBmdW5jdGlvbiBlbmRBZGRIYmwoKSB7CiAgICAgICRsb2cuZGVidWcoJ2FkZCBoYmwgKGVuZCknKTsKICAgICAgdm0uYWRkaW5nSGJsID0gZmFsc2U7CiAgICB9CgogICAgZnVuY3Rpb24gZGVsZXRlTWJsKCl7CiAgICAgIG1vZGFsLm9wZW4oX1QuTVNHLkNPTkZJUk1fREVMRVRFX01CTCkKICAgICAgICAudGhlbihmdW5jdGlvbihyZXN1bHQpewogICAgICAgICAgaWYocmVzdWx0ICE9PSAnb2snKQogICAgICAgICAgICByZXR1cm47CgogICAgICAgICAgJGh0dHAuZGVsZXRlKGdlblVybChVUkwuU0hJUE1FTlQsIHtmaWxpbmdfbm86IHZtLmZpbGluZ05vfSkpCiAgICAgICAgICAgIC50aGVuKAogICAgICAgICAgICAgIGZ1bmN0aW9uKHJlc3BvbnNlKXsKICAgICAgICAgICAgICAgIFNob3dGZWVkYmFja01zZygnc3VjY2VzcycsIF9ULk1TRy5ERUxFVEVfU1VDQyk7CiAgICAgICAgICAgICAgICBmb3JjZVJlZGlyZWN0VG8oJy8nKTsKICAgICAgICAgICAgICB9LCBmdW5jdGlvbihlcnJSZXNwb25zZSl7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnJSZXNwb25zZS5kYXRhKTsKICAgICAgICAgICAgICAgIFNob3dGZWVkYmFja01zZygnZXJyb3InLCBfVC5NU0cuREVMRVRFX0ZBSUwpOwogICAgICAgICAgICB9KQogICAgICAgIH0pCiAgICB9CgogICAgZnVuY3Rpb24gZGVsZXRlSGJsKGhibCl7CiAgICAgIGNvbnNvbGUubG9nKCdkZWxldGUgaGJsJyk7CgogICAgICBtb2RhbC5vcGVuKF9ULk1TRy5DT05GSVJNX0RFTEVURV9IQkwpCiAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzdWx0KXsKICAgICAgICAgIGlmKHJlc3VsdCAhPT0gJ29rJykKICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgIGlmKGhibC5pZCA9PT0gdW5kZWZpbmVkKXsgIC8vIG5vIHJlY29yZCBpbiBkYXRhYmFzZSwgcmVtb3ZlIGl0IGRpcmVjdGx5CiAgICAgICAgICAgIFNob3dGZWVkYmFja01zZygnc3VjY2VzcycsIF9ULk1TRy5ERUxFVEVfU1VDQyk7CiAgICAgICAgICAgIGRvRGVsZXRlSGJsKGhibCk7CiAgICAgICAgICAgIGRvQ2xvc2VIYmwoKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgICRodHRwLmRlbGV0ZShnZW5VcmwoVVJMLlNISVBNRU5UX0hCTCwge2hibF9pZDogaGJsLmlkfSkpCiAgICAgICAgICAgIC50aGVuKAogICAgICAgICAgICAgIGZ1bmN0aW9uKHJlc3BvbnNlKXsKICAgICAgICAgICAgICAgIF91cGRhdGVOb3RpZmljYXRpb24oKTsKICAgICAgICAgICAgICAgIFNob3dGZWVkYmFja01zZygnc3VjY2VzcycsIF9ULk1TRy5ERUxFVEVfU1VDQyk7CiAgICAgICAgICAgICAgICBkb0RlbGV0ZUhibChoYmwpOwogICAgICAgICAgICAgICAgZG9DbG9zZUhibCgpOwogICAgICAgICAgICAgICAgY29uc29sZS5sb2cocmVzcG9uc2UuZGF0YSk7CiAgICAgICAgICAgICAgfSwgZnVuY3Rpb24oZXJyUmVzcG9uc2UpewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyUmVzcG9uc2UuZGF0YSk7CiAgICAgICAgICAgICAgICBTaG93RmVlZGJhY2tNc2coJ2Vycm9yJywgX1QuTVNHLkRFTEVURV9GQUlMKTsKICAgICAgICAgIH0pOwogICAgICAgIH0pCiAgICB9CgogICAgZnVuY3Rpb24gZG9EZWxldGVIYmwoaGJsKXsKICAgICAgdm0uaGJsX2xpc3QgPSBfKHZtLmhibF9saXN0KS5yZWplY3QoaGJsKS52YWx1ZSgpOwogICAgICBjYWNoZUhibEZvcm1EYXRhKCk7CiAgICB9CgogICAgZnVuY3Rpb24gY2FuRGV0YWNoSGJsKGhibCkgewogICAgICByZXR1cm4gIWRpc2FibGVEZXRhY2hIYmxUb29sdGlwKGhibCk7CiAgICB9CgogICAgZnVuY3Rpb24gZGlzYWJsZURldGFjaEhibFRvb2x0aXAoaGJsKSB7CiAgICAgIGlmIChoYmwuaXNfYmxvY2spIHsKICAgICAgICByZXR1cm4gbWJsQ29udHJvbGxlck1lc3NhZ2UuQ0FOX05PVF9ERVRBQ0hfQllfQkxPQ0s7CiAgICAgIH0KCiAgICAgIGlmIChoYmwuaXNfYW55X2xpbmtlZF9mcmVpZ2h0X2luX21ibCkgewogICAgICAgIHJldHVybiBtYmxDb250cm9sbGVyTWVzc2FnZS5DQU5fTk9UX0RFVEFDSF9CWV9BTllfRlJFSUdIVF9BU1NJR05fVE9fTUJMOwogICAgICB9CgogICAgICBpZiAoaGJsLm9lX2luZm8uaXNfY2FuY2VsZWQpIHsKICAgICAgICByZXR1cm4gbWJsQ29udHJvbGxlck1lc3NhZ2UuQ0FOX05PVF9ERVRBQ0hfQllfQ0FOQ0VMRUQ7CiAgICAgIH0KCiAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIGZ1bmN0aW9uIGRldGFjaEhibChoYmwpIHsKICAgICAgd2FybkZvcm1OZWVkU2F2ZSgpCiAgICAgICAgLnRoZW4oKCkgPT4gbW9kYWwub3BlbihfVC5NU0cuQ09ORklSTV9ERVRBQ0hfSEJMKSkKICAgICAgICAudGhlbigocmVzdWx0KSA9PiB7CiAgICAgICAgICBpZiAocmVzdWx0ICE9PSAnb2snKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICAkaHR0cC5wdXQoZ2VuVXJsKFVSTC5TSElQTUVOVF9IQkxfREVUQUNILCB7IGhibF9pZDogaGJsLmlkIH0pKQogICAgICAgICAgICAudGhlbigKICAgICAgICAgICAgICAocmVzcG9uc2UpID0+IHsKICAgICAgICAgICAgICAgIF91cGRhdGVOb3RpZmljYXRpb24oKTsKICAgICAgICAgICAgICAgIFNob3dGZWVkYmFja01zZygnc3VjY2VzcycsIF9ULk1TRy5ERVRBQ0hfU1VDQyk7CiAgICAgICAgICAgICAgICBkb0RlbGV0ZUhibChoYmwpOwogICAgICAgICAgICAgICAgZG9DbG9zZUhibCgpOwogICAgICAgICAgICAgICAgY29uc29sZS5sb2cocmVzcG9uc2UuZGF0YSk7CiAgICAgICAgICAgICAgfSwgKGVyclJlc3BvbnNlKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnJSZXNwb25zZS5kYXRhKTsKICAgICAgICAgICAgICAgIFNob3dGZWVkYmFja01zZygnZXJyb3InLCBfVC5NU0cuREVUQUNIX0ZBSUwpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gaXNGb3JtTmVlZFNhdmUob25seV9jaGVja19oYmwpIHsKICAgICAgdmFyIGlzX25ld19oYmwgPSBmYWxzZTsKICAgICAgdmFyIGlzX2hibF9mb3JtX2RpcnR5ID0gZmFsc2U7CgogICAgICBpZih2bS5jdXJIYmxJZHggIT09IG51bGwpIHsKICAgICAgICAvLyBIQkwgaXMgb3BlbmVkCiAgICAgICAgdmFyIGhibCA9IHZtLmhibF9saXN0W3ZtLmN1ckhibElkeF07CiAgICAgICAgaXNfbmV3X2hibCA9IChoYmwuaWQgPT09IHVuZGVmaW5lZCk7CiAgICAgICAgaXNfaGJsX2Zvcm1fZGlydHkgPSBoYmwuX19oYmxGb3JtICYmIGhibC5fX2hibEZvcm0uJGRpcnR5OwogICAgICB9CgogICAgICBpZighb25seV9jaGVja19oYmwgJiYgdm0uZ0Zvcm0uJGRpcnR5KSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYoaXNfbmV3X2hibCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIHJldHVybiBpc19oYmxfZm9ybV9kaXJ0eTsKICAgIH0KCiAgICBmdW5jdGlvbiB3YXJuRm9ybU5lZWRTYXZlKG9ubHlfY2hlY2tfaGJsKSB7CiAgICAgIGlmKGlzRm9ybU5lZWRTYXZlKG9ubHlfY2hlY2tfaGJsKSkKICAgICAgICByZXR1cm4gbW9kYWwub3BlbihfVC5NU0cuQ09ORklSTV9XSVRIT1VUX1NBVklORyk7CiAgICAgIGVsc2UKICAgICAgICByZXR1cm4gJHEud2hlbih0cnVlKTsKICAgIH0KCiAgICBmdW5jdGlvbiB0b2dnbGVIYmwoaWR4KSB7CiAgICAgIGNvbnNvbGUubG9nKGlkeCk7CiAgICAgIGlmKGlkeCA9PT0gdm0uY3VySGJsSWR4KQogICAgICAgIHJldHVybjsKCiAgICAgIHJldHVybiB3YXJuRm9ybU5lZWRTYXZlKHRydWUpCiAgICAgICAgLnRoZW4oKCkgPT4gaW52b2ljZVRwVXBkYXRlU2VydmljZS5jbGVhck5ld1RyYWRlUGFydG5lcigpKQogICAgICAgIC50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciB0b2dnbGVJZHggPSBpZHg7CgogICAgICAgICAgaWYodm0uY3VySGJsSWR4ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBoYmwgPSB2bS5oYmxfbGlzdFt2bS5jdXJIYmxJZHhdOwogICAgICAgICAgICBpZiAoaGJsLmlkID09PSB1bmRlZmluZWQpIHsgLy8gbmV3IEhCTCBjYXNlCiAgICAgICAgICAgICAgLy8gY3VycmVudCBIQkwgd2lsbCBiZSBkZWxldGVkLCBjaGVjayB0b2dnbGUgaW5kZXgKICAgICAgICAgICAgICB0b2dnbGVJZHggPSAoaWR4ID4gdm0uY3VySGJsSWR4KSA/IChpZHggLSAxKSA6IGlkeDsKICAgICAgICAgICAgICBkb0RlbGV0ZUhibChoYmwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYoaGJsLl9faGJsRm9ybS4kZGlydHkpIHsgIC8vIG1vZGlmaWVkCiAgICAgICAgICAgICAgcmVzdG9yZUhibENhY2hlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGRvVG9nZ2xlSGJsKHRvZ2dsZUlkeCk7CgogICAgICAgICAgd2FyblNoaXBtZW50QmxvY2sodm0uaGJsX2xpc3RbdG9nZ2xlSWR4XSk7CiAgICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gY29weUhibCgpIHsKICAgICAgc2F2ZUVkaXRpbmdIYmwoKQogICAgICAgIC50aGVuKG9uQ29udGludWUpOwoKICAgICAgZnVuY3Rpb24gb25Db250aW51ZSgpIHsKICAgICAgICBkb0FkZEhibEJ5Q29weSh2bS5jdXJIYmxJZHgpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gY29weUhibFRvT3RoZXJNYmwoaGJsKSB7CiAgICAgIHNhdmVFZGl0aW5nSGJsKCkKICAgICAgICAudGhlbigoKSA9PiBfb3BlblNlbGVjdENvcHlUb01ibE1vZGFsKGhibC50eXBlLCBoYmwubWJsKSkKICAgICAgICAudGhlbigocmVzdWx0KSA9PiB7CiAgICAgICAgICBjb25zdCBwb3N0RGF0YSA9IHsKICAgICAgICAgICAgZmlsaW5nX25vOiByZXN1bHQuZmlsaW5nTm8sCiAgICAgICAgICAgIGNvcHlfaW52X3R5cGU6IHJlc3VsdC5jb3B5SW52VHlwZXMsCiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuICRodHRwLnBvc3QoZ2VuVXJsKFVSTC5TSElQTUVOVF9IQkxfQ09QWV9UTywgeyBoYmxfaWQ6IGhibC5pZCB9KSwgcG9zdERhdGEpCiAgICAgICAgICAgIC50aGVuKCh7IGRhdGEgfSkgPT4gewogICAgICAgICAgICAgIGlmIChkYXRhKSB7CiAgICAgICAgICAgICAgICBTaG93RmVlZGJhY2tNc2coJ3N1Y2Nlc3MnLCBfVC5NU0cuQ09QWV9IQkxfVE9fTUJMX0NPTVBMRVRFKTsKICAgICAgICAgICAgICAgIF9vcGVuSGJsQ29waWVkU3VjY2Vzc01vZGFsKGRhdGEuZmlsaW5nX25vLCBkYXRhLmhibF9pZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAoZXJyUmVzcG9uc2UpID0+IHsKICAgICAgICAgICAgICBTaG93RmVlZGJhY2tNc2coJ2Vycm9yJywgX1QuTVNHLkNPUFlfSEJMX1RPX01CTF9GQUlMKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSk7CgogICAgICBmdW5jdGlvbiBfb3BlblNlbGVjdENvcHlUb01ibE1vZGFsKHNoaXBtZW50VHlwZSwgZmlsaW5nTm8pIHsKICAgICAgICBjb25zdCBtb2RhbEluc3RhbmNlID0gJHVpYk1vZGFsLm9wZW4oewogICAgICAgICAgLi4uTW9kYWxIYmxDb3B5VG9DdHJsLm1vZGFsT3B0aW9ucywKICAgICAgICAgIGFuaW1hdGlvbjogdHJ1ZSwKICAgICAgICAgIGJhY2tkcm9wOiAnc3RhdGljJywKICAgICAgICAgIHdpbmRvd1RlbXBsYXRlVXJsOiAnaGNXaW5kb3dUZW1wbGF0ZS5odG1sJywKICAgICAgICAgIHJlc29sdmU6IHsKICAgICAgICAgICAgc2hpcG1lbnRUeXBlOiAoKSA9PiBzaGlwbWVudFR5cGUsCiAgICAgICAgICAgIGZpbGluZ05vOiAoKSA9PiBmaWxpbmdObywKICAgICAgICAgIH0sCiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIG1vZGFsSW5zdGFuY2UucmVzdWx0OwogICAgICB9CgogICAgICBmdW5jdGlvbiBfb3BlbkhibENvcGllZFN1Y2Nlc3NNb2RhbChmaWxpbmdObywgaGJsSWQpIHsKICAgICAgICBjb25zdCBlbnRyeVVybCA9IFVSTC5IQkxfRU5UUllfVVJMLmZvcm1hdCgKICAgICAgICAgIGZpbGluZ05vLCBoYmxJZCwgQ09NUEFOWV9JTkZPLmlzX21ibF9hcmVhX2Rpc3BsYXlfZGVmYXVsdF9jbG9zZWQsCiAgICAgICAgKTsKICAgICAgICBjb25zdCB0aXRsZSA9IF9ULk1TRy5DT1BZX0hCTF9UT19NQkw7CiAgICAgICAgY29uc3QgbXNnID0gX1QuTVNHLkNPUFlfSEJMX1RPX01CTF9TVUNDOwoKICAgICAgICBjb25zdCBsaW5rcyA9IFt7CiAgICAgICAgICB1cmw6IGVudHJ5VXJsLAogICAgICAgICAgdGV4dDogZmlsaW5nTm8sCiAgICAgICAgfV07CgogICAgICAgIHJldHVybiBfb3BlbkNvbmZpcm1MaW5rc01vZGFsKHRpdGxlLCBtc2csIGxpbmtzKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIG1vdmVIYmxUb090aGVyTWJsKGhibCkgewogICAgICBzYXZlRWRpdGluZ0hibCgpCiAgICAgICAgLnRoZW4oKCkgPT4gX29wZW5TZWxlY3RDb3B5VG9NYmxNb2RhbChoYmwudHlwZSwgaGJsLm1ibCkpCiAgICAgICAgLnRoZW4oKHJlc3VsdCkgPT4gewogICAgICAgICAgY29uc3QgcG9zdERhdGEgPSB7CiAgICAgICAgICAgIGZpbGluZ19ubzogcmVzdWx0LmZpbGluZ05vLAogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybiAkaHR0cC5wb3N0KGdlblVybChVUkwuU0hJUE1FTlRfSEJMX01PVkVfVE8sIHtoYmxfaWQ6IGhibC5pZH0pLCBwb3N0RGF0YSkKICAgICAgICAgICAgLnRoZW4oKHsgZGF0YSB9KSA9PiB7CiAgICAgICAgICAgICAgaWYgKGRhdGEpIHsKICAgICAgICAgICAgICAgIFNob3dGZWVkYmFja01zZygnc3VjY2VzcycsIF9ULk1TRy5NT1ZFX0hCTF9UT19NQkxfQ09NUExFVEUpOwogICAgICAgICAgICAgICAgZG9EZWxldGVIYmwoaGJsKTsKICAgICAgICAgICAgICAgIGRvQ2xvc2VIYmwoKTsKICAgICAgICAgICAgICAgIF9vcGVuSGJsTW92ZWRTdWNjZXNzTW9kYWwoZGF0YS5maWxpbmdfbm8sIGRhdGEuaGJsX2lkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIChlcnJSZXNwb25zZSkgPT4gewogICAgICAgICAgICAgIFNob3dGZWVkYmFja01zZygnZXJyb3InLCBfVC5NU0cuTU9WRV9IQkxfVE9fTUJMX0ZBSUwpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgIGZ1bmN0aW9uIF9vcGVuU2VsZWN0Q29weVRvTWJsTW9kYWwoc2hpcG1lbnRUeXBlLCBmaWxpbmdObykgewogICAgICAgIGNvbnN0IG1vZGFsSW5zdGFuY2UgPSAkdWliTW9kYWwub3Blbih7CiAgICAgICAgICAuLi5Nb2RhbEhibE1vdmVUb0N0cmwubW9kYWxPcHRpb25zLAogICAgICAgICAgYW5pbWF0aW9uOiB0cnVlLAogICAgICAgICAgYmFja2Ryb3A6ICdzdGF0aWMnLAogICAgICAgICAgd2luZG93VGVtcGxhdGVVcmw6ICdoY1dpbmRvd1RlbXBsYXRlLmh0bWwnLAogICAgICAgICAgcmVzb2x2ZTogewogICAgICAgICAgICBzaGlwbWVudFR5cGU6ICgpID0+IHNoaXBtZW50VHlwZSwKICAgICAgICAgICAgZmlsaW5nTm86ICgpID0+IGZpbGluZ05vLAogICAgICAgICAgfSwKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gbW9kYWxJbnN0YW5jZS5yZXN1bHQ7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIF9vcGVuSGJsTW92ZWRTdWNjZXNzTW9kYWwoZmlsaW5nTm8sIGhibElkKSB7CiAgICAgICAgY29uc3QgZW50cnlVcmwgPSBVUkwuSEJMX0VOVFJZX1VSTC5mb3JtYXQoCiAgICAgICAgICBmaWxpbmdObywgaGJsSWQsIENPTVBBTllfSU5GTy5pc19tYmxfYXJlYV9kaXNwbGF5X2RlZmF1bHRfY2xvc2VkLAogICAgICAgICk7CiAgICAgICAgY29uc3QgdGl0bGUgPSBfVC5NU0cuTU9WRV9IQkxfVE9fTUJMOwogICAgICAgIGNvbnN0IG1zZyA9IF9ULk1TRy5NT1ZFX0hCTF9UT19NQkxfU1VDQzsKCiAgICAgICAgY29uc3QgbGlua3MgPSBbewogICAgICAgICAgdXJsOiBlbnRyeVVybCwKICAgICAgICAgIHRleHQ6IGZpbGluZ05vLAogICAgICAgIH1dOwoKICAgICAgICByZXR1cm4gX29wZW5Db25maXJtTGlua3NNb2RhbCh0aXRsZSwgbXNnLCBsaW5rcyk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBfb3BlbkNvbmZpcm1MaW5rc01vZGFsKHRpdGxlLCBtc2csIGxpbmtzKSB7CiAgICAgIHJldHVybiAkdWliTW9kYWwub3Blbih7CiAgICAgICAgYW5pbWF0aW9uOiB0cnVlLAogICAgICAgIHRlbXBsYXRlVXJsOiAnY29uZmlybUxpbmtzTW9kYWxDb250ZW50Lmh0bWwnLAogICAgICAgIHdpbmRvd1RlbXBsYXRlVXJsOiAnaGNXaW5kb3dUZW1wbGF0ZS5odG1sJywKICAgICAgICBjb250cm9sbGVyOiAnY29uZmlybUxpbmtzTW9kYWxJbnN0YW5jZUN0cmwnLAogICAgICAgIGJhY2tkcm9wOiAnc3RhdGljJywKICAgICAgICByZXNvbHZlOiB7CiAgICAgICAgICB0aXRsZTogKCkgPT4gdGl0bGUsCiAgICAgICAgICBtc2c6ICgpID0+IG1zZywKICAgICAgICAgIGxpbmtzOiAoKSA9PiBsaW5rcywKICAgICAgICAgIGNvbmZpcm1CdXR0b25UZXh0OiAoKSA9PiBfVC5NU0cuQ0xPU0UsCiAgICAgICAgfSwKICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gY2xvc2VIYmwoKSB7CiAgICAgIHdhcm5Gb3JtTmVlZFNhdmUodHJ1ZSkKICAgICAgICAudGhlbigoKSA9PiBpbnZvaWNlVHBVcGRhdGVTZXJ2aWNlLmNsZWFyTmV3VHJhZGVQYXJ0bmVyKCkpCiAgICAgICAgLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYodm0uY3VySGJsSWR4ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBoYmwgPSB2bS5oYmxfbGlzdFt2bS5jdXJIYmxJZHhdOwogICAgICAgICAgICBpZiAoaGJsLmlkID09PSB1bmRlZmluZWQpIHsgLy8gbmV3IEhCTCBjYXNlCiAgICAgICAgICAgICAgdmFyIGlkeCA9IHZtLmN1ckhibElkeDsKICAgICAgICAgICAgICBkb0Nsb3NlSGJsKCk7CiAgICAgICAgICAgICAgZG9EZWxldGVIYmwoaGJsKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZihoYmwuX19oYmxGb3JtLiRkaXJ0eSkgeyAgLy8gbW9kaWZpZWQKICAgICAgICAgICAgICByZXN0b3JlSGJsQ2FjaGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZG9DbG9zZUhibCgpOwogICAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIGRvQ2xvc2VIYmwoKSB7CiAgICAgIHNldEN1ckhibElkeChudWxsKTsKCiAgICAgIHZhciAkbGlua1NpYmxpbmcgPSAkKCcuaGJsX3NtJyk7CiAgICAgIHZhciAkYm9hcmRTaWJsaW5nID0gJCgnLmhibF9ib2FyZCcpOwogICAgICAkbGlua1NpYmxpbmcucmVtb3ZlQ2xhc3MoJ3NlbGVjdGVkJyk7CiAgICAgICRib2FyZFNpYmxpbmcuc2xpZGVVcCg1MDApOwogICAgfQoKICAgIGZ1bmN0aW9uIGRvVG9nZ2xlSGJsKGlkeCwgaXNfYW5pbSkgewogICAgICBpc19hbmltID0gaXNfYW5pbSA9PT0gdW5kZWZpbmVkID8gdHJ1ZSA6IGlzX2FuaW07CgogICAgICAvLyBjYWNoZSBkYXRhCiAgICAgIHNldEN1ckhibElkeChpZHgpOwogICAgICB1cGRhdGVIYmxDYWNoZSgpOwogICAgICBjb25maWdJbnZvaWNlVHBVcGRhdGVTZXJ2aWNlKCk7CgogICAgICB2YXIgaGJsID0gdm0uaGJsX2xpc3Rbdm0uY3VySGJsSWR4XTsKCiAgICAgIGlmIChpc09JKCkgfHwgaXNPRSgpKSB7CiAgICAgICAgdm0udHJhZGVQYXJ0bmVyUmVsYXRpb24uaGJsX2NvbnNpZ25lZS5iZWZvcmVWYWx1ZSA9IHZtLmhibF9saXN0W2lkeF0uY29uc2lnbmVlOwogICAgICAgIHZtLnRyYWRlUGFydG5lclJlbGF0aW9uLmhibF9zaGlwcGVyLmJlZm9yZVZhbHVlID0gdm0uaGJsX2xpc3RbaWR4XS5zaGlwcGVyOwogICAgICAgIHZtLnRyYWRlUGFydG5lclJlbGF0aW9uLmhibF9jdXN0b21lci5iZWZvcmVWYWx1ZSA9IHZtLmhibF9saXN0W2lkeF0uY3VzdG9tZXI7CiAgICAgIH0KCiAgICAgIGlmIChoYmwuaWQgaW4gdm0uaGJsUG9zdFNhdmluZykgewogICAgICAgIC8vIGFwcGx5IGhibFBvc3RTYXZlaW5nIGRhdGEgdG8gY3VycmVudCBIQkwKCiAgICAgICAgdm0uaGJsUG9zdFNhdmluZ1toYmwuaWRdLmZvckVhY2goIG9iaiA9PiB7CiAgICAgICAgICBzeW5jTUJMRmllbGRUb0hCTChvYmouZmllbGQsIG51bGwsIG9iai5jb25kaXRpb25DaG9pY2VJbmRleCk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIFJlbW92ZSBjdXJyZW50IG9wZW5lZCBIQkwgaWQgdGhlIGxpc3QgdGhhdCBuZWVkIHRvIHN5bmMgZnJvbSBNQkwKICAgICAgICBkZWxldGUgdm0uaGJsUG9zdFNhdmluZ1toYmwuaWRdOwogICAgICB9CgogICAgICBpZiAoaGJsLmlkKSB7CiAgICAgICAgdm0uaGJsSGlzdG9yeUV4aXN0UXVlcmllci5jaGVja0V4aXN0KGhibC5pZCk7CiAgICAgIH0KCiAgICAgICR0aW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAkc2NvcGUuJGJyb2FkY2FzdCgndG9nZ2xlLWhibCcsIHtpbmRleDogaWR4LCBpc0FuaW06IGlzX2FuaW19KTsKCiAgICAgICAgLy8gQWR2YW5jZWQKICAgICAgICAkKCcuaW5wdXQtaGlkZS1oYmwtJyArIGlkeCkuaGlkZSgpOwoKICAgICAgICB2bS5ub3RpZmljYXRpb25IZWxwZXIuc2hvd01CTEFuZEhCTE5vdGlmaWNhdGlvbih2bS5oYmxfbGlzdFtpZHhdLmlkKTsKCiAgICAgICAgaWYgKGlzT0koKSAmJiB2bS5oYmxfbGlzdFtpZHhdLm9pX2luZm8uaXNfaG9sZCkgewogICAgICAgICAgdmFyIG1zZyA9IGdldEhvbGRNZXNzYWdlKHZtLmhibF9saXN0W2lkeF0ub2lfaW5mbywgdHJ1ZSk7CiAgICAgICAgICBTaG93T25Ib2xkSEJMTXNnKG1zZyk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRDdXJIYmxJZHgoaW5kZXgpIHsKICAgICAgaWYgKGluZGV4ICE9PSB2bS5jdXJIYmxJZHgpIHsKICAgICAgICB2bS5wcmV2aW91c0hibElkeCA9IHZtLmN1ckhibElkeDsKICAgICAgICB2bS5jdXJIYmxJZHggPSBpbmRleDsKICAgICAgfQogICAgICB2bS50YXJnZXRIYmxJZCA9IF8uZ2V0KHZtLmhibF9saXN0LCBbaW5kZXgsICdpZCddKTsKICAgICAgdXBkYXRlQ3VycmVudFVybCgpOwogICAgfQoKICAgIGZ1bmN0aW9uIHVwZGF0ZUN1cnJlbnRVcmwoKSB7CiAgICAgIGxldCBoYmwgPSB2bS5oYmxfbGlzdFt2bS5jdXJIYmxJZHhdOwogICAgICBsZXQgaGJsSWQgPSBoYmwgPyBoYmwuaWQgOiBudWxsOwogICAgICAkbG9jYXRpb24KICAgICAgICAuc2VhcmNoKCdoYmwnLCBoYmxJZCkKICAgICAgICAucmVwbGFjZSgpOwogICAgfQoKICAgIC8qKgogICAgICogV2Ugd2FudCB0byB1c2UgbmctaWYgdG8gb3B0aW1pemUgcGVyZm9ybWFuY2Ugd2hlbiB0aGVyZSBhcmUgbG90cyBvZiBIQkxzCiAgICAgKiBidXQgdGhlIGhibF9ib2FyZCBoYXMgaXRzIGFuaW1hdGlvbiwgc2hvdWxkIG5vdCBiZSBoaWRlIGltbWVkaWF0ZWx5LAogICAgICogc28gd2UgbmVlZCB0byByZW5kZXIgdGhlIHJlY2VudGx5IDIgSEJMcwogICAgICovCiAgICBmdW5jdGlvbiBpc0hibE5lZWRSZW5kZXJlZChpbmRleCkgewogICAgICByZXR1cm4gdm0uY3VySGJsSWR4ID09PSBpbmRleCB8fCB2bS5wcmV2aW91c0hibElkeCA9PT0gaW5kZXg7CiAgICB9CgogICAgZnVuY3Rpb24gdG9nZ2xlTWJsRGlzcGxheVN0YXR1cygpIHsKICAgICAgdm0uaGlkZU1ibCA9ICF2bS5oaWRlTWJsOwogICAgfQoKICAgIGZ1bmN0aW9uIGRvT3Blbk1ibCgpIHsgIC8vIHJlZmVyZW5jZSBmcm9tIG1ldHJvbmljLmpzCiAgICAgIHZtLmhpZGVNYmwgPSBmYWxzZTsKICAgICAgdmFyICRjb2xsYXBzZSA9ICQoJyNtYmxGb3JtID4gLnBvcnRsZXQtdGl0bGUgLmNvbGxhcHNlJyk7CiAgICAgIHZhciAkYm9hcmQgPSAkKCcjbWJsRm9ybSA+IC5wb3J0bGV0LWJvZHknKTsKICAgICAgJGNvbGxhcHNlLnJlbW92ZUNsYXNzKCJleHBhbmQiKS5hZGRDbGFzcygiY29sbGFwc2UiKTsKICAgICAgJGJvYXJkLnNsaWRlRG93bigyMDApOwogICAgfQoKICAgIGZ1bmN0aW9uIHRvZ2dsZU1CTFJlY2VpdmVkKCkgewogICAgICBpZighdm0ubWJsLmlzX3JlbGVhc2VkKQogICAgICAgIHZtLm1ibC5yZWxlYXNlX2RhdGUgPSBudWxsOwogICAgICBlbHNlCiAgICAgICAgdm0ubWJsLnJlbGVhc2VfZGF0ZSA9IHRvZGF5OwogICAgfQoKICAgIGZ1bmN0aW9uIHRvZ2dsZU9ibFJlY2VpdmVkKGJsKXsKICAgICAgaWYoIWJsLmlzX29yaWdpbmFsX2JsX3JlY2VpdmVkKQogICAgICAgIGJsLm9yaWdpbmFsX2JsX3JlY2VpdmVkX2RhdGUgPSBudWxsOwogICAgICBlbHNlCiAgICAgICAgYmwub3JpZ2luYWxfYmxfcmVjZWl2ZWRfZGF0ZSA9IHRvZGF5OwogICAgfQoKICAgIGZ1bmN0aW9uIHRvZ2dsZVRlbGV4UmVsZWFzZVJlY2VpdmVkKGJsKXsKICAgICAgaWYoIWJsLmlzX3RlbGV4X3JlbGVhc2VfcmVjZWl2ZWQpCiAgICAgICAgYmwudGVsZXhfcmVsZWFzZV9yZWNlaXZlZF9kYXRlID0gbnVsbDsKICAgICAgZWxzZQogICAgICAgIGJsLnRlbGV4X3JlbGVhc2VfcmVjZWl2ZWRfZGF0ZSA9IHRvZGF5OwogICAgfQoKICAgIGZ1bmN0aW9uIHRvZ2dsZUhCTFJlbGVhc2VkKGhibCkgewogICAgICBpZighaGJsLmlzX3JlbGVhc2VkKXsKICAgICAgICBoYmwucmVsZWFzZV9kYXRlID0gbnVsbDsKICAgICAgICBoYmwucmVsZWFzZV9ieSA9IG51bGw7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgZW50cnlIZWxwZXJTZXJ2aWNlLnRyYWRlUGFydG5lckNoZWNrQ3JlZGl0KCdjdXN0b21lcicsIGhibC5jdXN0b21lcikKICAgICAgICAgIC50aGVuKHByb2Nlc3MpCiAgICAgICAgICAuY2F0Y2gocmV2ZXJ0KTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gcHJvY2VzcygpIHsKICAgICAgICBoYmwucmVsZWFzZV9kYXRlID0gZ2V0U2VydmVyU3RyRnJvbURhdGUobmV3IERhdGUoKSwgJ2RheXN0YXJ0Jyk7CiAgICAgICAgaGJsLnJlbGVhc2VfYnkgPSBtZVNlcnZpY2UuZGF0YTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gcmV2ZXJ0KCkgewogICAgICAgIGhibC5pc19yZWxlYXNlZCA9IGZhbHNlOwogICAgICAgIGhibC5yZWxlYXNlX2RhdGUgPSBudWxsOwogICAgICAgIGhibC5yZWxlYXNlX2J5ID0gbnVsbDsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHRvZ2dsZU1CTFJlbGVhc2VkKG1ibCkgewogICAgICBpZiAoIW1ibC5pc19yZWxlYXNlZCkgewogICAgICAgIG1ibC5yZWxlYXNlX2RhdGUgPSBudWxsOwogICAgICAgIG1ibC5yZWxlYXNlX2J5ID0gbnVsbDsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICBtYmwucmVsZWFzZV9kYXRlID0gZ2V0U2VydmVyU3RyRnJvbURhdGUobmV3IERhdGUoKSk7CiAgICAgICAgbWJsLnJlbGVhc2VfYnkgPSBtZVNlcnZpY2UuZGF0YTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIG9uQWlyRXhwb3J0TWJsSXRuTm9DaGFuZ2UoKSB7CiAgICAgIGlmICh2bS5tYmwuYWVfaW5mby5pdG5fbm8pIHsKICAgICAgICAvLyBHRjFWSVAtNDYxNjogZG8gbm90IHN5bmMgdG8gSEFXQihzKSB3aGlsZSBjbGVhcmluZyBiZWNhdXNlIGN1c3RvbWVyIHRoaW5rIGl0cyBhbm5veWluZwogICAgICAgIC8vIHRoYXQgdGhlIHByb21wdCBzaG93cyBlYWNoIHRpbWUgdGhleSB3YW50IHRvIGNsZWFyIHRoZSBkZWZhdWx0IE1BV0IgSVROIE5vLgogICAgICAgIC8vIGhvd2V2ZXIgdGhleSB1c3VhbGx5IHdhbnQgdG8ga2VlcCB0aGUgcHJlLWVkaXRlZCBJVE4gTm8uIG9mIEhBV0IocykKICAgICAgICBzeW5jTUJMRmllbGRUb0FsbEhCTCgnYWVfaW5mby5pdG5fbm8nKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHRvZ2dsZU1CTENhbmNlbGxlZCgpIHsKICAgICAgaWYgKCF2bS5tYmwuaXNfY2FuY2VsZWQpIHsKICAgICAgICB2bS5tYmwuY2FuY2VsX2RhdGUgPSBudWxsOwogICAgICAgIHZtLm1ibC5jYW5jZWxfYnkgPSBudWxsOwogICAgICAgIHZtLm1ibC5jYW5jZWxfcmVhc29uID0gbnVsbDsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25maXJtVXNlclN5bmNDYW5jZWxUb0FsbEhibCgpCiAgICAgICAgICAudGhlbigoKSA9PiB7CiAgICAgICAgICAgIHZtLm1ibC5jYW5jZWxfZGF0ZSA9IHRvZGF5OwogICAgICAgICAgICB2bS5tYmwuY2FuY2VsX2J5ID0gbWVTZXJ2aWNlLmRhdGE7CiAgICAgICAgICAgIGRvU3luY01CTEZpZWxkVG9BbGxIQkwoWydpc19jYW5jZWxlZCcsICdjYW5jZWxfZGF0ZScsICdjYW5jZWxfYnknLCAnY2FuY2VsX3JlYXNvbiddKTsKICAgICAgICAgIH0pCiAgICAgICAgICAuY2F0Y2goKCkgPT4gewogICAgICAgICAgICB2bS5tYmwuaXNfY2FuY2VsZWQgPSBmYWxzZTsgLy8gcm9sbGJhY2sKICAgICAgICAgIH0pOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gY29uZmlybVVzZXJTeW5jQ2FuY2VsVG9BbGxIYmwoKSB7CiAgICAgIGlmICh2bS5oYmxfbGlzdC5sZW5ndGggPCAxKSB7CiAgICAgICAgcmV0dXJuICRxLnJlc29sdmUoKTsKICAgICAgfQogICAgICByZXR1cm4gbW9kYWwub3Blblllc05vQ29uZmlybSgnJywgdm0ubWVzc2FnZS5DT05GSVJNX1NZTkNfTUJMX0NBTkNFTF9UT19BTExfSEJMKTsKICAgIH0KCiAgICBmdW5jdGlvbiB0b2dnbGVPRUhCTENhbmNlbGxlZChoYmwpIHsKICAgICAgY29uc3Qgb2VJbmZvID0gaGJsLm9lX2luZm87CgogICAgICBpZiAoIW9lSW5mby5pc19jYW5jZWxlZCkgewogICAgICAgIG9lSW5mby5jYW5jZWxfZGF0ZSA9IG51bGw7CiAgICAgICAgb2VJbmZvLmNhbmNlbF9ieSA9IG51bGw7CiAgICAgICAgb2VJbmZvLmNhbmNlbF9yZWFzb24gPSBudWxsOwogICAgICB9IGVsc2UgewogICAgICAgIG9lSW5mby5jYW5jZWxfZGF0ZSA9IHRvZGF5OwogICAgICAgIG9lSW5mby5jYW5jZWxfYnkgPSBtZVNlcnZpY2UuZGF0YTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHRvZ2dsZUFFSEJMQ2FuY2VsbGVkKGhibCkgewogICAgICBjb25zdCBhZUluZm8gPSBoYmwuYWVfaW5mbzsKCiAgICAgIGlmICghYWVJbmZvLmlzX2NhbmNlbGVkKSB7CiAgICAgICAgYWVJbmZvLmNhbmNlbF9kYXRlID0gbnVsbDsKICAgICAgICBhZUluZm8uY2FuY2VsX2J5ID0gbnVsbDsKICAgICAgICBhZUluZm8uY2FuY2VsX3JlYXNvbiA9IG51bGw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYWVJbmZvLmNhbmNlbF9kYXRlID0gdG9kYXk7CiAgICAgICAgYWVJbmZvLmNhbmNlbF9ieSA9IG1lU2VydmljZS5kYXRhOwogICAgICB9CiAgICB9CgoKICAgIGZ1bmN0aW9uIG9wZW5Db25maXJtTWJsU3luY0RpYWxvZyguLi5maWVsZHMpIHsKICAgICAgLy8gVE9ETzogcmVmYWN0b3IgZW50cnlIZWxwZXJTZXJ2aWNlIHRvIGV4dHJhY3QgTUIvTCBkYXRhIHN5bmNpbmcgbG9naWMKICAgICAgY29uc3QgY3VySGJsID0gdm0uaGJsX2xpc3Rbdm0uY3VySGJsSWR4XTsKICAgICAgY29uc3QgY29uZmlybU1zZ3MgPSBmaWVsZHMKICAgICAgICAubWFwKGYgPT4gZW50cnlIZWxwZXJTZXJ2aWNlLmdldE1ibFN5bmNIYmxDb25maXJtTXNnKGYsIGN1ckhibCkpCiAgICAgICAgLmZpbHRlcihmID0+IGYpOwoKICAgICAgaWYgKGVudHJ5SGVscGVyU2VydmljZS5oYXNNYmxTeW5jQ29uZGljdGlvbk1hdGNoZWQoZmllbGRzWzBdLCBjdXJIYmwpKSB7CiAgICAgICAgY29uc3QgZmllbGRzU3RyaW5nID0gY29uZmlybU1zZ3Muam9pbignLCAnKTsKICAgICAgICBjb25zdCBtYmxXb3JkaW5nID0gaXNBSSgpIHx8IGlzQUUoKSA/IF9ULk1TRy5NQVdCIDogX1QuTVNHLk1CTDsKICAgICAgICBjb25zdCBoYmxXb3JkaW5nID0gaXNBSSgpIHx8IGlzQUUoKSA/IF9ULk1TRy5IQVdCIDogX1QuTVNHLkhCTDsKCiAgICAgICAgY29uc3QgbW9kYWxJbnN0YW5jZSA9ICR1aWJNb2RhbC5vcGVuKHsKICAgICAgICAgIGFuaW1hdGlvbjogdHJ1ZSwKICAgICAgICAgIHRlbXBsYXRlVXJsOiAnc3luY01ibFRvSGJsc0FkdmFuY2VkTW9kYWxDb250ZW50Lmh0bWwnLAogICAgICAgICAgd2luZG93VGVtcGxhdGVVcmw6ICdoY1dpbmRvd1RlbXBsYXRlLmh0bWwnLAogICAgICAgICAgY29udHJvbGxlcjogJ3N5bmNNYmxUb0hibHNBZHZhbmNlZE1vZGFsQ3RybCcsCiAgICAgICAgICByZXNvbHZlOiB7CiAgICAgICAgICAgIGZpZWxkczogKCkgPT4gZmllbGRzU3RyaW5nLAogICAgICAgICAgICBkZWZhdWx0TXNnOiAoKSA9PiBjcmVhdGVTdHJpbmdGb3JtYXR0ZXIoX1QuTVNHLkNPTkZJUk1fU1lOQykuZm9ybWF0KG1ibFdvcmRpbmcsIGZpZWxkc1N0cmluZywgaGJsV29yZGluZywgZmllbGRzU3RyaW5nKSwKICAgICAgICAgICAgbXNnVGVtcGxhdGU6ICgpID0+IGVudHJ5SGVscGVyU2VydmljZS5nZXRNYmxTeW5jSGJsTXNnVGVtcGxhdGUoZmllbGRzWzBdLCBjdXJIYmwpLAogICAgICAgICAgICBjb25kaXRpb25DaG9pY2VzOiAoKSA9PiBlbnRyeUhlbHBlclNlcnZpY2UuZ2V0TWJsU3luY0hibENvbmRpdGlvbkNob2ljZXMoZmllbGRzWzBdKSwKICAgICAgICAgIH0sCiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiBtb2RhbEluc3RhbmNlLnJlc3VsdDsKICAgICAgfQoKICAgICAgcmV0dXJuICRxLnJlc29sdmUoKTsgLy8gRG8gc3luYyB3aXRob3V0IGRpYWxvZyBjb25maXJtYXRpb24KICAgIH0KCiAgICBmdW5jdGlvbiBzeW5jTUJMRmllbGRUb0FsbEhCTCguLi5maWVsZHMpIHsKICAgICAgY29uc3QgY3VySGJsID0gdm0uaGJsX2xpc3Rbdm0uY3VySGJsSWR4XTsKICAgICAgY29uc3QgY29uZmlybU1zZ3MgPSBmaWVsZHMKICAgICAgICAubWFwKGYgPT4gZW50cnlIZWxwZXJTZXJ2aWNlLmdldE1ibFN5bmNIYmxDb25maXJtTXNnKGYsIGN1ckhibCkpCiAgICAgICAgLmZpbHRlcihmID0+IGYpOwoKICAgICAgaWYgKGNvbmZpcm1Nc2dzLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25zdCBmaWVsZHNTdHJpbmcgPSBjb25maXJtTXNncy5qb2luKCcsICcpOwogICAgICAgIGNvbnN0IG1ibFdvcmRpbmcgPSBpc0FJKCkgfHwgaXNBRSgpID8gX1QuTVNHLk1BV0IgOiBfVC5NU0cuTUJMOwogICAgICAgIGNvbnN0IGhibFdvcmRpbmcgPSBpc0FJKCkgfHwgaXNBRSgpID8gX1QuTVNHLkhBV0IgOiBfVC5NU0cuSEJMOwoKICAgICAgICBjb25zdCBtb2RhbEluc3RhbmNlID0gJHVpYk1vZGFsLm9wZW4oewogICAgICAgICAgYW5pbWF0aW9uOiB0cnVlLAogICAgICAgICAgdGVtcGxhdGVVcmw6ICdzeW5jTWJsVG9IYmxzQWR2YW5jZWRNb2RhbENvbnRlbnQuaHRtbCcsCiAgICAgICAgICB3aW5kb3dUZW1wbGF0ZVVybDogJ2hjV2luZG93VGVtcGxhdGUuaHRtbCcsCiAgICAgICAgICBjb250cm9sbGVyOiAnc3luY01ibFRvSGJsc0FkdmFuY2VkTW9kYWxDdHJsJywKICAgICAgICAgIHJlc29sdmU6IHsKICAgICAgICAgICAgZmllbGRzOiAoKSA9PiBmaWVsZHNTdHJpbmcsCiAgICAgICAgICAgIGRlZmF1bHRNc2c6ICgpID0+IGNyZWF0ZVN0cmluZ0Zvcm1hdHRlcihfVC5NU0cuQ09ORklSTV9TWU5DKS5mb3JtYXQobWJsV29yZGluZywgZmllbGRzU3RyaW5nLCBoYmxXb3JkaW5nLCBmaWVsZHNTdHJpbmcpLAogICAgICAgICAgICBtc2dUZW1wbGF0ZTogKCkgPT4gZW50cnlIZWxwZXJTZXJ2aWNlLmdldE1ibFN5bmNIYmxNc2dUZW1wbGF0ZShmaWVsZHNbMF0sIGN1ckhibCksCiAgICAgICAgICAgIGNvbmRpdGlvbkNob2ljZXM6ICgpID0+IGVudHJ5SGVscGVyU2VydmljZS5nZXRNYmxTeW5jSGJsQ29uZGl0aW9uQ2hvaWNlcyhmaWVsZHNbMF0pLAogICAgICAgICAgfSwKICAgICAgICB9KTsKCiAgICAgICAgbW9kYWxJbnN0YW5jZS5yZXN1bHQKICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIGRvU3luY01CTEZpZWxkVG9BbGxIQkwoZmllbGRzLCByZXNwb25zZS5jb25kaXRpb25DaG9pY2VJbmRleCk7CiAgICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBkb1N5bmNNQkxGaWVsZFRvQWxsSEJMKGZpZWxkcyk7CiAgICB9CgogICAgZnVuY3Rpb24gZG9TeW5jTUJMRmllbGRUb0FsbEhCTChmaWVsZHMsIGNvbmRpdGlvbkNob2ljZUluZGV4KSB7CiAgICAgIGxldCBpc1N5bmNTb21ldGhpbmcgPSBmYWxzZTsKCiAgICAgIGZpZWxkcy5mb3JFYWNoKGZ1bmN0aW9uIChmaWVsZCkgewogICAgICAgIGlzU3luY1NvbWV0aGluZyB8PSBzeW5jTUJMRmllbGRUb0hCTChmaWVsZCwgbnVsbCwgY29uZGl0aW9uQ2hvaWNlSW5kZXgpOwogICAgICAgIGlzU3luY1NvbWV0aGluZyB8PSB1cGRhdGVIYmxQb3N0U2F2aW5nKGZpZWxkLCBjb25kaXRpb25DaG9pY2VJbmRleCk7CiAgICAgIH0pOwoKICAgICAgaWYgKGlzU3luY1NvbWV0aGluZykgewogICAgICAgIFNob3dGZWVkYmFja01zZygnaW5mbycsIF9ULk1TRy5DSEFOR0VfQVBQTFlfVE9fSEJMKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHN5bmNNQkxGaWVsZFRvSEJMKGZpZWxkLCBoYmwsIGNvbmRpdGlvbkNob2ljZUluZGV4KSB7CiAgICAgIGhibCA9IGhibCB8fCB2bS5oYmxfbGlzdFt2bS5jdXJIYmxJZHhdOwogICAgICAvLyBTeW5jIE1CTCdzIGZpZWxkIHRvIEhCTCBpbiBVSSBhbmQgc2V0IEhCTCBkaXJ0eQogICAgICBpZiAoZW50cnlIZWxwZXJTZXJ2aWNlLm1ibERhdGFDaGFuZ2VIYW5kbGVyKGZpZWxkLCBoYmwsIGNvbmRpdGlvbkNob2ljZUluZGV4KSkgewogICAgICAgIGhibC5fX2hibEZvcm0uJHNldERpcnR5KCk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIGZ1bmN0aW9uIHVwZGF0ZUhibFBvc3RTYXZpbmcoZmllbGQsIGNvbmRpdGlvbkNob2ljZUluZGV4KSB7CiAgICAgIC8vIFVwZGF0ZSB0aGUgZmllbGRzIG9mIGVhY2ggSEJMIHdoaWNoIG5lZWQgdG8gc3luYyBzb21lIGZpZWxkcyBmcm9tIE1CTAogICAgICBsZXQgY2hhbmdlZFNvbWV0aGluZyA9IGZhbHNlOwoKICAgICAgdm0uaGJsX2xpc3QuZm9yRWFjaCgoaGJsLCBpZHgpID0+IHsKICAgICAgICBpZiAoaWR4ID09PSB2bS5jdXJIYmxJZHgpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICghdm0uaGJsUG9zdFNhdmluZ1toYmwuaWRdKSB7CiAgICAgICAgICB2bS5oYmxQb3N0U2F2aW5nW2hibC5pZF0gPSBbXTsKICAgICAgICB9CgogICAgICAgIGlmICh2bS5oYmxQb3N0U2F2aW5nW2hibC5pZF0uaW5kZXhPZihmaWVsZCkgPCAwKSB7CiAgICAgICAgICBpZiAoZW50cnlIZWxwZXJTZXJ2aWNlLm1ibERhdGFDaGFuZ2VIYW5kbGVyKGZpZWxkLCBoYmwsIGNvbmRpdGlvbkNob2ljZUluZGV4LCB0cnVlKSkgewogICAgICAgICAgICB2bS5oYmxQb3N0U2F2aW5nW2hibC5pZF0ucHVzaCh7CiAgICAgICAgICAgICAgZmllbGQ6IGZpZWxkLAogICAgICAgICAgICAgIGNvbmRpdGlvbkNob2ljZUluZGV4OiBjb25kaXRpb25DaG9pY2VJbmRleCwKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNoYW5nZWRTb21ldGhpbmcgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CgogICAgICByZXR1cm4gY2hhbmdlZFNvbWV0aGluZzsKICAgIH0KCiAgICBmdW5jdGlvbiBvbk9mZmljZUNoYW5naW5nKGV2ZW50KSB7CiAgICAgIGNvbnN0IG9sZE9mZmljZSA9IHZtLm1ibC5vZmZpY2U7CiAgICAgIGNvbnN0IG9sZERlcGFydG1lbnQgPSB2bS5tYmwub2ZmaWNlX2RlcGFydG1lbnQ7CiAgICAgIHZtLm1ibC5vZmZpY2UgPSBldmVudC5vZmZpY2U7CiAgICAgIHZtLm1ibC5vZmZpY2VfZGVwYXJ0bWVudCA9IGV2ZW50LmRlcGFydG1lbnQ7CiAgICAgIGNvbnN0IGlzT2ZmaWNlQ2hhbmdlZCA9IG9sZE9mZmljZSAhPT0gdm0ubWJsLm9mZmljZTsKICAgICAgY29uc3QgaXNEZXBhcnRtZW50Q2hhbmdlZCA9IG9sZERlcGFydG1lbnQgIT09IHZtLm1ibC5vZmZpY2VfZGVwYXJ0bWVudDsKICAgICAgY29uc3QgY2FuSGF2ZUhibCA9IGlzT0UoKSB8fCBpc09JKCkgfHwgaXNBRSgpIHx8IGlzQUkoKTsKICAgICAgaWYgKAogICAgICAgIChpc09mZmljZUNoYW5nZWQgfHwgaXNEZXBhcnRtZW50Q2hhbmdlZCkKICAgICAgICAmJiBjYW5IYXZlSGJsCiAgICAgICAgJiYgdm0uaGJsX2xpc3QubGVuZ3RoID4gMAogICAgICApIHsKICAgICAgICBjb25zdCBtb2RhbE1zZyA9IGlzT2ZmaWNlQ2hhbmdlZAogICAgICAgICAgPyBfVC5NU0cuTk9USUZZX0FQUExZX09GRklDRV9UT19BTExfSEJMIDogX1QuTVNHLk5PVElGWV9BUFBMWV9ERVBBUlRNRU5UX1RPX0FMTF9IQkw7CiAgICAgICAgbW9kYWwub3BlbkNvbmZpcm0oJycsIG1vZGFsTXNnKS50aGVuKCgpID0+IHsKICAgICAgICAgIHN5bmNNQkxGaWVsZFRvQWxsSEJMKCdvZmZpY2VfZGVwYXJ0bWVudCcpOwogICAgICAgICAgb25PZmZpY2VDaGFuZ2VkKCk7CiAgICAgICAgfSkuY2F0Y2goKCkgPT4gewogICAgICAgICAgLy8gT0xDLTk2OiBrZWVwIHVzZXIgc2VsZWN0aW9uIGlmIHRoZSBvZmZpY2Ugbm90IGNoYW5nZWQuCiAgICAgICAgICBpZiAoaXNPZmZpY2VDaGFuZ2VkKSB7CiAgICAgICAgICAgIHZtLm1ibC5vZmZpY2UgPSBvbGRPZmZpY2U7CiAgICAgICAgICAgIHZtLm1ibC5vZmZpY2VfZGVwYXJ0bWVudCA9IG9sZERlcGFydG1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb25PZmZpY2VDaGFuZ2VkKCk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBvbk9mZmljZUNoYW5nZWQoKSB7CiAgICAgIGlmICh2bS5jcmVhdGluZykgewogICAgICAgIC8vIG9ubHkgc3luYyB1bml0IHdoZW4gY3JlYXRpbmcKICAgICAgICBsZXQgb2ZjID0gXy5maW5kKHZtLm9mZmljZXMsIHsgaWQ6IHZtLm1ibC5vZmZpY2UgfSk7CgogICAgICAgIGlmIChpc0FFKCkpIHsKICAgICAgICAgIHZtLm1ibC5wYWNrYWdlX3VuaXQgPSBvZmMuYWVfcGFja2FnZV91bml0OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2bS5tYmwucGFja2FnZV91bml0ID0gb2ZjLnBhY2thZ2VfdW5pdDsKICAgICAgICB9CgogICAgICAgIGlmIChpc0FJKCkgfHwgaXNBRSgpKSB7CiAgICAgICAgICAvLyBGb3IgQWlyLCBzeXN0ZW0gYXNzdW1lcyB3ZWlnaHRfdW5pdCBhbmQgbWVhc3VyZV91bml0IGlzIEtHIGFuZCBDQk0uCiAgICAgICAgICB2bS5tYmwud2VpZ2h0X3VuaXQgPSAnS0cnOwogICAgICAgICAgdm0ubWJsLm1lYXN1cmVfdW5pdCA9ICdDQk0nOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2bS5tYmwud2VpZ2h0X3VuaXQgPSBvZmMud2VpZ2h0X3VuaXQ7CiAgICAgICAgICB2bS5tYmwubWVhc3VyZV91bml0ID0gb2ZjLm1lYXN1cmVfdW5pdDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBvbkRhdGVDaGFuZ2VkKGRhdGUsIGZpZWxkKSB7CiAgICAgIC8vIEdGMVZJUC0zNTIxCiAgICAgIC8vIG5nLWNoYW5nZSBiZWluZyB0cmlnZ2VyZWQgd2hpbGUgdXNlciBtYW51YWxseSBlZGl0IHRoZSBkYXRlIHdpdGhvdXQgdXNpbmcgZGF0ZS1waWNrZXIKICAgICAgLy8gYnV0IGN1cnJlbnRseSB0aGlzIGV2ZW50IGlzIG5lZWRlZCBieSBkYXRlLXBpY2tlcgogICAgICAvLyB0ZW1wb3Jhcnkgd29ya2Fyb3VuZCBpcyB0byBjaGVjayBmb3IgdmFsaWRpdHkgb2YgdGhlIGRhdGUgYmVmb3JlIHNob3dpbmcgcG9wdXAKICAgICAgLy8gYmVjYXVzZSB0aGUgdmFsdWUgYmVjb21lcyBudWxsIHdoZW4gaXRzIGZvcm1hdCBpcyBpbnZhbGlkCiAgICAgIGlmICghZGF0ZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBzeW5jTUJMRmllbGRUb0FsbEhCTChmaWVsZCk7CiAgICB9CgogICAgZnVuY3Rpb24gb25FVERDaGFuZ2VkKCkgewogICAgICBpZiAoIXZtLm1ibC5FVEQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIGZpZWxkID0gJ0VURCc7CiAgICAgIHZhbGlkYXRlRVRBRVREKGZpZWxkKTsKICAgICAgc3luY01CTEZpZWxkVG9BbGxIQkwoZmllbGQpOwogICAgfQoKICAgIGZ1bmN0aW9uIG9uRVRBQ2hhbmdlZCgpIHsKICAgICAgaWYgKCF2bS5tYmwuRVRBKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBmaWVsZCA9ICdFVEEnOwogICAgICB2YWxpZGF0ZUVUQUVURChmaWVsZCk7CiAgICAgIG9wZW5Db25maXJtTWJsU3luY0RpYWxvZyhmaWVsZCkKICAgICAgICAudGhlbigocmVzcCkgPT4gewogICAgICAgICAgZW50cnlIZWxwZXJTZXJ2aWNlLnN5bmNNYmxEYXRhVG9NYmxGaWVsZHMoZmllbGQpCiAgICAgICAgICAgIC50aGVuKCgpID0+IHsKICAgICAgICAgICAgICB2bS5nRm9ybS5tYmxGb3JtLiRzZXREaXJ0eSgpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICBkb1N5bmNNQkxGaWVsZFRvQWxsSEJMKFtmaWVsZF0sIHJlc3AgPyByZXNwLmNvbmRpdGlvbkNob2ljZUluZGV4IDogbnVsbCk7CiAgICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gc2hvd0VkaU1ibE1hbmRhdG9yeUVycm9yKHZhbHVlKSB7CiAgICAgIHJldHVybiB2bS5jYW5TaG93RWRpRXJyb3IKICAgICAgICAmJiAhdm0uZ0Zvcm0uJGRpcnR5CiAgICAgICAgJiYgIXZhbHVlCiAgICAgICAgJiYgdm0ub2NlYW5FeHBvcnRNYmwuaXNPdmVyc2VhQWdlbnRBY3RpdmF0ZWRGb3JFZGkodm0ubWJsKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzaG93RWRpTWJsTWFuZGF0b3J5V2FybmluZyh2YWx1ZSkgewogICAgICByZXR1cm4gIXZtLnNob3dFZGlNYmxNYW5kYXRvcnlFcnJvcih2YWx1ZSkKICAgICAgICAmJiAhdmFsdWUKICAgICAgICAmJiB2bS5vY2VhbkV4cG9ydE1ibC5pc092ZXJzZWFBZ2VudEFjdGl2YXRlZEZvckVkaSh2bS5tYmwpOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldEV0YVdhcm5pbmdNZXNzYWdlKCkgewogICAgICBpZiAodm0uc2hvd0VkaU1ibE1hbmRhdG9yeVdhcm5pbmcodm0ubWJsLkVUQSkpIHsKICAgICAgICByZXR1cm4gX1QuTVNHLk1BTkRBVE9SWV9GT1JfRURJX1NVQk1JU1NJT047CiAgICAgIH0KCiAgICAgIGlmICh2bS53YXJuaW5nLkVUQSkgewogICAgICAgIHJldHVybiBfVC5NU0cuQ09ORklSTV9DT1JSRUNUX0VUQTsKICAgICAgfQoKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgLy8gVE9ETzogdXNlIGRpcmVjdGl2ZShleDogcXRpcC13YXJuaW5nLCBxdGlwLWVycm9yKSB0byBoYW5kbGUgdGhlIHZhbGlkYXRpb24gY2FzZQogICAgLy8gICAgICAgRVg6IHF0aXAtZXJyb3I9InZtLm1ibC5FVEEgPCB2bS5tbWwuRVREIiBxdGlwLWVycm9yLW1lc3NhZ2U9IlBsZWFzZSBlbnRlciB0aGUgY29ycmVjdCBkYXRlIgogICAgZnVuY3Rpb24gdmFsaWRhdGVFVEFFVEQoZm9jdXNFbGVtZW50KSB7CiAgICAgIHZhciBFVEEgPSB2bS5tYmwuRVRBID8gZ2V0RGF0ZUZyb21TZXJ2ZXJTdHIodm0ubWJsLkVUQSkgOiBudWxsOwogICAgICB2YXIgRVREID0gdm0ubWJsLkVURCA/IGdldERhdGVGcm9tU2VydmVyU3RyKHZtLm1ibC5FVEQpIDogbnVsbDsKICAgICAgdmFyIGVsZW1lbnRFVEEgPSAkKCdpbnB1dFtuZy1tb2RlbD0idm0ubWJsLkVUQSJdJyk7CiAgICAgIHZhciBlbGVtZW50RVREID0gJCgnaW5wdXRbbmctbW9kZWw9InZtLm1ibC5FVEQiXScpOwogICAgICB2YXIgaXNFVEFWYWxpZCA9IHRydWU7CiAgICAgIHZhciBpc0VURFZhbGlkID0gdHJ1ZTsKICAgICAgdmFyIGlzT3JpRVRBVmFsaWQgPSAhdm0uZXJyb3JzLkVUQSAmJiAhdm0ud2FybmluZy5FVEE7CiAgICAgIHZhciBpc09yaUVURFZhbGlkID0gIXZtLmVycm9ycy5FVEQgJiYgIXZtLndhcm5pbmcuRVREOwogICAgICB2YXIgRVRBc3R5bGUgPSBudWxsOwogICAgICB2YXIgRVREc3R5bGUgPSBudWxsOwogICAgICB2YXIgZGVsYXkgPSAyNTAwOwoKICAgICAgLy8gdG9kYXkgLSA5MCA+PSBFVEEKICAgICAgLy8gdG9kYXkgLSA5MCA+PSBFVEQKICAgICAgdmFyIGxpbWl0RGF0ZSA9IG5ldyBEYXRlKCk7CiAgICAgIGxpbWl0RGF0ZS5zZXREYXRlKGxpbWl0RGF0ZS5nZXREYXRlKCkgLSA5MCk7CgogICAgICAvLyA9PT09PT09PT09PT09PT09IHZhbGlkYXRpb24gPT09PT09PT09PT09PT09PQogICAgICBpZiAoRVRBICYmIEVURCkgewogICAgICAgIHZhciBpc0VUQUVUREludmFsaWQ7CiAgICAgICAgaWYoaXNBSSgpIHx8IGlzQUUoKSkgewogICAgICAgICAgdmFyIGRheSA9IDYwICogNjAgKiAyNCAqIDEwMDA7CiAgICAgICAgICB2YXIgYWxsb3dFYXJseUVUQSA9IG5ldyBEYXRlKEVUQS5nZXRUaW1lKCkgKyBkYXkpOwogICAgICAgICAgaXNFVEFFVERJbnZhbGlkID0gYWxsb3dFYXJseUVUQSA8IEVURDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaXNFVEFFVERJbnZhbGlkID0gRVRBIDwgRVREOwogICAgICAgIH0KCiAgICAgICAgaWYgKGlzRVRBRVRESW52YWxpZCkgewogICAgICAgICAgaWYgKGZvY3VzRWxlbWVudCA9PT0gJ0VUQScpIHsKICAgICAgICAgICAgaXNFVEFWYWxpZCA9IGZhbHNlOwogICAgICAgICAgICBFVEFzdHlsZSA9ICdlcnJvcic7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgaXNFVERWYWxpZCA9IGZhbHNlOwogICAgICAgICAgICBFVERzdHlsZSA9ICdlcnJvcic7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChpc0VUQVZhbGlkICYmIEVUQSAmJiBsaW1pdERhdGUgPj0gRVRBKSB7CiAgICAgICAgaXNFVEFWYWxpZCA9IGZhbHNlOwogICAgICAgIEVUQXN0eWxlID0gJ3dhcm5pbmcnOwogICAgICB9CiAgICAgIGlmIChpc0VURFZhbGlkICYmIEVURCAmJiBsaW1pdERhdGUgPj0gRVREKSB7CiAgICAgICAgaXNFVERWYWxpZCA9IGZhbHNlOwogICAgICAgIEVURHN0eWxlID0gJ3dhcm5pbmcnOwogICAgICB9CgogICAgICAvLyA9PT09PT09PT09PT09PT09IHBvc3QgcHJvY2VzcyA9PT09PT09PT09PT09PT09CiAgICAgIGlmIChmb2N1c0VsZW1lbnQgPT09ICdFVEEnIHx8IChpc09yaUVUQVZhbGlkICE9PSBpc0VUQVZhbGlkKSkgewogICAgICAgIHZtLmVycm9ycy5FVEEgPSBmYWxzZTsKICAgICAgICB2bS53YXJuaW5nLkVUQSA9IGZhbHNlOwogICAgICAgICRzY29wZS5tYmxGb3JtLkVUQS4kc2V0VmFsaWRpdHkoJ0VUQV9yYW5nZScsIHRydWUpOwoKICAgICAgICBpZiAoIWlzRVRBVmFsaWQpIHsKICAgICAgICAgIGlmIChFVEFzdHlsZSA9PT0gJ2Vycm9yJykgewogICAgICAgICAgICB2bS5lcnJvcnMuRVRBID0gdHJ1ZTsKICAgICAgICAgICAgJHNjb3BlLm1ibEZvcm0uRVRBLiRzZXRWYWxpZGl0eSgnRVRBX3JhbmdlJywgZmFsc2UpOwogICAgICAgICAgICAkbG9nLmRlYnVnKCdFVEEgZXJyb3InKTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICB2bS53YXJuaW5nLkVUQSA9IHRydWU7CiAgICAgICAgICAgICRsb2cuZGVidWcoJ0VUQSB3YXJuaW5nJyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoZm9jdXNFbGVtZW50ID09PSAnRVREJyB8fCAoaXNPcmlFVERWYWxpZCAhPT0gaXNFVERWYWxpZCkpIHsKICAgICAgICB2bS5lcnJvcnMuRVREID0gZmFsc2U7CiAgICAgICAgdm0ud2FybmluZy5FVEQgPSBmYWxzZTsKICAgICAgICAkc2NvcGUubWJsRm9ybS5FVEQuJHNldFZhbGlkaXR5KCdFVERfcmFuZ2UnLCB0cnVlKTsKCiAgICAgICAgaWYgKCFpc0VURFZhbGlkKSB7CiAgICAgICAgICBpZiAoRVREc3R5bGUgPT09ICdlcnJvcicpIHsKICAgICAgICAgICAgc2hvd1F0aXAoZWxlbWVudEVURCwgIkluY29ycmVjdCBFVEQiLCAnZXJyb3InKTsKICAgICAgICAgICAgdm0uZXJyb3JzLkVURCA9IHRydWU7CiAgICAgICAgICAgICRzY29wZS5tYmxGb3JtLkVURC4kc2V0VmFsaWRpdHkoJ0VURF9yYW5nZScsIGZhbHNlKTsKICAgICAgICAgICAgJGxvZy5kZWJ1ZygnRVREIGVycm9yJyk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgc2hvd1F0aXAoZWxlbWVudEVURCwgX1QuTVNHLkNPTkZJUk1fQ09SUkVDVF9FVEQsICd3YXJuaW5nJywge2RlbGF5OiBkZWxheX0pOwogICAgICAgICAgICB2bS53YXJuaW5nLkVURCA9IHRydWU7CiAgICAgICAgICAgICRsb2cuZGVidWcoJ0VURCB3YXJuaW5nJyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgaGlkZVF0aXAoZWxlbWVudEVURCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0VmFsaWRQb3N0RGF0ZShkYXRlKSB7CiAgICAgIGlmICh2bS5sYXN0QmxvY2tEYXRlKSB7CiAgICAgICAgdmFyIGRhdGVPYmogPSBnZXREYXRlRnJvbVNlcnZlclN0cihkYXRlKTsKICAgICAgICB2YXIgbGFzdEJsb2NrRGF0ZSA9IGdldERhdGVGcm9tU2VydmVyU3RyKHZtLmxhc3RCbG9ja0RhdGUpOwogICAgICAgIGlmIChkYXRlT2JqIDw9IGxhc3RCbG9ja0RhdGUpIHsKICAgICAgICAgIC8vIHBvc3RfZGF0ZSA6PSBsYXN0QmxvY2tEYXRlICsgMQogICAgICAgICAgbGFzdEJsb2NrRGF0ZS5zZXREYXRlKGxhc3RCbG9ja0RhdGUuZ2V0RGF0ZSgpICsgMSk7CiAgICAgICAgICBsYXN0QmxvY2tEYXRlID0gZ2V0U2VydmVyU3RyRnJvbURhdGUobGFzdEJsb2NrRGF0ZSk7CiAgICAgICAgICAkbG9nLmRlYnVnKCdnZXRWYWxpZFBvc3REYXRlKCkgcG9zdF9kYXRlIDo9IGxhc3RCbG9ja0RhdGUrMSAoJyArIGxhc3RCbG9ja0RhdGUgKyAnKScpOwogICAgICAgICAgcmV0dXJuIGxhc3RCbG9ja0RhdGU7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBkYXRlOwogICAgfQoKICAgIGZ1bmN0aW9uIHZhbGlkYXRlUG9zdERhdGUoKSB7CiAgICAgIGlmIChpc09JKCkgfHwgaXNPRSgpIHx8IGlzQUkoKSB8fCBpc0FFKCkpIHsKICAgICAgICBsZXQgb2ZjID0gXy5maW5kKHZtLm9mZmljZXMsIHsgaWQ6IHZtLm1ibC5vZmZpY2UgfSk7CiAgICAgICAgbGV0IGtleSA9IChpc09JKCkgfHwgaXNBSSgpKSA/CiAgICAgICAgICAgICAgb2ZjICYmIG9mYy5zaGlwbWVudF9wb3N0X2RhdGVfaW1wb3J0IDogIC8vIGltcG9ydAogICAgICAgICAgICAgIG9mYyAmJiBvZmMuc2hpcG1lbnRfcG9zdF9kYXRlX2V4cG9ydDsgICAvLyBleHBvcnQKCiAgICAgICAgJHNjb3BlLm1ibEZvcm0uRVRELiRzZXRWYWxpZGl0eSgncG9zdF9kYXRlX3JhbmdlJywgdHJ1ZSk7CiAgICAgICAgJHNjb3BlLm1ibEZvcm0uRVRBLiRzZXRWYWxpZGl0eSgncG9zdF9kYXRlX3JhbmdlJywgdHJ1ZSk7CiAgICAgICAgLy8gJHNjb3BlLm1ibEZvcm0uREVUQS4kc2V0VmFsaWRpdHkoJ3Bvc3RfZGF0ZV9yYW5nZScsIHRydWUpOwogICAgICAgIGlmIChrZXkgJiYga2V5ICE9PSAiVE9EQVkiICYmIHZtLm1ibFtrZXldKSB7CiAgICAgICAgICBpZiAodm0ubWJsW2tleV0gIT09IGdldFZhbGlkUG9zdERhdGUodm0ubWJsW2tleV0pKSB7CiAgICAgICAgICAgICRzY29wZS5tYmxGb3JtW2tleV0uJHNldFZhbGlkaXR5KCdwb3N0X2RhdGVfcmFuZ2UnLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gc2F2ZShhY3Rpb24pIHsKICAgICAgdm0uaXNTYXZpbmcgPSB0cnVlOwoKICAgICAgcmV0dXJuIGNvbmZpcm1TYXZpbmdXYXJuaW5nKCkKICAgICAgICAudGhlbih2YWxpZGF0ZUZvcm0pCiAgICAgICAgLnRoZW4oXy5wYXJ0aWFsKHBlcmZvcm1TYXZlLCBhY3Rpb24pKQogICAgICAgIC5maW5hbGx5KHJlc2V0KTsKCiAgICAgIGZ1bmN0aW9uIHJlc2V0KCkgewogICAgICAgIHZtLmlzU2F2aW5nID0gZmFsc2U7CiAgICAgICAgdm0ud2FybmluZyA9IHt9OwogICAgICAgIHZtLmVycm9ycyA9IHt9OwogICAgICAgIHZtLmNhblNob3dFZGlFcnJvciA9IGZhbHNlOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gY29uZmlybVNhdmluZ1dhcm5pbmcoKSB7CiAgICAgIHJldHVybiBnZXRIQkxMaXN0V2l0aFRoZVNhbWVCb29raW5nTm8oKQogICAgICAgIC50aGVuKHNob3dDb25maXJtRHVwbGljYXRlQm9va2luZ05vTW9kYWwpOwoKICAgICAgZnVuY3Rpb24gc2hvd0NvbmZpcm1EdXBsaWNhdGVCb29raW5nTm9Nb2RhbChkYXRhKSB7CiAgICAgICAgaWYgKGRhdGEubGVuZ3RoID4gMCkgewogICAgICAgICAgcmV0dXJuIG1vZGFsLm9wZW4oTVNHX0RVUExJQ0FURV9CT09LSU5HX05PICsgJyAnICsgTVNHX1NVUkVfQ09OVElOVUVfU0FWSU5HKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICRxLnJlc29sdmUoKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHZhbGlkYXRlRm9ybSgpIHsKICAgICAgdmFsaWRhdGVQb3N0RGF0ZSgpOwogICAgICAvLyB2YWxpZERlcGFydG1lbnRzKCk7CgogICAgICBpZih2bS5nRm9ybS4kaW52YWxpZCl7CiAgICAgICAgLy8gaWYgTUJMX05PIG5vdCBmaWxsZWQsIG9wZW4gTUJMIHBhbmVsCiAgICAgICAgaWYoJHNjb3BlLm1ibEZvcm0uJGVycm9yLnJlcXVpcmVkKXsKICAgICAgICAgIGRvT3Blbk1ibCgpOwogICAgICAgIH0KCiAgICAgICAgJHNjb3BlLiRicm9hZGNhc3QoJ3Nob3ctZXJyb3JzLWNoZWNrLXZhbGlkaXR5Jyk7CiAgICAgICAgJHNjb3BlLiRicm9hZGNhc3QoJ2ZvY3VzLWludmFsaWQtZmllbGQnLCBmdW5jdGlvbihlbGVtKXsKICAgICAgICAgIGlmKHZtLmdGb3JtLiRlcnJvci5yZXF1aXJlZCl7CiAgICAgICAgICAgIFNob3dGZWVkYmFja01zZygnZXJyb3InLCBfVC5NU0cuUkVRVUlSRV9GSUxMX01BTkRBVE9SWSk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmKHZtLmdGb3JtLiRlcnJvci5wb3N0X2RhdGVfcmFuZ2UpewogICAgICAgICAgICBTaG93RmVlZGJhY2tNc2coJ2Vycm9yJywgX1QuTVNHLkJMX1BPU1RfREFURV9FUlJPUik7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlewogICAgICAgICAgICBTaG93RmVlZGJhY2tNc2coJ2Vycm9yJywgX1QuTVNHLkZJTExfQ09SUkVDVF9WQUxVRSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuICRxLnJlamVjdCgpOwogICAgICB9CiAgICAgICRzY29wZS4kYnJvYWRjYXN0KCdzaG93LWVycm9ycy1yZXNldCcpOwogICAgICByZXR1cm4gJHEucmVzb2x2ZSgpOwogICAgfQoKICAgIGZ1bmN0aW9uIHBlcmZvcm1TYXZlKGFjdGlvbil7CiAgICAgIC8vIHJlZmluZSBVUkwncyBwYXJhbQogICAgICB2YXIgcGFyYW1zID0gJGxvY2F0aW9uLnNlYXJjaCgpOwogICAgICBpZiAocGFyYW1zLmFjdGlvbiA9PT0gJ2FkZF9oYmwnKSB7CiAgICAgICAgJGxvY2F0aW9uLnNlYXJjaCgnYWN0aW9uJywgbnVsbCkucmVwbGFjZSgpOyAgLy8gcmVtb3ZlIGFjdGlvbj1hZGRfaGJsIHBhcmFtCiAgICAgIH0KCiAgICAgIHZhciBuZXdfaGJsX2l0ZW0gPSB7fTsKCiAgICAgIGlmKHZtLmNyZWF0aW5nKSB7CiAgICAgICAgdmFyIGRvU2F2ZSA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgIHNob3dTcGluKCk7CiAgICAgICAgICByZXR1cm4gJGh0dHAucG9zdChVUkwuU0hJUE1FTlRfQ1JFQVRFLCBkYXRhKQogICAgICAgICAgICAuY2F0Y2goZXhjZXB0aW9uSGFuZGxlci5zaG93U2F2ZUVycm9yKQogICAgICAgICAgICAudGhlbigKICAgICAgICAgICAgICBmdW5jdGlvbihyZXNwb25zZSl7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnUmVzcG9uc2U6ICcrcmVzcG9uc2UuZGF0YSk7CiAgICAgICAgICAgICAgICBhbmd1bGFyLmV4dGVuZCh2bS5tYmwsIHJlc3BvbnNlLmRhdGEubWJsKTsKICAgICAgICAgICAgICAgIGZvcih2YXIgaT0wIDsgaTx2bS5oYmxfbGlzdC5sZW5ndGggOyArK2kpIHsKICAgICAgICAgICAgICAgICAgdmFyIGhibF9pZCA9IHJlc3BvbnNlLmRhdGEuaGJsW2ldOwogICAgICAgICAgICAgICAgICB2bS5oYmxfbGlzdFtpXS5pZCA9IGhibF9pZDsKICAgICAgICAgICAgICAgICAgXy5tZXJnZSh2bS5oYmxfbGlzdFtpXSwgcmVzcG9uc2UuZGF0YS5oYmxfdXBkYXRlX2luZm9baGJsX2lkXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaXNUSygpKSB7CiAgICAgICAgICAgICAgICAgIGFuZ3VsYXIuZXh0ZW5kKHZtLm1ibC50a19pbmZvLCByZXNwb25zZS5kYXRhLmNyZWF0ZWRfdHAudGtfaW5mbyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzT0UoKSkgewogICAgICAgICAgICAgICAgICBhbmd1bGFyLmV4dGVuZCh2bS5tYmwub2VfaW5mbywgcmVzcG9uc2UuZGF0YS5jcmVhdGVkX3RwLm9lX2luZm8pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdXBkYXRlSGJsQ2FjaGUoKTsKCiAgICAgICAgICAgICAgICB2YXIgcmVxID0ge307CiAgICAgICAgICAgICAgICBpZiAoaXNBSSgpIHx8IGlzQUUoKSkgewogICAgICAgICAgICAgICAgICByZXEgPSBzYXZlQ29tbW9kaXR5KHZtLmhibF9saXN0LCBuZXdfaGJsX2l0ZW0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiAkcS5hbGwocmVxKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLnRoZW4oCiAgICAgICAgICAgICAgZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgICAgICAgICBpZiAoaXNBSSgpIHx8IGlzQUUoKSkgewogICAgICAgICAgICAgICAgICBwb3N0U2F2ZUNvbW1vZGl0eShyZXN1bHQsIG5ld19oYmxfaXRlbSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIHJlcSA9IHt9OwogICAgICAgICAgICAgICAgbmV3X2hibF9pdGVtID0ge307CgogICAgICAgICAgICAgICAgaWYgKGlzQUkoKSkgewogICAgICAgICAgICAgICAgICByZXEgPSBzYXZlU3ViSGF3Yih2bS5oYmxfbGlzdCwgbmV3X2hibF9pdGVtKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBRSgpKSB7CiAgICAgICAgICAgICAgICAgIHJlcSA9IHNhdmVPdGhlckNoYXJnZSh2bS5oYmxfbGlzdCwgbmV3X2hibF9pdGVtKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gJHEuYWxsKHJlcSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC50aGVuKAogICAgICAgICAgICAgIGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgICAgICAgICAgaWYgKGlzQUkoKSkgewogICAgICAgICAgICAgICAgICBwb3N0U2F2ZVN1Ykhhd2IocmVzdWx0LCBuZXdfaGJsX2l0ZW0pOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0FFKCkpIHsKICAgICAgICAgICAgICAgICAgcG9zdFNhdmVPdGhlckNoYXJnZShyZXN1bHQsIG5ld19oYmxfaXRlbSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC50aGVuKCgpID0+IGludm9pY2VUcFVwZGF0ZVNlcnZpY2UucGVyZm9ybVNhdmUoKSkKICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgdXJsID0gdm0ucmVxdWVzdFBhdGgrdm0ubWJsLmZpbGluZ19ubysnLyc7ICAgLy8gcmVkaXJlY3QgdG8gZWRpdCBwYWdlCgogICAgICAgICAgICAgICAgJGxvY2F0aW9uLnBhdGgodXJsKQogICAgICAgICAgICAgICAgICAgIC5zZWFyY2goJ2NvcHlfZnJvbScsIG51bGwpCiAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoKQogICAgICAgICAgICAgICAgICAgIC5zZWFyY2goJ2NvcHlfaGJsJywgbnVsbCkKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgpCiAgICAgICAgICAgICAgICAgICAgLnNlYXJjaCgnY29weV9pbnZfdHlwZXMnLCBudWxsKQogICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKCkKICAgICAgICAgICAgICAgICAgICAuc2VhcmNoKCdjcmVhdGVfZnJvbV9pc2YnLCBudWxsKQogICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKCkKICAgICAgICAgICAgICAgICAgICAuc2VhcmNoKCdjcmVhdGVfZnJvbV9pc2ZfbWJsX25vJywgbnVsbCkKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgpCiAgICAgICAgICAgICAgICAgICAgLnNlYXJjaCgnY3JlYXRlX2Zyb21faXNmX2hibF9ubycsIG51bGwpCiAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoKTsKCiAgICAgICAgICAgICAgICB2bS5maWxpbmdObyA9IHZtLm1ibC5maWxpbmdfbm87CiAgICAgICAgICAgICAgICB2bS5jcmVhdGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgdm0uY29weUZyb20gPSAnJzsKCiAgICAgICAgICAgICAgICB2bS5nRm9ybS4kc2V0UHJpc3RpbmUodHJ1ZSk7IC8vIHJlc2V0IGFsbCBmb3JtCiAgICAgICAgICAgICAgICBjb25maWdJbnZvaWNlVHBVcGRhdGVTZXJ2aWNlKCk7CiAgICAgICAgICAgICAgICBjYWNoZUZvcm1EYXRhKCk7CiAgICAgICAgICAgICAgICBTaG93RmVlZGJhY2tNc2coJ3N1Y2Nlc3MnLCBfVC5NU0cuU0FWRV9EQVRBX1NVQ0MpOwogICAgICAgICAgICAgICAgaWYoYWN0aW9uID09PSAnYWRkX2hibCcpCiAgICAgICAgICAgICAgICAgIGFkZEhibCgpOwoKICAgICAgICAgICAgICAgIF91cGRhdGVOb3RpZmljYXRpb24oKTsKCiAgICAgICAgICAgICAgICBwb3N0U2F2ZSgpOwogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC5maW5hbGx5KGhpZGVTcGluKTsKICAgICAgICB9OyAvLyBlbmQgZG9TYXZlKCkKCiAgICAgICAgLy8gY2xvbmUgZm9yIGZpbHRlciBwcml2YXRlIHZhcmlhYmxlCiAgICAgICAgdmFyIGRhdGEgPSBhbmd1bGFyLmNvcHkodm0ubWJsKTsKICAgICAgICBpZiAoaXNBRSgpKSB7CiAgICAgICAgICBwb191aTJiYWNrZW5kKGRhdGEuYWVfaW5mbyk7CiAgICAgICAgfQoKICAgICAgICB2YXIgaGJsX25vX2xpc3QgPSBbXTsKICAgICAgICBkYXRhLmhibF9saXN0ID0gYW5ndWxhci5jb3B5KHZtLmhibF9saXN0KTsKICAgICAgICBmb3IodmFyIGk9MCA7IGk8ZGF0YS5oYmxfbGlzdC5sZW5ndGggOyBpKyspewogICAgICAgICAgaWYgKGlzQUkoKSB8fCBpc0FFKCkpIHsKICAgICAgICAgICAgcG9fdWkyYmFja2VuZChkYXRhLmhibF9saXN0W2ldKTsKICAgICAgICAgIH0KICAgICAgICAgIGRhdGEuaGJsX2xpc3RbaV0gPSB1cGRhdGVyLmZpbHRlclByaXZhdGUoZGF0YS5oYmxfbGlzdFtpXSk7CiAgICAgICAgICBoYmxfbm9fbGlzdC5wdXNoKGRhdGEuaGJsX2xpc3RbaV0uSEJMX05PKTsKICAgICAgICB9CiAgICAgICAgdXBkYXRlci5maWx0ZXJQcml2YXRlKGRhdGEpOwoKICAgICAgICBjb25zdCBwYXJhbSA9IHsKICAgICAgICAgIHR5cGU6IHZtLnR5cGUsCiAgICAgICAgICBtYmw6IGRhdGEuTUJMX05PLAogICAgICAgICAgaGJsOiBoYmxfbm9fbGlzdCwKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gdmVyaWZ5TWJsSGJsTm8ocGFyYW0pCiAgICAgICAgICAudGhlbihfLnBhcnRpYWwoZG9TYXZlLCBkYXRhKSk7CiAgICAgIH0gIC8vIHZtLmNyZWF0aW5nCiAgICAgIGVsc2UgewoKICAgICAgICAvLyBjb2xsZWN0IGFsbCBkaXJ0eSBmb3JtLCBmaWx0ZXIgc2FtZSAmJiBwcml2YXRlIGRhdGEKICAgICAgICB2YXIgcHJvbWlzZURhdGEgPSB7fTsKICAgICAgICBpZigkc2NvcGUubWJsRm9ybS4kZGlydHkpIHsKICAgICAgICAgIGlmIChpc0FFKCkpIHsKICAgICAgICAgICAgcG9fdWkyYmFja2VuZCh2bS5tYmwuYWVfaW5mbyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZGlmZiA9IHVwZGF0ZXIuZGlmZignbWJsJywgdm0ubWJsKTsKICAgICAgICAgIHVwZGF0ZXIuZmlsdGVyUHJpdmF0ZShkaWZmKTsKICAgICAgICAgIHByb21pc2VEYXRhWydtYmwnXSA9IFsnbWJsJywgJ3B1dCcsIGdlblVybChVUkwuU0hJUE1FTlQsIHtmaWxpbmdfbm86IHZtLmZpbGluZ05vfSksIGRpZmZdOwogICAgICAgIH0KCiAgICAgICAgdm0uaGJsX2xpc3QuZm9yRWFjaChmdW5jdGlvbihoYmwsIGlkeCkgewogICAgICAgICAgaWYgKGlzQUkoKSB8fCBpc0FFKCkpIHsKICAgICAgICAgICAgcG9fdWkyYmFja2VuZChoYmwpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChoYmwuaWQgaW4gdm0uaGJsUG9zdFNhdmluZykgewogICAgICAgICAgICB2bS5oYmxQb3N0U2F2aW5nW2hibC5pZF0uZm9yRWFjaChmdW5jdGlvbihvYmopIHsKICAgICAgICAgICAgICAvLyBhcHBseSBwb3N0IGNoYW5nZWQgb24gdGhlIGBoYmxgIGFuZCBkaXJ0eSBpdCBmb3IgdHJpZ2dlciBzYXZlCiAgICAgICAgICAgICAgc3luY01CTEZpZWxkVG9IQkwob2JqLmZpZWxkLCBoYmwsIG9iai5jb25kaXRpb25DaG9pY2VJbmRleCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQoKICAgICAgICAgIGlmKGhibC5pZCA9PT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgdmFyIGRhdGEgPSBhbmd1bGFyLmNvcHkoaGJsKTsKICAgICAgICAgICAgdXBkYXRlci5maWx0ZXJQcml2YXRlKGRhdGEpOwogICAgICAgICAgICBwcm9taXNlRGF0YVtpZHhdID0gWydoYmwnLCAncG9zdCcsIGdlblVybChVUkwuU0hJUE1FTlRfSEJMX0xJU1QsIHtmaWxpbmdfbm86IHZtLmZpbGluZ05vfSksIGRhdGFdOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZihoYmwuX19oYmxGb3JtLiRkaXJ0eSkgeyAvLyBvbmx5IHVwZGF0ZSB3aGVuICRkaXJ0eQogICAgICAgICAgICB2YXIgZGlmZiA9IHVwZGF0ZXIuZGlmZkxpc3QoJ2hibF9saXN0JywgaWR4LCBoYmwpOwogICAgICAgICAgICB1cGRhdGVyLmZpbHRlclByaXZhdGUoZGlmZik7CiAgICAgICAgICAgIHByb21pc2VEYXRhW2lkeF0gPSBbJ2hibCcsICdwdXQnLCBnZW5VcmwoVVJMLlNISVBNRU5UX0hCTCwge2hibF9pZDogaGJsLmlkfSksIGRpZmZdOwogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICB2bS5oYmxQb3N0U2F2aW5nID0ge307CgogICAgICAgIC8vIGdlbmVyYXRlIHZlcmlmeSBzYW1lIE1CTF9OTyAmIEhCTF9OTyBkYXRhCiAgICAgICAgdmFyIGhibF9saXN0ID0gW107CiAgICAgICAgY29uc3QgcGFyYW0gPSB7CiAgICAgICAgICB0eXBlOiB2bS50eXBlLAogICAgICAgICAgbWJsOiAnJywKICAgICAgICAgIGhibDogaGJsX2xpc3QsCiAgICAgICAgfTsKICAgICAgICBmb3IodmFyIGtleSBpbiBwcm9taXNlRGF0YSl7CiAgICAgICAgICB2YXIgdHlwZSA9IHByb21pc2VEYXRhW2tleV1bMF07CiAgICAgICAgICB2YXIgZGF0YSA9IHByb21pc2VEYXRhW2tleV1bM107CiAgICAgICAgICBpZih0eXBlID09PSAnbWJsJyAmJiAnTUJMX05PJyBpbiBkYXRhKXsgIC8vIGNoZWNrIG5lZWQgdXBkYXRlIE1CTF9OTwogICAgICAgICAgICBwYXJhbS5tYmwgPSBkYXRhLk1CTF9OTzsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYodHlwZSA9PT0gJ2hibCcgJiYgJ0hCTF9OTycgaW4gZGF0YSl7ICAvLyBjaGVjayBuZWVkIHVwZGF0ZSBIQkxfTk8KICAgICAgICAgICAgaGJsX2xpc3QucHVzaChkYXRhLkhCTF9OTyk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyByZXNldCBzYWxlc0JlZm9yZSBhbmQgc2FsZXNBZnRlcgogICAgICAgIHZhciBwb3N0U2F2ZVF1ZXVlID0gW3Bvc3RTYXZlLCBfdXBkYXRlTm90aWZpY2F0aW9uLCBjb25maWdJbnZvaWNlVHBVcGRhdGVTZXJ2aWNlXTsKCiAgICAgICAgLy8gcHV0IHNob3dTcGluIGJlbG93IHZlcmlmeU1ibEhibE5vCiAgICAgICAgLy8gYmVjYXVzZSB2ZXJpZnlNYmxIYmxObyB3aWxsIHBvcHVwIG1vZGFsIGFuZCBjYXVzZSBVSSBibG9ja2VkCiAgICAgICAgcmV0dXJuIHZlcmlmeU1ibEhibE5vKHBhcmFtKQogICAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzKSB7IHNob3dTcGluKCk7IHJldHVybiByZXM7IH0pCiAgICAgICAgICAudGhlbihfLnBhcnRpYWwocGVyZm9ybU1CTFJlcXVlc3RGb3JVcGRhdGUsIHByb21pc2VEYXRhKSkKICAgICAgICAgIC50aGVuKF8ucGFydGlhbFJpZ2h0KHBvc3RTYXZlTUJMRm9yVXBkYXRlLCBwb3N0U2F2ZVF1ZXVlKSkKICAgICAgICAgIC50aGVuKF8ucGFydGlhbChwcmVwYXJlSEJMUmVxdWVzdEZvclVwZGF0ZSwgcHJvbWlzZURhdGEpKQogICAgICAgICAgLnRoZW4oXy5wYXJ0aWFsUmlnaHQocG9zdFNhdmVIQkxGb3JVcGRhdGUsIHBvc3RTYXZlUXVldWUpKQogICAgICAgICAgLnRoZW4oKCkgPT4gaW52b2ljZVRwVXBkYXRlU2VydmljZS5wZXJmb3JtU2F2ZSgpKQogICAgICAgICAgLnRoZW4oXy5wYXJ0aWFsKGV4ZWN1dGVBbGwsIHBvc3RTYXZlUXVldWUpKQogICAgICAgICAgLmZpbmFsbHkoaGlkZVNwaW4pOwogICAgICB9CiAgICB9ICAvLyBzYXZlKCkKCiAgICBmdW5jdGlvbiBjcmVhdGVIdHRwUHJvbWlzZShkYXRhKSB7CiAgICAgIC8vIFttYmwgb3IgaGJsLCBtZXRob2QsIHVybCwgcGFyYW1dCiAgICAgIHJldHVybiBkYXRhID8gJGh0dHBbZGF0YVsxXV0oZGF0YVsyXSwgZGF0YVszXSkgOiAkcS5yZXNvbHZlKCk7CiAgICB9CgogICAgZnVuY3Rpb24gZXhlY3V0ZUFsbChxdWV1ZSkgewogICAgICBxdWV1ZS5mb3JFYWNoKGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgaWYgKGZuKSB7CiAgICAgICAgICBmbigpOwogICAgICAgIH0KICAgICAgfSkKICAgIH0KCiAgICBmdW5jdGlvbiBjYW5TYXZlKCkgewogICAgICBsZXQgaXNEaXJ0eSA9IHZtLmdGb3JtLiRkaXJ0eTsKICAgICAgY29uc3Qgc29tZUVkaXRhYmxlID0gKCFkaXNhYmxlTW9kZSgnQScpIHx8ICFoYmxEaXNhYmxlTW9kZSgnQScsIHZtLmhibF9saXN0W3ZtLmN1ckhibElkeF0pKTsKCiAgICAgIC8vIGFsbG93IHNhdmluZyBpbiBjcmVhdGluZyBtb2RlLCBldmVuIGlmIGZvcm0gaXMgcHJpc3RpbmUKICAgICAgaWYgKGlzVEsoKSB8fCBpc01pc2MoKSkgewogICAgICAgIGlzRGlydHkgPSBpc0RpcnR5IHx8IHZtLmNyZWF0aW5nOwogICAgICB9CgogICAgICByZXR1cm4gaXNEaXJ0eSAmJiBzb21lRWRpdGFibGUgJiYgIXZtLmlzU2F2aW5nOwogICAgfQoKICAgIC8vID09PT09PT09PT09PT0gRm9yIHNhdmUgdXBkYXRlIGNhc2UgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICBmdW5jdGlvbiBjcmVhdGVGdW5jVG9TaG93U2FsZXNDaGFuZ2Uoc2FsZXNCZWZvcmUsIHNhbGVzQWZ0ZXIpIHsKICAgICAgaWYgKHNhbGVzQmVmb3JlICE9PSBzYWxlc0FmdGVyKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIG1zZ0NyZWF0b3IgPSBjcmVhdGVTdHJpbmdGb3JtYXR0ZXIoX1QuTVNHLlNBTEVTX1BFUlNPTl9DSEFOR0UpOwogICAgICAgICAgU2hvd0ZlZWRiYWNrTXNnKCdzdWNjZXNzJywgbXNnQ3JlYXRvci5mb3JtYXQoc2FsZXNCZWZvcmUgfHwgJyAnLCBzYWxlc0FmdGVyIHx8ICcgJykpOwogICAgICAgIH07CiAgICAgIH0KICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgZnVuY3Rpb24gcGVyZm9ybU1CTFJlcXVlc3RGb3JVcGRhdGUoZGF0YSkgewogICAgICByZXR1cm4gY3JlYXRlSHR0cFByb21pc2UoZGF0YS5tYmwpLmNhdGNoKGV4Y2VwdGlvbkhhbmRsZXIuc2hvd1NhdmVFcnJvcik7CiAgICB9CgogICAgZnVuY3Rpb24gcG9zdFNhdmVNQkxGb3JVcGRhdGUodmFsdWUsIHBvc3RTYXZlUXVldWUpIHsKICAgICAgaWYgKCF2YWx1ZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBhbmd1bGFyLmV4dGVuZCh2bS5tYmwsIHZhbHVlLmRhdGEubWJsKTsgIC8vIE1CTCBQVVQgdXBkYXRlIHJlc3VsdAogICAgICBpZiAoaXNUSygpKSB7CiAgICAgICAgYW5ndWxhci5leHRlbmQodm0ubWJsLnRrX2luZm8sIHZhbHVlLmRhdGEuY3JlYXRlZF90cC50a19pbmZvKTsKICAgICAgICBhbmd1bGFyLmV4dGVuZCh2bS5tYmwudGtfaW5mbywgdmFsdWUuZGF0YS50a19pbmZvKTsKICAgICAgfSBlbHNlIGlmIChpc01pc2MoKSkgewogICAgICAgIGFuZ3VsYXIuZXh0ZW5kKHZtLm1ibC5tc19pbmZvLCB2YWx1ZS5kYXRhLm1zX2luZm8pOwogICAgICB9IGVsc2UgaWYgKGlzT0UoKSkgewogICAgICAgIGFuZ3VsYXIuZXh0ZW5kKHZtLm1ibC5vZV9pbmZvLCB2YWx1ZS5kYXRhLmNyZWF0ZWRfdHAub2VfaW5mbyk7CiAgICAgICAgYW5ndWxhci5leHRlbmQodm0ubWJsLm9lX2luZm8sIHZhbHVlLmRhdGEub2VfaW5mbyk7CiAgICAgIH0KCiAgICAgIGlmIChpc1RLKCkgfHwgaXNNaXNjKCkgfHwgaXNPRSgpIHx8IGlzQUUoKSkgewogICAgICAgIHBvc3RTYXZlUXVldWUucHVzaChjcmVhdGVGdW5jVG9TaG93U2FsZXNDaGFuZ2UodmFsdWUuZGF0YS5zYWxlc19iZWZvcmUsIHZhbHVlLmRhdGEuc2FsZXNfYWZ0ZXIpKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHByZXBhcmVIQkxSZXF1ZXN0Rm9yVXBkYXRlKGRhdGEpIHsKICAgICAgdmFyIHJlcSA9IHt9OwogICAgICBmb3IodmFyIGtleSBpbiBkYXRhKXsKICAgICAgICBpZiAoZGF0YS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAvLyBtYmwgcGFydCBpcyBoYW5kbGVkLCBza2lwIGl0CiAgICAgICAgICBpZiAoa2V5ID09PSAnbWJsJykgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJlcVtrZXldID0gY3JlYXRlSHR0cFByb21pc2UoZGF0YVtrZXldKS5jYXRjaChleGNlcHRpb25IYW5kbGVyLnNob3dTYXZlRXJyb3IpCiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXE7CiAgICB9CgogICAgZnVuY3Rpb24gcG9zdFNhdmVIQkxGb3JVcGRhdGUocmVxLCBwb3N0U2F2ZVF1ZXVlKSB7CiAgICAgIHZhciBhdXRvX2Fzc2lnbl9jdCA9IGZhbHNlOwogICAgICB2YXIgbmV3SGJsSXRlbSA9IHt9OwogICAgICByZXR1cm4gJHEuYWxsKHJlcSkKICAgICAgICAudGhlbihmdW5jdGlvbih2YWx1ZXMpIHsKICAgICAgICAgICRsb2cubG9nKCdoYmwgc2F2ZTonLCB2YWx1ZXMpOwoKICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaCh2YWx1ZXMsIChyZXNwLCBrZXkpID0+IHsKICAgICAgICAgICAgY29uc3QgZGF0YSA9IHJlc3AuZGF0YTsKCiAgICAgICAgICAgIC8vIHVwZGF0ZSBoYmwgZGF0YQogICAgICAgICAgICBPYmplY3QuYXNzaWduKHZtLmhibF9saXN0W2tleV0sIGRhdGEpOwoKICAgICAgICAgICAgYXV0b19hc3NpZ25fY3QgPSBkYXRhLmF1dG9fYXNzaWduX2N0OwogICAgICAgICAgICBwb3N0U2F2ZVF1ZXVlLnB1c2goY3JlYXRlRnVuY1RvU2hvd1NhbGVzQ2hhbmdlKGRhdGEuc2FsZXNfYmVmb3JlLCBkYXRhLnNhbGVzX2FmdGVyKSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB2YXIgcmVxID0ge307CiAgICAgICAgICBpZiAoaXNBSSgpIHx8IGlzQUUoKSkgewogICAgICAgICAgICByZXEgPSBzYXZlQ29tbW9kaXR5KHZtLmhibF9saXN0LCBuZXdIYmxJdGVtKTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gJHEuYWxsKHJlcSk7CiAgICAgICAgfSkKICAgICAgICAudGhlbihmdW5jdGlvbihyZXN1bHQpIHsKCiAgICAgICAgICBpZiAoaXNBSSgpIHx8IGlzQUUoKSkgewogICAgICAgICAgICBwb3N0U2F2ZUNvbW1vZGl0eShyZXN1bHQsIG5ld0hibEl0ZW0pOwogICAgICAgICAgfQoKICAgICAgICAgIG5ld0hibEl0ZW0gPSB7fTsKICAgICAgICAgIHZhciByZXEgPSB7fTsKICAgICAgICAgIGlmIChpc0FJKCkpIHsKICAgICAgICAgICAgcmVxID0gc2F2ZVN1Ykhhd2Iodm0uaGJsX2xpc3QsIG5ld0hibEl0ZW0pOwogICAgICAgICAgfSBlbHNlIGlmIChpc0FFKCkpIHsKICAgICAgICAgICAgcmVxID0gc2F2ZU90aGVyQ2hhcmdlKHZtLmhibF9saXN0LCBuZXdIYmxJdGVtKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAkcS5hbGwocmVxKTsKICAgICAgICB9KQogICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgICAgaWYgKGlzQUkoKSkgewogICAgICAgICAgICBwb3N0U2F2ZVN1Ykhhd2IocmVzdWx0LCBuZXdIYmxJdGVtKTsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNBRSgpKSB7CiAgICAgICAgICAgIHBvc3RTYXZlT3RoZXJDaGFyZ2UocmVzdWx0LCBuZXdIYmxJdGVtKTsKICAgICAgICAgIH0KCiAgICAgICAgICAkbG9jYXRpb24KICAgICAgICAgICAgLnNlYXJjaCgnY3JlYXRlX2Zyb21faXNmJywgbnVsbCkKICAgICAgICAgICAgLnNlYXJjaCgnY3JlYXRlX2Zyb21faXNmX2hibF9ubycsIG51bGwpCiAgICAgICAgICAgIC5yZXBsYWNlKCk7CgogICAgICAgICAgdm0uZ0Zvcm0uJHNldFByaXN0aW5lKHRydWUpOyAvLyByZXNldCBhbGwgZm9ybQogICAgICAgICAgY2FjaGVGb3JtRGF0YSgpOwogICAgICAgICAgaWYodm0uY3VySGJsSWR4ICE9PSBudWxsICYmIHZtLmN1ckhibENhY2hlZC5pZCA9PT0gdW5kZWZpbmVkKXsgLy8gbmV3IEhCTCwgdXBkYXRlIGNhY2hlIGRhdGEKICAgICAgICAgICAgdXBkYXRlSGJsQ2FjaGUoKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZihhdXRvX2Fzc2lnbl9jdCkKICAgICAgICAgICAgU2hvd0ZlZWRiYWNrTXNnKCdzdWNjZXNzJywgX1QuTVNHLlNBVkVfREFUQV9BTkRfQVNTSUdOX0NPTlRBSU5FUl9TVUNDKTsKICAgICAgICAgIGVsc2UKICAgICAgICAgICAgU2hvd0ZlZWRiYWNrTXNnKCdzdWNjZXNzJywgX1QuTVNHLlNBVkVfREFUQV9TVUNDKTsKICAgICAgICB9KTsKICAgIH0KICAgIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CgogICAgZnVuY3Rpb24gdmVyaWZ5TWJsSGJsTm8ocGFyYW1zKSB7CiAgICAgIGNvbnN0IGlzSWdub3JlRHVwbGljYXRlSGF3Yk5vID0gKGlzQUkoKSB8fCBpc0FFKCkpCiAgICAgICAgJiYgIUNPTVBBTllfSU5GTy5haXJfaXNfYWxsb3dfZHVwbGljYXRlX2hhd2Jfbm87CgogICAgICBzaG93U3BpbigpOwogICAgICByZXR1cm4gdm0uZW5kcG9pbnRzLlZFUklGWV9NQkxfSEJMX05PLmdldCh7IHBhcmFtczogZ2V0UGFyYW1zKCkgfSkKICAgICAgICAgIC5maW5hbGx5KGhpZGVTcGluKQogICAgICAgICAgLnRoZW4ob25WZXJpZmllZCwgb25BcGlGYWlsKTsKCiAgICAgIGZ1bmN0aW9uIGdldFBhcmFtcygpIHsKICAgICAgICBpZiAoaXNJZ25vcmVEdXBsaWNhdGVIYXdiTm8pIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIC4uLnBhcmFtcywKICAgICAgICAgICAgaWdub3JlX2NvcGllZF9oYmxfbm86IHRydWUsCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBwYXJhbXM7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIG9uVmVyaWZpZWQocmVzcG9uc2UpIHsKICAgICAgICB2YXIgcmVzID0gcmVzcG9uc2UuZGF0YTsKCiAgICAgICAgY29uc3QgaXNBaXIgPSBpc0FJKCkgfHwgaXNBRSgpOwogICAgICAgIGNvbnN0IG1ibFdvcmRpbmcgPSBpc0FpciA/IF9ULk1TRy5NQVdCIDogX1QuTVNHLk1CTDsKICAgICAgICBjb25zdCBoYmxXb3JkaW5nID0gaXNBaXIgPyBfVC5NU0cuSEFXQiA6IF9ULk1TRy5IQkw7CgogICAgICAgIGlmIChyZXMuYW55KSB7CiAgICAgICAgICBpZiAoaXNJZ25vcmVEdXBsaWNhdGVIYXdiTm8pIHsKICAgICAgICAgICAgaWYgKHJlcy5oYmwpIHsKICAgICAgICAgICAgICBTaG93RXJyb3JGZWVkYmFja01zZyhjcmVhdGVTdHJpbmdGb3JtYXR0ZXIoX1QuTVNHLlNBTUVfSEJMX0VYSVNUX1JFSkVDVCkuZm9ybWF0KGhibFdvcmRpbmcsIHJlcy5oYmwpKTsKICAgICAgICAgICAgICB2bS5lcnJvcnMuSEJMX05PID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gJHEucmVqZWN0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBsZXQgbXNnID0gJyc7CiAgICAgICAgICBpZiAocmVzLm1ibCAmJiByZXMuaGJsKSB7CiAgICAgICAgICAgIGNvbnN0IHRtcCA9IGNyZWF0ZVN0cmluZ0Zvcm1hdHRlcihfVC5NU0cuU0FNRV9NQkxfSEJMX0VYSVNUKS5mb3JtYXQobWJsV29yZGluZywgaGJsV29yZGluZywgcmVzLmhibCk7CiAgICAgICAgICAgIG1zZyA9IGAke3RtcH0gJHtNU0dfU1VSRV9DT05USU5VRV9TQVZJTkd9YDsKICAgICAgICAgIH0gZWxzZSBpZiAocmVzLm1ibCkgewogICAgICAgICAgICBjb25zdCB0bXAgPSBjcmVhdGVTdHJpbmdGb3JtYXR0ZXIoX1QuTVNHLlNBTUVfTUJMX0VYSVNUKS5mb3JtYXQobWJsV29yZGluZyk7CiAgICAgICAgICAgIG1zZyA9IGAke3RtcH0gJHtNU0dfU1VSRV9DT05USU5VRV9TQVZJTkd9YDsKICAgICAgICAgIH0gZWxzZSBpZiAocmVzLmhibCkgewogICAgICAgICAgICBjb25zdCB0bXAgPSBjcmVhdGVTdHJpbmdGb3JtYXR0ZXIoX1QuTVNHLlNBTUVfSEJMX0VYSVNUKS5mb3JtYXQoaGJsV29yZGluZywgcmVzLmhibCk7CiAgICAgICAgICAgIG1zZyA9IGAke3RtcH0gJHtNU0dfU1VSRV9DT05USU5VRV9TQVZJTkd9YDsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gbW9kYWwub3Blbihtc2cpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gb25BcGlGYWlsKCkgewogICAgICAgIFNob3dFcnJvckZlZWRiYWNrTXNnKF9ULk1TRy5WRVJJRllfREFUQV9GQUlMKTsKICAgICAgICByZXR1cm4gJHEucmVqZWN0KCk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBwb3N0U2F2ZSgpIHsKICAgICAgZ2V0U2hpcG1lbnRCYXNpY0luZm8oKTsKICAgICAgc2V0Q3VySGJsSWR4KHZtLmN1ckhibElkeCk7CiAgICB9CgogICAgLy8gPT09PT09PT09PT09PT09PSBUb29scyA9PT09PT09PT09PT09PT09CiAgICBmdW5jdGlvbiBjb3B5TWJsKG9iaikgewogICAgICBtb2RhbEFkdmFuY2VkQ29weVNoaXBtZW50Lm9wZW4odm0udHlwZSwgdm0uaGJsX2xpc3QubGVuZ3RoKQogICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgICAgbG9jYXRpb24uaHJlZiA9IFVSTC5NQkxfQ09QWS5mb3JtYXQoCiAgICAgICAgICAgIG9iai5maWxpbmdObywKICAgICAgICAgICAgcmVzdWx0LmNvcHlIYmwsIHJlc3VsdC5jb3B5SW52VHlwZXMsIHJlc3VsdC5jb3B5U3R5bGUsIHJlc3VsdC5jb3B5Q29tbW9kaXR5LAogICAgICAgICAgKTsKICAgICAgfSwgZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgY29uc29sZS5sb2coJ2NhbmNlbCBjb3B5aW5nIHNoaXBtZW50Jyk7CiAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIHByZXBhcmVNYmxBZXNUb29scygpIHsKICAgICAgY29uc3Qgc2hvd09uT2UgPSAoKSA9PiAoCiAgICAgICAgdm0ub2NlYW5FeHBvcnRNYmwuaXNFeHBvcnRGcm9tVVModm0ubWJsKQogICAgICAgICYmIHZtLm1ibC50eXBlID09PSAnT0UnICYmIHZtLm1ibC5vZV9pbmZvLmlzX2RpcmVjdAogICAgICApOwogICAgICBjb25zdCBzaG93T25BZSA9ICgpID0+ICgKICAgICAgICB2bS5haXJFeHBvcnRNYXdiLmlzRXhwb3J0RnJvbVVTKHZtLm1ibCkKICAgICAgICAmJiB2bS5tYmwudHlwZSA9PT0gJ0FFJyAmJiB2bS5tYmwuYWVfaW5mby5pc19kaXJlY3QKICAgICAgKTsKICAgICAgcmV0dXJuIHsKICAgICAgICBsYWJlbDogX1QuTVNHLkFFU19ESVJFQ1QsCiAgICAgICAgaWNvbjogJ2ZhIGZhLWZpbGUtdGV4dC1vJywKICAgICAgICBjbGljazogKCkgPT4gewogICAgICAgICAgY29uc3Qgb3BlbkFlc01vZGFsID0gKCkgPT4gewogICAgICAgICAgICBjb25zdCBhZXNNb2RhbCA9IHZtLmFlc1N2Yy5vcGVuTW9kYWwoJ21ibCcsIHZtLm1ibC5maWxpbmdfbm8pOwogICAgICAgICAgICBhZXNNb2RhbC5yZXN1bHQuZmluYWxseSgoKSA9PiBsb2FkRGF0YSgpKTsKICAgICAgICAgIH07CiAgICAgICAgICBpZiAodm0uZ0Zvcm0uJGRpcnR5KSB7CiAgICAgICAgICAgIGlmICghdm0uUC5TSElQTUVOVF9FTlRSWV9FRElUX0FMTCAmJiAhdm0uUC5TSElQTUVOVF9FTlRSWV9FRElUX1NFTEYpIHsKICAgICAgICAgICAgICByZXR1cm4gbW9kYWwub3Blbk5vdGljZShtYmxDb250cm9sbGVyTWVzc2FnZS5OT1RJRllfTk9fUEVSTV9UT19TQVZFKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbW9kYWwKICAgICAgICAgICAgICAub3BlbihtYmxDb250cm9sbGVyTWVzc2FnZS5OT1RJRllfVE9fU0FWRV9OT1cpCiAgICAgICAgICAgICAgLnRoZW4odm0uc2F2ZSkKICAgICAgICAgICAgICAudGhlbigoKSA9PiBvcGVuQWVzTW9kYWwoKSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gb3BlbkFlc01vZGFsKCk7CiAgICAgICAgfSwKICAgICAgICBzaG93OiAoKSA9PiBzaG93T25PZSgpIHx8IHNob3dPbkFlKCksCiAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gcHJlcGFyZU1ibFRvb2xzKG9wdGlvbnMpIHsKCiAgICAgIGxldCBtZW51ID0gWwogICAgICAgIHNoaXBtZW50QmxvY2tTZXJ2aWNlLmdldE1CTFRvb2xJdGVtKHsKICAgICAgICAgIGdldE1CTDogKCkgPT4gdm0ubWJsLAogICAgICAgICAgb25DbGljazogKCkgPT4gb25DbGlja0Jsb2NrTWJsKCksCiAgICAgICAgICBpc1Nob3c6ICgpID0+IHZtLlAgJiYgdm0uUC5TSElQTUVOVF9FTlRSWV9CTE9DS19VTkJMT0NLX1ZJU0lCTEUsCiAgICAgICAgfSksCiAgICAgICAgewogICAgICAgICAgbGFiZWw6IF9ULk1TRy5DT1BZLAogICAgICAgICAgaWNvbjogJ2ZhIGZhLWZpbGVzLW8nLAogICAgICAgICAgY2xpY2s6IGNvcHlNYmwsCiAgICAgICAgICBzaG93OiBvcHRpb25zLnBlcm1Db3B5VmlzaWJsZSwKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgIGxhYmVsOiBfVC5NU0cuREVMRVRFLAogICAgICAgICAgaWNvbjogJ2ZhIGZhLXRyYXNoLW8nLAogICAgICAgICAgY2xpY2s6IGRlbGV0ZU1ibCwKICAgICAgICAgIGRpc2FibGVkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICFjYW5EZWxldGVNYmwoKTsKICAgICAgICAgIH0sCiAgICAgICAgICB0b29sdGlwOiBmdW5jdGlvbigpewogICAgICAgICAgICByZXR1cm4gZGlzYWJsZURlbGV0ZU1ibFRvb2x0aXAoKTsKICAgICAgICAgIH0sCiAgICAgICAgICBzaG93OiBvcHRpb25zLnBlcm1EZWxWaXNpYmxlLAogICAgICAgIH0KICAgICAgXTsKCiAgICAgIGlmIChpc09JKCkgJiYgdm0udXNlci5jYW5FbWFpbCkgewogICAgICAgIG1lbnUucHVzaCh7CiAgICAgICAgICBsYWJlbDogX1QuTVNHLkJBVENIX0VNQUlMLAogICAgICAgICAgaWNvbjogJ2ZhIGZhLWZpbGUtdGV4dC1vJywKICAgICAgICAgIGNsaWNrOiBvcGVuQmF0Y2hFbWFpbE1vZGFsLAogICAgICAgICAgZGlzYWJsZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdm0uaGJsX2xpc3QubGVuZ3RoIDwgMTsKICAgICAgICAgIH0sCiAgICAgICAgICBzaG93OiAoKSA9PiB2bS5QICYmIHZtLlAuU0hJUE1FTlRfRU5UUllfTUJMX0JBVENIX0FDVElPTl9WSVNJQkxFLAogICAgICAgIH0pOwogICAgICB9CgogICAgICBpZiAoaXNPSSgpIHx8IGlzQUkoKSkgewogICAgICAgIG1lbnUucHVzaCh7CiAgICAgICAgICBsYWJlbDogX1QuTVNHLkJBVENIX1BSSU5ULAogICAgICAgICAgaWNvbjogJ2ZhIGZhLWZpbGUtdGV4dC1vJywKICAgICAgICAgIGNsaWNrOiBvcGVuQmF0Y2hQcmludE1vZGFsLAogICAgICAgICAgZGlzYWJsZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdm0uaGJsX2xpc3QubGVuZ3RoIDwgMTsKICAgICAgICAgIH0sCiAgICAgICAgICBzaG93OiAoKSA9PiB2bS5QICYmIHZtLlAuU0hJUE1FTlRfRU5UUllfTUJMX0JBVENIX0FDVElPTl9WSVNJQkxFLAogICAgICAgIH0pOwogICAgICB9CgogICAgICBpZiAoaXNPRSgpICYmIENPTVBBTllfSU5GTy5lbmFibGVfZXNpKSB7CiAgICAgICAgbWVudS5wdXNoKF9wcmVwYXJlRXNpVG9vbCgpKTsKICAgICAgfQoKICAgICAgaWYgKGlzT0UoKSAmJiBDT01QQU5ZX0lORk8uZW5hYmxlX2dmX2VkaSkgewogICAgICAgIG1lbnUucHVzaChfcHJlcGFyZUdvRnJlaWdodEVkaVRvb2woKSk7CiAgICAgIH0KCiAgICAgIGlmIChDT01QQU5ZX0lORk8uYWVzX3NldHVwX3N0eWxlICE9PSBBRVNfU0VUVVBfU1RZTEUuRElTQUJMRUQpIHsKICAgICAgICBpZiAoaXNPRSgpIHx8IGlzQUUoKSkgewogICAgICAgICAgbWVudS5wdXNoKHByZXBhcmVNYmxBZXNUb29scygpKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIG1lbnUucHVzaChzaGlwbWVudFRvb2xTZXJ2aWNlLmFkZERpdmlkZXIoewogICAgICAgIHNob3c6ICgpID0+IHsKICAgICAgICAgIHJldHVybiAodm0uUCAmJiB2bS5QLlNISVBNRU5UX0VOVFJZX0JMT0NLX1VOQkxPQ0tfVklTSUJMRSkgfHwgb3B0aW9ucy5wZXJtRGVsVmlzaWJsZSB8fCBvcHRpb25zLnBlcm1Db3B5VmlzaWJsZQogICAgICAgICAgICB8fCAodm0uUCAmJiB2bS5QLlNISVBNRU5UX0VOVFJZX01CTF9CQVRDSF9BQ1RJT05fVklTSUJMRSk7CiAgICAgICAgfQogICAgICB9KSk7CgogICAgICBtZW51ID0gbWVudS5jb25jYXQoc2hpcG1lbnRUb29sU2VydmljZS5nZXRNQkxHZW5lcmFsSXRlbXMoewogICAgICAgIHNoaXBtZW50VHlwZTogdm0udHlwZSwKICAgICAgICBhY3Rpb25Gb3JDdXN0b21lckhpc3Rvcnk6IHsKICAgICAgICAgIHNob3c6IHZtLm1ibEhpc3RvcnlFeGlzdFF1ZXJpZXIuaXNFeGlzdCwKICAgICAgICB9LAogICAgICB9KSk7CgogICAgICByZXR1cm4gbWVudTsKICAgIH0KCiAgICBmdW5jdGlvbiBjYW5Eb0RlcGFydG1lbnRUcmFuc2ZlcigpIHsKICAgICAgcmV0dXJuICEodm0uY3JlYXRpbmcgfHwgdm0uZ0Zvcm0uJGRpcnR5IHx8IHZtLmRpc2FibGVNb2RlKCdBJykpOwogICAgfQoKICAgIGZ1bmN0aW9uIG9wZW5Nb2RhbERlcGFydG1lbnRUcmFuc2ZlcigpIHsKICAgICAgaWYgKCF2bS5jYW5Eb0RlcGFydG1lbnRUcmFuc2ZlcigpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2bS5vY2VhbkV4cG9ydE1ibC5vcGVuTW9kYWxEZXBhcnRtZW50VHJhbnNmZXIodm0ubWJsKQogICAgICAgIC5yZXN1bHQKICAgICAgICAuZmluYWxseShsb2FkRGF0YSk7CiAgICB9CgogICAgZnVuY3Rpb24gX3ByZXBhcmVFc2lUb29sKCkgewogICAgICByZXR1cm4gewogICAgICAgIGxhYmVsOiBfVC5NU0cuRVNJLAogICAgICAgIGljb246ICdmYSBmYS1maWxlLXRleHQtbycsCiAgICAgICAgY2xpY2s6ICh0b29sT3B0aW9ucykgPT4gewogICAgICAgICAgY29uc3Qgb3BlbkVzaU1vZGFsID0gKCkgPT4gewogICAgICAgICAgICBjb25zdCBlc2lNb2RhbCA9IHZtLmVzaVNlcnZpY2Uub3BlbkVzaU1vZGFsKHRvb2xPcHRpb25zLmZpbGluZ05vKTsKICAgICAgICAgICAgZXNpTW9kYWwucmVzdWx0LmZpbmFsbHkoKCkgPT4gbG9hZERhdGEoKSk7CiAgICAgICAgICB9OwogICAgICAgICAgaWYgKHZtLmdGb3JtLiRkaXJ0eSkgewogICAgICAgICAgICBpZiAoIXZtLlAuU0hJUE1FTlRfRU5UUllfRURJVF9BTEwgJiYgIXZtLlAuU0hJUE1FTlRfRU5UUllfRURJVF9TRUxGKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG1vZGFsLm9wZW5Ob3RpY2UobWJsQ29udHJvbGxlck1lc3NhZ2UuTk9USUZZX05PX1BFUk1fVE9fU0FWRSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1vZGFsCiAgICAgICAgICAgICAgLm9wZW4obWJsQ29udHJvbGxlck1lc3NhZ2UuTk9USUZZX1RPX1NBVkVfTk9XKQogICAgICAgICAgICAgIC50aGVuKHZtLnNhdmUpCiAgICAgICAgICAgICAgLnRoZW4oKCkgPT4gb3BlbkVzaU1vZGFsKCkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG9wZW5Fc2lNb2RhbCgpOwogICAgICAgIH0sCiAgICAgICAgZGlzYWJsZWQ6ICgpID0+IHZtLmNyZWF0aW5nCiAgICAgICAgICB8fCAhdm0uUC5FU0lfVklFVwogICAgICAgICAgfHwgISh2bS5tYmwuY29udGFpbmVyX2luZm9fc2V0ICYmIHZtLm1ibC5jb250YWluZXJfaW5mb19zZXQubGVuZ3RoKSwKICAgICAgICB0b29sdGlwOiAoKSA9PiB7CiAgICAgICAgICBpZiAoIXZtLlAuRVNJX1ZJRVcpIHsKICAgICAgICAgICAgcmV0dXJuIF9ULk1TRy5OT19QRVJNSVNTSU9OX1RPX1ZJRVdfRVNJOwogICAgICAgICAgfQoKICAgICAgICAgIGlmICghKHZtLm1ibC5jb250YWluZXJfaW5mb19zZXQgJiYgdm0ubWJsLmNvbnRhaW5lcl9pbmZvX3NldC5sZW5ndGgpKSB7CiAgICAgICAgICAgIHJldHVybiBfVC5NU0cuRVNJX1JFUVVJUkVfQ09OVEFJTkVSOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfSwKICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBfcHJlcGFyZUdvRnJlaWdodEVkaVRvb2woKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgbGFiZWw6IF9ULk1TRy5HRl9FREksCiAgICAgICAgaWNvbjogJ2ZhIGZhLWZpbGUtdGV4dC1vJywKICAgICAgICBjbGljazogKCkgPT4gewogICAgICAgICAgdm0uY2FuU2hvd0VkaUVycm9yID0gdHJ1ZTsKCiAgICAgICAgICBpZiAodm0uZ0Zvcm0uJGRpcnR5KSB7CiAgICAgICAgICAgIHJldHVybiBtb2RhbAogICAgICAgICAgICAgIC5vcGVuKG1ibENvbnRyb2xsZXJNZXNzYWdlLk5PVElGWV9UT19TQVZFX05PVykKICAgICAgICAgICAgICAudGhlbigoKSA9PiB2bS5zYXZlKCkpCiAgICAgICAgICAgICAgLnRoZW4oKCkgPT4gb3BlblN1Ym1pdE1vZGFsKCkpOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBvcGVuU3VibWl0TW9kYWwoKTsKCiAgICAgICAgICAvKiBAaW50ZXJuYWwgZnVuY3Rpb25zICovCiAgICAgICAgICBmdW5jdGlvbiBwcmVwYXJlTW9kYWxEaWFsb2dUZXh0KCkgewogICAgICAgICAgICBsZXQgYmxOb0xpc3QgPSBbXTsKCiAgICAgICAgICAgIGlmICghdm0ubWJsLmVkaV9pbmZvKSB7CiAgICAgICAgICAgICAgYmxOb0xpc3QucHVzaCh2bS5tYmwuTUJMX05PKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYmxOb0xpc3QgPSBibE5vTGlzdC5jb25jYXQoCiAgICAgICAgICAgICAgdm0uaGJsX2xpc3QKICAgICAgICAgICAgICAgIC5maWx0ZXIoaGJsID0+ICFoYmwuZWRpX2luZm8pCiAgICAgICAgICAgICAgICAubWFwKGhibCA9PiBoYmwuSEJMX05PKSwKICAgICAgICAgICAgKTsKCiAgICAgICAgICAgIGNvbnN0IHRpdGxlID0gY3JlYXRlU3RyaW5nRm9ybWF0dGVyKF9ULk1TRy5FRElfU1VCTUlUX0NPTkZJUk0pLmZvcm1hdCh2bS5tYmwub3ZlcnNlYV9hZ2VudC5uYW1lKTsKICAgICAgICAgICAgcmV0dXJuIFt0aXRsZSwgYmxOb0xpc3Quam9pbignPGJyLz4nKV07CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gb3BlblN1Ym1pdE1vZGFsKCkgewogICAgICAgICAgICBjb25zdCBjb250YWluZXJJbmZvU2V0ID0gdm0ubWJsLmNvbnRhaW5lcl9pbmZvX3NldDsKICAgICAgICAgICAgY29uc3QgW25vTWJsTm8sIG5vRXRhLCBub0N0Tm9dID0gWwogICAgICAgICAgICAgICF2bS5tYmwuTUJMX05PLAogICAgICAgICAgICAgICF2bS5tYmwuRVRBLAogICAgICAgICAgICAgIChjb250YWluZXJJbmZvU2V0ICYmICFjb250YWluZXJJbmZvU2V0LmV2ZXJ5KGN0ID0+IGN0LmNvbnRhaW5lcl9ubykpLAogICAgICAgICAgICBdOwoKICAgICAgICAgICAgaWYgKFtub01ibE5vLCBub0V0YSwgbm9DdE5vXS5zb21lKGMgPT4gYykpIHsKICAgICAgICAgICAgICBjb25zdCBtaXNzaW5nRmllbGRzID0gW107CiAgICAgICAgICAgICAgaWYgKG5vTWJsTm8pIHsKICAgICAgICAgICAgICAgIG1pc3NpbmdGaWVsZHMucHVzaChfVC5NU0cuTUJMX05PKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGlmIChub0V0YSkgewogICAgICAgICAgICAgICAgbWlzc2luZ0ZpZWxkcy5wdXNoKF9ULk1TRy5FVEEpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaWYgKG5vQ3RObykgewogICAgICAgICAgICAgICAgbWlzc2luZ0ZpZWxkcy5wdXNoKF9ULk1TRy5DT05UQUlORVJfTk8pOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgY29uc3QgbXNnID0gY3JlYXRlU3RyaW5nRm9ybWF0dGVyKF9ULk1TRy5NQU5EQVRPUllfRk9SX0VESSkuZm9ybWF0KG1pc3NpbmdGaWVsZHMuam9pbignLCAnKSk7CgogICAgICAgICAgICAgIFNob3dFcnJvckZlZWRiYWNrTXNnKG1zZyk7CiAgICAgICAgICAgICAgcmV0dXJuICRxLnJlamVjdCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gbW9kYWwKICAgICAgICAgICAgICAub3BlbkNvbmZpcm0oLi4ucHJlcGFyZU1vZGFsRGlhbG9nVGV4dCgpKQogICAgICAgICAgICAgIC50aGVuKCgpID0+ICRodHRwCiAgICAgICAgICAgICAgICAucG9zdChgL2FwaS9lZGkvb2UtdG8tb2kvJHt2bS5tYmwuZmlsaW5nX25vfS9gKQogICAgICAgICAgICAgICAgLnRoZW4oCiAgICAgICAgICAgICAgICAgICgpID0+IHsKICAgICAgICAgICAgICAgICAgICBTaG93U3VjY2Vzc0ZlZWRiYWNrTXNnKF9ULk1TRy5TVUJNSVRfU1VDQyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxvYWREYXRhKCk7CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICgpID0+IHsKICAgICAgICAgICAgICAgICAgICBTaG93RXJyb3JGZWVkYmFja01zZyhfVC5NU0cuU1VCTUlUX0ZBSUwpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcS5yZWplY3QoKTsKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICkpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZGlzYWJsZWQ6ICgpID0+ICghdm0uUC5TSElQTUVOVF9FTlRSWV9FRElUX0FMTCAmJiAhdm0uUC5TSElQTUVOVF9FTlRSWV9FRElUX1NFTEYpCiAgICAgICAgICB8fCAhdm0ub2NlYW5FeHBvcnRNYmwuaXNPdmVyc2VhQWdlbnRBY3RpdmF0ZWRGb3JFZGkodm0ubWJsKQogICAgICAgICAgfHwgKCEhdm0ubWJsLmVkaV9pbmZvICYmIHZtLmhibF9saXN0LmV2ZXJ5KGhibCA9PiAhIWhibC5lZGlfaW5mbykpLCAvLyBhbGwgc3VibWl0dGVkCiAgICAgICAgdG9vbHRpcDogKCkgPT4gewogICAgICAgICAgaWYgKCF2bS5QLlNISVBNRU5UX0VOVFJZX0VESVRfQUxMICYmICF2bS5QLlNISVBNRU5UX0VOVFJZX0VESVRfU0VMRikgewogICAgICAgICAgICByZXR1cm4gX1QuTVNHLk5PX1BFUk1JU1NJT05fVE9fU1VCTUlUX0VESTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoIXZtLm9jZWFuRXhwb3J0TWJsLmlzT3ZlcnNlYUFnZW50QWN0aXZhdGVkRm9yRWRpKHZtLm1ibCkpIHsKICAgICAgICAgICAgcmV0dXJuIF9ULk1TRy5PVkVSU0VBX0FHRU5UX05PVF9BQ1RJVkFURV9GT1JfRURJOwogICAgICAgICAgfQoKICAgICAgICAgIGlmICghIXZtLm1ibC5lZGlfaW5mbyAmJiB2bS5oYmxfbGlzdC5ldmVyeShoYmwgPT4gISFoYmwuZWRpX2luZm8pKSB7IC8vIGFsbCBzdWJtaXR0ZWQKICAgICAgICAgICAgcmV0dXJuIF9ULk1TRy5OT1RfQUxMT1dfRFVFX1RPX0FMTF9TSElQTUVOVF9TVUJNSVQ7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfSwKICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBvcGVuQmF0Y2hFbWFpbE1vZGFsKCkgewogICAgICB3YXJuRm9ybU5lZWRTYXZlKCkKICAgICAgICAudGhlbigoKSA9PiBpbnZvaWNlVHBVcGRhdGVTZXJ2aWNlLmNsZWFyTmV3VHJhZGVQYXJ0bmVyKCkpCiAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICBoY0JhdGNoRW1haWxTZXJ2aWNlLm9wZW5Nb2RhbCh2bS5maWxpbmdObywgdm0udXNlciwgdm0ubWJsLm9mZmljZSk7CiAgICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gb3BlbkJhdGNoUHJpbnRNb2RhbCgpIHsKICAgICAgYmF0Y2hQcmludFNlcnZpY2Uub3Blbk1vZGFsKHZtLm1ibC5maWxpbmdfbm8sIHZtLnR5cGUpOwogICAgfQoKICAgIGZ1bmN0aW9uIHByZXBhcmVIYmxBZXNUb29scygpIHsKICAgICAgY29uc3Qgc2hvd09uT2UgPSAoKSA9PiAoCiAgICAgICAgdm0ub2NlYW5FeHBvcnRIYmwuaXNFeHBvcnRGcm9tVVMoeyBtYmw6IHZtLm1ibCB9KQogICAgICAgICYmIHZtLmhibF9saXN0W3ZtLmN1ckhibElkeF0gJiYgdm0uaGJsX2xpc3Rbdm0uY3VySGJsSWR4XS50eXBlID09PSAnT0UnCiAgICAgICk7CiAgICAgIGNvbnN0IHNob3dPbkFlID0gKCkgPT4gKAogICAgICAgIHZtLmFpckV4cG9ydEhhd2IuaXNFeHBvcnRGcm9tVVMoeyBtYmw6IHZtLm1ibCB9KQogICAgICAgICYmIHZtLmhibF9saXN0W3ZtLmN1ckhibElkeF0gJiYgdm0uaGJsX2xpc3Rbdm0uY3VySGJsSWR4XS50eXBlID09PSAnQUUnCiAgICAgICk7CiAgICAgIHJldHVybiB7CiAgICAgICAgbGFiZWw6IF9ULk1TRy5BRVNfRElSRUNULAogICAgICAgIGljb246ICdmYSBmYS1maWxlLXRleHQtbycsCiAgICAgICAgY2xpY2s6ICgpID0+IHsKICAgICAgICAgIGNvbnN0IG9wZW5BZXNNb2RhbCA9ICgpID0+IHsKICAgICAgICAgICAgY29uc3QgYWVzTW9kYWwgPSB2bS5hZXNTdmMub3Blbk1vZGFsKCdoYmwnLCB2bS5oYmxfbGlzdFt2bS5jdXJIYmxJZHhdLmlkKTsKICAgICAgICAgICAgYWVzTW9kYWwucmVzdWx0LmZpbmFsbHkoKCkgPT4gbG9hZERhdGEoKSk7CiAgICAgICAgICB9OwogICAgICAgICAgaWYgKHZtLmdGb3JtLiRkaXJ0eSkgewogICAgICAgICAgICBpZiAoIXZtLlAuU0hJUE1FTlRfRU5UUllfRURJVF9BTEwgJiYgIXZtLlAuU0hJUE1FTlRfRU5UUllfRURJVF9TRUxGKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG1vZGFsLm9wZW5Ob3RpY2UobWJsQ29udHJvbGxlck1lc3NhZ2UuTk9USUZZX05PX1BFUk1fVE9fU0FWRSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1vZGFsCiAgICAgICAgICAgICAgLm9wZW4obWJsQ29udHJvbGxlck1lc3NhZ2UuTk9USUZZX1RPX1NBVkVfTk9XKQogICAgICAgICAgICAgIC50aGVuKHZtLnNhdmUpCiAgICAgICAgICAgICAgLnRoZW4oKCkgPT4gb3BlbkFlc01vZGFsKCkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG9wZW5BZXNNb2RhbCgpOwogICAgICAgIH0sCiAgICAgICAgc2hvdzogKCkgPT4gc2hvd09uT2UoKSB8fCBzaG93T25BZSgpLAogICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIHByZXBhcmVIYmxUb29scyhvcHRpb25zKSB7CiAgICAgIGxldCBtZW51ID0gWwogICAgICAgIHNoaXBtZW50QmxvY2tTZXJ2aWNlLmdldEhCTFRvb2xJdGVtKHsKICAgICAgICAgIGdldE1CTDogKCkgPT4gdm0ubWJsLAogICAgICAgICAgb25DbGljazogb2JqID0+IG9uQ2xpY2tCbG9ja0hibChvYmouaGJsKSwKICAgICAgICAgIGlzU2hvdzogKCkgPT4gdm0uUCAmJiB2bS5QLlNISVBNRU5UX0VOVFJZX0JMT0NLX1VOQkxPQ0tfVklTSUJMRSwKICAgICAgICB9KSwKICAgICAgICB7CiAgICAgICAgICBsYWJlbDogX1QuTVNHLkNPUFksCiAgICAgICAgICBpY29uOiAnZmEgZmEtZmlsZXMtbycsCiAgICAgICAgICBkaXNhYmxlZDogZnVuY3Rpb24gKGFyZ3MpIHsKICAgICAgICAgICAgLy8gZGlzYWJsZSBpdCBpZiBtYmwgaXMgYmxvY2tlZAogICAgICAgICAgICByZXR1cm4gdm0ubWJsLmlzX2Jsb2NrX3Blcm07CiAgICAgICAgICB9LAogICAgICAgICAgdG9vbHRpcDogZnVuY3Rpb24gKGFyZ3MpIHsKICAgICAgICAgICAgcmV0dXJuIGRpc2FibGVDb3B5SEJMVG9vbHRpcCgpOwogICAgICAgICAgfSwKICAgICAgICAgIGNsaWNrOiB2bS5jb3B5SGJsLAogICAgICAgICAgc2hvdzogb3B0aW9ucy5wZXJtQ29weVZpc2libGUsCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICBsYWJlbDogX1QuTVNHLkRFTEVURSwKICAgICAgICAgIGljb246ICdmYSBmYS10cmFzaC1vJywKICAgICAgICAgIGNsaWNrOiBmdW5jdGlvbiAoYXJncykgewogICAgICAgICAgICBkZWxldGVIYmwoYXJncy5oYmwpOwogICAgICAgICAgfSwKICAgICAgICAgIGRpc2FibGVkOiBmdW5jdGlvbihhcmdzKSB7CiAgICAgICAgICAgIHJldHVybiAhY2FuRGVsZXRlSGJsKGFyZ3MuaGJsKTsKICAgICAgICAgIH0sCiAgICAgICAgICB0b29sdGlwOiBmdW5jdGlvbihhcmdzKXsKICAgICAgICAgICAgcmV0dXJuIGRpc2FibGVEZWxldGVIYmxUb29sdGlwKGFyZ3MuaGJsKTsKICAgICAgICAgIH0sCiAgICAgICAgICBzaG93OiBvcHRpb25zLnBlcm1EZWxWaXNpYmxlLAogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgbGFiZWw6IF9ULk1TRy5DT1BZX1RPLAogICAgICAgICAgaWNvbjogJ2ZhIGZhLWZpbGVzLW8nLAogICAgICAgICAgZGlzYWJsZWQ6IGZ1bmN0aW9uIChhcmdzKSB7CiAgICAgICAgICAgIHJldHVybiB2bS5tYmwuaXNfYmxvY2tfcGVybTsKICAgICAgICAgIH0sCiAgICAgICAgICB0b29sdGlwOiBmdW5jdGlvbiAoYXJncykgewogICAgICAgICAgICByZXR1cm4gZGlzYWJsZUNvcHlIQkxUb090aGVyTWJsVG9vbHRpcCgpOwogICAgICAgICAgfSwKICAgICAgICAgIGNsaWNrOiAoYXJncykgPT4gewogICAgICAgICAgICB2bS5jb3B5SGJsVG9PdGhlck1ibChhcmdzLmhibCk7CiAgICAgICAgICB9LAogICAgICAgICAgc2hvdzogb3B0aW9ucy5wZXJtQ29weVZpc2libGUsCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICBsYWJlbDogX1QuTVNHLk1PVkVfVE8sCiAgICAgICAgICBpY29uOiAnZmEgZmEtc2hhcmUnLAogICAgICAgICAgZGlzYWJsZWQ6IGZ1bmN0aW9uIChhcmdzKSB7CiAgICAgICAgICAgIGNvbnN0IHsgaGJsIH0gPSBhcmdzOwogICAgICAgICAgICBjb25zdCBoYXNCbG9ja2VkSW52b2ljZSA9IGhibC5pbnZvaWNlX3NldAogICAgICAgICAgICAgID8gaGJsLmludm9pY2Vfc2V0LnNvbWUoaW52ID0+IGludi5pc19ibG9jaykKICAgICAgICAgICAgICA6IGZhbHNlOwogICAgICAgICAgICByZXR1cm4gdm0ubWJsLmlzX2Jsb2NrIHx8IGhibC5pc19ibG9jayB8fCBoYXNCbG9ja2VkSW52b2ljZTsKICAgICAgICAgIH0sCiAgICAgICAgICB0b29sdGlwOiBmdW5jdGlvbiAoYXJncykgewogICAgICAgICAgICByZXR1cm4gZGlzYWJsZU1vdmVIQkxUb090aGVyTWJsVG9vbHRpcChhcmdzKTsKICAgICAgICAgIH0sCiAgICAgICAgICBjbGljazogKGFyZ3MpID0+IHsKICAgICAgICAgICAgdm0ubW92ZUhibFRvT3RoZXJNYmwoYXJncy5oYmwpOwogICAgICAgICAgfSwKICAgICAgICAgIHNob3c6IG9wdGlvbnMucGVybUNvcHlWaXNpYmxlLAogICAgICAgIH0sCiAgICAgIF07CiAgICAgIGlmIChpc09FKCkpIHsKICAgICAgICBtZW51LnB1c2goewogICAgICAgICAgbGFiZWw6IF9ULk1TRy5ERVRBQ0gsCiAgICAgICAgICBpY29uOiAnZmEgZmEtdW5saW5rJywKICAgICAgICAgIGNsaWNrOiAoYXJncykgPT4gewogICAgICAgICAgICBkZXRhY2hIYmwoYXJncy5oYmwpOwogICAgICAgICAgfSwKICAgICAgICAgIGRpc2FibGVkOiBhcmdzID0+ICFjYW5EZXRhY2hIYmwoYXJncy5oYmwpLAogICAgICAgICAgdG9vbHRpcDogYXJncyA9PiBkaXNhYmxlRGV0YWNoSGJsVG9vbHRpcChhcmdzLmhibCksCiAgICAgICAgICBzaG93OiBvcHRpb25zLnBlcm1EZWxWaXNpYmxlLAogICAgICAgIH0pOwogICAgICB9CgogICAgICAvLyBBRVMgRGlyZWN0CiAgICAgIGlmIChDT01QQU5ZX0lORk8uYWVzX3NldHVwX3N0eWxlICE9PSBBRVNfU0VUVVBfU1RZTEUuRElTQUJMRUQpIHsKICAgICAgICBpZiAoaXNPRSgpIHx8IGlzQUUoKSkgewogICAgICAgICAgbWVudS5wdXNoKHByZXBhcmVIYmxBZXNUb29scygpKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIG1lbnUucHVzaChzaGlwbWVudFRvb2xTZXJ2aWNlLmFkZERpdmlkZXIoKSk7CiAgICAgIG1lbnUgPSBtZW51LmNvbmNhdChzaGlwbWVudFRvb2xTZXJ2aWNlLmdldEhCTEdlbmVyYWxJdGVtcyh7CiAgICAgICAgc2hpcG1lbnRUeXBlOiB2bS50eXBlLAogICAgICAgIGFjdGlvbkZvckN1c3RvbWVySGlzdG9yeTogewogICAgICAgICAgc2hvdzogdm0uaGJsSGlzdG9yeUV4aXN0UXVlcmllci5pc0V4aXN0LAogICAgICAgIH0sCiAgICAgIH0pKTsKCiAgICAgIHJldHVybiBtZW51OwogICAgfQoKICAgIGZ1bmN0aW9uIGdldFRyYWNraW5nSGJsTGluayhoYmwpIHsKICAgICAgaWYodm0uY3JlYXRpbmcpCiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIHJldHVybiBmdHNTZXJ2aWNlLmdldEhibFVybChoYmwuaWQpOwogICAgfQoKICAgIGZ1bmN0aW9uIHRvZ2dsZUhibEFkdmFuY2VkKGlkeCkgewogICAgICB2YXIgYWR2YW5jZUZpZWxkID0gJCgnLmlucHV0LWhpZGUtaGJsLScgKyBpZHgpOwogICAgICB2YXIgYWR2YW5jZUhibEJ0biA9ICQoJy5hZHZhbmNlLWhibC1idG4tJyArIGlkeCk7CgogICAgICB2YXIgYmdfcG9zID0gKGFkdmFuY2VGaWVsZC5jc3MoJ2Rpc3BsYXknKSA9PT0gJ25vbmUnKSA/ICcxcHggNjVweCcgOiAnMXB4IDFweCc7CgogICAgICBhZHZhbmNlRmllbGQuZmFkZVRvZ2dsZSgiZmFzdCIsICJsaW5lYXIiKTsKICAgICAgYWR2YW5jZUhibEJ0bi5jc3MoImJhY2tncm91bmQtcG9zaXRpb24iLCBiZ19wb3MpOwogICAgfQoKICAgIGZ1bmN0aW9uIGZpbGxPY2VhbkNhcnJpZXIoKSB7CiAgICAgIGlmICh2bS5tYmwuTUJMX05PICYmIHZtLm1ibC5NQkxfTk8ubGVuZ3RoID49IDQpIHsKICAgICAgICBkb0ZpbGxJbkNhcnJpZXJCeSh7CiAgICAgICAgICBzY2FjOiB2bS5tYmwuTUJMX05PLnN1YnN0cmluZygwLCA0KSwKICAgICAgICAgIHR5cGU6ICdDUicsCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBmaWxsQWlyQ2FycmllcigpIHsKICAgICAgaWYgKHZtLm1ibC5NQkxfTk8gJiYgdm0ubWJsLk1CTF9OTy5sZW5ndGggPj0gMykgewogICAgICAgIGRvRmlsbEluQ2FycmllckJ5KHsKICAgICAgICAgIHByZWZpeDogdm0ubWJsLk1CTF9OTy5zdWJzdHJpbmcoMCwgMyksCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBkb0ZpbGxJbkNhcnJpZXJCeShwYXJhbXMpIHsKICAgICAgcGFyYW1zWydsaW1pdCddID0gMTsKCiAgICAgIHNob3dTcGluKCk7CgogICAgICByZXR1cm4gdm0uZW5kcG9pbnRzLlRQLmdldCh7IHBhcmFtczogcGFyYW1zIH0pCiAgICAgICAgLnRoZW4ob25TdWNjZXNzKQogICAgICAgIC5jYXRjaChleGNlcHRpb25IYW5kbGVyLmxvZ0Vycm9yKQogICAgICAgIC5maW5hbGx5KGhpZGVTcGluKTsKCiAgICAgIGZ1bmN0aW9uIG9uU3VjY2VzcyhyZXNwb25zZSkgewogICAgICAgIHZhciBjYXJyaWVyID0gXyhyZXNwb25zZS5kYXRhKS5maXJzdCgpOwogICAgICAgIGlmIChjYXJyaWVyKSB7CiAgICAgICAgICB2bS5tYmwuY2FycmllciA9IGNhcnJpZXI7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gX3VwZGF0ZU5vdGlmaWNhdGlvbigpIHsKICAgICAgY29uc3QgcCA9IHZtLm5vdGlmaWNhdGlvbkhlbHBlci51cGRhdGVOb3RpZmljYXRpb24oKTsKICAgICAgdm0ubm90aWZpY2F0aW9uSGVscGVyLmJyb2FkY2FzdE5vdGlmaWNhdGlvbigkc2NvcGUpOwogICAgICByZXR1cm4gcDsKICAgIH0KCiAgICAvLyA9PT09PT09PT09PT09PT09PT09PT0gRm9yIEFJL0FFIG9ubHkgPT09PT09PT09PT09PT09PT09PT09CiAgICBmdW5jdGlvbiBwb19iYWNrZW5kMnVpKG9iail7ICAvLyBzdHIgdG8gbWFwCiAgICAgIHZhciBzID0gb2JqLnBvX251bV9saXN0OwogICAgICB2YXIgbWFwID0gW107CiAgICAgIGlmKHMpewogICAgICAgIHZhciBzX2FyciA9IHMuc3BsaXQoJywnKTsKICAgICAgICBmb3IodmFyIGk9MCA7IGk8c19hcnIubGVuZ3RoIDsgKytpKQogICAgICAgICAgbWFwLnB1c2goe3RleHQ6IHNfYXJyW2ldfSk7CiAgICAgIH0KICAgICAgb2JqLl9fcG9fbnVtX2xpc3QgPSBtYXA7CiAgICB9CgogICAgZnVuY3Rpb24gcG9fdWkyYmFja2VuZChvYmopewogICAgICB2YXIgbWFwID0gb2JqLl9fcG9fbnVtX2xpc3Q7CiAgICAgIGlmKG1hcC5sZW5ndGggPT09IDApewogICAgICAgIG9iai5wb19udW1fbGlzdCA9IG51bGw7CiAgICAgIH0KICAgICAgZWxzZXsKICAgICAgICB2YXIgcyA9ICcnOwogICAgICAgIGZvcih2YXIgaT0wIDsgaTxtYXAubGVuZ3RoIDsgKytpKXsKICAgICAgICAgIGlmKGk+MCkKICAgICAgICAgICAgcyArPSAnLCc7CiAgICAgICAgICBzICs9IG1hcFtpXS50ZXh0OwogICAgICAgIH0KICAgICAgICBvYmoucG9fbnVtX2xpc3QgPSBzOwogICAgICB9CgogICAgfQoKICAgIGZ1bmN0aW9uIGNvcHlQT05vVG9EZXNjcmlwdGlvbihvYmpQTywgb2JqRGVzYywgZm9ybVRvRGlydHkpIHsKICAgICAgdmFyIHBvID0gb2JqUE8uX19wb19udW1fbGlzdC5tYXAoZnVuY3Rpb24gKHBvX251bSkgewogICAgICAgIHJldHVybiBwb19udW0udGV4dDsKICAgICAgfSk7CiAgICAgIHBvID0gJ1AuTy4gTk8uJyArICdcbicgKyBwby5qb2luKCcsICcpOwoKICAgICAgaWYgKG9iakRlc2MuZGVzY3JpcHRpb24pIHsKICAgICAgICBvYmpEZXNjLmRlc2NyaXB0aW9uICs9ICdcblxuJyArIHBvOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIG9iakRlc2MuZGVzY3JpcHRpb24gPSBwbzsKICAgICAgfQoKICAgICAgZm9ybVRvRGlydHkuJHNldERpcnR5KCk7CiAgICB9CgogICAgZnVuY3Rpb24gY29weUNvbW1vZGl0eVRvRGVzY3JpcHRpb24ob2JqQ29tbW9kaXR5LCBvYmpEZXNjLCBmb3JtVG9EaXJ0eSwgb3B0aW9ucyA9IG51bGwpIHsKICAgICAgY29uc3Qgd2l0aEh0c0NvZGUgPSBvcHRpb25zID8gb3B0aW9ucy53aXRoSHRzQ29kZSA6IGZhbHNlOwogICAgICBjb25zdCBkZXNjcmlwdGlvbiA9IG9iakNvbW1vZGl0eS5fX2l0cwogICAgICAgIC5tYXAoKGl0KSA9PiB7CiAgICAgICAgICBjb25zdCBkZXNjID0gW107CiAgICAgICAgICBpZiAoaXQuZGVzY3JpcHRpb24pIHsKICAgICAgICAgICAgZGVzYy5wdXNoKGAke2l0LmRlc2NyaXB0aW9ufWApOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHdpdGhIdHNDb2RlICYmIGl0Lmh0c19jb2RlKSB7CiAgICAgICAgICAgIGRlc2MucHVzaChgJHtpdC5odHNfY29kZX1gKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBkZXNjLmpvaW4oJyAnKTsKICAgICAgICB9KQogICAgICAgIC5maWx0ZXIoZCA9PiBkKQogICAgICAgIC5qb2luKCdcbicpOwoKCiAgICAgIGlmIChvYmpEZXNjLmRlc2NyaXB0aW9uKSB7CiAgICAgICAgb2JqRGVzYy5kZXNjcmlwdGlvbiArPSBkZXNjcmlwdGlvbiA/IGBcblxuJHtkZXNjcmlwdGlvbn1gIDogJyc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb2JqRGVzYy5kZXNjcmlwdGlvbiA9IGRlc2NyaXB0aW9uOwogICAgICB9CiAgICAgIGZvcm1Ub0RpcnR5LiRzZXREaXJ0eSgpOwogICAgfQoKICAgIGZ1bmN0aW9uIHNlbEFsbENvbW1vZGl0aWVzKG9iaikgewogICAgICB2YXIgaXNfc2VsX2FsbF9pdCA9IG9iai5fX2l0cy5ldmVyeShmdW5jdGlvbihpdGVtKXsKICAgICAgICByZXR1cm4gaXRlbS5fX2NoZWNrZWQ7CiAgICAgIH0pOwogICAgICBvYmouX19pdHMuZm9yRWFjaChmdW5jdGlvbihpdGVtKXsKICAgICAgICBpdGVtLl9fY2hlY2tlZCA9ICFpc19zZWxfYWxsX2l0OwogICAgICB9KTsKICAgICAgcmVmcmVzaEFsbENvbW1vZGl0aWVzKG9iaik7CiAgICB9CgogICAgZnVuY3Rpb24gc2VsQ29tbW9kaXR5KG9iaiwgaXRlbSkgewogICAgICBpdGVtLl9fY2hlY2tlZCA9ICFpdGVtLl9fY2hlY2tlZDsKICAgICAgcmVmcmVzaEFsbENvbW1vZGl0aWVzKG9iaik7CiAgICB9CgogICAgZnVuY3Rpb24gcmVmcmVzaEFsbENvbW1vZGl0aWVzKG9iail7CiAgICAgIGlmKG9iai5fX2l0cy5sZW5ndGggPT09IDApewogICAgICAgIG9iai5fX2lzX3NlbF9hbGxfaXQgPSBmYWxzZTsKICAgICAgfQogICAgICBlbHNlewogICAgICAgIG9iai5fX2lzX3NlbF9hbGxfaXQgPSBvYmouX19pdHMuZXZlcnkoZnVuY3Rpb24oaXRlbSl7CiAgICAgICAgICByZXR1cm4gaXRlbS5fX2NoZWNrZWQ7CiAgICAgICAgfSkKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGdldHRpZCgpeyAgLy8gZ2V0IHRlbXAgaWQgZm9yIG5ldyBjb250YWluZXIgcmVjb3JkCiAgICAgIHRpZCsrOwogICAgICByZXR1cm4gJ0B0bXAtJyt0aWQ7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0X29ial90aWQob2JqKXsKICAgICAgb2JqLnRpZCA9IGdldHRpZCgpOwogICAgfQoKICAgIGZ1bmN0aW9uIGRlbF9vYmpfdGlkKG9iail7CiAgICAgIGlmKG9iai50aWQgIT09IHVuZGVmaW5lZCkKICAgICAgICBkZWxldGUgb2JqLnRpZDsKICAgIH0KCiAgICBmdW5jdGlvbiBhZGRDb21tb2RpdHkob2JqLCB0eXBlKSB7CiAgICAgIHZhciBpdGVtID0gYW5ndWxhci5jb3B5KHZtLmRlZmF1bHRJdGVtW3R5cGVdKTsKICAgICAgc2V0X29ial90aWQoaXRlbSk7CiAgICAgIG9iai5fX2l0cy5zcGxpY2UoMCwgMCwgaXRlbSk7ICAvLyBpbnNlcnQgdG8gMAoKICAgICAgLy8gZm9jdXMgb24gbmV3bHkgY3JlYXRlZCBpdGVtCiAgICAgIHZtLmNvbW1vZGl0eUZvY3VzVGlkW3R5cGVdID0gaXRlbS50aWQ7CiAgICB9CgogICAgZnVuY3Rpb24gZGVsQ29tbW9kaXR5KG9iaiwgdHlwZSl7CiAgICAgIG1vZGFsLm9wZW4oX1QuTVNHLkNPTkZJUk1fREVMRVRFKQogICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3VsdCl7CiAgICAgICAgICB2YXIgcmVxID0gW107CiAgICAgICAgICB2YXIga2VlcF9pdF9saXN0ID0gW107CiAgICAgICAgICBvYmouX19pdHMuZm9yRWFjaChmdW5jdGlvbihpdGVtKXsKICAgICAgICAgICAgaWYoaXRlbS5fX2NoZWNrZWQpewogICAgICAgICAgICAgIGlmKGl0ZW0uaWQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdmFyIGRlbFVybCA9IHsKICAgICAgICAgICAgICAgICAgbWJsOiBVUkwuU0hJUE1FTlRfTUJMX0lULAogICAgICAgICAgICAgICAgICBoYmw6IFVSTC5TSElQTUVOVF9IQkxfSVQsCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcmVxLnB1c2goJGh0dHAuZGVsZXRlKGdlblVybChkZWxVcmxbdHlwZV0sIHtpdGVtX2lkOiBpdGVtLmlkfSkpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgIGtlZXBfaXRfbGlzdC5wdXNoKGl0ZW0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKCiAgICAgICAgICAkcS5hbGwocmVxKQogICAgICAgICAgICAudGhlbigKICAgICAgICAgICAgICBmdW5jdGlvbihyZXN1bHQpewogICAgICAgICAgICAgICAgb2JqLl9faXRzID0ga2VlcF9pdF9saXN0OwogICAgICAgICAgICAgICAgcmVmcmVzaEFsbENvbW1vZGl0aWVzKG9iaik7CiAgICAgICAgICAgICAgICBTaG93RmVlZGJhY2tNc2coJ3N1Y2Nlc3MnLCBfVC5NU0cuREVMRVRFX1NVQ0MpOwogICAgICAgICAgICAgIH0sZnVuY3Rpb24oZXJyUmVzdWx0KXsKICAgICAgICAgICAgICAgICRsb2cuZXJyb3IoZXJyUmVzdWx0KTsKICAgICAgICAgICAgICAgIFNob3dGZWVkYmFja01zZygnZXJyb3InLCBfVC5NU0cuREVMRVRFX0ZBSUwpOwogICAgICAgICAgICB9KQogICAgICAgIH0pCiAgICB9CgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgICBmdW5jdGlvbiBuZ1RhZ3NGaWx0ZXIoc291cmNlLCAkcXVlcnkpewogICAgICBpZigkcXVlcnkgPT09ICcnKQogICAgICAgIHJldHVybiBzb3VyY2U7CiAgICAgIHJldHVybiBzb3VyY2UuZmlsdGVyKGZ1bmN0aW9uKG9iail7CiAgICAgICAgcmV0dXJuIG9iai50ZXh0LnRvVXBwZXJDYXNlKCkuaW5kZXhPZigkcXVlcnkudG9VcHBlckNhc2UoKSkgPj0gMDsKICAgICAgfSkKICAgIH0KCiAgICBmdW5jdGlvbiBhZGRlZFBvVGFnKHBvX251bV9saXN0KSB7CiAgICAgIHBvX251bV9saXN0LmZvckVhY2goZnVuY3Rpb24gKHBvKSB7CiAgICAgICAgcG8udGV4dCA9IHBvLnRleHQudG9VcHBlckNhc2UoKTsKICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gcmVtb3ZpbmdQb1RhZyhvYmosIHJlbW92ZWRfdGFnLCBmb3JtVG9EaXJ0eSl7CiAgICAgIGlmKGZpbmRQb1RhZyhvYmosIHJlbW92ZWRfdGFnKSApewogICAgICAgIG1vZGFsLm9wZW4oX1QuTVNHLkNPTkZJUk1fREVMRVRFKQogICAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzdWx0KXsKICAgICAgICAgICAgLy8gcmVtb3ZlIGZyb20gTUJML0hCTCBpdGVtCiAgICAgICAgICAgIG9iai5fX2l0cy5mb3JFYWNoKGZ1bmN0aW9uKGl0ZW0pewogICAgICAgICAgICAgIHZhciBuZXdfcG9fbGlzdCA9IGl0ZW0uX19wb19udW1fbGlzdC5maWx0ZXIoZnVuY3Rpb24ocG8peyAgLy8gZmlsdGVyIHJlbW92ZWQgdGFnCiAgICAgICAgICAgICAgICByZXR1cm4gcG8udGV4dCAhPT0gcmVtb3ZlZF90YWcudGV4dDsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBpZihuZXdfcG9fbGlzdC5sZW5ndGggIT09IGl0ZW0uX19wb19udW1fbGlzdC5sZW5ndGgpewogICAgICAgICAgICAgICAgaXRlbS5fX3BvX251bV9saXN0ID0gbmV3X3BvX2xpc3Q7CiAgICAgICAgICAgICAgICBpdGVtLl9fZm9ybS4kc2V0RGlydHkoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gcmVtb3ZlIGZyb20gTUJML0hCTAogICAgICAgICAgICB2YXIgbmV3X3BvX2xpc3QgPSBvYmouX19wb19udW1fbGlzdC5maWx0ZXIoZnVuY3Rpb24ocG8peyAgLy8gZmlsdGVyIHJlbW92ZWQgdGFnCiAgICAgICAgICAgICAgcmV0dXJuIHBvLnRleHQgIT09IHJlbW92ZWRfdGFnLnRleHQ7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZihuZXdfcG9fbGlzdC5sZW5ndGggIT09IG9iai5fX3BvX251bV9saXN0Lmxlbmd0aCl7CiAgICAgICAgICAgICAgb2JqLl9fcG9fbnVtX2xpc3QgPSBuZXdfcG9fbGlzdDsKICAgICAgICAgICAgICBpZiAoZm9ybVRvRGlydHkpIHsKICAgICAgICAgICAgICAgIGZvcm1Ub0RpcnR5LiRzZXREaXJ0eSgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgLy8gYWx3YXlzIHJldHVybiBmYWxzZQogICAgICAgIC8vIG1hbnVhbCB1cGRhdGUgaGJsLnBvX251bV9saXN0IGlmIG1vZGFsIGNsaWNrIE9LCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGVsc2V7CiAgICAgICAgaWYgKGZvcm1Ub0RpcnR5KSB7CiAgICAgICAgICBmb3JtVG9EaXJ0eS4kc2V0RGlydHkoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBmaW5kUG9UYWcob2JqLCB0YWcpIHsKICAgICAgdmFyIG5vdF9maW5kID0gb2JqLl9faXRzLmV2ZXJ5KGZ1bmN0aW9uKGl0ZW0pewogICAgICAgIHJldHVybiBpdGVtLl9fcG9fbnVtX2xpc3QuZXZlcnkoZnVuY3Rpb24ocG8peyAgLy8gZmlsdGVyIHJlbW92ZWQgdGFnCiAgICAgICAgICByZXR1cm4gcG8udGV4dCAhPT0gdGFnLnRleHQ7CiAgICAgICAgfSkKICAgICAgfSk7CiAgICAgIHJldHVybiAhbm90X2ZpbmQKICAgIH0KCiAgICBmdW5jdGlvbiBzYXZlQ29tbW9kaXR5KGhibExpc3QsIG5ld0l0ZW0pIHsKICAgICAgdmFyIHJlcSA9IHt9OwoKICAgICAgLy8gTUJMCiAgICAgIGlmIChpc0FFKCkpIHsKICAgICAgICBuZXdJdGVtLm1ibCA9IFtdOwogICAgICAgIHZtLm1ibC5hZV9pbmZvLl9faXRzLmZvckVhY2goZnVuY3Rpb24oaXRlbSl7CiAgICAgICAgICBwb191aTJiYWNrZW5kKGl0ZW0pOwogICAgICAgICAgaWYgKGl0ZW0uaWQgPT09IHVuZGVmaW5lZCkgIC8vIG5ldwogICAgICAgICAgICBuZXdJdGVtLm1ibC5wdXNoKGl0ZW0pOwogICAgICAgICAgZWxzZSBpZiAoaXNDb21tb2RpdHlEaXJ0eShpdGVtKSkKICAgICAgICAgICAgcmVxW2l0ZW0uaWRdID0gJGh0dHAucHV0KGdlblVybChVUkwuU0hJUE1FTlRfTUJMX0lULCB7aXRlbV9pZDogaXRlbS5pZH0pLCBpdGVtKTsKICAgICAgICB9KTsKCiAgICAgICAgaWYgKG5ld0l0ZW0ubWJsLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHJlcVsnbmV3JyArICdtYmwnXSA9ICRodHRwLnBvc3QoZ2VuVXJsKFVSTC5TSElQTUVOVF9NQkxfSVRfTElTVCwge2ZpbGluZ19ubzogdm0ubWJsLmZpbGluZ19ub30pLCBuZXdJdGVtLm1ibCk7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBIQkwKICAgICAgaWYgKGlzQUkoKSB8fCBpc0FFKCkpIHsKICAgICAgICBoYmxMaXN0LmZvckVhY2goZnVuY3Rpb24oaGJsKSB7CiAgICAgICAgICBuZXdJdGVtW2hibC5pZF0gPSBbXTsKCiAgICAgICAgICBoYmwuX19pdHMuZm9yRWFjaChmdW5jdGlvbihpdGVtKXsKICAgICAgICAgICAgcG9fdWkyYmFja2VuZChpdGVtKTsKICAgICAgICAgICAgaWYgKGl0ZW0uaWQgPT09IHVuZGVmaW5lZCkgIC8vIG5ldwogICAgICAgICAgICAgIG5ld0l0ZW1baGJsLmlkXS5wdXNoKGl0ZW0pOwogICAgICAgICAgICBlbHNlIGlmIChpc0NvbW1vZGl0eURpcnR5KGl0ZW0pKQogICAgICAgICAgICAgIHJlcVtpdGVtLmlkXSA9ICRodHRwLnB1dChnZW5VcmwoVVJMLlNISVBNRU5UX0hCTF9JVCwge2l0ZW1faWQ6IGl0ZW0uaWR9KSwgaXRlbSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBpZiAobmV3SXRlbVtoYmwuaWRdLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgcmVxWyduZXcnICsgaGJsLmlkXSA9ICRodHRwLnBvc3QoZ2VuVXJsKFVSTC5TSElQTUVOVF9IQkxfSVRfTElTVCwge2hibF9pZDogaGJsLmlkfSksIG5ld0l0ZW1baGJsLmlkXSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlcTsKICAgIH0KCiAgICBmdW5jdGlvbiBwb3N0U2F2ZUNvbW1vZGl0eShyZXN1bHQsIG5ld0l0ZW0pIHsKICAgICAgZm9yICh2YXIgayBpbiBuZXdJdGVtKSB7CiAgICAgICAgdmFyIHJlc19rZXkgPSAnbmV3JyArIGs7CgogICAgICAgIGlmIChyZXN1bHRbcmVzX2tleV0gPT09IHVuZGVmaW5lZCkgIC8vIGRvZXNuJ3Qgc2VuZCByZXF1ZXN0IGZvciBoYmxfaWQKICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICB2YXIgaWRfbGlzdCA9IHJlc3VsdFtyZXNfa2V5XS5kYXRhOwogICAgICAgIGlkX2xpc3QuZm9yRWFjaChmdW5jdGlvbihlbGUsIGlkeCl7CiAgICAgICAgICBhbmd1bGFyLmV4dGVuZChuZXdJdGVtW2tdW2lkeF0sIGVsZSk7CiAgICAgICAgICBkZWxfb2JqX3RpZChuZXdJdGVtW2tdW2lkeF0pOyAgLy8gZGVsZXRlIHRlbXAgaWQKICAgICAgICB9KTsKICAgICAgfQogICAgfQoKICAgIC8vID09PT09PT09PT09PT09PSBBSSBTdWIgSEFXQiA9PT09PT09PT09PT09PT0KCiAgICBmdW5jdGlvbiBzYXZlU3ViSGF3YihoYmxMaXN0LCBuZXdJdGVtKSB7CiAgICAgIHZhciByZXEgPSB7fTsKCiAgICAgIGlmIChpc0FJKCkpIHsKICAgICAgICBoYmxMaXN0LmZvckVhY2goZnVuY3Rpb24gKGhibCkgewogICAgICAgICAgbmV3SXRlbVtoYmwuaWRdID0gW107CgogICAgICAgICAgaGJsLl9fc3ViaGF3Yi5mb3JFYWNoKGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgICAgICAgIGlmIChpdGVtLmlkID09PSB1bmRlZmluZWQpICAvLyBuZXcKICAgICAgICAgICAgICBuZXdJdGVtW2hibC5pZF0ucHVzaChpdGVtKTsKICAgICAgICAgICAgZWxzZSBpZiAoaXNTdWJIYXdiRGlydHkoaXRlbSkpCiAgICAgICAgICAgICAgcmVxW2l0ZW0uaWRdID0gJGh0dHAucHV0KGdlblVybChVUkwuU0hJUE1FTlRfSEJMX1NVQl9IQVdCLCB7c3ViaGF3Yl9pZDogaXRlbS5pZH0pLCBpdGVtKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGlmIChuZXdJdGVtW2hibC5pZF0ubGVuZ3RoID4gMCkgewogICAgICAgICAgICByZXFbJ25ldycgKyBoYmwuaWRdID0gJGh0dHAucG9zdChnZW5VcmwoVVJMLlNISVBNRU5UX0hCTF9TVUJfSEFXQl9DUkVBVEUsIHtoYmxfaWQ6IGhibC5pZH0pLCBuZXdJdGVtW2hibC5pZF0pOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CgogICAgICByZXR1cm4gcmVxOwogICAgfQoKICAgIGZ1bmN0aW9uIHBvc3RTYXZlU3ViSGF3YihyZXN1bHQsIG5ld0l0ZW0pIHsKICAgICAgZm9yICh2YXIgayBpbiBuZXdJdGVtKSB7CiAgICAgICAgdmFyIHJlc19rZXkgPSAnbmV3JyArIGs7CgogICAgICAgIGlmIChyZXN1bHRbcmVzX2tleV0gPT09IHVuZGVmaW5lZCkgIC8vIGRvZXNuJ3Qgc2VuZCByZXF1ZXN0IGZvciBoYmxfaWQKICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICB2YXIgaWRfbGlzdCA9IHJlc3VsdFtyZXNfa2V5XS5kYXRhOwogICAgICAgIGlkX2xpc3QuZm9yRWFjaChmdW5jdGlvbiAoZWxlLCBpZHgpIHsKICAgICAgICAgIGFuZ3VsYXIuZXh0ZW5kKG5ld0l0ZW1ba11baWR4XSwgZWxlKTsKICAgICAgICAgIGRlbF9vYmpfdGlkKG5ld0l0ZW1ba11baWR4XSk7ICAvLyBkZWxldGUgdGVtcCBpZAogICAgICAgIH0pOwogICAgICB9CiAgICB9CgogICAgLy8gPT09PT09PT09PT09PT09IEFFIE1BV0IvSEFXQiBPdGhlciBDaGFyZ2UgPT09PT09PT09PT09PT09CgogICAgZnVuY3Rpb24gc2F2ZU90aGVyQ2hhcmdlKGhibExpc3QsIG5ld0l0ZW0pIHsKICAgICAgdmFyIHJlcSA9IHt9OwoKICAgICAgaWYgKGlzQUUoKSkgewoKICAgICAgICAvLyBNQkwKICAgICAgICBuZXdJdGVtLm1ibCA9IFtdOwogICAgICAgIHZtLm1ibC5hZV9pbmZvLm90aGVyX2NoYXJnZV9saXN0LmZvckVhY2goZnVuY3Rpb24oaXRlbSl7CiAgICAgICAgICBpZiAoaXRlbS5pZCA9PT0gdW5kZWZpbmVkKSAgLy8gbmV3CiAgICAgICAgICAgIG5ld0l0ZW0ubWJsLnB1c2goaXRlbSk7CiAgICAgICAgICBlbHNlIGlmIChpc090aGVyQ2hhcmdlRGlydHkoaXRlbSkpCiAgICAgICAgICAgIHJlcVtpdGVtLmlkXSA9ICRodHRwLnB1dChnZW5VcmwoVVJMLlNISVBNRU5UX01CTF9PVEhFUl9DSEFSR0UsIHtjaGFyZ2VfaWQ6IGl0ZW0uaWR9KSwgaXRlbSk7CiAgICAgICAgfSk7CgogICAgICAgIGlmIChuZXdJdGVtLm1ibC5sZW5ndGggPiAwKSB7CiAgICAgICAgICByZXFbJ25ldycgKyAnbWJsJ10gPSAkaHR0cC5wb3N0KGdlblVybChVUkwuU0hJUE1FTlRfTUJMX09USEVSX0NIQVJHRV9MSVNULCB7ZmlsaW5nX25vOiB2bS5tYmwuZmlsaW5nX25vfSksIG5ld0l0ZW0ubWJsKTsKICAgICAgICB9CgogICAgICAgIC8vIEhCTAogICAgICAgIGhibExpc3QuZm9yRWFjaChmdW5jdGlvbihoYmwpIHsKICAgICAgICAgIG5ld0l0ZW1baGJsLmlkXSA9IFtdOwoKICAgICAgICAgIGhibC5vdGhlcl9jaGFyZ2VfbGlzdC5mb3JFYWNoKGZ1bmN0aW9uKGl0ZW0pewogICAgICAgICAgICBpZiAoaXRlbS5pZCA9PT0gdW5kZWZpbmVkKSAgLy8gbmV3CiAgICAgICAgICAgICAgbmV3SXRlbVtoYmwuaWRdLnB1c2goaXRlbSk7CiAgICAgICAgICAgIGVsc2UgaWYgKGlzT3RoZXJDaGFyZ2VEaXJ0eShpdGVtKSkKICAgICAgICAgICAgICByZXFbaXRlbS5pZF0gPSAkaHR0cC5wdXQoZ2VuVXJsKFVSTC5TSElQTUVOVF9IQkxfT1RIRVJfQ0hBUkdFLCB7Y2hhcmdlX2lkOiBpdGVtLmlkfSksIGl0ZW0pOwogICAgICAgICAgfSk7CgogICAgICAgICAgaWYgKG5ld0l0ZW1baGJsLmlkXS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHJlcVsnbmV3JyArIGhibC5pZF0gPSAkaHR0cC5wb3N0KGdlblVybChVUkwuU0hJUE1FTlRfSEJMX09USEVSX0NIQVJHRV9MSVNULCB7aGJsX2lkOiBoYmwuaWR9KSwgbmV3SXRlbVtoYmwuaWRdKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gcmVxOwogICAgfQoKICAgIGZ1bmN0aW9uIHBvc3RTYXZlT3RoZXJDaGFyZ2UocmVzdWx0LCBuZXdJdGVtKSB7CiAgICAgIGZvciAodmFyIGsgaW4gbmV3SXRlbSkgewogICAgICAgIHZhciByZXNfa2V5ID0gJ25ldycgKyBrOwoKICAgICAgICBpZiAocmVzdWx0W3Jlc19rZXldID09PSB1bmRlZmluZWQpICAvLyBkb2Vzbid0IHNlbmQgcmVxdWVzdCBmb3IgaGJsX2lkCiAgICAgICAgICBjb250aW51ZTsKCiAgICAgICAgdmFyIGlkX2xpc3QgPSByZXN1bHRbcmVzX2tleV0uZGF0YTsKICAgICAgICBpZF9saXN0LmZvckVhY2goZnVuY3Rpb24oZWxlLCBpZHgpewogICAgICAgICAgYW5ndWxhci5leHRlbmQobmV3SXRlbVtrXVtpZHhdLCBlbGUpOwogICAgICAgICAgZGVsX29ial90aWQobmV3SXRlbVtrXVtpZHhdKTsgIC8vIGRlbGV0ZSB0ZW1wIGlkCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBvbkNoYXJnZUl0ZW1DaGFuZ2VkKGNoYXJnZSkgewogICAgICBpZiAoY2hhcmdlLmJpbGxpbmcpIHsKICAgICAgICBjaGFyZ2UuZGVzY3JpcHRpb24gPSBjaGFyZ2UuYmlsbGluZy5uYW1lOwogICAgICB9CiAgICB9CgogICAgLy8gPT09PT09PT09PT09PT09IE9FIEJvb2tpbmcgTm8uIGNoZWNraW5nID09PT09PT09PT09PT09PQogICAgZnVuY3Rpb24gZ2V0SEJMTGlzdFdpdGhUaGVTYW1lQm9va2luZ05vKCkgewogICAgICB2YXIgYm9va2luZ05vID0gaXNPRSgpICYmIHZtLmhibF9saXN0W3ZtLmN1ckhibElkeF0gJiYgdm0uaGJsX2xpc3Rbdm0uY3VySGJsSWR4XS5vZV9pbmZvLmJvb2tpbmdfbm87CgogICAgICBpZiAoIWJvb2tpbmdObykgewogICAgICAgIHJldHVybiAkcS5yZXNvbHZlKFtdKTsKICAgICAgfQoKICAgICAgcmV0dXJuICRodHRwLmdldChVUkwuVkVSSUZZX09FX0hCTF9CT09LSU5HX05PX0VYSVNULCB7CiAgICAgICAgcGFyYW1zOiB7CiAgICAgICAgICBib29raW5nX25vOiBib29raW5nTm8sCiAgICAgICAgICBleGNsdWRlOiB2bS5oYmxfbGlzdFt2bS5jdXJIYmxJZHhdLmlkLAogICAgICAgIH0KICAgICAgfSkKICAgICAgICAudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7CiAgICAgICAgICB9LCBmdW5jdGlvbiAoZXJyUmVzcG9uc2UpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coJ0Vycm9yOiAnICsgZXJyUmVzcG9uc2UuZGF0YSk7CiAgICAgICAgICB9CiAgICAgICAgKTsKICAgIH0KCiAgICBmdW5jdGlvbiBvbkJvb2tpbmdOb0JsdXIoJGV2ZW50KSB7CiAgICAgIGdldEhCTExpc3RXaXRoVGhlU2FtZUJvb2tpbmdObygpCiAgICAgICAgLnRoZW4oc2hvd1dhcm5pbmdUaXApCiAgICAgICAgLnRoZW4oc2F2ZVdhcm5pbmdTdGF0ZSk7CgogICAgICBmdW5jdGlvbiBzaG93V2FybmluZ1RpcChkYXRhKSB7CiAgICAgICAgaWYgKGRhdGEubGVuZ3RoID4gMCkgewogICAgICAgICAgdmFyIGRlbGF5ID0gMjUwMDsKICAgICAgICAgIHF0aXBTZXJ2aWNlLnNob3dRdGlwV2FybmluZyhRVElQX0dST1VQLCAkKCRldmVudC50YXJnZXQpLCBNU0dfRFVQTElDQVRFX0JPT0tJTkdfTk8sIGRlbGF5KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHNhdmVXYXJuaW5nU3RhdGUoZGF0YSkgewogICAgICAgIHZtLndhcm5pbmcuYm9va2luZ19ubyA9IGRhdGEubGVuZ3RoID4gMDsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIG9uQm9va2luZ05vQ2hhbmdlT25CbHVyKGhibCkgewogICAgICBpZiAoaXNCb29raW5nTm9TeW5jSGJsTm8oaGJsKSkgewogICAgICAgIG1vZGFsLm9wZW4oX1QuTVNHLkJPT0tJTkdfQ0hBTkdFX09OX0JMVVIpCiAgICAgICAgICAudGhlbigoKSA9PiB7IGhibC5IQkxfTk8gPSBoYmwub2VfaW5mby5ib29raW5nX25vOyB9KTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIG9uSGJsTm9DaGFuZ2VPbkJsdXIoaGJsKSB7CiAgICAgIGlmIChpc0Jvb2tpbmdOb1N5bmNIYmxObyhoYmwpKSB7CiAgICAgICAgbW9kYWwub3BlbihfVC5NU0cuSEJMX0NIQU5HRV9PTl9CTFVSKQogICAgICAgICAgLnRoZW4oKCkgPT4geyBoYmwub2VfaW5mby5ib29raW5nX25vID0gaGJsLkhCTF9OTzsgfSk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBzaG93Q2FjaGVkQm9va2luZ05vRXhpc3RXYXJuaW5nKCRldmVudCkgewogICAgICBxdGlwU2VydmljZS5zaG93UXRpcFdhcm5pbmcoUVRJUF9HUk9VUCwgJCgkZXZlbnQudGFyZ2V0KSwgTVNHX0RVUExJQ0FURV9CT09LSU5HX05PKTsKICAgIH0KCiAgICBmdW5jdGlvbiBoaWRlV2FybmluZygpIHsKICAgICAgcXRpcFNlcnZpY2UuaGlkZVF0aXAoUVRJUF9HUk9VUCk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0TUJMTGlzdFdpdGhUaGVTYW1lU2hpcG1lbnRObygpIHsKICAgICAgdmFyIHNoaXBtZW50Tm8gPSBpc09FKCkgJiYgdm0ubWJsLnNoaXBtZW50X25vOwoKICAgICAgaWYgKCFzaGlwbWVudE5vKSB7CiAgICAgICAgcmV0dXJuICRxLnJlc29sdmUoZmFsc2UpOwogICAgICB9CgogICAgICByZXR1cm4gJGh0dHAuZ2V0KFVSTC5WRVJJRllfTUJMX1NISVBNRU5UX05PX0VYSVNULCB7CiAgICAgICAgcGFyYW1zOiB7CiAgICAgICAgICBzaGlwbWVudF9ubzogc2hpcG1lbnRObywKICAgICAgICAgIGV4Y2x1ZGU6IHZtLm1ibC5maWxpbmdfbm8sCiAgICAgICAgfQogICAgICB9KQogICAgICAgIC50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YTsKICAgICAgICAgIH0sIGZ1bmN0aW9uIChlcnJSZXNwb25zZSkgewogICAgICAgICAgICBjb25zb2xlLmxvZygnRXJyb3I6ICcgKyBlcnJSZXNwb25zZS5kYXRhKTsKICAgICAgICAgIH0KICAgICAgICApOwogICAgfQoKICAgIGZ1bmN0aW9uIG9uU2hpcG1lbnROb0JsdXIoJGV2ZW50KSB7CiAgICAgIGdldE1CTExpc3RXaXRoVGhlU2FtZVNoaXBtZW50Tm8oKQogICAgICAgIC50aGVuKHNob3dFcnJvclRpcCkKICAgICAgICAudGhlbihzYXZlRXJyb3JTdGF0ZSk7CgogICAgICBmdW5jdGlvbiBzaG93RXJyb3JUaXAoZXhpc3RzKSB7CiAgICAgICAgaWYgKGV4aXN0cykgewogICAgICAgICAgdmFyIGRlbGF5ID0gMjUwMDsKICAgICAgICAgIHF0aXBTZXJ2aWNlLnNob3dRdGlwRXJyb3IoUVRJUF9HUk9VUCwgJCgkZXZlbnQudGFyZ2V0KSwgTVNHX0RVUExJQ0FURV9TSElQTUVOVF9OTywgZGVsYXkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZXhpc3RzOwogICAgICB9CgogICAgICBmdW5jdGlvbiBzYXZlRXJyb3JTdGF0ZShleGlzdHMpIHsKICAgICAgICB2YXIgaW52YWxpZCA9IGV4aXN0czsKICAgICAgICB2bS5lcnJvcnMuc2hpcG1lbnRfbm8gPSBpbnZhbGlkOwogICAgICAgICRzY29wZS5tYmxGb3JtLnNoaXBtZW50X25vLiRzZXRWYWxpZGl0eSgnc2hpcG1lbnRfbm8nLCAhaW52YWxpZCk7CiAgICAgICAgaWYgKGludmFsaWQpIHsKICAgICAgICAgICRsb2cuZGVidWcoJ1NoaXBtZW50IE5vLiBkdXBsaWNhdGUnKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBvbkN1c3RvbWVyUmVmTm9DaGFuZ2VkKGhibCkgewogICAgICBpZiAoaXNPRSgpICYmIGlzU2hpcHBlclVJTW9kZSgpKSB7CiAgICAgICAgdm0ubWJsLnNoaXBtZW50X25vID0gaGJsLmN1c3RvbWVyX3JlZl9ubzsKICAgICAgICBhbmd1bGFyLmVsZW1lbnQoJ2lucHV0W25hbWU9InNoaXBtZW50X25vIl0nKS50cmlnZ2VyKCdibHVyJyk7CiAgICAgICAgJHNjb3BlLm1ibEZvcm0uJHNldERpcnR5KCk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBpc0Rpc2FibGVNYmxPZmZpY2VEZXBhcnRtZW50KCkgewogICAgICBpZiAodm0uY3JlYXRpbmcpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuICgKICAgICAgICAhdm0uUC5DT01QQU5ZX0VOVFJZX0FGVEVSX0NSRUFURV9PRkZJQ0VfRURJVCB8fAogICAgICAgIHZtLmRpc2FibGVNb2RlKCdBJykgfHwKICAgICAgICAhc2hpcG1lbnRBY1N2Yy5pc01ibERlcGFydG1lbnRFZGl0YWJsZSh2bS5tYmwpCiAgICAgICk7CiAgICB9CgogICAgZnVuY3Rpb24gaXNEaXNhYmxlSGJsT2ZmaWNlRGVwYXJ0bWVudCgpIHsKICAgICAgaWYgKHZtLmNyZWF0aW5nKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiAhdm0uUC5DT01QQU5ZX0VOVFJZX0FGVEVSX0NSRUFURV9PRkZJQ0VfRURJVCB8fCB2bS5kaXNhYmxlTW9kZSgnQScpOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzRW5hYmxlRGVwYXJ0bWVudFRyYW5zZmVyKCkgewogICAgICBpZiAoIXZtLm9mZmljZXMpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIGlmICghdm0ubWJsKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICByZXR1cm4gdm0ub2ZmaWNlc1t2bS5tYmwub2ZmaWNlXS5pc19lbmFibGVfc2hpcG1lbnRfZGVwYXJ0bWVudF90cmFuc2ZlcgogICAgfQoKICAgIGZ1bmN0aW9uIGlzQm9va2luZ05vU3luY0hibE5vKGhibCkgewogICAgICByZXR1cm4gXy5maW5kKHZtLm9mZmljZXMsIHsgaWQ6IHZtLm1ibC5vZmZpY2UgfSkgPwogICAgICAgIF8uZmluZCh2bS5vZmZpY2VzLCB7IGlkOiB2bS5tYmwub2ZmaWNlIH0pLmlzX2Jvb2tpbmdfbm9fc3luY19oYmxfbm8gOgogICAgICAgIGZhbHNlOwogICAgfQoKICAgIGZ1bmN0aW9uIGlzQm9va2luZ05vUmVhZE9ubHkoaGJsKSB7CiAgICAgIHJldHVybiBpc0Jvb2tpbmdOb1N5bmNIYmxObyhoYmwpICYmICFoYmwuaWQ7CiAgICB9CgogICAgZnVuY3Rpb24gb25NYmxEZWxpdmVyeVRvQ2hhbmdlZCgpIHsKICAgICAgc3luY01CTEZpZWxkVG9BbGxIQkwoJ29lX2luZm8uZGVsaXZlcnlfdG8nKTsKICAgIH0KCiAgICBmdW5jdGlvbiBvbk1ibEVtcHR5UGlja3VwQ2hhbmdlZCgpIHsKICAgICAgc3luY01CTEZpZWxkVG9BbGxIQkwoJ29lX2luZm8uZW1wdHlfcGlja3VwJyk7CiAgICB9CgogICAgZnVuY3Rpb24gb25NYmxJdG5Ob0NoYW5nZWQoKSB7CiAgICAgIHN5bmNNQkxGaWVsZFRvQWxsSEJMKCdvZV9pbmZvLml0bl9ubycpOwogICAgfQoKICAgIGZ1bmN0aW9uIG9uTWJsUE9SQ2hhbmdlZCgpIHsKICAgICAgc3luY01CTEZpZWxkVG9BbGxIQkwoJ1BPUicpOwogICAgfQoKICAgIGZ1bmN0aW9uIG9uTWJsQ2FuY2VsRGF0ZUNoYW5nZWQoKSB7CiAgICAgIHN5bmNNQkxGaWVsZFRvQWxsSEJMKCdjYW5jZWxfZGF0ZScpOwogICAgfQoKICAgIGZ1bmN0aW9uIG9uTWJsQ2FuY2VsUmVhc29uQ2hhbmdlZCgpIHsKICAgICAgc3luY01CTEZpZWxkVG9BbGxIQkwoJ2NhbmNlbF9yZWFzb24nKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRDYW5jZWxNQkxEaXNhYmxlTW9kZSgpIHsKICAgICAgaWYgKCF2bS5QLlNISVBNRU5UX0VOVFJZX0JMX0NBTkNFTF9FRElUKSB7CiAgICAgICAgcmV0dXJuIENBTkNFTF9CTF9ESVNBQkxFX01PREUuTk9fUEVSTUlTU0lPTjsKICAgICAgfQoKICAgICAgaWYgKHZtLm1ibC5pc19wYXltZW50X2xvY2spIHsKICAgICAgICAvLyBXaGVuIHBheW1lbnQgbG9ja2VkLCBzdGlsbCBhbGxvdyB1c2VyIHRvIHVuY2hlY2sgImJsIGNhbmNlbCIKICAgICAgICBpZiAoIXZtLm1ibC5pc19jYW5jZWxlZCkgewogICAgICAgICAgcmV0dXJuIENBTkNFTF9CTF9ESVNBQkxFX01PREUuUEFZTUVOVF9MT0NLOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIENBTkNFTF9CTF9ESVNBQkxFX01PREUuTk9ORTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRDYW5jZWxIQkxEaXNhYmxlTW9kZShoYmwpIHsKICAgICAgaWYgKCF2bS5QLlNISVBNRU5UX0VOVFJZX0JMX0NBTkNFTF9FRElUKSB7CiAgICAgICAgcmV0dXJuIENBTkNFTF9CTF9ESVNBQkxFX01PREUuTk9fUEVSTUlTU0lPTjsKICAgICAgfQoKICAgICAgaWYgKGhibC5pc19wYXltZW50X2xvY2spIHsKICAgICAgICBsZXQgaXNDYW5jZWxlZCA9IGZhbHNlOwoKICAgICAgICBpZiAoaXNPRSgpKSB7CiAgICAgICAgICBpc0NhbmNlbGVkID0gaGJsLm9lX2luZm8uaXNfY2FuY2VsZWQ7CiAgICAgICAgfSBlbHNlIGlmIChpc0FFKCkpIHsKICAgICAgICAgIGlzQ2FuY2VsZWQgPSBoYmwuYWVfaW5mby5pc19jYW5jZWxlZDsKICAgICAgICB9CgogICAgICAgIC8vIFdoZW4gcGF5bWVudCBsb2NrZWQsIHN0aWxsIGFsbG93IHVzZXIgdG8gdW5jaGVjayAiYmwgY2FuY2VsIgogICAgICAgIGlmICghaXNDYW5jZWxlZCkgewogICAgICAgICAgcmV0dXJuIENBTkNFTF9CTF9ESVNBQkxFX01PREUuUEFZTUVOVF9MT0NLOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHZtLm1ibC5pc19jYW5jZWxlZCkgewogICAgICAgIHJldHVybiBDQU5DRUxfQkxfRElTQUJMRV9NT0RFLk1CTF9DQU5DRUxFRDsKICAgICAgfQoKICAgICAgcmV0dXJuIENBTkNFTF9CTF9ESVNBQkxFX01PREUuTk9ORTsKICAgIH0KCiAgICBmdW5jdGlvbiBjYW5DYW5jZWxNQkwoKSB7CiAgICAgIHJldHVybiBnZXRDYW5jZWxNQkxEaXNhYmxlTW9kZSgpID09PSBDQU5DRUxfQkxfRElTQUJMRV9NT0RFLk5PTkU7CiAgICB9CgogICAgZnVuY3Rpb24gY2FuQ2FuY2VsSEJMKGhibCkgewogICAgICByZXR1cm4gZ2V0Q2FuY2VsSEJMRGlzYWJsZU1vZGUoaGJsKSA9PT0gQ0FOQ0VMX0JMX0RJU0FCTEVfTU9ERS5OT05FOwogICAgfQoKICAgIGZ1bmN0aW9uIF9nZXRDYW5jZWxCTFRvb2x0aXAobW9kZSkgewogICAgICBzd2l0Y2ggKG1vZGUpIHsKICAgICAgICBjYXNlIENBTkNFTF9CTF9ESVNBQkxFX01PREUuUEFZTUVOVF9MT0NLOgogICAgICAgICAgcmV0dXJuIF9ULk1TRy5OT1RfQUxMT1dfVE9fQ0FOQ0VMOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICByZXR1cm4gJyc7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBnZXRDYW5jZWxNQkxUb29sdGlwKCkgewogICAgICBjb25zdCBtb2RlID0gZ2V0Q2FuY2VsTUJMRGlzYWJsZU1vZGUoKTsKICAgICAgcmV0dXJuIF9nZXRDYW5jZWxCTFRvb2x0aXAobW9kZSk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0Q2FuY2VsSEJMVG9vbHRpcChoYmwpIHsKICAgICAgY29uc3QgbW9kZSA9IGdldENhbmNlbEhCTERpc2FibGVNb2RlKGhibCk7CiAgICAgIHJldHVybiBfZ2V0Q2FuY2VsQkxUb29sdGlwKG1vZGUpOwogICAgfQoKICAgIGZ1bmN0aW9uIG9uVXNlQ2FyZU9mQ2hhbmdlZCgpIHsKICAgICAgaWYgKGlzT0UoKSkgewogICAgICAgIGlmICh2bS5tYmwub2VfaW5mby51c2VfY2FyZV9vZikgewogICAgICAgICAgaWYgKGlzRGlyZWN0TWFzdGVyKCkpIHsKICAgICAgICAgICAgdm0ubWJsLm9lX2luZm8uY2FyZV9vZiA9IGFuZ3VsYXIuY29weSh2bS5tYmwub2VfaW5mby5jdXN0b21lcik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCBmaXJzdEhibCA9IHZtLmhibF9saXN0WzBdOwogICAgICAgICAgICBpZiAoZmlyc3RIYmwpIHsKICAgICAgICAgICAgICB2bS5tYmwub2VfaW5mby5jYXJlX29mID0gYW5ndWxhci5jb3B5KGZpcnN0SGJsLnNoaXBwZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZtLm1ibC5vZV9pbmZvLmNhcmVfb2YgPSBudWxsOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIG9wZW5Wb2x1bWVXZWlnaHRDYWxjdWxhdGlvbihibE5hbWUsIGhibCkgewogICAgICBpZiAoIWlzQUkoKSAmJiAhaXNBRSgpKSB7CiAgICAgICAgdGhyb3cgRXJyb3IoJ29wZW5Wb2x1bWVXZWlnaHRDYWxjdWxhdGlvbiBvbmx5IHN1cHBvcnRzIEFJL0FFJyk7CiAgICAgIH0KCiAgICAgIGlmIChibE5hbWUgPT09ICdoYmwnICYmICFoYmwpIHsKICAgICAgICB0aHJvdyBFcnJvcignU2hvdWxkIHBhc3MgaGJsIG9iamVjdCcpOwogICAgICB9CgogICAgICBjb25zdCBvZmZpY2VTaXplVW5pdCA9IF8uZmluZCh2bS5vZmZpY2VzLCB7IGlkOiB2bS5tYmwub2ZmaWNlIH0pLnNpemVfdW5pdDsKICAgICAgY29uc3QgZGVmYXVsdFNpemVVbml0ID0gVm9sdW1lQ2FsY3VsYXRvci5VTklUX01BUFBJTkdbb2ZmaWNlU2l6ZVVuaXRdOwoKICAgICAgbGV0IGV2ZW50SGFuZGxlcnM7CiAgICAgIGxldCBuZ0Zvcm07CiAgICAgIGxldCBvbkNoYW5nZUV2ZW50OwogICAgICBsZXQgYmxPYmo7CiAgICAgIGxldCBibEluZm9PYmo7CiAgICAgIGxldCBpc1N5bmNXYXJlaG91c2VEaW1lbnNpb25zOwogICAgICBsZXQgd2FyZWhvdXNlSXRlbXM7CiAgICAgIGxldCB3ZWlnaHRQcmVjaXNpb247CgogICAgICAvLyBpbml0aWFsaXplIGJsT2JqIGFuZCByZWxhdGVkIHZhcmlhYmxlcwogICAgICBzd2l0Y2ggKGJsTmFtZSkgewogICAgICAgIGNhc2UgJ21ibCc6CiAgICAgICAgICBldmVudEhhbmRsZXJzID0gaXNBSSgpID8gdm0uYWlySW1wb3J0TWF3YkV2ZW50SGFuZGxlcnMgOiB2bS5haXJFeHBvcnRNYXdiRXZlbnRIYW5kbGVyczsKICAgICAgICAgIGJsT2JqID0gdm0ubWJsOwogICAgICAgICAgYmxJbmZvT2JqID0gaXNBSSgpID8gdm0ubWJsLmFpX2luZm8gOiB2bS5tYmwuYWVfaW5mbzsKICAgICAgICAgIG5nRm9ybSA9ICRzY29wZS5tYmxGb3JtOwogICAgICAgICAgb25DaGFuZ2VFdmVudCA9IHZtLmV2ZW50cy5NQkxfQUVfSU5GT19QQUNLQUdFX0NIQU5HRUQ7CiAgICAgICAgICBpc1N5bmNXYXJlaG91c2VEaW1lbnNpb25zID0gdm0ubWJsLmlzX3N5bmNfd2FyZWhvdXNlX2RpbWVuc2lvbnM7CiAgICAgICAgICB3YXJlaG91c2VJdGVtcyA9IHZtLm1ibC5saW5rX3doX3JlY2VpcHRfZGV0YWlsX3NldAogICAgICAgICAgICA/IHZtLm1ibC5saW5rX3doX3JlY2VpcHRfZGV0YWlsX3NldC5tYXAoZCA9PiBkLndoX3JlY2VpcHRfZGV0YWlsKSA6IFtdOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAnaGJsJzoKICAgICAgICAgIGV2ZW50SGFuZGxlcnMgPSBpc0FJKCkgPyB2bS5haXJJbXBvcnRIYXdiRXZlbnRIYW5kbGVycyA6IHZtLmFpckV4cG9ydEhhd2JFdmVudEhhbmRsZXJzOwogICAgICAgICAgYmxPYmogPSBoYmw7CiAgICAgICAgICBibEluZm9PYmogPSBpc0FJKCkgPyBoYmwuYWlfaW5mbyA6IGhibC5hZV9pbmZvOwogICAgICAgICAgbmdGb3JtID0gaGJsLl9faGJsRm9ybTsKICAgICAgICAgIG9uQ2hhbmdlRXZlbnQgPSB2bS5ldmVudHMuSEJMX1BBQ0tBR0VfQ0hBTkdFRDsKICAgICAgICAgIGlzU3luY1dhcmVob3VzZURpbWVuc2lvbnMgPSBoYmwuaXNfc3luY193YXJlaG91c2VfZGltZW5zaW9uczsKICAgICAgICAgIHdhcmVob3VzZUl0ZW1zID0gaGJsLmxpbmtfd2hfcmVjZWlwdF9kZXRhaWxfc2V0CiAgICAgICAgICAgID8gaGJsLmxpbmtfd2hfcmVjZWlwdF9kZXRhaWxfc2V0Lm1hcChkID0+IGQud2hfcmVjZWlwdF9kZXRhaWwpIDogW107CiAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgdGhyb3cgRXJyb3IoYFVua25vd24gYmxOYW1lOiAke2JsTmFtZX1gKTsKICAgICAgfQoKICAgICAgLy8gZGVjaWRlIHdlaWdodCBwcmVjaXNpb24KICAgICAgc3dpdGNoIChibE9iai50eXBlKSB7CiAgICAgICAgY2FzZSAnQUknOgogICAgICAgICAgd2VpZ2h0UHJlY2lzaW9uID0gQ09NUEFOWV9JTkZPLmFpX3dlaWdodF9mbG9hdF9wcmVjaXNpb247CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdBRSc6CiAgICAgICAgICB3ZWlnaHRQcmVjaXNpb24gPSBDT01QQU5ZX0lORk8uYWVfd2VpZ2h0X2Zsb2F0X3ByZWNpc2lvbjsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICB3ZWlnaHRQcmVjaXNpb24gPSBDT01QQU5ZX0lORk8ud2VpZ2h0X2Zsb2F0X3ByZWNpc2lvbjsKICAgICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICAvLyBvcGVuIERpbWVuc2lvbnMgbW9kYWwKICAgICAgY29uc3QgbW9kYWxJbnN0YW5jZSA9ICR1aWJNb2RhbC5vcGVuKHsKICAgICAgICBhbmltYXRpb246IHRydWUsCiAgICAgICAgdGVtcGxhdGVVcmw6ICd2b2x1bWVXZWlnaHRDYWxjdWxhdGlvbi5odG1sJywKICAgICAgICB3aW5kb3dUZW1wbGF0ZVVybDogJ2hjV2luZG93VGVtcGxhdGUuaHRtbCcsCiAgICAgICAgY29udHJvbGxlcjogJ3ZvbHVtZVdlaWdodENhbGN1bGF0aW9uTW9kYWxDdHJsJywKICAgICAgICBjb250cm9sbGVyQXM6ICd2bScsCiAgICAgICAgd2luZG93Q2xhc3M6ICd1aWItbW9kYWwtbGcnLAogICAgICAgIGJhY2tkcm9wOiAnc3RhdGljJywKICAgICAgICByZXNvbHZlOiB7CiAgICAgICAgICBkYXRhU3RyOiAoKSA9PiBibEluZm9PYmoudm9sdW1lX3dlaWdodF9pbmZvLAogICAgICAgICAgZ2V0QmxQYWNrYWdlOiAoKSA9PiAoKSA9PiBibEluZm9PYmoucGFja2FnZSwKICAgICAgICAgIGlzU3luY1dhcmVob3VzZURpbWVuc2lvbnM6IGlzU3luY1dhcmVob3VzZURpbWVuc2lvbnMsCiAgICAgICAgICB3YXJlaG91c2VJdGVtczogKCkgPT4gd2FyZWhvdXNlSXRlbXMsCiAgICAgICAgICB3ZWlnaHRQcmVjaXNpb246IHdlaWdodFByZWNpc2lvbiwKICAgICAgICAgIG1lYXN1cmVQcmVjaXNpb246IENPTVBBTllfSU5GTy5tZWFzdXJlX2Zsb2F0X3ByZWNpc2lvbiwKICAgICAgICAgIGRpc2FibGVkOiB2bS5kaXNhYmxlTW9kZSgnQScpLAogICAgICAgICAgZGVmYXVsdFNpemVVbml0OiAoKSA9PiBkZWZhdWx0U2l6ZVVuaXQsCiAgICAgICAgICBvblVwZGF0ZTogKCkgPT4gKHN0YXR1cykgPT4gewogICAgICAgICAgICBibEluZm9PYmoudm9sdW1lX3dlaWdodF9pbmZvID0gc3RhdHVzLnZvbHVtZVdlaWdodEluZm87CiAgICAgICAgICAgIGJsSW5mb09iai52b2x1bWVfd2VpZ2h0ID0gc3RhdHVzLnZvbHVtZVdlaWdodDsKICAgICAgICAgICAgYmxJbmZvT2JqLnZvbHVtZV9tZWFzdXJlID0gc3RhdHVzLnZvbHVtZU1lYXN1cmU7CiAgICAgICAgICB9LAogICAgICAgIH0sCiAgICAgIH0pOwoKICAgICAgLy8gcG9zdCBwcm9jZXNzIG9mIGNhbGN1bGF0aW5nIHZvbHVtZSB3ZWlnaHQKICAgICAgbW9kYWxJbnN0YW5jZS5yZXN1bHQKICAgICAgICAudGhlbigocmVzdWx0KSA9PiB7CiAgICAgICAgICBpZiAocmVzdWx0ICE9PSAnb2snKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIC8vIHNldCBkaXJ0eQogICAgICAgICAgbmdGb3JtLiRzZXREaXJ0eSgpOwoKICAgICAgICAgIC8vIGhhbmRsZSB2b2x1bWUgd2VpZ2h0IGNoYW5nZQogICAgICAgICAgZXZlbnRIYW5kbGVycy5oYW5kbGVWb2x1bWVXZWlnaHRVcGRhdGUoYmxPYmopOwoKICAgICAgICAgIGlmIChpc0FFKCkpIHsKICAgICAgICAgICAgLy8gVXNlIHRpbWVvdXQgYmVjYXVzZSB3ZSB3YW50IHRvIHRyaWdnZXIgZXZlbnQgaW4gbmV4dCBkaWdlc3QKICAgICAgICAgICAgLy8gKGRhdGEgbWF5IG5vdCBiZSB1cGRhdGVkIGluIHRoaXMgZGlnZXN0KQogICAgICAgICAgICAkdGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgJHNjb3BlLiRicm9hZGNhc3Qob25DaGFuZ2VFdmVudCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIG9wZW5Db25uZWN0RmxpZ2h0KCkgewoKICAgICAgdmFyIGluZm87CgogICAgICBpZiAoaXNBSSgpKXsKICAgICAgICBpbmZvID0gdm0ubWJsLmFpX2luZm87CiAgICAgIH0gZWxzZSBpZihpc0FFKCkpIHsKICAgICAgICBpbmZvID0gdm0ubWJsLmFlX2luZm87CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgJ29wZW5Db25uZWN0RmxpZ2h0IG9ubHkgc3VwcG9ydHMgQUkvQUUnOwogICAgICB9CgogICAgICAvLyBwcmVwYXJlIGluaXRpYWwgZGF0YSBmcm9tIE1BV0IgYW5kIGFpX2luZm8vYWVfaW5mbwoKICAgICAgdmFyIG1ibERhdGEgPSB7fTsKICAgICAgdmFyIG1ibEluZm9EYXRhID0gYW5ndWxhci5jb3B5KGluZm8pOwoKICAgICAgLy8gcHJlcGFyZSBpbml0aWFsIGRhdGEgZnJvbSBNQVdCCiAgICAgIHZhciBibEZpZWxkcyA9IFsnQVBPTCcsICdBUE9EJywgJ2NhcnJpZXInLCAnRVRBJywgJ0VURCddOwoKICAgICAgYmxGaWVsZHMuZm9yRWFjaChmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgbWJsRGF0YVtpdGVtXSA9IHZtLm1ibFtpdGVtXTsKICAgICAgfSk7CgogICAgICAvLyBjb21tdW5pY2F0aW9uIG9iamVjdAogICAgICB2YXIgY29tbU9iaiA9IHsKICAgICAgICAvLyBJbnB1dAogICAgICAgIHR5cGU6IHZtLnR5cGUsCiAgICAgICAgbWJsRGF0YTogbWJsRGF0YSwKICAgICAgICBtYmxJbmZvRGF0YTogbWJsSW5mb0RhdGEsCiAgICAgICAgZGlzYWJsZU1vZGU6IHZtLmRpc2FibGVNb2RlLAogICAgICB9OwoKICAgICAgdmFyIG1vZGFsSW5zdGFuY2UgPSAkdWliTW9kYWwub3Blbih7CiAgICAgICAgYW5pbWF0aW9uOiB0cnVlLAogICAgICAgIHRlbXBsYXRlVXJsOiAnY29ubmVjdGluZ0ZsaWdodC5odG1sJywKICAgICAgICB3aW5kb3dUZW1wbGF0ZVVybDogJ2hjV2luZG93VGVtcGxhdGUuaHRtbCcsCiAgICAgICAgY29udHJvbGxlcjogJ2Nvbm5lY3RpbmdGbGlnaHRNb2RhbEN0cmwnLAogICAgICAgIHdpbmRvd0NsYXNzOiAndWliLW1vZGFsLWxnJywKICAgICAgICBiYWNrZHJvcDogJ3N0YXRpYycsCiAgICAgICAgcmVzb2x2ZTogewogICAgICAgICAgY29tbU9iajogY29tbU9iaiwKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgLy8gcG9zdCBwcm9jZXNzCiAgICAgIG1vZGFsSW5zdGFuY2UucmVzdWx0CiAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzdWx0KSB7CgogICAgICAgICAgYmxGaWVsZHMuZm9yRWFjaChmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgIHZtLm1ibFtpdGVtXSA9IHJlc3VsdC5tYmxEYXRhW2l0ZW1dOwogICAgICAgICAgfSk7CgogICAgICAgICAgaWYgKGlzQUkoKSkgewogICAgICAgICAgICB2bS5tYmwuYWlfaW5mbyA9IHJlc3VsdC5tYmxJbmZvRGF0YTsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNBRSgpKSB7CiAgICAgICAgICAgIHZtLm1ibC5hZV9pbmZvID0gcmVzdWx0Lm1ibEluZm9EYXRhOwogICAgICAgICAgICBvbk1ibEFwb2xDaGFuZ2VkKCk7CiAgICAgICAgICAgIG9uTWJsQXBvZENoYW5nZWQoKTsKICAgICAgICAgIH0KCiAgICAgICAgICAkc2NvcGUubWJsRm9ybS4kc2V0RGlydHkoKTsKCiAgICAgIH0sIGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIGNvbnNvbGUubG9nKCdjYW5jZWwgY29ubmVjdGluZyBmbGlnaHQnKTsKICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gaXNTaG93SHRzRmllbGRzKCkgewogICAgICByZXR1cm4gQ09NUEFOWV9JTkZPLmlzX3Nob3dfY29tbW9kaXR5X2h0c19maWVsZDsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRDb2xzcGFuRm9yTm9Db21tb2RpdHkoKSB7CiAgICAgIHJldHVybiBpc1Nob3dIdHNGaWVsZHMoKSA/IDQgOiAzOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldEFkZE5ld1Jvd1dvcmRpbmcoKSB7CiAgICAgIHJldHVybiBjcmVhdGVTdHJpbmdGb3JtYXR0ZXIoX1QuQUREX05FV19ST1cpLmZvcm1hdCgnPHNwYW4gY2xhc3M9ImZvbnQtYmx1ZSI+JywgJzwvc3Bhbj4nKTsKICAgIH0KCiAgICBmdW5jdGlvbiBhZGRTdWJIYXdiKG9iaikgewogICAgICB2YXIgaXRlbSA9IGFuZ3VsYXIuY29weSh2bS5kZWZhdWx0U3ViSGF3Yik7CgogICAgICBzZXRfb2JqX3RpZChpdGVtKTsKICAgICAgb2JqLl9fc3ViaGF3Yi5zcGxpY2UoMCwgMCwgaXRlbSk7ICAvLyBpbnNlcnQgdG8gMAoKICAgICAgLy8gZm9jdXMgb24gbmV3bHkgY3JlYXRlZCBpdGVtCiAgICAgIHZtLnN1Ykhhd2JGb2N1c1RpZCA9IGl0ZW0udGlkOwogICAgfQoKICAgIGZ1bmN0aW9uIGRlbFN1Ykhhd2Iob2JqKSB7CiAgICAgIG1vZGFsLm9wZW4oX1QuTVNHLkNPTkZJUk1fREVMRVRFKQogICAgICAgIC50aGVuKGZ1bmN0aW9uIChyZXN1bHQpIHsKICAgICAgICAgIHZhciByZXEgPSBbXTsKICAgICAgICAgIHZhciBrZWVwX2xpc3QgPSBbXTsKICAgICAgICAgIG9iai5fX3N1Ymhhd2IuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkgewogICAgICAgICAgICBpZiAoaXRlbS5fX2NoZWNrZWQpIHsKICAgICAgICAgICAgICBpZiAoaXRlbS5pZCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXEucHVzaCgkaHR0cC5kZWxldGUoZ2VuVXJsKFVSTC5TSElQTUVOVF9IQkxfU1VCX0hBV0IsIHtzdWJoYXdiX2lkOiBpdGVtLmlkfSkpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAga2VlcF9saXN0LnB1c2goaXRlbSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwoKICAgICAgICAgICRxLmFsbChyZXEpCiAgICAgICAgICAgIC50aGVuKAogICAgICAgICAgICAgIGZ1bmN0aW9uIChyZXN1bHQpIHsKICAgICAgICAgICAgICAgIG9iai5fX3N1Ymhhd2IgPSBrZWVwX2xpc3Q7CiAgICAgICAgICAgICAgICByZWZyZXNoQWxsU3ViSGF3YihvYmopOwogICAgICAgICAgICAgICAgU2hvd0ZlZWRiYWNrTXNnKCdzdWNjZXNzJywgX1QuTVNHLkRFTEVURV9TVUNDKTsKICAgICAgICAgICAgICB9LCBmdW5jdGlvbiAoZXJyUmVzdWx0KSB7CiAgICAgICAgICAgICAgICAkbG9nLmVycm9yKGVyclJlc3VsdCk7CiAgICAgICAgICAgICAgICBTaG93RmVlZGJhY2tNc2coJ2Vycm9yJywgX1QuTVNHLkRFTEVURV9GQUlMKTsKICAgICAgICAgICAgICB9KQogICAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIHNlbEFsbFN1Ykhhd2Iob2JqKSB7CiAgICAgIHZhciBpc1NlbGVjdEFsbCA9IG9iai5fX3N1Ymhhd2IuZXZlcnkoZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgICByZXR1cm4gaXRlbS5fX2NoZWNrZWQ7CiAgICAgIH0pOwogICAgICBvYmouX19zdWJoYXdiLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgICBpdGVtLl9fY2hlY2tlZCA9ICFpc1NlbGVjdEFsbDsKICAgICAgfSk7CiAgICAgIHJlZnJlc2hBbGxTdWJIYXdiKG9iaik7CiAgICB9CgogICAgZnVuY3Rpb24gc2VsU3ViSGF3YihvYmosIGl0ZW0pIHsKICAgICAgaXRlbS5fX2NoZWNrZWQgPSAhaXRlbS5fX2NoZWNrZWQ7CiAgICAgIHJlZnJlc2hBbGxTdWJIYXdiKG9iaik7CiAgICB9CgogICAgZnVuY3Rpb24gcmVmcmVzaEFsbFN1Ykhhd2Iob2JqKSB7CiAgICAgIGlmIChvYmouX19zdWJoYXdiLmxlbmd0aCA9PT0gMCkgewogICAgICAgIG9iai5fX2lzX3NlbF9hbGxfc3ViaGF3YiA9IGZhbHNlOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIG9iai5fX2lzX3NlbF9hbGxfc3ViaGF3YiA9IG9iai5fX3N1Ymhhd2IuZXZlcnkoZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgICAgIHJldHVybiBpdGVtLl9fY2hlY2tlZDsKICAgICAgICB9KQogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0Q3VycmVudERpc3BsYXlWYWx1ZShrZXkpIHsKICAgICAgcmV0dXJuIGVudHJ5SGVscGVyU2VydmljZS5nZXRDdXJyZW50RGlzcGxheVZhbHVlKGtleSk7CiAgICB9CgogICAgZnVuY3Rpb24gZWRpdEZvcm1EaXNwbGF5KCRldmVudCwgaW5wdXQsIHdyaXRlT2JqLCBrZXksIGZvcm0sIG9wdGlvbnMgPSBudWxsKSB7CiAgICAgIHZhciBkZWZhdWx0RGlzcGxheVZhbHVlID0gZW50cnlIZWxwZXJTZXJ2aWNlLmdldERlZmF1bHREaXNwbGF5VmFsdWUoa2V5KTsKICAgICAgdmFyIGRpc3BsYXlGaWVsZCA9IGVudHJ5SGVscGVyU2VydmljZS5nZXREaXNwbGF5RmllbGQoa2V5KTsKICAgICAgdmFyIGRpc3BsYXlWYWx1ZSA9IHdyaXRlT2JqW2Rpc3BsYXlGaWVsZF07CiAgICAgIHZhciBvcmlnaW4gPSAoZGlzcGxheVZhbHVlID09PSBudWxsKSA/IGRlZmF1bHREaXNwbGF5VmFsdWUgOiBkaXNwbGF5VmFsdWU7CiAgICAgIHZhciBjb250ZW50VGV4dDsKICAgICAgdmFyIGNsYXNzZXMgPSAncXRpcC1ib290c3RyYXAgJzsKCiAgICAgIGlmIChpbnB1dCA9PT0gJ2lucHV0JykgewogICAgICAgIGNvbnRlbnRUZXh0ID0gJzxpbnB1dCB0eXBlPSJ0ZXh0IiBpZD0iZm9ybV9kaXNwbGF5X2VkaXQiIGNsYXNzPSJ2YWx1ZS1zbSIgdmFsdWU9IicgKyBvcmlnaW4gKyAnIj4nOwogICAgICAgIGNsYXNzZXMgKz0gJ3Rvb2x0aXBpbnB1dCcKICAgICAgfSBlbHNlIHsKICAgICAgICBjb250ZW50VGV4dCA9ICc8dGV4dGFyZWEgcm93cz0iNSIgaWQ9ImZvcm1fZGlzcGxheV9lZGl0IiBjbGFzcz0iZm9ybS1jb250cm9sIHZhbHVlLXNtIiA+JyArIG9yaWdpbiArICc8L3RleHRhcmVhPic7CiAgICAgICAgY2xhc3NlcyArPSAndG9vbHRpcHRleHRhcmVhJzsKICAgICAgfQoKICAgICAgdmFyIGVsZW1lbnQgPSAkKCRldmVudC50YXJnZXQpOwogICAgICAkKGVsZW1lbnQpLnF0aXAoewogICAgICAgIHNob3c6IHsKICAgICAgICAgIHJlYWR5OiB0cnVlLAogICAgICAgICAgZXZlbnQ6IGZhbHNlLAogICAgICAgICAgc29sbzogdHJ1ZSwKICAgICAgICB9LAogICAgICAgIGNvbnRlbnQ6IHsKICAgICAgICAgIHRleHQ6IGNvbnRlbnRUZXh0LAogICAgICAgICAgYnV0dG9uOiAnQ2xvc2UnLAogICAgICAgICAgdGl0bGU6IF9ULk1TRy5FRElULAogICAgICAgIH0sCiAgICAgICAgcG9zaXRpb246IHsKICAgICAgICAgIG15OiAndG9wIHJpZ2h0JywgIC8vIFBvc2l0aW9uIG15IHRvcCBsZWZ0Li4uCiAgICAgICAgICBhdDogJ2JvdHRvbSByaWdodCcsIC8vIGF0IHRoZSBib3R0b20gcmlnaHQgb2YuLi4KICAgICAgICAgIHRhcmdldDogJChlbGVtZW50KSwgLy8gbXkgdGFyZ2V0CiAgICAgICAgICBhZGp1c3Q6IHsKICAgICAgICAgICAgeTogMgogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgc3R5bGU6IHsKICAgICAgICAgIGNsYXNzZXM6IGNsYXNzZXMsCiAgICAgICAgfSwKICAgICAgICBoaWRlOiAndW5mb2N1cycsCiAgICAgICAgZXZlbnRzOiB7CiAgICAgICAgICAgIGhpZGU6IGZ1bmN0aW9uKGV2ZW50LCBhcGkpIHsKICAgICAgICAgICAgICB2YXIgbmV3VGV4dCA9ICQoJyNmb3JtX2Rpc3BsYXlfZWRpdCcpLnZhbCgpOwogICAgICAgICAgICAgIGlmIChuZXdUZXh0ICE9PSBvcmlnaW4pIHsKICAgICAgICAgICAgICAgICR0aW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBpZiAobmV3VGV4dCA9PT0gZGVmYXVsdERpc3BsYXlWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgIG5ld1RleHQgPSBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHdyaXRlT2JqW2Rpc3BsYXlGaWVsZF0gPSBuZXdUZXh0OwogICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnN5bmNUb0hibEtleSkgewogICAgICAgICAgICAgICAgICAgIHN5bmNNQkxGaWVsZFRvQWxsSEJMKG9wdGlvbnMuc3luY1RvSGJsS2V5KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBmb3JtLiRzZXREaXJ0eSgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICQodGhpcykucXRpcCgnZGVzdHJveScpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICBmdW5jdGlvbiBlbmFibGVBdXRvR2VuSEJMKGhibCkgewogICAgICByZXR1cm4gIWhibC5pZCAmJiAoaXNPRSgpIHx8IGlzQUUoKSk7CiAgICB9CgogICAgZnVuY3Rpb24gb25DbGlja0hCTE5vQXV0b0dlbihjdXJIYmwpIHsKCiAgICAgIC8vIGZvciBjb3B5IHdob2xlIE1CTCBjYXNlLCBuZWVkIHRvIHN5bmMgYWxsIEhCTHMnIEhCTF9OTyBnZW5lcmF0aW9uCiAgICAgIGlmICh2bS5jb3B5RnJvbSkgewogICAgICAgIHZtLmhibF9saXN0LmZvckVhY2goZnVuY3Rpb24gKGhibCwgaWR4KSB7CiAgICAgICAgICBoYmwuSEJMX05PID0gdm0uYXV0b0dlbkhCTE5PID8gbnVsbCA6ICdDT1BZLScgKyAoaWR4ICsgMSk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY3VySGJsLkhCTF9OTyA9IG51bGw7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBnZXRIb2xkTWVzc2FnZShpbmZvLCBzaG93SG9sZFJlYXNvbikgewogICAgICBjb25zdCBob2xkQnkgPSAkZmlsdGVyKCdnZXRVc2VyRGlzcGxheU5hbWUnKShpbmZvLmhvbGRfYnkpOwogICAgICBjb25zdCBob2xkQXQgPSAkZmlsdGVyKCdkYXRlX2Zvcm1hdCcpKGluZm8uaG9sZF9hdCk7CiAgICAgIGNvbnN0IGhvbGRSZWFzb24gPSBpbmZvLmhvbGRfcmVhc29uOwoKICAgICAgaWYgKHNob3dIb2xkUmVhc29uICYmIGhvbGRSZWFzb24pIHsKICAgICAgICByZXR1cm4gY3JlYXRlU3RyaW5nRm9ybWF0dGVyKF9ULk1TRy5IT0xEX0RVRV9UT19CWV9PTikuZm9ybWF0KGhvbGRSZWFzb24sIGhvbGRCeSwgaG9sZEF0KTsKICAgICAgfQoKICAgICAgcmV0dXJuIGNyZWF0ZVN0cmluZ0Zvcm1hdHRlcihfVC5NU0cuSE9MRF9CWV9PTikuZm9ybWF0KGhvbGRCeSwgaG9sZEF0KTsKICAgIH0KCiAgICBmdW5jdGlvbiBzaG93SG9sZE1lc3NhZ2UoaW5mbykgewogICAgICByZXR1cm4gaW5mby5pc19ob2xkICYmIGluZm8uaG9sZF9hdCAmJiBpbmZvLmhvbGRfYnk7CiAgICB9CgogICAgZnVuY3Rpb24gb25Jc0hvbGRDaGFuZ2UoaW5mbykgewogICAgICBpZiAoaW5mby5pc19ob2xkKSB7CiAgICAgICAgaW5mby5ob2xkX2F0ID0gdG9kYXk7CiAgICAgICAgaW5mby5ob2xkX2J5ID0gbWVTZXJ2aWNlLmRhdGE7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaW5mby5ob2xkX3JlYXNvbiA9IG51bGw7CiAgICAgICAgaW5mby5ob2xkX2F0ID0gbnVsbDsKICAgICAgICBpbmZvLmhvbGRfYnkgPSBudWxsOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gYmFja2dyb3VuZFNhdmVIYmxzKHNyY0hibCwgLi4uZmllbGRzKSB7CiAgICAgIGNvbnN0IHByb21pc2VzID0gW107CiAgICAgIGNvbnN0IHBhcmFtID0ge307CgogICAgICAvLyByZXF1ZXN0cyBmb3Igc2F2aW5nIGhibHMKICAgICAgZmllbGRzLmZvckVhY2goKGZpZWxkKSA9PiB7CiAgICAgICAgcGFyYW1bZmllbGRdID0gc3JjSGJsW2ZpZWxkXTsKICAgICAgfSk7CgogICAgICB2bS5oYmxfbGlzdC5mb3JFYWNoKChoYmwpID0+IHsKICAgICAgICBpZiAoaGJsLmlkICE9PSBzcmNIYmwuaWQpIHsKICAgICAgICAgIGZpZWxkcy5mb3JFYWNoKChmaWVsZCkgPT4gewogICAgICAgICAgICBoYmxbZmllbGRdID0gc3JjSGJsW2ZpZWxkXTsKICAgICAgICAgIH0pOwogICAgICAgICAgcHJvbWlzZXMucHVzaCgkaHR0cC5wdXQoZ2VuVXJsKFVSTC5TSElQTUVOVF9IQkwsIHsgaGJsX2lkOiBoYmwuaWQgfSksIHBhcmFtKSk7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIC8vIHVwZGF0ZSBjYWNoZSBhbmQgc2V0IHByaXN0aW5lIGZvciBvdGhlciBoYmxzCiAgICAgIHNob3dTcGluKCk7CiAgICAgIHJldHVybiAkcS5hbGwocHJvbWlzZXMpCiAgICAgICAgLnRoZW4oKCkgPT4gewogICAgICAgICAgY2FjaGVJbmFjdGl2ZUhibEZvcm1EYXRhKHNyY0hibCk7CiAgICAgICAgICBTaG93RmVlZGJhY2tNc2coJ3N1Y2Nlc3MnLCBNU0dfQ09QWV9IQkxfRklFTERfVE9fT1RIRVJTKTsKICAgICAgICB9KS5maW5hbGx5KGhpZGVTcGluKTsKICAgIH0KCiAgICBmdW5jdGlvbiBvbkNvcHlJc2ZJbmZvVG9BbGxIYmxzKGhibCkgewogICAgICBtb2RhbC5vcGVuKF9ULk1TRy5DT05GSVJNX0NPUFlfQU1TX0lTRikKICAgICAgICAudGhlbigoKSA9PiB7CiAgICAgICAgICBiYWNrZ3JvdW5kU2F2ZUhibHMoaGJsLCAnSVNGX05PJywgJ0FNU19OTycpCiAgICAgICAgICAgIC50aGVuKCgpID0+IHsKICAgICAgICAgICAgICB2bS5oYmxfbGlzdC5mb3JFYWNoKChfaGJsKSA9PiB7CiAgICAgICAgICAgICAgICBfaGJsLmlzZl9pZCA9IGhibC5pc2ZfaWQ7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIGNhbkVkaXRBbGxIYmwoKSB7CiAgICAgIHJldHVybiB2bS5oYmxfbGlzdC5ldmVyeShmdW5jdGlvbihoYmwpIHsKICAgICAgICByZXR1cm4gIWhibC5pc19ibG9ja19wZXJtOwogICAgICB9KTsKICAgIH0KCiAgICBmdW5jdGlvbiBvcGVuSXNmRW50cnkoaWQpIHsKICAgICAgJHdpbmRvdy5vcGVuKFVSTC5JU0ZfVklFVy5FTlRSWS5mb3JtYXQoaWQpKTsKICAgIH0KCiAgICBmdW5jdGlvbiBvcGVuQ3JlYXRlSXNmRnJvbUhibChoYmxJZCkgewogICAgICBpZiAodm0uZ0Zvcm0uJGRpcnR5KSB7CiAgICAgICAgaWYgKCF2bS5QLlNISVBNRU5UX0VOVFJZX0VESVRfQUxMICYmICF2bS5QLlNISVBNRU5UX0VOVFJZX0VESVRfU0VMRikgewogICAgICAgICAgICAgIHJldHVybiBtb2RhbC5vcGVuTm90aWNlKG1ibENvbnRyb2xsZXJNZXNzYWdlLk5PVElGWV9OT19QRVJNX1RPX1NBVkUpOwogICAgICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1vZGFsCiAgICAgICAgICAub3BlbihtYmxDb250cm9sbGVyTWVzc2FnZS5OT1RJRllfVE9fU0FWRV9OT1cpCiAgICAgICAgICAudGhlbih2bS5zYXZlKQogICAgICAgICAgLnRoZW4oKCkgPT4gZG9PcGVuKCkpOwogICAgICB9CgogICAgICByZXR1cm4gZG9PcGVuKCk7CgogICAgICAvKiBpbnRlcm5hbCBmdW5jdGlvbnMgKi8KICAgICAgZnVuY3Rpb24gZG9PcGVuKCkgewogICAgICAgICR3aW5kb3cub3BlbihnZW5VcmwoVVJMLklTRl9DUkVBVEUsIHsgY3JlYXRlX2Zyb21faGJsOiBoYmxJZCB9KSk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBzaG93Q3JlYXRlSXNmRnJvbUhibChoYmwpIHsKICAgICAgcmV0dXJuICFoYmwuaXNfM3JkX3BhcnR5X2lzZl9maWxpbmcgJiYgIWhibC5pc2ZfaWQgJiYgIWhibC5JU0ZfTk8gJiYgaGJsLmlkOwogICAgfQoKICAgIGZ1bmN0aW9uIGRvU2hpcG1lbnRCbG9jayhoYW5kbGVyKSB7CiAgICAgIHdhcm5Gb3JtTmVlZFNhdmUoKQogICAgICAgIC50aGVuKCgpID0+IGludm9pY2VUcFVwZGF0ZVNlcnZpY2UuY2xlYXJOZXdUcmFkZVBhcnRuZXIoKSkKICAgICAgICAudGhlbihzaG93U3BpbikKICAgICAgICAudGhlbigoKSA9PiBoYW5kbGVyLnBlcmZvcm1CbG9ja1VuYmxvY2soKSkKICAgICAgICAudGhlbihyZXNwID0+IHsKICAgICAgICAgIGxvYWREYXRhKCk7CiAgICAgICAgICBTaG93RmVlZGJhY2tNc2coJ3N1Y2Nlc3MnLCByZXNwLmZlZWRiYWNrTWVzc2FnZSk7CiAgICAgICAgfSwgcmVzcCA9PiB7CiAgICAgICAgICBpZiAocmVzcCAmJiByZXNwLmZlZWRiYWNrTWVzc2FnZSkgewogICAgICAgICAgICBTaG93RmVlZGJhY2tNc2coJ2Vycm9yJywgcmVzcC5mZWVkYmFja01lc3NhZ2UpOwogICAgICAgICAgfQogICAgICAgIH0pLmZpbmFsbHkoaGlkZVNwaW4pOwogICAgfQoKICAgIGZ1bmN0aW9uIG9uQ2xpY2tCbG9ja01ibCgpIHsKICAgICAgZG9TaGlwbWVudEJsb2NrKG5ldyBNYmxCbG9ja1VuYmxvY2tIYW5kbGVyKHZtLm1ibCkpOwogICAgfQoKICAgIGZ1bmN0aW9uIG9uQ2xpY2tCbG9ja0hibChoYmwpIHsKICAgICAgZG9TaGlwbWVudEJsb2NrKG5ldyBIYmxCbG9ja1VuYmxvY2tIYW5kbGVyKGhibCkpOwogICAgfQoKICAgIC8vID09PT09PT09PT09PT09PSBUcnVjayB2aWV3IGFwaSA9PT09PT09PT09PT09PT0KICAgIGZ1bmN0aW9uIG9uVHJ1Y2tEZWxpdmVyZWRDaGFuZ2UoKSB7CiAgICAgIGlmKCF2bS5tYmwudGtfaW5mby5pc19kZWxpdmVyZWQpIHsKICAgICAgICB2bS5tYmwudGtfaW5mby5kZWxpdmVyZWRfZGF0ZSA9IG51bGw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gTG9jYWxEYXRlVGltZUZpZWxkIHJlcXVpcmUgdG8gaW5jbHVkZSB0aW1lem9uZSBpbmZvLCBidXQgd2UgZG9uJ3Qgd2FudCB0byBzaG93IHRpbWUgaW5mbyB0byB1c2VycwogICAgICAgIC8vIFVzZSBkYXlzdGFydCBmb3JtYXQgdG8gc3RyaXAgdXNlbGVzcyB0aW1lIGluZm8KICAgICAgICB2bS5tYmwudGtfaW5mby5kZWxpdmVyZWRfZGF0ZSA9IG1vbWVudCgpLmZvcm1hdChTRVJWRVJfU1RSX0ZPUk1BVF9UQUJMRS5kYXlzdGFydCk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBvblRydWNrVHJhZGVQYXJ0bmVyQ2hhbmdlKHRwKSB7CiAgICAgIGVudHJ5SGVscGVyU2VydmljZS50cmFkZVBhcnRuZXJDaGFuZ2VIYW5kbGVyKHRwKS50aGVuKCgpID0+IHsKICAgICAgICBpbnZvaWNlVHBVcGRhdGVTZXJ2aWNlLnNldE5ld1RyYWRlUGFydG5lcih2bS5tYmwudGtfaW5mby5iaWxsX3RvKTsKICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gb25NaXNjVHJhZGVQYXJ0bmVyQ2hhbmdlKHRwKSB7CiAgICAgIGVudHJ5SGVscGVyU2VydmljZS50cmFkZVBhcnRuZXJDaGFuZ2VIYW5kbGVyKHRwKS50aGVuKCgpID0+IHsKICAgICAgICBpbnZvaWNlVHBVcGRhdGVTZXJ2aWNlLnNldE5ld1RyYWRlUGFydG5lcih2bS5tYmwubXNfaW5mby5iaWxsX3RvKTsKICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gY29uZmlnSW52b2ljZVRwVXBkYXRlU2VydmljZSgpIHsKICAgICAgaWYgKGlzRGlyZWN0TWFzdGVyKCkpIHsKICAgICAgICBpbnZvaWNlVHBVcGRhdGVTZXJ2aWNlLmNvbmZpZyh7CiAgICAgICAgICBmaWxpbmdObzogdm0ubWJsLmZpbGluZ19ubywKICAgICAgICAgIG9sZFRwOiBnZXREaXJlY3RNYXN0ZXJCaWxsVG8oKSwKICAgICAgICB9KTsKCiAgICAgIH0gZWxzZSBpZiAoaXNPSSgpIHx8IGlzT0UoKSB8fCBpc0FJKCkgfHwgaXNBRSgpKSB7CiAgICAgICAgY29uc3QgaGJsID0gdm0uaGJsX2xpc3Rbdm0uY3VySGJsSWR4XTsKICAgICAgICBpZiAoaGJsKSB7CiAgICAgICAgICBpbnZvaWNlVHBVcGRhdGVTZXJ2aWNlLmNvbmZpZyh7CiAgICAgICAgICAgIGhibElkOiBoYmwuaWQsCiAgICAgICAgICAgIG9sZFRwOiBoYmwuYmlsbF90bywKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgIH0gZWxzZSBpZiAoaXNUSygpKSB7CiAgICAgICAgaW52b2ljZVRwVXBkYXRlU2VydmljZS5jb25maWcoewogICAgICAgICAgZmlsaW5nTm86IHZtLm1ibC5maWxpbmdfbm8sCiAgICAgICAgICBvbGRUcDogdm0ubWJsLnRrX2luZm8uYmlsbF90bywKICAgICAgICB9KTsKCiAgICAgIH0gZWxzZSBpZiAoaXNNaXNjKCkpIHsKICAgICAgICBpbnZvaWNlVHBVcGRhdGVTZXJ2aWNlLmNvbmZpZyh7CiAgICAgICAgICBmaWxpbmdObzogdm0ubWJsLmZpbGluZ19ubywKICAgICAgICAgIG9sZFRwOiB2bS5tYmwubXNfaW5mby5iaWxsX3RvLAogICAgICAgIH0pOwogICAgICB9CiAgICB9CgogICAgLy8gPT09PT09PT09PT09PT09IGhvb2sgYXBpID09PT09PT09PT09PT09PQogICAgd2luZG93Lm9uYmVmb3JldW5sb2FkID0gZnVuY3Rpb24oKXsKICAgICAgaWYoaXNGb3JtTmVlZFNhdmUoKSkKICAgICAgICByZXR1cm4gX1QuTVNHLkNPTkZJUk1fV0lUSE9VVF9TQVZJTkc7CiAgICAgIGVsc2UKICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfTsKCiAgfQoKICBjbGFzcyBBZUJhc2ljRW50cnlMYXlvdXQgewogICAgY29uc3RydWN0b3IoKSB7CiAgICAgIHRoaXMuaXNNYW5pZmVzdE5hdHVyZUFuZFF1YW50aXR5T2ZHb29kc1Nob3duID0gQ09NUEFOWV9JTkZPLmlzX2FlX2hhd2JfbWFuaWZlc3RfYW5kX3F1YW50aXR5X29mX2dvb2RzX3Nob3duOwogICAgfQogIH0KCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogIC8vIE5vdGlmaWNhdGlvbiBDb25maWcKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgogIGNsYXNzIEJhc2VOb3RpZmljYXRpb25Db25maWcgewogICAgZ2V0Tm90aWZpY2F0aW9uVHlwZVRhZyhub3RpZnkpIHt9CiAgfQoKICBjbGFzcyBPaU5vdGlmaWNhdGlvbkNvbmZpZyBleHRlbmRzIEJhc2VOb3RpZmljYXRpb25Db25maWcgewogICAgZ2V0Tm90aWZpY2F0aW9uVHlwZVRhZyhub3RpZnkpIHsKICAgICAgc3dpdGNoIChub3RpZnkudHlwZSkgewogICAgICAgIGNhc2UgJ01CTCc6IHJldHVybiBgWyR7X1QuTk9USUZJQ0FUSU9OLk1CTH1dYDsKICAgICAgICBjYXNlICdIQkwnOiByZXR1cm4gYFske19ULk5PVElGSUNBVElPTi5IQkx9XWA7CiAgICAgICAgZGVmYXVsdDogcmV0dXJuICdbXSc7CiAgICAgIH0KICAgIH0KICB9CgogIGNsYXNzIEFpTm90aWZpY2F0aW9uQ29uZmlnIGV4dGVuZHMgQmFzZU5vdGlmaWNhdGlvbkNvbmZpZyB7CiAgICBnZXROb3RpZmljYXRpb25UeXBlVGFnKG5vdGlmeSkgewogICAgICBzd2l0Y2ggKG5vdGlmeS50eXBlKSB7CiAgICAgICAgY2FzZSAnTUJMJzogcmV0dXJuIGBbJHtfVC5OT1RJRklDQVRJT04uTUFXQn1dYDsKICAgICAgICBjYXNlICdIQkwnOiByZXR1cm4gYFske19ULk5PVElGSUNBVElPTi5IQVdCfV1gOwogICAgICAgIGRlZmF1bHQ6IHJldHVybiAnW10nOwogICAgICB9CiAgICB9CiAgfQoKICBjbGFzcyBNc05vdGlmaWNhdGlvbkNvbmZpZyBleHRlbmRzIEJhc2VOb3RpZmljYXRpb25Db25maWcgewogICAgZ2V0Tm90aWZpY2F0aW9uVHlwZVRhZyhub3RpZnkpIHsKICAgICAgc3dpdGNoIChub3RpZnkudHlwZSkgewogICAgICAgIGNhc2UgJ01pc2MnOiByZXR1cm4gYFske19ULk5PVElGSUNBVElPTi5NSVNDfV1gOwogICAgICAgIGRlZmF1bHQ6IHJldHVybiAnW10nOwogICAgICB9CiAgICB9CiAgfQoKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8gTm90aWZpY2F0aW9uIEhlbHBlcgogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICBjb25zdCBXRl9OT1JNQUwgPSAnbm90aWZpY2F0aW9uJzsKICBjb25zdCBXRl9FTUVSR0VOQ1kgPSAnZW1lcmdlbmN5JzsKICBjb25zdCBXRl9OT1RJRklDQVRJT05fQ0FURUdPUlkgPSBbV0ZfTk9STUFMLCBXRl9FTUVSR0VOQ1ldOwoKICBjbGFzcyBCYXNlTm90aWZpY2F0aW9uSGVscGVyIHsKICAgIGNvbnN0cnVjdG9yKHskaHR0cCwgJHEsIFVSTCwgZmlsaW5nTm8sIG5vdGlmaWNhdGlvbkNvbmZpZ30pIHsKICAgICAgdGhpcy4kaHR0cCA9ICRodHRwOwogICAgICB0aGlzLiRxID0gJHE7CiAgICAgIHRoaXMubm90aWZpY2F0aW9uQ29uZmlnID0gbm90aWZpY2F0aW9uQ29uZmlnOwoKICAgICAgdGhpcy51cmwgPSBVUkwuU0hJUE1FTlRfV09SS0ZMT1dfU1RBVFVTLmZvcm1hdChmaWxpbmdObyk7CgogICAgICB0aGlzLm5vdGlmaWNhdGlvbnMgPSBbXTsKCiAgICAgIHRoaXMubm90aWZpY2F0aW9uX21zZ19ib3ggPSB7fTsKICAgICAgV0ZfTk9USUZJQ0FUSU9OX0NBVEVHT1JZLmZvckVhY2goKGl0ZW0pID0+IHsKICAgICAgICB0aGlzLm5vdGlmaWNhdGlvbl9tc2dfYm94W2l0ZW1dID0gbnVsbDsKICAgICAgfSkKICAgIH0KCiAgICB1cGRhdGVOb3RpZmljYXRpb24oKSB7fQogICAgYnJvYWRjYXN0Tm90aWZpY2F0aW9uKCRzY29wZSkge30KICAgIHNob3dNQkxBbmRIQkxOb3RpZmljYXRpb24oaGJsSWQpIHt9CiAgICBzaG93TUJMTm90aWZpY2F0aW9uKCkge30KICAgIHNob3dNaXNjTm90aWZpY2F0aW9uKCkge30KICB9CgogIGNsYXNzIE51bGxOb3RpZmljYXRpb25IZWxwZXIgZXh0ZW5kcyBCYXNlTm90aWZpY2F0aW9uSGVscGVyIHsKICAgIHVwZGF0ZU5vdGlmaWNhdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuJHEud2hlbih0cnVlKTsKICAgIH0KICB9CgogIGNsYXNzIE5vdGlmaWNhdGlvbkhlbHBlciBleHRlbmRzIEJhc2VOb3RpZmljYXRpb25IZWxwZXIgewogICAgdXBkYXRlTm90aWZpY2F0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy4kaHR0cAogICAgICAgICAgLmdldCh0aGlzLnVybCkKICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gewogICAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YSkgewogICAgICAgICAgICAgIHRoaXMubm90aWZpY2F0aW9ucyA9IHJlc3BvbnNlLmRhdGEubm90aWZpY2F0aW9uczsKICAgICAgICAgICAgfQogICAgICAgICAgfSkKICAgICAgICAgIC5jYXRjaCgoZXJyUmVzcG9uc2UpID0+IHsKICAgICAgICAgICAgY29uc29sZS5sb2coYEVycm9yOiAke2VyclJlc3BvbnNlLmRhdGF9YCk7CiAgICAgICAgICB9KTsKICAgIH0KCiAgICBicm9hZGNhc3ROb3RpZmljYXRpb24oJHNjb3BlKSB7CiAgICAgICRzY29wZS4kYnJvYWRjYXN0KCd1cGRhdGUtbm90aWZpY2F0aW9uJyk7CiAgICB9CgogICAgc2hvd01CTEFuZEhCTE5vdGlmaWNhdGlvbihoYmxJZCkgewogICAgICBpZiAodGhpcy5ub3RpZmljYXRpb25zLmxlbmd0aCA8PSAwKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBjb25zdCBoYmxOb3RpZmljYXRpb25zID0gXyh0aGlzLm5vdGlmaWNhdGlvbnMpCiAgICAgICAgICAuZmlsdGVyKHtoYmw6IGhibElkfSkKICAgICAgICAgIC52YWx1ZSgpOwoKICAgICAgdGhpcy5fc2hvd05vdGlmaWNhdGlvbihoYmxOb3RpZmljYXRpb25zKTsKICAgIH0KCiAgICBzaG93TUJMTm90aWZpY2F0aW9uKCkgewogICAgICBpZiAodGhpcy5ub3RpZmljYXRpb25zLmxlbmd0aCA8PSAwKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBjb25zdCBtYmxOb3RpZmljYXRpb25zID0gXyh0aGlzLm5vdGlmaWNhdGlvbnMpCiAgICAgICAgICAuZmlsdGVyKHt0eXBlOiAnTUJMJ30pCiAgICAgICAgICAudW5pcUJ5KCd0aXRsZScpCiAgICAgICAgICAudmFsdWUoKTsKCiAgICAgIHRoaXMuX3Nob3dOb3RpZmljYXRpb24obWJsTm90aWZpY2F0aW9ucyk7CiAgICB9CgogICAgc2hvd01pc2NOb3RpZmljYXRpb24oKSB7CiAgICAgIGlmICh0aGlzLm5vdGlmaWNhdGlvbnMubGVuZ3RoIDw9IDApIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGNvbnN0IG5vdGlmaWNhdGlvbnMgPSBfKHRoaXMubm90aWZpY2F0aW9ucykKICAgICAgICAgIC5maWx0ZXIoe3R5cGU6ICdNaXNjJ30pCiAgICAgICAgICAudW5pcUJ5KCd0aXRsZScpCiAgICAgICAgICAudmFsdWUoKTsKCiAgICAgIHRoaXMuX3Nob3dOb3RpZmljYXRpb24obm90aWZpY2F0aW9ucyk7CiAgICB9CgogICAgX3Nob3dOb3RpZmljYXRpb24obm90aWZpY2F0aW9ucykgewogICAgICBpZiAobm90aWZpY2F0aW9ucy5sZW5ndGggPD0gMCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5fY2xvc2VBbGxOb3RpZmljYXRpb25Nc2dCb3goKTsKCiAgICAgIC8vIHByZXBhcmUgdHlwZVRhZywgc3RhdHVzSWNvbkNsYXNzCiAgICAgIG5vdGlmaWNhdGlvbnMuZm9yRWFjaCgobikgPT4gewogICAgICAgIG4udHlwZVRhZyA9IHRoaXMubm90aWZpY2F0aW9uQ29uZmlnLmdldE5vdGlmaWNhdGlvblR5cGVUYWcobik7CiAgICAgICAgbi5zdGF0dXNJY29uQ2xhc3MgPSB0aGlzLl9nZXROb3RpZmljYXRpb25TdGF0dXNJY29uQ2xhc3Mobik7CiAgICAgIH0pOwoKICAgICAgY29uc3QgW2VtZXJnZW5jeU5vdGlmaWNhdGlvbnMsIG5vcm1hbE5vdGlmaWNhdGlvbnNdID0gXy5wYXJ0aXRpb24obm90aWZpY2F0aW9ucywge3N0YXR1czogJ2VtZXJnZW5jeSd9KTsKCiAgICAgIC8vIC0tLS0tIG5vcm1hbCBub3RpZmljYXRpb24gLS0tLS0KICAgICAgbGV0IG5vcm1hbE5vdGlmaWNhdGlvblRhZyA9IF8obm9ybWFsTm90aWZpY2F0aW9ucykuc29tZSh7c3RhdHVzOiAnQWxlcnQnfSkgPyAnZXJyb3InIDogJ2luZm8nOwoKICAgICAgY29uc3Qgbm9ybWFsTm90aWZpY2F0aW9uTWVzc2FnZSA9IF8obm9ybWFsTm90aWZpY2F0aW9ucykKICAgICAgICAgIC5zb3J0QnkobiA9PiB0aGlzLl9nZXROb3RpZmljYXRpb25TdGF0dXNQcmlvcml0eShuKSkgIC8vIHNvcnQgYnkgc3RhdHVzCiAgICAgICAgICAuc29ydEJ5KG4gPT4gdGhpcy5fZ2V0Tm90aWZpY2F0aW9uVHlwZVByaW9yaXR5KG4pKSAgLy8gc29ydCBieSB0eXBlCiAgICAgICAgICAubWFwKG4gPT4gdGhpcy5fYnVpbGROb3JtYWxOb3RpZmljYXRpb25MaW5lSHRtbChuKSkKICAgICAgICAgIC5qb2luKCdcbicpOwoKICAgICAgaWYgKG5vcm1hbE5vdGlmaWNhdGlvbk1lc3NhZ2UpIHsKICAgICAgICB0aGlzLm5vdGlmaWNhdGlvbl9tc2dfYm94W1dGX05PUk1BTF0gPSBTaG93Tm90aWZpY2F0aW9uTXNnKG5vcm1hbE5vdGlmaWNhdGlvblRhZywgbm9ybWFsTm90aWZpY2F0aW9uTWVzc2FnZSk7CiAgICAgIH0KCiAgICAgIC8vIC0tLS0tIGVtZXJnZW5jeSBub3RpZmljYXRpb24gLS0tLS0KICAgICAgXyhlbWVyZ2VuY3lOb3RpZmljYXRpb25zKQogICAgICAgICAgLmdyb3VwQnkoJ3RpdGxlJykKICAgICAgICAgIC5mb3JFYWNoKChuTGlzdCwgdGl0bGUpID0+IHsgIC8vIGJ1aWxkIEhUTUwgc3RyaW5nCiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSB0aGlzLl9idWlsZEVtZXJnZW5jeU5vdGlmaWNhdGlvbk1lc3NhZ2VIdG1sKG5MaXN0LCB0aXRsZSk7CgogICAgICAgICAgICAvLyBUT0RPOiBoYW5kbGUgbXVsdGlwbGUgZW1lcmdlbmN5IG1lc3NhZ2VzCiAgICAgICAgICAgIHRoaXMubm90aWZpY2F0aW9uX21zZ19ib3hbV0ZfRU1FUkdFTkNZXSA9IFNob3dOb3RpZmljYXRpb25Nc2coJ2VtZXJnZW5jeScsIG1lc3NhZ2UpOwogICAgICAgICAgfSk7CiAgICB9CgogICAgX2J1aWxkTm9ybWFsTm90aWZpY2F0aW9uTGluZUh0bWwobm90aWZ5KSB7CiAgICAgIHJldHVybiBbCiAgICAgICAgYDxkaXYgY2xhc3M9ImFsZXJ0LWxpbmUiPmAsCiAgICAgICAgYCAgPHNwYW4gY2xhc3M9ImFsZXJ0LXRhZyI+PGkgY2xhc3M9IiR7bm90aWZ5LnN0YXR1c0ljb25DbGFzc30iPjwvaT4ke25vdGlmeS50aXRsZX08L3NwYW4+YCwKICAgICAgICBgICA8ZGl2IGNsYXNzPSJhbGVydC10ZXh0Ij48c3Ryb25nPiR7bm90aWZ5LnR5cGVUYWd9PC9zdHJvbmc+ICR7bm90aWZ5LmRlc2NyaXB0aW9ufTwvZGl2PmAsCiAgICAgICAgYCAgPGRpdiBjbGFzcz0iY2xlYXJmaXgiPjwvZGl2PmAsCiAgICAgICAgYDwvZGl2PmAsCiAgICAgIF0uam9pbignJyk7CiAgICB9CgogICAgX2J1aWxkRW1lcmdlbmN5Tm90aWZpY2F0aW9uTGluZUh0bWwobm90aWZ5KSB7CiAgICAgIHJldHVybiBgPHN0cm9uZz4ke25vdGlmeS50eXBlVGFnfTwvc3Ryb25nPiAke25vdGlmeS5kZXNjcmlwdGlvbn1gOwogICAgfQoKICAgIF9idWlsZEVtZXJnZW5jeU5vdGlmaWNhdGlvbk1lc3NhZ2VIdG1sKG5vdGlmeUxpc3QsIHRpdGxlKSB7CiAgICAgIGNvbnN0IGxpbmVzID0gXyhub3RpZnlMaXN0KQogICAgICAgICAgLnNvcnRCeShuID0+IHRoaXMuX2dldE5vdGlmaWNhdGlvblR5cGVQcmlvcml0eShuKSkgIC8vIHNvcnQgYnkgdHlwZQogICAgICAgICAgLm1hcChuID0+IHRoaXMuX2J1aWxkRW1lcmdlbmN5Tm90aWZpY2F0aW9uTGluZUh0bWwobikpCiAgICAgICAgICAuam9pbignPGJyPlxuJyk7CgogICAgICByZXR1cm4gWwogICAgICAgIGA8ZGl2IGNsYXNzPSJhbGVydC1saW5lIj5gLAogICAgICAgIGAgIDxzcGFuIGNsYXNzPSJhbGVydC10YWciPjxpIGNsYXNzPSJmYSBmYS13YXJuaW5nIj48L2k+JHt0aXRsZX08L3NwYW4+YCwKICAgICAgICBgICA8ZGl2IGNsYXNzPSJhbGVydC10ZXh0Ij48cD4ke2xpbmVzfTwvcD48L2Rpdj5gLAogICAgICAgIGAgIDxkaXYgY2xhc3M9ImNsZWFyZml4Ij48L2Rpdj5gLAogICAgICAgIGA8L2Rpdj5gLAogICAgICBdLmpvaW4oJycpOwogICAgfQoKICAgIF9nZXROb3RpZmljYXRpb25TdGF0dXNQcmlvcml0eShub3RpZnkpIHsKICAgICAgc3dpdGNoIChub3RpZnkuc3RhdHVzKSB7CiAgICAgICAgY2FzZSAnQWxlcnQnOiByZXR1cm4gMDsgIC8vIGhpZ2ggcHJpb3JpdHkKICAgICAgICBjYXNlICdSZW1pbmRlcic6IHJldHVybiAxOwogICAgICAgIGRlZmF1bHQ6IHJldHVybiAyOwogICAgICB9CiAgICB9CgogICAgX2dldE5vdGlmaWNhdGlvblR5cGVQcmlvcml0eShub3RpZnkpIHsKICAgICAgc3dpdGNoIChub3RpZnkudHlwZSkgewogICAgICAgIGNhc2UgJ01CTCc6IHJldHVybiAwOyAgLy8gaGlnaCBwcmlvcml0eQogICAgICAgIGNhc2UgJ0hCTCc6IHJldHVybiAxOwogICAgICAgIGRlZmF1bHQ6IHJldHVybiAyOwogICAgICB9CiAgICB9CgogICAgX2dldE5vdGlmaWNhdGlvblN0YXR1c0ljb25DbGFzcyhub3RpZnkpIHsKICAgICAgc3dpdGNoIChub3RpZnkuc3RhdHVzKSB7CiAgICAgICAgY2FzZSAnZW1lcmdlbmN5JzogcmV0dXJuICdmYSBmYS13YXJuaW5nJzsKICAgICAgICBjYXNlICdBbGVydCc6IHJldHVybiAnZmEgZmEtd2FybmluZyc7CiAgICAgICAgY2FzZSAnUmVtaW5kZXInOiByZXR1cm4gJ2ZhIGZhLWJlbGwnOwogICAgICAgIGRlZmF1bHQ6IHJldHVybiAnJzsKICAgICAgfQogICAgfQoKICAgIF9jbG9zZUFsbE5vdGlmaWNhdGlvbk1zZ0JveCgpIHsKICAgICAgV0ZfTk9USUZJQ0FUSU9OX0NBVEVHT1JZLmZvckVhY2goKGl0ZW0pID0+IHsKICAgICAgICBpZiAodGhpcy5ub3RpZmljYXRpb25fbXNnX2JveFtpdGVtXSkgewogICAgICAgICAgdGhpcy5ub3RpZmljYXRpb25fbXNnX2JveFtpdGVtXS5hbGVydCgnY2xvc2UnKTsKICAgICAgICAgIHRoaXMubm90aWZpY2F0aW9uX21zZ19ib3hbaXRlbV0gPSBudWxsOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogIH0KCn0pKCk7Cg==</text>
      </register>
      <register name="4" type="2">
        <text encoding="base64">aW1wb3J0IHsgX1QgfSBmcm9tICcuL2hjLWF1dG9jb21wbGV0ZS1iYXNlLmNvbXBvbmVudC50ZXh0X2RlZic7CmltcG9ydCB7CiAgQ29tcG9uZW50LAogIEVsZW1lbnRSZWYsCiAgRXZlbnRFbWl0dGVyLAogIEhvc3RCaW5kaW5nLAogIEhvc3RMaXN0ZW5lciwKICBJbmplY3QsCiAgSW5wdXQsCiAgT25DaGFuZ2VzLAogIE9uSW5pdCwKICBPdXRwdXQsCiAgU2ltcGxlQ2hhbmdlcywKICBWaWV3Q2hpbGQsCn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7CmltcG9ydCB7IENvbnRyb2xWYWx1ZUFjY2Vzc29yIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnOwppbXBvcnQgeyBOZ1NlbGVjdENvbXBvbmVudCB9IGZyb20gJ0BuZy1zZWxlY3Qvbmctc2VsZWN0JzsKaW1wb3J0IHsKICBBVVRPX0NPTVBMRVRFX1FVRVJJRVJfVE9LRU4sCiAgQXV0b0NvbXBsZXRlR2VuZXJhbFF1ZXJpZXIsCiAgSUF1dG9Db21wbGV0ZVF1ZXJpZXIsCiAgSUVuZFBvaW50UHJvdmlkZXIsCiAgUVVFUklFUl9UWVBFLAp9IGZyb20gJ0xpYi9hbmd1bGFyL3NoYXJlZC1jb21wb25lbnQvYXV0by1jb21wbGV0ZS11dGlsaXR5JzsKaW1wb3J0IHsgZ2V0RG9jdW1lbnRXaWR0aCwgZ2V0RWxlbWVudFBvc2l0aW9uIH0gZnJvbSAnTGliL3RzL3V0aWwtd2luZG93JzsKaW1wb3J0IHsgT2JzZXJ2YWJsZSwgUmVwbGF5U3ViamVjdCwgU3ViamVjdCB9IGZyb20gJ3J4anMnOwppbXBvcnQgeyBtYXAsIHNoYXJlLCB0YXAsIHRocm90dGxlVGltZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJzsKCmltcG9ydCB7IF9UIH0gZnJvbSAnLi9oYy1hdXRvY29tcGxldGUtYmFzZS5jb21wb25lbnQudGV4dF9kZWYnOwoKQENvbXBvbmVudCh7CiAgc2VsZWN0b3I6ICdhdXRvY29tcGxldGVQYXJlbnQnLAogIHRlbXBsYXRlOiAnJywKfSkKZXhwb3J0IGFic3RyYWN0IGNsYXNzIEhjQXV0b2NvbXBsZXRlQmFzZUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzLCBDb250cm9sVmFsdWVBY2Nlc3NvciwgSUVuZFBvaW50UHJvdmlkZXIgewogIEBJbnB1dCgpIGhjRGlzYWJsZWQ6IGJvb2xlYW47CiAgQElucHV0KCkgYXBwZW5kVG86IHN0cmluZzsKICBASW5wdXQoKSBoY0NsYXNzOiBzdHJpbmcgfCBzdHJpbmdbXSB8IHsgW2tleTogc3RyaW5nXTogYm9vbGVhbiB9OwogIEBJbnB1dCgpIGRyb3BEb3duUGFuZWxDbGFzczogc3RyaW5nW118c3RyaW5nOwogIEBJbnB1dCgpIGlzRHJvcERvd25PblJpZ2h0OiBib29sZWFuOwoKICBASW5wdXQoKSBwbGFjZWhvbGRlciA9IF9ULlNFTEVDVDsKICBASW5wdXQoKSBhbGxvd0NsZWFyID0gdHJ1ZTsKCiAgY3VycmVudFZhbHVlOiBhbnk7CiAgdmFsdWVzJCA9IG5ldyBSZXBsYXlTdWJqZWN0PGFueVtdPigxKTsKICB0eXBlYWhlYWQgPSBuZXcgU3ViamVjdDxzdHJpbmc+KCk7CiAgb25DaGFuZ2U6IGFueTsKICBvblRvdWNoZWQ6IGFueTsKICBpc1NlYXJjaGluZzogYm9vbGVhbiA9IGZhbHNlOwogIHNlYXJjaCQ6IE9ic2VydmFibGU8c3RyaW5nPjsKICBxdWVyaWVyOiBJQXV0b0NvbXBsZXRlUXVlcmllcjsKICBAT3V0cHV0KCkgbGVhdmUgPSBuZXcgRXZlbnRFbWl0dGVyKCk7CgogIC8vIFVzZSAibW9kZWwiIGFzIHZhcmlhYmxlIG5hbWUgd2lsbCBjYXVzZSBidWcgdGhhdCBjYW4ndCBnZXQgdGhlIGRhdGEgZnJvbSBhbmd1bGFyanMsIGl0IHNlZW1zIGEgYnVnIG9mIGFuZ3VsYXIKICBASW5wdXQoJ2hjTW9kZWwnKSBtb2RlbDogYW55OwogIEBPdXRwdXQoKSBiZWZvcmVNb2RlbENoYW5nZSA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpOwogIEBPdXRwdXQoKSBjaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTsKCiAgQFZpZXdDaGlsZCgnbmdTZWxlY3QnLCB7IHN0YXRpYzogdHJ1ZSB9KSBuZ1NlbGVjdDogTmdTZWxlY3RDb21wb25lbnQ7CiAgQFZpZXdDaGlsZCgnbmdTZWxlY3QnLCB7IHN0YXRpYzogdHJ1ZSwgcmVhZDogRWxlbWVudFJlZiB9KSBuZ1NlbGVjdFJhd0VsZW1lbnQ6IEVsZW1lbnRSZWY7CiAgQFZpZXdDaGlsZCgnc2VhcmNoSW5wdXQnKSBzZWFyY2hJbnB1dDogRWxlbWVudFJlZjsKCiAgQEhvc3RCaW5kaW5nKCd0YWJpbmRleCcpIHRhYmluZGV4ID0gMDsKCiAgQEhvc3RMaXN0ZW5lcignZm9jdXMnKQogIG9uRm9jdXMoKSB7CiAgICB0aGlzLmZvY3VzKCk7CiAgfQoKICBjb25zdHJ1Y3RvcigKICAgIHByb3RlY3RlZCBodHRwOiBIdHRwQ2xpZW50LAogICAgQEluamVjdChBVVRPX0NPTVBMRVRFX1FVRVJJRVJfVE9LRU4pIHByb3RlY3RlZCBxdWVyaWVyczogSUF1dG9Db21wbGV0ZVF1ZXJpZXJbXSwKICAgIEBJbmplY3QoJyRzY29wZScpIHByb3RlY3RlZCAkc2NvcGU6IGFueSwKICApIHsKICAgIHRoaXMuc2VhcmNoJCA9IHRoaXMudHlwZWFoZWFkLnBpcGUoCiAgICAgIHRhcCgoKSA9PiAodGhpcy5pc1NlYXJjaGluZyA9IHRydWUpKSwKICAgICAgdGhyb3R0bGVUaW1lKDUwMCwgdW5kZWZpbmVkLCB7IGxlYWRpbmc6IHRydWUsIHRyYWlsaW5nOiB0cnVlIH0pLAogICAgICBtYXAoc2VhcmNoID0+IHNlYXJjaCB8fCAnJyksCiAgICAgIHNoYXJlKCksCiAgICApOwoKICAgIGlmICh0aGlzLnF1ZXJpZXJzLmxlbmd0aCA+IDIpIHsKICAgICAgY29uc29sZS5lcnJvcignY2Fubm90IGhhdmUgbW9yZSB0aGFuIHR3byBxdWVyaWVycyBmb3IgYW4gYXV0by1jb21wbGV0ZSBjb21wb25lbnQnKTsKICAgIH0KCiAgICBjb25zdCBjdXN0b21RdWVyaWVyID0gdGhpcy5xdWVyaWVycy5maW5kKHF1ZXJpZXIgPT4gcXVlcmllci5UWVBFID09PSBRVUVSSUVSX1RZUEUuQ1VTVE9NKTsKICAgIGNvbnN0IGJhc2VRdWVyaWVyID0gdGhpcy5xdWVyaWVycy5maW5kKHF1ZXJpZXIgPT4gcXVlcmllci5UWVBFID09PSBRVUVSSUVSX1RZUEUuREVGQVVMVCk7CiAgICBpZiAoYmFzZVF1ZXJpZXIpIHsKICAgICAgKGJhc2VRdWVyaWVyIGFzIEF1dG9Db21wbGV0ZUdlbmVyYWxRdWVyaWVyKS5zZXRFbmRQb2ludFByb3ZpZGVyPy5jYWxsKGJhc2VRdWVyaWVyLCB0aGlzKTsKICAgIH0KCiAgICB0aGlzLnF1ZXJpZXIgPSAoY3VzdG9tUXVlcmllciB8fCBiYXNlUXVlcmllcikhOwogIH0KCiAgbmdPbkluaXQoKTogdm9pZCB7CiAgICB0aGlzLnF1ZXJpZXIuZ2V0T2JzZXJ2YWJsZSh0aGlzLnNlYXJjaCQpLnN1YnNjcmliZSgodmFsdWVzOiBhbnlbXSkgPT4gewogICAgICB0aGlzLnZhbHVlcyQubmV4dCh2YWx1ZXMpOwogICAgICB0aGlzLmlzU2VhcmNoaW5nID0gZmFsc2U7CiAgICB9KTsKICB9CgogIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHsKICAgIGlmIChjaGFuZ2VzLm1vZGVsKSB7CiAgICAgIHRoaXMuY3VycmVudFZhbHVlID0gdGhpcy5tb2RlbCB8fCBudWxsOwogICAgfQogIH0KCiAgd3JpdGVWYWx1ZShvYmo6IGFueSk6IHZvaWQgewogICAgdGhpcy5jdXJyZW50VmFsdWUgPSBvYmo7CiAgfQoKICByZWdpc3Rlck9uVG91Y2hlZChmbjogYW55KTogdm9pZCB7CiAgICB0aGlzLm9uVG91Y2hlZCA9IGZuOwogIH0KCiAgcmVnaXN0ZXJPbkNoYW5nZShmbjogYW55KTogdm9pZCB7CiAgICB0aGlzLm9uQ2hhbmdlID0gZm47CiAgfQoKICBzZXREaXNhYmxlZFN0YXRlKGlzRGlzYWJsZWQ6IGJvb2xlYW4pOiB2b2lkIHsKICAgIHRoaXMubmdTZWxlY3Quc2V0RGlzYWJsZWRTdGF0ZShpc0Rpc2FibGVkKTsKICB9CgogIG9uTW9kZWxDaGFuZ2UobmV3VmFsdWU6IGFueSk6IHZvaWQgewogICAgdGhpcy5jdXJyZW50VmFsdWUgPSBuZXdWYWx1ZTsKICAgIHRoaXMuYmVmb3JlTW9kZWxDaGFuZ2UuZW1pdChuZXdWYWx1ZSk7CiAgICBpZiAodGhpcy5vbkNoYW5nZSkgewogICAgICB0aGlzLm9uQ2hhbmdlKG5ld1ZhbHVlKTsKICAgIH0KICAgIHRoaXMuY2hhbmdlLmVtaXQobmV3VmFsdWUpOwogICAgLy8gZm9yIHRyaWdnZXJpbmcgbmcxIGRpZ2VzdDsKICAgIHRoaXMuJHNjb3BlPy4kYXBwbHkoKTsKICB9CgogIG9uQ2xvc2UoKSB7CiAgICB0aGlzLmZvY3VzKCk7CiAgfQoKCiAgcHJpdmF0ZSBjdXN0b21pemVEcm9wZG93blBhbmVsKCkgewogICAgY29uc3Qgb2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcigobXV0YXRpb25zLCBtdXRhdGlvbk9ic2VydmVyKSA9PiB7CiAgICAgIC8vIFdhaXQgdW50aWwgbmctZHJvcGRvd24tcGFuZWwgZWxlbWVudCBleGlzdAogICAgICBjb25zdCBkcm9wRG93biA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ25nLWRyb3Bkb3duLXBhbmVsJykhIGFzIEhUTUxFbGVtZW50OwogICAgICBpZiAoZ2V0RWxlbWVudFBvc2l0aW9uKGRyb3BEb3duKS54ID4gZ2V0RG9jdW1lbnRXaWR0aCgpIC8gMikgewogICAgICAgIGNvbnN0IHNlbGVjdFdpZHRoID0gdGhpcy5uZ1NlbGVjdFJhd0VsZW1lbnQubmF0aXZlRWxlbWVudC5vZmZzZXRXaWR0aDsKICAgICAgICBjb25zdCBkcm9wRG93bldpZHRoID0gZHJvcERvd24ub2Zmc2V0V2lkdGg7CiAgICAgICAgY29uc3QgbGVmdCA9IHBhcnNlRmxvYXQoZHJvcERvd24uc3R5bGUuZ2V0UHJvcGVydHlWYWx1ZSgnbGVmdCcpKSB8fCAwOwogICAgICAgIGNvbnN0IGRpc3BsYWNlbWVudCA9IGRyb3BEb3duV2lkdGggLSBzZWxlY3RXaWR0aDsKICAgICAgICBkcm9wRG93bi5zdHlsZS5zZXRQcm9wZXJ0eSgnbGVmdCcsIGAke2xlZnQgLSBkaXNwbGFjZW1lbnR9cHhgKTsKICAgICAgfQogICAgICBpZiAoZHJvcERvd24pIHsKICAgICAgICBjb25zdCBkcm9wRG93bkNsYXNzTGlzdCA9IGRyb3BEb3duLmNsYXNzTGlzdDsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh0aGlzLmRyb3BEb3duUGFuZWxDbGFzcykpIHsKICAgICAgICAgIGRyb3BEb3duQ2xhc3NMaXN0LmFkZCguLi50aGlzLmRyb3BEb3duUGFuZWxDbGFzcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRyb3BEb3duQ2xhc3NMaXN0LmFkZCh0aGlzLmRyb3BEb3duUGFuZWxDbGFzcyk7CiAgICAgICAgfQogICAgICAgIHRoaXMuc2VhcmNoSW5wdXQubmF0aXZlRWxlbWVudC5mb2N1cygpOwogICAgICAgIHRoaXMuc2VhcmNoSW5wdXQubmF0aXZlRWxlbWVudC5zZWxlY3QoKTsKICAgICAgICBtdXRhdGlvbk9ic2VydmVyLmRpc2Nvbm5lY3QoKTsKICAgICAgfQogICAgfSk7CiAgICBvYnNlcnZlci5vYnNlcnZlKGRvY3VtZW50LCB7CiAgICAgIGNoaWxkTGlzdDogdHJ1ZSwKICAgICAgc3VidHJlZTogdHJ1ZSwKICAgIH0pOwogIH0KCiAgb25PcGVuKCkgewogICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgIHRoaXMuZm9jdXMoKTsKICAgIH0pOwogICAgdGhpcy52YWx1ZXMkLm5leHQoQXJyYXkoMTApLmZpbGwoeyBmYWtlOiB0cnVlIH0pKTsgLy8gZm9yIHNjcm9sbCB0byB3b3JrIG5vcm1hbGx5CiAgICAvLyBzZXRUaW1lb3V0IGZvciB3YWl0aW5nIHRoaXMuc2VhcmNoSW5wdXQgc2hvdyB1cAogICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgIHRoaXMuY3VzdG9taXplRHJvcGRvd25QYW5lbCgpOwogICAgICBpZiAodGhpcy5jdXJyZW50VmFsdWUgJiYgIUFycmF5LmlzQXJyYXkodGhpcy5jdXJyZW50VmFsdWUpKSB7CiAgICAgICAgdGhpcy52YWx1ZXMkLm5leHQoW3RoaXMuY3VycmVudFZhbHVlXSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5pc1NlYXJjaGluZyA9IHRydWU7CiAgICAgICAgdGhpcy52YWx1ZXMkLm5leHQoW10pOyAvLyBmb3Igbm90IHNob3dpbmcgZW1wdHkgaXRlbQogICAgICAgIHRoaXMubmdTZWxlY3QuZmlsdGVyKCcnKTsKICAgICAgfQogICAgfSk7CiAgfQoKICBvbkJsdXIoKSB7CiAgICBpZiAodGhpcy5vblRvdWNoZWQpIHsKICAgICAgdGhpcy5vblRvdWNoZWQoKTsKICAgIH0KCiAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgaWYgKCF0aGlzLm5nU2VsZWN0LmlzT3BlbiAmJiAhdGhpcy5uZ1NlbGVjdC5mb2N1c2VkKSB7CiAgICAgICAgdGhpcy5sZWF2ZS5uZXh0KCk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgb25TZWFyY2hJbnB1dEtleWRvd24oZXZlbnQ6IEtleWJvYXJkRXZlbnQpIHsKICAgIGlmIChldmVudC5rZXkgPT09ICdFbnRlcicgJiYgdGhpcy5pc1NlYXJjaGluZykgewogICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmICh0aGlzLmFwcGVuZFRvID09PSAnYm9keScpIHsKICAgICAgdGhpcy5uZ1NlbGVjdC5oYW5kbGVLZXlEb3duKGV2ZW50KTsKICAgIH0KICB9CgogIG9uS2V5ZG93bihldmVudDogS2V5Ym9hcmRFdmVudCk6IHZvaWQgewogICAgaWYgKHRoaXMuaXNPcGVuKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoZXZlbnQua2V5ID09PSAnRGVsZXRlJyB8fCBldmVudC5rZXkgPT09ICdCYWNrc3BhY2UnKSB7CiAgICAgIHRoaXMubmdTZWxlY3QuY2xlYXJNb2RlbCgpOwogICAgfQoKICAgIGlmIChldmVudC5rZXkubGVuZ3RoID09PSAxKSB7CiAgICAgIHRoaXMub3BlbigpOwogICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICB0aGlzLnNlYXJjaElucHV0Lm5hdGl2ZUVsZW1lbnQudmFsdWUgPSBldmVudC5rZXk7CiAgICAgICAgdGhpcy5uZ1NlbGVjdC5maWx0ZXIoZXZlbnQua2V5KTsKICAgICAgfSk7CiAgICB9CiAgfQoKICBnZXQgaXNPcGVuKCkgewogICAgcmV0dXJuIHRoaXMubmdTZWxlY3QuaXNPcGVuOwogIH0KCiAgZm9jdXMoKSB7CiAgICB0aGlzLm5nU2VsZWN0LmZvY3VzKCk7CiAgfQoKICBvcGVuKCkgewogICAgdGhpcy5uZ1NlbGVjdC5vcGVuKCk7CiAgfQoKICBvbkNsZWFyKCkgewogICAgdGhpcy5uZ1NlbGVjdC5maWx0ZXIoJycpOwogIH0KCiAgYWJzdHJhY3QgZ2V0RW5kUG9pbnQoc2VhcmNoOiBzdHJpbmcpOiBzdHJpbmc7Cn0K</text>
      </register>
      <register name="t" type="4">
        <keys>
          <key char="106" code="0" mods="0" />
          <key char="121" code="0" mods="0" />
          <key char="121" code="0" mods="0" />
          <key char="107" code="0" mods="0" />
          <key char="107" code="0" mods="0" />
          <key char="107" code="0" mods="0" />
          <key char="112" code="0" mods="0" />
          <key char="111" code="0" mods="0" />
          <key char="110" code="0" mods="0" />
          <key char="103" code="0" mods="0" />
          <key char="45" code="0" mods="0" />
          <key char="114" code="0" mods="0" />
          <key char="101" code="0" mods="0" />
          <key char="113" code="0" mods="0" />
          <key char="117" code="0" mods="0" />
          <key char="105" code="0" mods="0" />
          <key char="114" code="0" mods="0" />
          <key char="101" code="0" mods="0" />
          <key char="100" code="0" mods="0" />
          <key char="61" code="0" mods="0" />
          <key char="116" code="0" mods="0" />
          <key char="114" code="0" mods="0" />
          <key char="117" code="0" mods="0" />
          <key char="101" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
          <key char="111" code="0" mods="0" />
          <key char="99" code="0" mods="0" />
          <key char="108" code="0" mods="0" />
          <key char="97" code="0" mods="0" />
          <key char="115" code="0" mods="0" />
          <key char="115" code="0" mods="0" />
          <key char="61" code="0" mods="0" />
          <key char="115" code="0" mods="0" />
          <key char="104" code="0" mods="0" />
          <key char="111" code="0" mods="0" />
          <key char="119" code="0" mods="0" />
          <key char="45" code="0" mods="0" />
          <key char="101" code="0" mods="0" />
          <key char="114" code="0" mods="0" />
          <key char="114" code="0" mods="0" />
          <key char="111" code="0" mods="0" />
          <key char="114" code="0" mods="0" />
          <key char="115" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
          <key char="106" code="0" mods="0" />
          <key char="106" code="0" mods="0" />
          <key char="56" code="0" mods="0" />
          <key char="100" code="0" mods="0" />
          <key char="100" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
        </keys>
      </register>
      <register name="5" type="2">
        <text encoding="base64">Cg==</text>
      </register>
      <register name="6" type="2">
        <text encoding="base64">Cg==</text>
      </register>
      <register name="v" type="4">
        <keys>
          <key char="94" code="0" mods="0" />
          <key char="97" code="0" mods="0" />
          <key char="104" code="0" mods="0" />
          <key char="99" code="0" mods="0" />
          <key char="45" code="0" mods="0" />
          <key char="99" code="0" mods="0" />
          <key char="108" code="0" mods="0" />
          <key char="97" code="0" mods="0" />
          <key char="115" code="0" mods="0" />
          <key char="115" code="0" mods="0" />
          <key char="61" code="0" mods="0" />
          <key char="118" code="0" mods="0" />
          <key char="97" code="0" mods="0" />
          <key char="108" code="0" mods="0" />
          <key char="117" code="0" mods="0" />
          <key char="101" code="0" mods="0" />
          <key char="45" code="0" mods="0" />
          <key char="115" code="0" mods="0" />
          <key char="109" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
        </keys>
      </register>
      <register name="7" type="2">
        <text encoding="base64">Cg==</text>
      </register>
      <register name="w" type="4">
        <keys>
          <key char="94" code="0" mods="0" />
          <key char="105" code="0" mods="0" />
          <key char="91" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
          <key char="102" code="0" mods="0" />
          <key char="61" code="0" mods="0" />
          <key char="105" code="0" mods="0" />
          <key char="93" code="0" mods="0" />
          <key char="65535" code="27" mods="0" />
        </keys>
      </register>
      <register name="8" type="2">
        <text encoding="base64">CiAgZnVuY3Rpb24gaXNBbWVuZG1lbnRQZW5kaW5nT3JBcHByb3ZlZChpbnYpIHsKICAgIGNvbnN0IGlzUGVuZGluZyA9IGlzQW1lbmRtZW50U3RhdHVzUGVuZGluZyhpbnYuYXBwcm92YWxfc3RhdHVzKTsKICAgIGNvbnN0IGlzQXBwcm92ZWQgPSBpc0FtZW5kbWVudChpbnYpICYmIGlzTm9ybWFsKGludik7CiAgICByZXR1cm4gaXNQZW5kaW5nIHx8IGlzQXBwcm92ZWQ7CiAgfQo=</text>
      </register>
      <register name="9" type="2">
        <text encoding="base64">Cg==</text>
      </register>
      <register name="y" type="4">
        <text />
      </register>
      <register name=":" type="4">
        <text>1260</text>
      </register>
    </registers>
  </component>
  <component name="VimSearchSettings">
    <search>
      <last-dir>0</last-dir>
      <show-last>false</show-last>
    </search>
  </component>
  <component name="VimSettings">
    <state version="6" enabled="true" />
    <notifications>
      <idea-join enabled="false" />
      <idea-put enabled="false" />
    </notifications>
  </component>
</application>